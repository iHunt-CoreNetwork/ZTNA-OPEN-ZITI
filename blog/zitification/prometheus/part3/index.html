<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">Scraping Anything, Anywhere in Action | OpenZiti</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://openziti.io/blog/zitification/prometheus/part3"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="robots" content="index, follow"><meta data-rh="true" property="og:title" content="Scraping Anything, Anywhere in Action | OpenZiti"><meta data-rh="true" name="description" content="_This is part three of a three-part article. This article builds on the previous two articles. Here we will take a look at what we built"><meta data-rh="true" property="og:description" content="_This is part three of a three-part article. This article builds on the previous two articles. Here we will take a look at what we built"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-10-14T00:04:08.000Z"><meta data-rh="true" property="article:author" content="https://github.com/dovholuknf"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://openziti.io/blog/zitification/prometheus/part3"><link data-rh="true" rel="alternate" href="https://openziti.io/blog/zitification/prometheus/part3" hreflang="en"><link data-rh="true" rel="alternate" href="https://openziti.io/blog/zitification/prometheus/part3" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://EXWPKK5PV4-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="OpenZiti RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="OpenZiti Atom Feed">


<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-THVRRJ3GLE"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-THVRRJ3GLE",{anonymize_ip:!0})</script>




<link rel="search" type="application/opensearchdescription+xml" title="OpenZiti" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.42970787.css">
<link rel="preload" href="/assets/js/runtime~main.323ab7b6.js" as="script">
<link rel="preload" href="/assets/js/main.a545230f.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="root_VOM9"><span style="color:whitesmoke">Star us on GitHubÂ </span><span style="height:20px"><span><a href="https://github.com/openziti/ziti" data-icon="octicon-star" data-show-count="true" aria-label="Star buttons/github-buttons on GitHub">Star</a></span></span></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://openziti.io" target="_self" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/img/ziti-logo-dark.svg" alt="The OpenZiti logo, an open source zero trust network overlay" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/ziti-logo-light.svg" alt="The OpenZiti logo, an open source zero trust network overlay" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/learn/introduction/">Documentation</a><a class="navbar__item navbar__link" href="/docs/downloads">Downloads</a><a href="https://blog.openziti.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Blog</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Links</a><ul class="dropdown__menu"><li><div class="text-divider"><p>Socials</p></div></li><li><a href="https://www.youtube.com/OpenZiti" target="_blank" title="OpenZiti on YouTube"><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/yt.svg">YouTube</span></a></li><li><a href="https://twitter.com/OpenZiti" target="_blank" title="OpenZiti on Twitter"><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/twit.svg">Twitter</span></a></li><li><a href="https://www.reddit.com/r/openziti" target="_blank" title="OpenZiti Subreddit"><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/reddit-logo.png">Reddit</span></a></li><li><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/ziggy.png"><a href="https://twitter.com/OpenZiggy" target="_blank" title="OpenZiggy on Twitter">Ziggy</a></span></li><li><div class="text-divider"><p>Other</p></div></li><li><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/blog-icon.png"><a href="https://blog.openziti.io/" target="_blank" title="Blog">Blog</a></span></li><li><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/oz-test-kitchen.png"><a href="https://github.com/openziti-test-kitchen" target="_blank" title="Git project for the test kitchen">Test Kitchen</a></span></li><li><a href="https://zeds.openziti.org" target="_blank" title="Developer Sandbox"><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/zeds.png">ZEDS</span></a></li><li><a href="https://netfoundry.io/pricing/" target="_blank" title="NetFoundry-hosted Ziti"><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/nf.svg">CloudZiti</span></a></li></ul></div><a href="https://openziti.discourse.group/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-discourse-link" title="Discourse"></a><a href="https://github.com/openziti/ziti" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" title="GitHub"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_eExm"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/articles">Articles</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/c-sdk-on-beaglebone">Building the Ziti C SDK and Sample Apps for arm (BeagleBone)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/bootstrapping-trust/part-01.encryption-everywhere">Bootstrapping Trust</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/bootstrapping-trust/part-02.a-primer-on-public-key-cryptography">Bootstrapping Trust</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/bootstrapping-trust/part-03.certificates">Bootstrapping Trust</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="_This is part three of a three-part article. This article builds on the previous two articles. Here we will take a look at what we built"><header><h1 class="title_f1Hy" itemprop="headline">Scraping Anything, Anywhere in Action</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-10-14T00:04:08.000Z" itemprop="datePublished">October 14, 2023</time> Â· <!-- -->12 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/dovholuknf" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/46322585?v=4" alt="Clint Dovholuk" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/dovholuknf" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Clint Dovholuk</span></a></div><small class="avatar__subtitle" itemprop="description">OpenZiti Maintainer</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p><em>This is part three of a three-part article. This article builds on the previous two articles. Here we will take a look at what we built
and use it to explore the power of a zitified Prometheus. See <a href="/blog/zitification/prometheus/part1">part one</a> for the necessary background about the series. See
<a href="/blog/zitification/prometheus/part2">part two</a> for detailed instructions covering how to setup the environment you&#x27;re about to explore</em></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-payoff">The Payoff<a href="#the-payoff" class="hash-link" aria-label="Direct link to The Payoff" title="Direct link to The Payoff">â</a></h2><p>Ok. Here it is. We are at the end of the series and here is where we&#x27;ll put it all together and really start to understand the sort of
innovations you can create when you zitify an application. As a reminder, we are working with <a href="https://prometheus.io/" target="_blank" rel="noopener noreferrer">Prometheus</a>, a
CNCF project which we will use to monitor a workload deployed in two separate <a href="https://kubernetes.io" target="_blank" rel="noopener noreferrer">Kubernetes</a> clusters. To save you
from flipping back to a previous article, here is what that solution looks like.</p><p><img loading="lazy" alt="overview" src="/assets/images/kubernetes-prometheus-after-1c432161cd5ceac47eadc4149cae35fb.svg" width="1264" height="531" class="img_ev3q"></p><p>Now we are ready to start using our Prometheus servers. We&#x27;ll use our OpenZiti overlay network to connect to a workload which will
generate a metric we want to display in Prometheus. We&#x27;ll then configure Prometheus to scrape the workload and put it on a graph to
prove it works. Once that&#x27;s complete, we&#x27;ll play around with the setup and see if we really can scrape anything, anywhere. Let&#x27;s begin.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="developer-access">Developer Access<a href="#developer-access" class="hash-link" aria-label="Direct link to Developer Access" title="Direct link to Developer Access">â</a></h2><p>In the <a href="/blog/zitification/prometheus/part2">previous article</a>, we established our entire solution using the OpenZiti overlay, <code>kubectl</code> and <code>helm</code>. We saw
everything get installed and it all &quot;seems to work&quot;. But how do we <strong>know</strong> it works?  Let&#x27;s provision an identity for yourself now and
let&#x27;s enroll it in your local tunneling app and find out. Go out and get <a href="/docs/learn/core-concepts/clients/choose">a tunneling client</a> running
locally. Once you have that installed, provision an identity and enroll it with your tunneling client. </p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create identity user dev.client -a &quot;prometheus-clients&quot;,&quot;reflectz-clients&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You should have access to six total services when this identity is enrolled:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Service Name: kubeA.prometheus.svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Intercept: kubeA.prometheus.svc:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Service Name: kubeA.reflect.svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Intercept: kubeA.reflect.svc.ziti:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Service Name: kubeA.reflect.scrape.svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Intercept: kubeA.reflect.scrape.svc.ziti:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Service Name: kubeB.prometheus.svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Intercept: kubeB.prometheus.svc:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Service Name: kubeB.reflect.svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Intercept: kubeB.reflect.svc.ziti:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Service Name: kubeB.reflect.scrape.svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Intercept: kubeB.reflect.scrape.svc.ziti:80</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="clustera">ClusterA<a href="#clustera" class="hash-link" aria-label="Direct link to ClusterA" title="Direct link to ClusterA">â</a></h2><p>With your developer access you should be able to navigate your browser to <a href="http://kubea.prometheus.svc/targets" target="_blank" rel="noopener noreferrer">http://kubea.prometheus.svc/targets</a>. </p><blockquote><p>[!NOTE]<!-- -->
We won&#x27;t dwell on this for long in this article but notice that this is showing off another superpower of OpenZiti, private DNS.
Notice that you were able to browse to a totally fictitious domain name: kubea.prometheus.svc. &quot;.svc&quot; is <strong>not</strong> a legitimate top level
domain.
<a href="https://en.wikipedia.org/wiki/List_of_Internet_top-level_domains#S" target="_blank" rel="noopener noreferrer">Look at the full list of top level domains starting with S</a>. You
won&#x27;t find &quot;.svc&quot; on that list at this time</p></blockquote><p><img loading="lazy" alt="kubea.prom.init" src="/assets/images/kubea.prom.init-4d7855b727621c1778b9a8a6b6d7a25d.png" width="510" height="433" class="img_ev3q"></p><p>You should see the following. You might have noticed that the chart deployed has a few other containers we have not discussed yet. We&#x27;ll
not go into those containers in this article. What&#x27;s important is that this Prometheus server has a few targets already for us to access.
Neat, but this isn&#x27;t what we want to actually monitor.</p><p>What we really want to monitor is the workload we deployed: <code>reflectz</code>. We can do this by editing the Prometheus configmap using
<code>kubectl</code>. Let&#x27;s go ahead and do this now:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl edit cm prometheuz-prometheus-server</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This will open an editor in your terminal and allow you to update the config map for the pod. Once the editor is open, find the section
labeled &quot;scrape_config&quot; and add the following entry:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    - job_name: &#x27;kubeA.reflectz&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      scrape_interval: 5s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      honor_labels: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      scheme: &#x27;ziti&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      params:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;match[]&#x27;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - &#x27;{job!=&quot;&quot;}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;ziti-config&#x27;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - &#x27;/etc/prometheus/scrape.json&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      static_configs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - targets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - &#x27;kubeA.reflect.scrape.svc-kubeA.reflect.id&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This is yaml and yaml is sensitive to spaces. The block above is properly indented for the config that the helm chart installs. You
should be able to simply copy it and add it under the scrape_config. Remember, there is a <code>configmap-reload</code> container in
the pod which monitors the configmap. On successful edit, this container will notice and will issue a web hook to the
<code>prometheus-server</code> container. The trigger is not immediate, don&#x27;t worry if it takes a while. It can take around a minute for the
trigger to fire. </p><p>While we wait for the trigger, let&#x27;s explain what this is doing. This is informing the Prometheus server to monitor a workload which can
be found at the provided target of <code>kubeA.reflect.scrape.svc-kubeA.reflect.id</code>. Notice that no port is included in this target, and also
notice that this is a very strange looking FQDN. That&#x27;s because this is a zitified version of Prometheus. We have extended Prometheus to
understand a &quot;scheme&quot; of <code>ziti</code>. When we configure this job with a scheme of ziti, we can then supply targets to the job which represent
an OpenZiti service.  We need to supply the <code>ziti-config</code> node with the path to the identity we want Prometheus to use to issue the
scrape. This will always be <code>/etc/prometheus/scrape.json</code> at this time. Should the community desire it, we can look into changing the
location of the identity.</p><p>If you would like to tail the <code>configmap-reloadz</code> container, you can issue this one liner. This will instruct <code>kubectl</code> to tail the logs
from <code>configmap-reloadz</code>. </p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pod=$(kubectl get pods | grep server | cut -d &quot; &quot; -f1); echo POD: $pod; kubectl logs -f &quot;$pod&quot; prometheus-server-configmap-reload</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>When the trigger happens for ClusterA you will see a message like the one below. Notice that <code>configmap-reloadz</code> is using the underlay
network: <code>http://127.0.0.1:9090/-/reload</code></p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2022/04/23 20:01:23 config map updated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/04/23 20:01:23 performing webhook request (1/1/http://127.0.0.1:9090/-/reload)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/04/23 20:01:23 successfully triggered reload</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="config-reloaded">Config Reloaded<a href="#config-reloaded" class="hash-link" aria-label="Direct link to Config Reloaded" title="Direct link to Config Reloaded">â</a></h3><p>Once you&#x27;ve correctly updated the configmap, and <code>configmap-reloadz</code> detected the change and told Prometheus to reload. You&#x27;ll see a new
target has been reported by Prometheus at <a href="http://kubea.prometheus.svc/targets" target="_blank" rel="noopener noreferrer">http://kubea.prometheus.svc/targets</a>. You should now see &quot;kubeA.reflectz (1/1 up)&quot; showing.
Congratulations! You have just successfully scraped a target from zitified Prometheus! Remember this workload does not listen on the
Kubernetes underlay network. It&#x27;s only accessible from the OpenZiti overlay. </p><p><img loading="lazy" alt="kubea.target1.png" src="/assets/images/kubea.target1-8f5a33a23d13709763eeff7c98afecf1.png" width="1055" height="197" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="lets-graph-it">Let&#x27;s Graph It!<a href="#lets-graph-it" class="hash-link" aria-label="Direct link to Let&#x27;s Graph It!" title="Direct link to Let&#x27;s Graph It!">â</a></h3><p>Cool, we have a target. The target can be scraped by Prometheus over the OpenZiti overlay. We&#x27;re also able to securely access the
Prometheus UI over the same OpenZiti overlay. Let&#x27;s use the Prometheus UI to graph the data point we want to see, the
<code>reflect_total_connections</code> metric. </p><ol><li>Navigate to <a href="http://kubea.prometheus.svc/graph" target="_blank" rel="noopener noreferrer">http://kubea.prometheus.svc/graph</a></li><li>enter <code>reflect_total_connections</code></li><li>click Graph (notice I changed my time to &#x27;10s&#x27;, located just under Graph)</li><li>click Execute</li><li>Notice there are no connections (0)</li></ol><p><img loading="lazy" alt="grpah it" src="/assets/images/kubea.graph-a39d9acca67d92b279c388dfda2fda53.png" width="1050" height="706" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="generate-some-data">Generate Some Data<a href="#generate-some-data" class="hash-link" aria-label="Direct link to Generate Some Data" title="Direct link to Generate Some Data">â</a></h3><p>Now let&#x27;s change that graph of <code>reflect_total_connections</code> from 0 to 1 (or more). One of the services you will have access to will
intercept <code>kubeA.reflect.svc.ziti:80</code>. </p><blockquote><p>[!NOTE]<!-- -->
If you are using Windows and Windows Subsystem for Linux (WSL) as I am, you <strong>might</strong> need to understand how get WSL to use your Ziti
Desktop Edge for Windows as your DNS resolver when inside WSL. Generally speaking this is as easy as editing /etc/resolv.conf and
adding the IP as the first nameserver: <code>nameserver 100.64.0.1</code> (or whatever the DNS IP is). Try it first, depending on how you setup
WSL it might &#x27;just work&#x27; for you. You can also just use cygwin or any other netcat tool from Windows (not WSL) too.</p></blockquote><p>Now we can use netcat to open a connection through this intercept a few times. The metric tracks the total number of connections to the
reflect service. Connect, send some text, the use ctrl-c to disconnect. Do that a few times then click &#x27;execute&#x27; again on the graph page.
You can see I did this over a minute and moved my total count on kubeA to 8, shown below.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/tmp/prometheus$ nc kubeA.reflect.svc.ziti 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeA reflect test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">you sent me: kubeA reflect test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">^C</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/tmp/prometheus$ nc kubeA.reflect.svc.ziti 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">another reflect test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">you sent me: another reflect test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">^C</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/tmp/prometheus$ nc kubeA.reflect.svc.ziti 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">another reflect test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">you sent me: another reflect test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">^C</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="kubea.more.total.conn.png" src="/assets/images/kubea.more.total.conn-056a41b592c79bd2b5efc64c4b45efbf.png" width="878" height="784" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="scrape-something-else">Scrape Something Else<a href="#scrape-something-else" class="hash-link" aria-label="Direct link to Scrape Something Else" title="Direct link to Scrape Something Else">â</a></h3><p>Hopefully you agree with me that this is pretty neat. Well what if we take it to the next level? What if we tried to scrape the
workload we deployed to ClusterB? Could we get that to work? Recall from above how we enabled the job named &#x27;kubeA.reflectz&#x27;. What if we
simply copied/pasted that into the configmap changing kubeA --&gt; kubeB. Would it work? Let&#x27;s see. </p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># edit the configmap on ClusterA:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl edit cm prometheuz-prometheus-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#add the job - and wait for the configmap to reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - job_name: &#x27;kubeB.reflectz&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      scrape_interval: 5s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      honor_labels: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      scheme: &#x27;ziti&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      params:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;match[]&#x27;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - &#x27;{job!=&quot;&quot;}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;ziti-config&#x27;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - &#x27;/etc/prometheus/scrape.json&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      static_configs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - targets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - &#x27;kubeB.reflect.scrape.svc-kubeB.reflect.id&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After watching the logs from <code>configmap-reloadz</code> on ClusterA and seeing the webhook trigger. Just go back to the Prometheus server in
the browser. You should be at the &#x27;graph&#x27; url but if not navigate back and execute another graph for <code>reflect_total_connections</code>. When
we do that it probably doesn&#x27;t look much different but... Wait a second? In the legend? Can it be? That&#x27;s right. From Kubernetes
ClusterA, we have just scraped a workload from Kubernetes ClusterB, entirely over the OpenZiti overlay.</p><p><img loading="lazy" alt="kubeA-and-kubeB.png" src="data:image/png;base64,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" width="581" height="73" class="img_ev3q"></p><p>Generate some data like you did before by running a few netcat connection/disconnects and click &#x27;Execute&#x27; again. Don&#x27;t forget to send
the connection request to kubeB though!</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nc kubeB.reflect.svc.ziti 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">this is kubeb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">you sent me: this is kubeb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">^C</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nc kubeB.reflect.svc.ziti 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">another to kube b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">you sent me: another to kube b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">^C</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nc kubeB.reflect.svc.ziti 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">one more for fun and profit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">you sent me: one more for fun and profit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">^C</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="kubeB from kubeA" src="/assets/images/kubeB-from-kubeA-0f78d64d83a2d8b02e25a72167d20de1.png" width="880" height="946" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="scraping-all-the-things">Scraping All the Things!<a href="#scraping-all-the-things" class="hash-link" aria-label="Direct link to Scraping All the Things!" title="Direct link to Scraping All the Things!">â</a></h2><p>By now, you are probably starting to get the idea just how powerful this is for Prometheus. A zitified Prometheus can scrape things
easily and natively by just deploying a <code>Prometheuz</code> instance into the location you want to scrape. Or, you can just enable a scrape
target using a tunneling app, or in Kubernetes using the <code>ziti-host</code> helm chart.  Let&#x27;s complete our vision now and stand up a
Prometheus server on our local workstation using Docker.</p><p>When we run <code>Prometheuz</code> locally using docker we&#x27;ll need a config file to give to docker using a volume mount. We also provide the
identity used to connect to the OpenZiti overlay in the same fashion. Let&#x27;s start up a docker container locally and see if we can grab
data from our two Prometheus instances using a locally deployed <code>Prometheuz</code> via docker.</p><p>GitHub has a sample Prometheus <a href="https://raw.githubusercontent.com/openziti/ziti-doc/main/docusaurus/blog/zitification/prometheus/scripts/local.prometheus.yml" target="_blank" rel="noopener noreferrer">file you can download</a>.
Below, I used curl to download it and put it into the expected location.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -s https://raw.githubusercontent.com/openziti/ziti-doc/main/docusaurus/blog/zitification/prometheus/scripts/local.prometheus.yml &gt; /tmp/prometheus/prometheus.config.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create identity user local.prometheus.id -o /tmp/prometheus/local.prometheus.id.jwt -a &quot;reflectz-clients&quot;,&quot;prometheus-clients&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge enroll /tmp/prometheus/local.prometheus.id.jwt -o /tmp/prometheus/local.prometheus.id.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker run \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -v /tmp/prometheus/local.prometheus.id.json:/etc/prometheus/ziti.id.json \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -v /tmp/prometheus/prometheus.config.yml:/etc/prometheus/prometheus.yml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -p 9090:9090 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  openziti/prometheuz</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="local-docker-targets.png" src="/assets/images/local-docker-targets-8dc1e23a53a77339ddc8926ac5d7327a.png" width="458" height="316" class="img_ev3q"></p><p>Look at what we&#x27;ve just done. We have started a Prometheus instance locally, and used it to connect to four Prometheus targets via
scrape configurations when all four targets are hidden entirely from my local computer (and any computer) unless the computer has an
OpenZiti identity. I personally think that is incredibly cool!</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="taking-it-to-11">Taking it to 11<a href="#taking-it-to-11" class="hash-link" aria-label="Direct link to Taking it to 11" title="Direct link to Taking it to 11">â</a></h2><p>But wait, I&#x27;m not done. That docker instance is listening on an underlay network. It&#x27;s exposed to attack by anything on my local network.
I want to fix that too. Let&#x27;s start this docker container up listening only on the OpenZiti overlay. Just like in <a href="/blog/zitification/prometheus/part2">part 2</a>
we will make a config, a service and two policies to enable identities on the OpenZiti overlay.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -s https://raw.githubusercontent.com/openziti/ziti-doc/main/docusaurus/blog/zitification/prometheus/scripts/local.prometheus.yml &gt; /tmp/prometheus/prometheus.config.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># create the config and service for the local prometheus server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config &quot;local.prometheus.svc-intercept.v1&quot; intercept.v1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;{&quot;protocols&quot;:[&quot;tcp&quot;],&quot;addresses&quot;:[&quot;local.prometheus.svc&quot;],&quot;portRanges&quot;:[{&quot;low&quot;:80, &quot;high&quot;:80}], &quot;dialOptions&quot;: {&quot;identity&quot;:&quot;local.prometheus.id&quot;}}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service &quot;local.prometheus.svc&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --configs &quot;local.prometheus.svc-intercept.v1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># grant the prometheus clients the ability to dial the service and the local.prometheus.id the ability to bind</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy &quot;local.prometheus.svc.dial&quot; Dial \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles &quot;@local.prometheus.svc&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --identity-roles &quot;#prometheus-clients&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy &quot;local.prometheus.svc.bind&quot; Bind \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles &quot;@local.prometheus.svc&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --identity-roles &quot;@local.prometheus.id&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Once that&#x27;s done - let&#x27;s see if we can start the docker container. The helm charts are configured to translate the <code>--set</code> flags
provided into &quot;container friendly&quot; settings like environment variables, volumes and mounts etc. In docker we need to provide those. If
you&#x27;re familiar with docker these will probably all make sense. The most important part of the command below is the <strong>lack</strong> of a <code>-p</code>
flag. The <code>-p</code> flag is used to expose a port from inside docker, outside docker. Look at the previous docker sample and you&#x27;ll find we
were mapping local underlay port 9090 to port 9090 in the docker container. In this example, <strong>we will do no such thing</strong>! :)</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">docker run \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -e ZITI_LISTENER_SERVICE_NAME=local.prometheus.svc \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -e ZITI_LISTENER_IDENTITY_FILE=/etc/prometheus/ziti.server.json \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -e ZITI_LISTENER_IDENTITY_NAME=local.prometheus.id \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -v /tmp/prometheus/prometheus.config.yml:/etc/prometheus/prometheus.yml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -v /tmp/prometheus/local.prometheus.id.json:/etc/prometheus/ziti.id.json \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -v /tmp/prometheus/local.prometheus.id.json:/etc/prometheus/ziti.server.json \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    openziti/prometheuz</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="but---does-it-work">But - Does It Work?<a href="#but---does-it-work" class="hash-link" aria-label="Direct link to But - Does It Work?" title="Direct link to But - Does It Work?">â</a></h3><p>After configuring the OpenZiti overlay, we just need to open a browser and navigate to <a href="http://local.prometheus.svc/targets" target="_blank" rel="noopener noreferrer">http://local.prometheus.svc/targets</a>. SUCCESS!</p><p><img loading="lazy" alt="local-docker-targets-no-listener.png" src="/assets/images/local-docker-targets-no-listener-c80c0b90432aa76d510ab4684613c0f2.png" width="495" height="405" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="success">SUCCESS!<a href="#success" class="hash-link" aria-label="Direct link to SUCCESS!" title="Direct link to SUCCESS!">â</a></h3><p><img loading="lazy" alt="local-docker-graph-no-listener.png" src="/assets/images/local-docker-graph-no-listener-bf6c6577b99852b0c9df5935da209c7b.png" width="891" height="953" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="wrap-up">Wrap Up<a href="#wrap-up" class="hash-link" aria-label="Direct link to Wrap Up" title="Direct link to Wrap Up">â</a></h2><p>This was quite the journey and a lot of fun. We have taken a wildly popular open source project and brought OpenZiti to it with really
not much code at all. Then using OpenZiti we were able to give Prometheus superpowers and enable it to scrape any target regardless of
where that target is or what network it is on. </p><p>Think of the possibilities here. Are you a cloud provider looking to monitor your client&#x27;s services which are deployed on-prem? That&#x27;s
so easy with OpenZiti and without sacrificing security <strong>at all</strong>. In fact, using OpenZiti like this provides amazing reach while
<strong>strengthening</strong> the security posture of the solution because you&#x27;re now using the concepts of
<a href="https://en.wikipedia.org/wiki/Zero_trust_security_model" target="_blank" rel="noopener noreferrer">zero trust networking principles</a> and applying them to your alerting and
monitoring solution.</p><p>What do you think? Was this series interesting? Do you think OpenZiti is cool and you are looking to try it out? What are you going to
zitify? Tell us on twitter or on discourse! Both links are included in this page. Let us know what you think! Go star the
<a href="http://github.com/openziti/ziti" target="_blank" rel="noopener noreferrer">openziti/ziti</a> repo and help us spread the word of OpenZiti to the world!</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/zitification/prometheus/part2"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Configuring OpenZiti to Enable Prometheus</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/zitification/zitifying-scp"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Zitifying SCP</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#the-payoff" class="table-of-contents__link toc-highlight">The Payoff</a></li><li><a href="#developer-access" class="table-of-contents__link toc-highlight">Developer Access</a></li><li><a href="#clustera" class="table-of-contents__link toc-highlight">ClusterA</a><ul><li><a href="#config-reloaded" class="table-of-contents__link toc-highlight">Config Reloaded</a></li><li><a href="#lets-graph-it" class="table-of-contents__link toc-highlight">Let&#39;s Graph It!</a></li><li><a href="#generate-some-data" class="table-of-contents__link toc-highlight">Generate Some Data</a></li><li><a href="#scrape-something-else" class="table-of-contents__link toc-highlight">Scrape Something Else</a></li></ul></li><li><a href="#scraping-all-the-things" class="table-of-contents__link toc-highlight">Scraping All the Things!</a></li><li><a href="#taking-it-to-11" class="table-of-contents__link toc-highlight">Taking it to 11</a><ul><li><a href="#but---does-it-work" class="table-of-contents__link toc-highlight">But - Does It Work?</a></li><li><a href="#success" class="table-of-contents__link toc-highlight">SUCCESS!</a></li></ul></li><li><a href="#wrap-up" class="table-of-contents__link toc-highlight">Wrap Up</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__links text--center"><div class="footer__links"><a class="footer__link-item" href="/policies/CODE_OF_CONDUCT">Policies</a><span class="footer__link-separator">Â·</span><a href="https://netfoundry.io/pricing/" target="_blank" rel="noopener noreferrer" class="footer__link-item">CloudZiti</a><span class="footer__link-separator">Â·</span><a href="https://blog.openziti.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog</a></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2023 NetFoundry Inc.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.323ab7b6.js"></script>
<script src="/assets/js/main.a545230f.js"></script>
</body>
</html>