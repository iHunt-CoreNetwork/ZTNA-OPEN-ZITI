<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">Golang Aha! Moments | OpenZiti</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://openziti.io/blog/golang-aha/article"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="robots" content="index, follow"><meta data-rh="true" property="og:title" content="Golang Aha! Moments | OpenZiti"><meta data-rh="true" name="description" content="Introduction"><meta data-rh="true" property="og:description" content="Introduction"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-11-03T15:23:27.000Z"><meta data-rh="true" property="article:author" content="https://github.com/plorenz"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://openziti.io/blog/golang-aha/article"><link data-rh="true" rel="alternate" href="https://openziti.io/blog/golang-aha/article" hreflang="en"><link data-rh="true" rel="alternate" href="https://openziti.io/blog/golang-aha/article" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://EXWPKK5PV4-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="OpenZiti RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="OpenZiti Atom Feed">


<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-THVRRJ3GLE"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-THVRRJ3GLE",{anonymize_ip:!0})</script>




<link rel="search" type="application/opensearchdescription+xml" title="OpenZiti" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.42970787.css">
<link rel="preload" href="/assets/js/runtime~main.c49952c9.js" as="script">
<link rel="preload" href="/assets/js/main.f2ddd13f.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="root_VOM9"><span style="color:whitesmoke">Star us on GitHubÂ </span><span style="height:20px"><span><a href="https://github.com/openziti/ziti" data-icon="octicon-star" data-show-count="true" aria-label="Star buttons/github-buttons on GitHub">Star</a></span></span></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://openziti.io" target="_self" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/img/ziti-logo-dark.svg" alt="The OpenZiti logo, an open source zero trust network overlay" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/ziti-logo-light.svg" alt="The OpenZiti logo, an open source zero trust network overlay" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/learn/introduction/">Documentation</a><a class="navbar__item navbar__link" href="/docs/downloads">Downloads</a><a href="https://blog.openziti.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Blog</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Links</a><ul class="dropdown__menu"><li><div class="text-divider"><p>Socials</p></div></li><li><a href="https://www.youtube.com/OpenZiti" target="_blank" title="OpenZiti on YouTube"><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/yt.svg">YouTube</span></a></li><li><a href="https://twitter.com/OpenZiti" target="_blank" title="OpenZiti on Twitter"><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/twit.svg">Twitter</span></a></li><li><a href="https://www.reddit.com/r/openziti" target="_blank" title="OpenZiti Subreddit"><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/reddit-logo.png">Reddit</span></a></li><li><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/ziggy.png"><a href="https://twitter.com/OpenZiggy" target="_blank" title="OpenZiggy on Twitter">Ziggy</a></span></li><li><div class="text-divider"><p>Other</p></div></li><li><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/blog-icon.png"><a href="https://blog.openziti.io/" target="_blank" title="Blog">Blog</a></span></li><li><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/oz-test-kitchen.png"><a href="https://github.com/openziti-test-kitchen" target="_blank" title="Git project for the test kitchen">Test Kitchen</a></span></li><li><a href="https://zeds.openziti.org" target="_blank" title="Developer Sandbox"><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/zeds.png">ZEDS</span></a></li><li><a href="https://netfoundry.io/pricing/" target="_blank" title="NetFoundry-hosted Ziti"><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/nf.svg">CloudZiti</span></a></li></ul></div><a href="https://openziti.discourse.group/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-discourse-link" title="Discourse"></a><a href="https://github.com/openziti/ziti" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" title="GitHub"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_eExm"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/articles">Articles</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/c-sdk-on-beaglebone">Building the Ziti C SDK and Sample Apps for arm (BeagleBone)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/bootstrapping-trust/part-01.encryption-everywhere">Bootstrapping Trust</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/bootstrapping-trust/part-02.a-primer-on-public-key-cryptography">Bootstrapping Trust</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/bootstrapping-trust/part-03.certificates">Bootstrapping Trust</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="Introduction"><header><h1 class="title_f1Hy" itemprop="headline">Golang Aha! Moments</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-11-03T15:23:27.000Z" itemprop="datePublished">November 3, 2023</time> Â· <!-- -->10 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/plorenz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/777993?v=4" alt="Paul Lorenz" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/plorenz" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Paul Lorenz</span></a></div><small class="avatar__subtitle" itemprop="description">OpenZiti Maintainer</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">â</a></h2><p>As we (the OpenZiti team) progressed on our Go journey, we&#x27;ve stumbled on various
obstacles, settled on some best practices and hopefully gotten better at writing Go
code. This document is meant to share some of the &#x27;Aha!&#x27; moments where we overcame
stumbling blocks and found solutions that sparked joy.
This is intended both for new team members and for anyone in the go community who
might be interested. We&#x27;d be very happy to hear from others about their own &#x27;aha&#x27;
moments and also how the solutions presented strike your sensibilities.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="channels">Channels<a href="#channels" class="hash-link" aria-label="Direct link to Channels" title="Direct link to Channels">â</a></h2><p>Channels are a core feature of go. As is typical of go, the channel API is small and
simple, but provides a lot of power. </p><p>If you haven&#x27;t read it yet, Dave Cheney&#x27;s <a href="https://dave.cheney.net/2014/03/19/channel-axioms" target="_blank" rel="noopener noreferrer">Channel Axioms</a>
is worth a look.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="closing-channels">Closing Channels<a href="#closing-channels" class="hash-link" aria-label="Direct link to Closing Channels" title="Direct link to Closing Channels">â</a></h2><p>Closing channels can be complicated. On the reader side things are generally uncomplicated.
A closed channel read will return immediately with the zero value and flag indicating that
it is closed.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func main() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ch := make(chan interface{}, 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ch &lt;- &quot;hello&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val, ok := &lt;- ch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fmt.Printf(&quot;%v, %v\n&quot;, val, ok) // prints hello, true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    close(ch)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val, ok = &lt;- ch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fmt.Printf(&quot;%v, %v\n&quot;, val, ok) // prints &lt;nil&gt;, false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>On the writer side, things can be more complicated. If you only have a single writer,
it can be responsible for closing the channel. This notifies any blocker readers that
the channel is closed. However, if there are multiple writers, this won&#x27;t work. Writing
to a closed channel will cause a panic. Closing an already closed channel will also
cause a panic. So, what do we do?</p><p>The main thing is to realize that we don&#x27;t have to close the channel. We only have to
make sure the readers and writers are safely notified that they should stop trying to
use the channel. For this, we can use a second channel.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;github.com/openziti/foundation/util/concurrenz&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;github.com/pkg/errors&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type Queue struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ch          chan int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    closeNotify chan struct{}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    closed      concurrenz.AtomicBoolean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *Queue) Push(val int) error {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    select {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case self.ch &lt;- val:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case &lt;-self.closeNotify:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return errors.New(&quot;queue closed&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *Queue) Pop() (int, error) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    select {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case val := &lt;-self.ch:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return val, nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case &lt;-self.closeNotify:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return 0, errors.New(&quot;queue closed&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *Queue) Close() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if self.closed.CompareAndSwap(false, true) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        close(self.closeNotify)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If there are several entities which all need to shutdown together, they can even
share a <code>closeNotify</code> channel.</p><p>A variation on this would let readers drain the channel once it&#x27;s closed. Because
select case evaluation is random, we may not read a val from the channel once
the close notify channel is closed. We can ensure that we return a value if it&#x27;s
available by modifying <code>Pop()</code> as follows:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func (self *Queue) Pop() (int, error) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    select {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case val := &lt;-self.ch:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return val, nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case &lt;-self.closeNotify:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        select {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case val := &lt;-self.ch:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return val, nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        default:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return 0, errors.New(&quot;queue closed&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Places used:</p><ul><li><a href="https://github.com/openziti/channel/blob/main/impl.go" target="_blank" rel="noopener noreferrer">https://github.com/openziti/channel/blob/main/impl.go</a> (see rxer, txer)</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="other-channel-uses">Other Channel Uses<a href="#other-channel-uses" class="hash-link" aria-label="Direct link to Other Channel Uses" title="Direct link to Other Channel Uses">â</a></h2><p>Let&#x27;s look at how we can use channels in a few other ways.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="semaphores-and-pools">Semaphores and Pools<a href="#semaphores-and-pools" class="hash-link" aria-label="Direct link to Semaphores and Pools" title="Direct link to Semaphores and Pools">â</a></h3><p>Because channels have a sized buffer and have well defined blocking behavior,
creating a semaphore implementation is very straightforward. We can create a
channel with a buffer of the size we want our semaphore to have. We can then
read and write from the channel to acquire and release the semaphore. </p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package concurrenz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import &quot;time&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type Semaphore interface {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Acquire()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AcquireWithTimeout(t time.Duration) bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TryAcquire() bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Release() bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func NewSemaphore(size int) Semaphore {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    result := &amp;semaphoreImpl{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        c: make(chan struct{}, size),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for result.Release() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type semaphoreImpl struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    c chan struct{}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *semaphoreImpl) Acquire() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;-self.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *semaphoreImpl) AcquireWithTimeout(t time.Duration) bool {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    select {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case &lt;-self.c:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case &lt;-time.After(t):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *semaphoreImpl) TryAcquire() bool {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    select {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case &lt;-self.c:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *semaphoreImpl) Release() bool {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    select {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case self.c &lt;- struct{}{}:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We could use mostly the same implementation for a resource pool. Instead of
a channel of struct{}, we could have a channel of connections or buffers
that are acquired and released.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="signal">Signal<a href="#signal" class="hash-link" aria-label="Direct link to Signal" title="Direct link to Signal">â</a></h3><p>We can use channels as signals. In this example we have something running
periodically, but we want to be able to trigger it to run sooner. With a
single element channel, we can notify a goroutine. By using <code>select</code> with
<code>default</code>, we can ensure that signalling code doesn&#x27;t block and that the
receiving side only gets a single signal per loop.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;fmt&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;github.com/openziti/foundation/util/concurrenz&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;time&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func NewWorker() *Worker {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    w := &amp;Worker{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        signal:  make(chan struct{}, 1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    go w.run()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type Worker struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    signal chan struct{}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stopped concurrenz.AtomicBoolean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *Worker) run() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ticker := time.NewTicker(time.Minute)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    defer ticker.Stop()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for !self.stopped.Get() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        select {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case &lt;-ticker.C:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.work()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case &lt;-self.signal:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.work()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *Worker) work() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if !self.stopped.Get() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fmt.Println(&quot;working hard&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *Worker) RunNow() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    select {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case self.signal &lt;- struct{}{}:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="channel-loops-and-event-handler">Channel Loops and Event Handler<a href="#channel-loops-and-event-handler" class="hash-link" aria-label="Direct link to Channel Loops and Event Handler" title="Direct link to Channel Loops and Event Handler">â</a></h3><p>We often have a loop which is processing inputs from one or channel. Often we have a set of data
we want to keep local to a single goroutine, so we don&#x27;t have to use any synchronization or worry
about cpu cache effects. We use channels to feed data to the goroutine and/or to trigger different
kinds of processing. A for with select loop can handle channels of different types. YOu can have
a channel per type of work, or per type of data. Sometimes it can be convenient to consolidate things
on a single channel, using an event API.</p><p>Here&#x27;s a simple example where the processor is maintaining some cached data which can be updated
externally. Presumably the processor would be doing something with the cached data, but we&#x27;ve left
that out to focus on the pattern itself.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type Event interface {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // events are passed the processor so they don&#x27;t each have to include it</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Handle(*Processor)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type Processor struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ch          chan Event</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    closeNotify chan struct{}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cache map[string]string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *Processor) run() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        select {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case event := &lt;-self.ch:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            event.Handle(self)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case &lt;-self.closeNotify:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *Processor) queueEvent(evt Event) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    select {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case self.ch &lt;- evt:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case &lt;-self.closeNotify:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *Processor) UpdateCache(k, v string) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self.queueEvent(&amp;updateCache{key: k, value: v})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *Processor) Invalidate(k string) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self.queueEvent(invalidate(k))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type updateCache struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    key string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    value string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *updateCache) Handle(p *Processor) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    p.cache[self.key] = self.value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type invalidate string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self invalidate) Handle(p *Processor) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    delete(p.cache, string(self))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="type-aliases">Type Aliases<a href="#type-aliases" class="hash-link" aria-label="Direct link to Type Aliases" title="Direct link to Type Aliases">â</a></h2><p>As we demonstrated in the previous example we can alias a type and add functions to it, usually
to satisfy some interface.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type invalidate string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self invalidate) Handle(p *Processor) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        delete(p.cache, string(self))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This can be useful if we only have a single piece of data. Rather than wrapping it in a struct,
we can just alias it and add our own funcs. </p><p>The main downside to this approach is that you have to unalias the data inside your functions
which can lead to code that is less clear. See for example this method from an <code>AtomicBoolean</code>
implementation:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type AtomicBoolean int32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (ab *AtomicBoolean) Set(val bool) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    atomic.StoreInt32((*int32)(ab), boolToInt(val))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="function-type-aliases">Function Type Aliases<a href="#function-type-aliases" class="hash-link" aria-label="Direct link to Function Type Aliases" title="Direct link to Function Type Aliases">â</a></h3><p>A go feature which can surprise developers is the ability to add function definitions to funcs.
The Event API in the Processor example above could be extended as follows:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type Event interface {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Handle(*Processor)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type EventF func(*Processor)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self EventF) Handle(p *Processor) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self(p)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <code>Invalidate</code> code could now be written as:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func (self *Processor) Invalidate(k string) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self.queueEvent(EventF(func(processor *Processor) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        delete(processor.cache, k)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The need for an <code>EventF</code> cast could be removed by adding a helper function.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func (self *Processor) queueEventF(evt EventF) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self.queueEvent(evt)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *Processor) UpdateCache(k, v string) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self.queueEventF(func(processor *Processor) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        processor.cache[k] = v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>I first encountered this style in the go http library where handlers can be defined
as structs implementing <code>Handler</code> or as functions matching <code>HandlerFunc</code>. This is
most useful when you may have both heavy implementations which carry a lot of state
as well as very simple implementations which make more sense as a function.</p><p>The processor event channel could also be implemented in terms of pure functions, if
all event implementations are lightweight.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="interfaces">Interfaces<a href="#interfaces" class="hash-link" aria-label="Direct link to Interfaces" title="Direct link to Interfaces">â</a></h2><p>A golang limitation that often trips people up is that packages cannot have circular
dependencies. There are a few ways to work around this, but the most common is to
introduce interfaces in the more independent of the packages.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="errors">Errors<a href="#errors" class="hash-link" aria-label="Direct link to Errors" title="Direct link to Errors">â</a></h2><p>In some situations, go&#x27;s error handling can be excessively verbose. Especially in
cases where you&#x27;re doing a series of I/O operations, your code can look something
like:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func WriteExample(w io.Writer) error {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if _, err := w.Write([]byte(&quot;one&quot;)); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if _, err := w.Write([]byte(&quot;two&quot;)); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if _, err := w.Write([]byte(&quot;three&quot;)); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if _, err := w.Write([]byte(&quot;four&quot;)); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>One way to clean this up is to wrap the error in the operation and only check it at
the end.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type WriterErr struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    err error</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    w io.Writer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *WriterErr) Write(s string) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if self.err == nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _, self.err = self.w.Write([]byte(s))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *WriterErr) Error() error {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return self.err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func WriteExample2(w io.Writer) error {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    writer := &amp;WriterErr{w: w}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    writer.Write(&quot;one&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    writer.Write(&quot;two&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    writer.Write(&quot;three&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    writer.Write(&quot;four&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return writer.Error()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>See also: </p><ul><li><a href="https://go.dev/blog/errors-are-values" target="_blank" rel="noopener noreferrer">https://go.dev/blog/errors-are-values</a></li><li><a href="https://dave.cheney.net/2019/01/27/eliminate-error-handling-by-eliminating-errors" target="_blank" rel="noopener noreferrer">https://dave.cheney.net/2019/01/27/eliminate-error-handling-by-eliminating-errors</a></li></ul><p>Note: This pattern is could be viewed as an error monad implementation</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="gotchas">Gotchas<a href="#gotchas" class="hash-link" aria-label="Direct link to Gotchas" title="Direct link to Gotchas">â</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="loop-variables">Loop Variables<sup id="fnref-cam-a1cd95"><a href="#fn-cam-a1cd95" class="footnote-ref">cam</a></sup><a href="#loop-variables" class="hash-link" aria-label="Direct link to loop-variables" title="Direct link to loop-variables">â</a></h3><p>Like many other languages, it&#x27;s possible to get into trouble when capturing loop variables,
both via pointer references and via closures.</p><p>The following snippet will print out <code>world world</code> since the loop variable
remains constant throughout loop iteration.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func main() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var list []*string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for _, v := range []string {&quot;hello&quot;, &quot;world&quot;} {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        list = append(list, &amp;v)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for _, v := range list {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fmt.Printf(&quot;%v &quot;, *v)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fmt.Println()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Similarly, the following will output <code>second second</code>:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func main() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for _, v := range []string {&quot;first&quot;, &quot;second&quot;} {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        go func() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            time.Sleep(100 * time.Millisecond)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            fmt.Printf(&quot;%v &quot;, v)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    time.Sleep(200 *time.Millisecond)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fmt.Println()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="common-deadlock-causes">Common Deadlock Causes<a href="#common-deadlock-causes" class="hash-link" aria-label="Direct link to Common Deadlock Causes" title="Direct link to Common Deadlock Causes">â</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="non-reentrant-mutexes">Non-reentrant Mutexes<a href="#non-reentrant-mutexes" class="hash-link" aria-label="Direct link to Non-reentrant Mutexes" title="Direct link to Non-reentrant Mutexes">â</a></h4><p>Unlike in some other languages, the mutexes provide in the sync package are non-reentrant. So if your code
grabs a lock and ends up calling back into something which gets the same lock, the goroutine will deadlock.
Typically, if you have to call back in, you&#x27;d either need an indicator that the lock is already acquired,
or do the work in a new go-routine, depending on how independent the second access was.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="channel-deadlocks">Channel Deadlocks<a href="#channel-deadlocks" class="hash-link" aria-label="Direct link to Channel Deadlocks" title="Direct link to Channel Deadlocks">â</a></h4><p>If you have a goroutine processing events from a channel, if the event submits an event back onto the channel,
that can cause a deadlock, if the channel is not buffered, or if the buffer is full.</p><p>Fixes include:</p><ul><li>Running the next event in-line, if you can detect that you&#x27;re already in the event processing context</li><li>Ensure the channel is buffer is big enough that it will never block</li><li>Handing the new event submission off to a new go-routine</li></ul><p>One benefit to keeping your channel buffers at zero, is that you will detect these deadlocks very quickly.
If you have a small buffer, then the deadlock may not be caught until the system is under load.</p><div class="footnotes"><hr><ol><li id="fn-cam-a1cd95">Suggested by Cameron Otts<a href="#fnref-cam-a1cd95" class="footnote-backref">â©</a></li></ol></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/wildcard-dns/cheatsheet"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Wildcard DNS Cheatsheet</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/zitification"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Zitification</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#channels" class="table-of-contents__link toc-highlight">Channels</a></li><li><a href="#closing-channels" class="table-of-contents__link toc-highlight">Closing Channels</a></li><li><a href="#other-channel-uses" class="table-of-contents__link toc-highlight">Other Channel Uses</a><ul><li><a href="#semaphores-and-pools" class="table-of-contents__link toc-highlight">Semaphores and Pools</a></li><li><a href="#signal" class="table-of-contents__link toc-highlight">Signal</a></li><li><a href="#channel-loops-and-event-handler" class="table-of-contents__link toc-highlight">Channel Loops and Event Handler</a></li></ul></li><li><a href="#type-aliases" class="table-of-contents__link toc-highlight">Type Aliases</a><ul><li><a href="#function-type-aliases" class="table-of-contents__link toc-highlight">Function Type Aliases</a></li></ul></li><li><a href="#interfaces" class="table-of-contents__link toc-highlight">Interfaces</a></li><li><a href="#errors" class="table-of-contents__link toc-highlight">Errors</a></li><li><a href="#gotchas" class="table-of-contents__link toc-highlight">Gotchas</a><ul><li><a href="#loop-variables" class="table-of-contents__link toc-highlight">Loop Variables</a></li><li><a href="#common-deadlock-causes" class="table-of-contents__link toc-highlight">Common Deadlock Causes</a></li></ul></li></ul></div></div></div></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__links text--center"><div class="footer__links"><a class="footer__link-item" href="/policies/CODE_OF_CONDUCT">Policies</a><span class="footer__link-separator">Â·</span><a href="https://netfoundry.io/pricing/" target="_blank" rel="noopener noreferrer" class="footer__link-item">CloudZiti</a><span class="footer__link-separator">Â·</span><a href="https://blog.openziti.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog</a></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2023 NetFoundry Inc.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.c49952c9.js"></script>
<script src="/assets/js/main.f2ddd13f.js"></script>
</body>
</html>