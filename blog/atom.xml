<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://openziti.io/blog</id>
    <title>OpenZiti Blog</title>
    <updated>2023-10-14T16:50:51.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://openziti.io/blog"/>
    <subtitle>OpenZiti Blog</subtitle>
    <icon>https://openziti.io/img/favicon.ico</icon>
    <entry>
        <title type="html"><![CDATA[Articles]]></title>
        <id>https://openziti.io/blog/articles</id>
        <link href="https://openziti.io/blog/articles"/>
        <updated>2023-10-14T16:50:51.000Z</updated>
        <summary type="html"><![CDATA[Here you'll find articles that cover various topics related to developing]]></summary>
        <content type="html"><![CDATA[<p>Here you'll find articles that cover various topics related to developing
applications with Ziti.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="topics">Topics<a href="#topics" class="hash-link" aria-label="Direct link to Topics" title="Direct link to Topics">​</a></h2><ul><li><a href="/blog/c-sdk-on-beaglebone">Ziti Up and Running on BeagleBone</a></li><li><a href="/blog/bootstrapping-trust/part-01.encryption-everywhere">Bootstrapping Trust</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="zitifications"><a href="/blog/zitification">Zitifications</a><a href="#zitifications" class="hash-link" aria-label="Direct link to zitifications" title="Direct link to zitifications">​</a></h2><p>A Zitification is any open-source project that has been modified to use the OpenZiti Edge SDK for client or server connectivity, or both. Zitified apps are bound to an identity instead of an address.</p><ul><li><a href="/blog/zitification/prometheus/part1">Prometheus</a></li><li><a href="/blog/zitification/kubernetes">Kubernetes</a></li><li><a href="/blog/zitification/zitifying-ssh"><strong>SSH</strong></a></li><li><a href="/blog/zitification/zitifying-scp"><strong>SCP</strong></a></li></ul>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Building the Ziti C SDK and Sample Apps for arm (BeagleBone)]]></title>
        <id>https://openziti.io/blog/c-sdk-on-beaglebone</id>
        <link href="https://openziti.io/blog/c-sdk-on-beaglebone"/>
        <updated>2023-10-14T16:50:51.000Z</updated>
        <summary type="html"><![CDATA[This article walks you through building the Ziti C SDK for Linux-arm and running]]></summary>
        <content type="html"><![CDATA[<p>This article walks you through building the Ziti C SDK for Linux-arm and running
the wttr sample application on a <a href="https://beagleboard.org/enhanced" target="_blank" rel="noopener noreferrer">BeagleBone SanCloud</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="configure-the-host-system">Configure the Host System<a href="#configure-the-host-system" class="hash-link" aria-label="Direct link to Configure the Host System" title="Direct link to Configure the Host System">​</a></h2><p>This article uses an Ubuntu 19.10 virtual machine as a development host because it's
relatively easy to install a functional toolchain that targets arm-linux.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">devbox$ sudo apt-get install gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    binutils-arm-linux-gnueabihf gdb-multiarch cmake git</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="build-the-sdk-and-sample-applications">Build the SDK and Sample Applications<a href="#build-the-sdk-and-sample-applications" class="hash-link" aria-label="Direct link to Build the SDK and Sample Applications" title="Direct link to Build the SDK and Sample Applications">​</a></h2><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">devbox$ git clone --recurse-submodules https://github.com/netfoundry/ziti-sdk-c.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Cloning into 'ziti-sdk-c'...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">remote: Enumerating objects: 77, done.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">remote: Counting objects: 100% (77/77), done.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">remote: Compressing objects: 100% (50/50), done.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">remote: Total 1287 (delta 35), reused 51 (delta 24), pack-reused 1210</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Receiving objects: 100% (1287/1287), 475.44 KiB | 4.85 MiB/s, done.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">devbox$ cd ziti-sdk-c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">devbox$ mkdir build-Linux-arm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">devbox$ cd build-Linux-arm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">devbox$ cmake -DCMAKE_TOOLCHAIN_FILE=../toolchains/Linux-arm.cmake ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">project version: 0.9.2.1 (derived from git)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- The C compiler identification is GNU 9.2.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- The CXX compiler identification is GNU 9.2.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- Check for working C compiler: /usr/bin/arm-linux-gnueabihf-gcc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ make</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  1%] Building C object deps/uv-mbed/deps/libuv/CMakeFiles/uv_a.dir/src/fs-poll.c.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  1%] Building C object deps/uv-mbed/deps/libuv/CMakeFiles/uv_a.dir/src/idna.c.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  2%] Building C object deps/uv-mbed/deps/libuv/CMakeFiles/uv_a.dir/src/inet.c.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  2%] Building C object deps/uv-mbed/deps/libuv/CMakeFiles/uv_a.dir/src/random.c.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[ 99%] Building C object programs/sample_wttr/CMakeFiles/sample_wttr.dir/sample_wttr.c.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[ 99%] Linking C executable sample_wttr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[ 99%] Built target sample_wttr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[100%] Built target sample-host</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>When <code>make</code> completes, you'll have statically linked binaries for the SDK's sample applications.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="set-up-a-ziti-network">Set up a Ziti Network<a href="#set-up-a-ziti-network" class="hash-link" aria-label="Direct link to Set up a Ziti Network" title="Direct link to Set up a Ziti Network">​</a></h2><p>For this article we'll use a Ziti Edge Developer Edition to run our network. Follow
the <a href="/docs/learn/quickstarts/network/">Ziti Network Quickstart</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-the-demo-weather-service">Create the "demo-weather" Service<a href="#create-the-demo-weather-service" class="hash-link" aria-label="Direct link to Create the &quot;demo-weather&quot; Service" title="Direct link to Create the &quot;demo-weather&quot; Service">​</a></h3><p>The sample_wttr application accesses a service named "demo-weather", so we'll create
that service now. Log in to your Ziti Edge Developer Edition web UI and follow the
steps:</p><ol><li>On the left side nav bar, click "Edge Services"</li><li>In the top right corner of the screen click the "plus" image to add a new service</li><li>Choose a name for the service. Enter "demo-weather"</li><li>Choose Router "ziti-gw01"</li><li>For Endpoint Service choose:<ul><li>protocol = tcp</li><li>host = wttr.in</li><li>port = 80</li></ul></li><li>Click save</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="upload-the-artifacts-to-your-beaglebone">Upload the Artifacts to Your BeagleBone<a href="#upload-the-artifacts-to-your-beaglebone" class="hash-link" aria-label="Direct link to Upload the Artifacts to Your BeagleBone" title="Direct link to Upload the Artifacts to Your BeagleBone">​</a></h2><p>At this point we have created all of the artifacts that are needed for running the
sample application:</p><ul><li>The "sample_wttr" executable</li><li>The Ziti identity json file (e.g. "NewUser.json")</li></ul><p>Now we need to upload these artifacts to the BeagleBone. The scp command shown here
assumes that:</p><ul><li>You are in the <code>build-Linux-arm</code> subdirectory where the <code>make</code> command was executed above.</li><li>Your BeagleBone is running sshd and has an IP address of 192.168.2.2 which
can be reached from your development host</li><li>The Ziti identity json file that was created when you followed the Ziti Network Quickstart
was downloaded to your ~/Downloads directory.</li></ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">devbox$ scp ./programs/sample_wttr/sample_wttr root@192.168.2.2:.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ scp ~/Downloads/NewUser.json ./programs/sample_wttr/sample_wttr debian@192.168.2.2:.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NewUser.json                                  100% 6204     2.5MB/s   00:00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sample_wttr                                   100% 2434KB   5.4MB/s   00:00</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="run-the-application">Run the Application<a href="#run-the-application" class="hash-link" aria-label="Direct link to Run the Application" title="Direct link to Run the Application">​</a></h2><p>Now we're ready to log into the BeagleBone and run the sample application.
Let's go!</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ubuntu@beaglebone:~$ ./sample_wttr ./NewUser.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[        0.000] INFO    library/ziti.c:173 NF_init(): ZitiSDK version 0.9.2.1-local @de37e6f(wttr-sample-shutdown-cleanup) starting at (2019-09-05T22:35:12.259)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[        0.000] INFO    library/ziti.c:195 NF_init_with_tls(): ZitiSDK version 0.9.2.1-local @de37e6f(wttr-sample-shutdown-cleanup)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/home/scarey/repos/github.com/netfoundry/ziti-sdk-c/deps/uv-mbed/src/http.c:315 ERR TLS handshake error </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/home/scarey/repos/github.com/netfoundry/ziti-sdk-c/deps/uv-mbed/src/http.c:153 WARN received -103 (software caused connection abort)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[        0.210] ERROR   library/ziti.c:433 version_cb(): failed to get controller version from ec2-54-164-120-24.compute-1.amazonaws.com:1280 CONTROLLER_UNAVAILABLE(software caused connection abort)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[        0.210] WARN    library/ziti_ctrl.c:49 code_to_error(): unmapped error code: CONTROLLER_UNAVAILABLE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[        0.210] ERROR   library/ziti.c:419 session_cb(): failed to login: CONTROLLER_UNAVAILABLE[-11](software caused connection abort)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ERROR: status =&gt; WTF: programming error</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ubuntu@beaglebone:~# </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Oops. Actually The Ziti SDK verifies the certificate from the Ziti Edge Controller,
so we need to set the clock on the BeagleBone to a time/date that is within the
valid range of the certificate. Might as well set the clock to the current time:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ubuntu@beaglebone:~# sudo rdate time.nist.gov</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Wed Mar 18 15:46:56 2020</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And <em>now</em> we are ready to run the application:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ubuntu@beaglebone:~$ ./sample_wttr ./NewUser.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[        0.000] INFO    library/ziti.c:173 NF_init(): ZitiSDK version 0.9.2.1-local @de37e6f(wttr-sample-shutdown-cleanup) starting at (2020-03-18T15:46:57.536)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[        0.000] INFO    library/ziti.c:195 NF_init_with_tls(): ZitiSDK version 0.9.2.1-local @de37e6f(wttr-sample-shutdown-cleanup)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[        0.554] INFO    library/ziti.c:438 version_cb(): connected to controller ec2-54-164-120-24.compute-1.amazonaws.com:1280 version v0.9.0(ea556fc18740 2020-02-11 16:09:08)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[        0.696] INFO    library/connect.c:180 connect_get_service_cb(): got service[demo-weather] id[cc90410f-1017-4d23-977a-3695cb58f4e8]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[        0.810] INFO    library/connect.c:209 connect_get_net_session_cb(): got session[d89bfdd8-c7e5-42ff-a39f-63056eeb3a82] for service[demo-weather]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[        0.810] INFO    library/channel.c:148 ziti_channel_connect(): opening new channel for ingress[tls://ec2-54-164-120-24.compute-1.amazonaws.com:3022] ch[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sending HTTP request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">request success: 99 bytes sent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HTTP/1.1 200 OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Server: nginx/1.10.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Date: Wed, 18 Mar 2020 15:47:00 GMT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Type: text/plain; charset=utf-8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Length: 8662</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connection: close</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Weather report: Rochester</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     \   /     Sunny</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .-.      39 °F          </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ― (   ) ―   ↖ 0 mph        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      `-’      9 mi           </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     /   \     0.0 in         </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                       ┌─────────────┐                                                       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────┬───────────────────────┤  Wed 18 Mar ├───────────────────────┬──────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│            Morning           │             Noon      └──────┬──────┘     Evening           │             Night            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────┼──────────────────────────────┼──────────────────────────────┼──────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│               Overcast       │               Overcast       │               Cloudy         │               Overcast       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      .--.     32..35 °F      │      .--.     35..41 °F      │      .--.     39..44 °F      │      .--.     37..42 °F      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   .-(    ).   ↖ 3-4 mph      │   .-(    ).   ← 6-8 mph      │   .-(    ).   ← 9-16 mph     │   .-(    ).   ↖ 9-17 mph     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  (___.__)__)  6 mi           │  (___.__)__)  6 mi           │  (___.__)__)  6 mi           │  (___.__)__)  6 mi           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│               0.0 in | 0%    │               0.0 in | 0%    │               0.0 in | 0%    │               0.0 in | 0%    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────┴──────────────────────────────┴──────────────────────────────┴──────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                       ┌─────────────┐                                                       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────┬───────────────────────┤  Thu 19 Mar ├───────────────────────┬──────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│            Morning           │             Noon      └──────┬──────┘     Evening           │             Night            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────┼──────────────────────────────┼──────────────────────────────┼──────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    \  /       Partly cloudy  │               Cloudy         │    \  /       Partly cloudy  │  _`/"".-.     Patchy light d…│</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  _ /"".-.     41..44 °F      │      .--.     50 °F          │  _ /"".-.     53..55 °F      │   ,\_(   ).   50..53 °F      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    \_(   ).   ← 4-7 mph      │   .-(    ).   ← 4-6 mph      │    \_(   ).   ↖ 6-11 mph     │    /(___(__)  ↖ 10-19 mph    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    /(___(__)  3 mi           │  (___.__)__)  6 mi           │    /(___(__)  6 mi           │      ‘ ‘ ‘ ‘  4 mi           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│               0.0 in | 0%    │               0.0 in | 0%    │               0.0 in | 0%    │     ‘ ‘ ‘ ‘   0.0 in | 20%   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────┴──────────────────────────────┴──────────────────────────────┴──────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                       ┌─────────────┐                                                       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────┬───────────────────────┤  Fri 20 Mar ├───────────────────────┬──────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│            Morning           │             Noon      └──────┬──────┘     Evening           │             Night            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────┼──────────────────────────────┼──────────────────────────────┼──────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  _`/"".-.     Light rain sho…│    \  /       Partly cloudy  │    \  /       Partly cloudy  │               Cloudy         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ,\_(   ).   62 °F          │  _ /"".-.     66 °F          │  _ /"".-.     48..51 °F      │      .--.     46 °F          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    /(___(__)  ↑ 14-27 mph    │    \_(   ).   ↗ 26-41 mph    │    \_(   ).   → 24-36 mph    │   .-(    ).   → 22-30 mph    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      ‘ ‘ ‘ ‘  6 mi           │    /(___(__)  6 mi           │    /(___(__)  6 mi           │  (___.__)__)  6 mi           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     ‘ ‘ ‘ ‘   0.0 in | 29%   │               0.0 in | 59%   │               0.0 in | 41%   │               0.0 in | 0%    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────┴──────────────────────────────┴──────────────────────────────┴──────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Location: Rochester, Monroe County, New York, United States of America [43.157285,-77.6152139]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Follow @igor_chubin for wttr.in updates</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">request completed: Connection closed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[        3.714] INFO    library/ziti.c:238 NF_shutdown(): Ziti is shutting down</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">========================</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Bootstrapping Trust]]></title>
        <id>https://openziti.io/blog/bootstrapping-trust/part-01.encryption-everywhere</id>
        <link href="https://openziti.io/blog/bootstrapping-trust/part-01.encryption-everywhere"/>
        <updated>2023-10-14T16:50:51.000Z</updated>
        <summary type="html"><![CDATA[Part 1: Encryption Everywhere]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="part-1-encryption-everywhere">Part 1: Encryption Everywhere<a href="#part-1-encryption-everywhere" class="hash-link" aria-label="Direct link to Part 1: Encryption Everywhere" title="Direct link to Part 1: Encryption Everywhere">​</a></h2><p>Whether you are an encryption expert or a newcomer, welcome! This series
is for you! It assumes you know nothing and takes you from soup to nuts
on how to bootstrap trust with the intent to power a Zero Trust security
model. The process and thinking described in this series are the direct
output of developing the same system for the Ziti open source project.
Ziti can be found on the GitHub project page for
<a href="https://github.com/openziti" target="_blank" rel="noopener noreferrer">OpenZiti</a>. The series starts with the
basics and dovetails into Ziti's Enrollment system.</p><p>The parts are as follows.</p><ul><li><a href="/blog/bootstrapping-trust/part-01.encryption-everywhere">Part 1: Encryption Everywhere</a></li><li><a href="/blog/bootstrapping-trust/part-02.a-primer-on-public-key-cryptography">Part 2: A Primer On Public-Key Cryptography</a></li><li><a href="/blog/bootstrapping-trust/part-03.certificates">Part 3: Certificates</a></li><li><a href="/blog/bootstrapping-trust/part-04.certificate-authorities-and-chains-of-trust">Part 4: Certificate Authorities &amp; Chains Of Trust</a></li><li><a href="/blog/bootstrapping-trust/part-05.bootstrapping-trust">Part 5: Bootstrapping Trust</a></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="zero-trust">Zero Trust<a href="#zero-trust" class="hash-link" aria-label="Direct link to Zero Trust" title="Direct link to Zero Trust">​</a></h3><p>This entire series assumes some familiarity with Zero Trust. If you do
not have a strong background in it, that is fine. This section should
give the reader enough context to make use of the entire series. If a
more in-depth understanding is desired, please consider reading <em>Zero
Trust Networks: Building Secure Systems in Untrusted Networks</em> by Evan
Gilman.</p><p>Zero Trust is a security model that requires strict identity
authentication and access verification on every connection at all times.
It sets the tone for a system's security to say, "this system shall
never assume the identity or access of any connection." Before the Zero
Trust security models, IT infrastructures were set up as a series of
security perimeters. Think of as a castle with walls and moats. The
castle would have a set number of entry points with guards. Once past
the guards and inside the castle, any visitors were trusted and had
access to the castle. In the real world, passing the guards is analogous
to authenticating with a machine or, at worst, connect the office
network via WiFi or ethernet cable.</p><p>Zero Trust does away with the concept of having a central castle that
assumes anyone inside is trusted. It assumes that the castle has already
been breached. That is to say, we expect attackers to already be inside
the network and for it to be a hostile environment. Any resources inside
the network should be treated as being publicly available on the
internet and must be defended. To accomplish this defense, a series of
Zero Trust pillars are defined:</p><ul><li>Never Trust, Verify - the virtue of a connection should not grant
access</li><li>Authenticate Before Connect - authentication should happen before
resources are connected to</li><li>Least Privileged Access - access should only grant connectivity to the
minimum number of resources</li></ul><p>Implementing those pillars is not a simple tweak to existing
infrastructure. The first point alone will have much of this series
dedicated to it.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ziti--zero-trust">Ziti &amp; Zero Trust<a href="#ziti--zero-trust" class="hash-link" aria-label="Direct link to Ziti &amp; Zero Trust" title="Direct link to Ziti &amp; Zero Trust">​</a></h3><p>In a Zero Trust model, there needs to exist mechanisms to verify
identities such that trust can be granted. Zero Trust does not mean
there is no trust. Zero Trust means that trust is given only after
verification. Even then, that trust is limited to accessing the minimum
network resources necessary. To accomplish this, we need a network that
can force all connections through the following process.</p><ol><li>Authenticate</li><li>Request Access To A Resource</li><li>Connect To The Requested Resource</li></ol><p>This process is not the typical connection order on a network. Most
connections on a network are done in the reverse order. At first, this
may seem counter-intuitive. To help make Zero Trust and bootstrapping
trust a bit clearer, it helps to have a concrete system to use an
example. It just so happens that the Ziti software system makes a great
example!</p><p><img loading="lazy" alt="Ziti System" src="/assets/images/ziti-system-c36f11d4eaa20132bc62e5b899b00d2f.png" width="2910" height="479" class="img_ev3q"></p><p>In Ziti, all of the above steps require interacting with a Ziti
Controller. The Ziti Controller manages the Ziti overlay network by
maintaining a list of known network services, SDK clients, routers,
enrollments, policies, and much more! All of these pieces working
together to create a Ziti Network. A Ziti Network is an overlay network
<!-- -->-<!-- --> meaning it creates a virtual network on top of a concrete network.
The concrete network may be the internet, a university network, or your
own home network. Whatever it is, it is referred to as the underlay
network.</p><p>In the Ziti Network, all network resources are modeled as services in
the Ziti Controller. All services on a Ziti Network should only be
accessible via the Ziti Network for maximum effect. Network services can
be made available via a Ziti Network in a variety of manners. The
preferred method is embedding the Ziti SDK inside of applications and
servers as it provides the highest degree of Zero Trust security.
However, it is also possible to configure various overlay-to-underlay
connections to existing network services via "router termination" or a
particular type of application with the Ziti SDK embedded in it that
specifically deals with underlay-to-overlay translations (i.e. Ziti
Desktop Edge/Mobile Edge).</p><p>The Ziti Controller also knows about one or more Ziti Routers that form
a mesh network that can create dynamic circuits amongst themselves.
Routers use circuits to move data across the Ziti Network. Routers can
be configured to allow data to enter and exit the mesh. The most common
entry/exit points are Ziti SDKs acting as clients or servers.</p><p>Network clients wishing to attach to the network use the Ziti SDK to
first authenticate with the Ziti Controller. During authentication, the
Ziti SDK client and Ziti Controller will verify each other. Upon
successful authentication, the Ziti Controller can provide a list of
available services to dial (connect) or to bind (host) for the
authenticated SDK Client. The client can then request to dial or bind a
service. If fulfilled, a session is associated with the client and
service. This new session is propagated to the necessary Ziti Routers,
and the required circuits are created. The client is returned a list of
Ziti Routers which can be connected to in order to complete the last
mile of communication between the Ziti overlay network and the SDK
client.</p><p>This set of steps covers the pillars of the Zero Trust model! The Ziti
Controller and SDK Clients verify each other. The client cannot connect
to network resources or services until it authenticates. After
authentication, a client is given the least privilege access allowed by
only being told about and only being able to dial/bind the authenticated
identity's assigned services. It is a Zero Trust overlay network!</p><p>How did this system come into existence? How do the Ziti SDK client and
Ziti Controller verify each other? How do the routers and controller
know to validate each other? How is this managed at scale with hundreds
of Ziti Routers and thousands of Ziti SDK clients? It seems that this is
a recursive problem. To terminate the recursion, we have to start our
system with a well-defined and carefully controlled seed of trust.</p><h1>Trust</h1><p>In software systems that require network connectivity, there are at
least two parties in the system. Generally, there are more, and in the
case of a Ziti network, there could be thousands. Between two parties,
each time a connection is made, a trust decision is made. Should this
connection be allowed? Mechanisms must be put into place to verify the
identity of the connecting party if that question is to be answered.</p><p>One mechanism that might jump out at the reader is a password or secret.
In Ziti, it would be possible to configure the Controller, Routers, and
SDK Clients with a secret. Software is easy to deploy with a secret.
Throw it into a configuration file, point the software at, and off you
go!</p><p>It is also fundamentally weak as there is only one secret in the system
necessary to compromise the entire system. In Ziti, this would mean
giving the secret to network clients that may or may not be owned by the
network operator. Also, shared secrets do not individually identify each
component, nor do they define how secrets will power other security
concerns, like encryption.</p><p>The solution can be improved. Secrets could be generated per software
component. The controller, each router, and each SDK client could have a
unique secret. This secret would then individually identity each
component! It is a significant improvement, but how does each component
verify connections? Do they challenge for the incoming connections
secret and compare it to a list? That means that a pair of systems that
need to connect must have each other's secrets. Secret sharing will not
do! We can not be copying secrets between every machine. One machine
that is compromised would mean that many secrets are revealed!</p><p>This solution can be evolved and improved, but we do not have to do that
hard work! If we did, we would end up recreating an existing technology.
That technology is (public-key
cryptography)<!-- -->[https://en.wikipedia.org/wiki/Public-key_cryptography]<!-- -->,
and it provides everything we need.</p><p>Public-key cryptography allows each device to have a unique, secret,
private key that proves its unique identity. That private key is
mathematically tied to a public key. The public key can be used to
encrypt messages that only the private key holder can decrypt. Also, the
public key cannot be used to derive the original private key. This
functionality fits perfectly with what our distributed system needs!
Alas, public-key cryptography introduces complex behaviors, setup, and
management. In the next article, we will dive a little deeper into this
topic. For now, let us take it on faith that it will serve our needs
well.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="setting-it-up">Setting It Up<a href="#setting-it-up" class="hash-link" aria-label="Direct link to Setting It Up" title="Direct link to Setting It Up">​</a></h4><p>So we have decided that public-key cryptography is the answer. What does
that mean? What do I have to do? Let us explore what would need to be
done by a human or a piece of software automating this process. Don't
worry if you don't get all of this; the gist is all you need for now.
Later articles will expand upon this terminology. In fact, after reading
the later articles, consider revisiting this part.</p><p>Consider the following diagram of a "mesh" distributed system. This mesh
could be any type of system such as a mesh of Ziti Routers, or maybe it
is a system of sensors on an airplane. What they do does not matter.
What matters is that this system has multiple pieces of software
connecting amongst themselves. Consider what it means to accomplish this
using public-key cryptography.</p><p><img loading="lazy" alt="Mesh" src="/assets/images/mesh-329d97ab70482d5223a4d30c0263e6cb.png" width="1179" height="887" class="img_ev3q"></p><p>In the diagram above, each system needs:</p><ul><li>a key pair for client and server connections</li><li>to have the public keys of each system it is connecting to</li></ul><p>So what do we need to do? Drop into a CLI and start generating keys on
each machine. Do that by using these commands:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">openssl ecparam -name secp256k1-genkey -param_enc explicit -out private-key.pem</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">openssl req -new -x509 -key private-key.pem -out server.pem -days 360</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Voila - you now have a self-signed certificate! What is a self-signed
certificate? For now, let us understand it means that no other system
has expressed trust in your public certificate. In
<a href="/blog/bootstrapping-trust/part-04.certificate-authorities-and-chains-of-trust">Part 4: Certificate Authorities &amp; Chains Of Trust</a>
we will cover them in more detail.</p><p>You can repeat the above process for every piece of software in your
mesh network. Preferably, you log into each machine and generate the
private key there. Moving private keys on and off devices is a security
risk and frowned upon. For maximum security, hardware, such as
<a href="https://en.wikipedia.org/wiki/Hardware_security_module" target="_blank" rel="noopener noreferrer">Hardware Security Modules (HSMs)</a>
and <a href="https://en.wikipedia.org/wiki/Trusted_Platform_Module" target="_blank" rel="noopener noreferrer">Trusted Platform Modules
(TPMs)</a>, can be
used to store the private keys in a manner that does not make them
directly accessible.</p><p>Then you will need to copy each public certificate to every other
machine and configure your software so that it trusts that certificate.
The system will need to repeat this process any time the system adds a
piece of software. If a machine is compromised, the analogous public
certificate will need to be untrusted on every node in the mesh. Adding
or removing trust in a public certificate involves configuring software
or operating systems. There are many ways it can be implemented,
including configuration files, files stored in specific directories, and
even via configuration tools such as Windows Certificate Manager
snap-in.</p><p>This is a log of careful work to get a simple system running. Consider
what this means when adding or removing many nodes? Visiting each
machine and reconfiguring them each time is quite a bit of overhead.
There is a solution to these woes. While it is elegant on its own, it
does add complexity. Let us see how Certificate Authorities (CAs) can
help! In the next section, we will hit the highlights of CAs. For more
detail, look forward to
<a href="/blog/bootstrapping-trust/part-04.certificate-authorities-and-chains-of-trust">Part 4: Certificate Authorities &amp; Chains Of Trust</a>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="cas--adding-complexity">CAs &amp; Adding Complexity<a href="#cas--adding-complexity" class="hash-link" aria-label="Direct link to CAs &amp; Adding Complexity" title="Direct link to CAs &amp; Adding Complexity">​</a></h4><p>A CA enables trust deferral from multiple individual certificates to a
single certificate which means that instead of trusting each
certificate, each piece of software will trust the CA. The CA will be
used to sign every public certificate our software pieces need to use.
How does "signing" work? We will cover that in
<a href="/blog/bootstrapping-trust/part-03.certificates">part three</a> and why it matters part in
<a href="/blog/bootstrapping-trust/part-04.certificate-authorities-and-chains-of-trust">four</a>. For
now, the basics will be provided.</p><p>Here are the high-level steps of using a CA:</p><ol><li>create a CA configuration via OpenSSL CNF files</li><li>create the CA</li><li>use the CA's public key to sign all of the public certificates</li><li>distribute the CA's certificate to every machine</li><li>configure the machines certificate store or configure the software</li></ol><p>For items one and two, the process can be a bit mystical. There is a
multitude of options involved in managing a CA. To perform number three,
you will need to go through the processing of creating certificate
signing requests (CSRs, see <a href="/blog/bootstrapping-trust/part-03.certificates">parts three</a> for
more detail) on behalf of the piece of software, and someone or
something will have to play the role of the CA and resolve the CSRs. The
last two steps will depend on the operating system and software being
used.</p><p>All of these actions can be done via a CLI or programmatically. You will
have to spend time and energy, making sure the options are correctly set
and learning about all the different capabilities and extensions.
Mistakes will inevitably occur. It is time-consuming to debug why a
specific public certificate is not working as intended. The tools and
systems that use the certificates are purposely vague in error messages
as not to reveal too much information to attackers.</p><p>The payoff for using CAs is having the ability to create chains of
trust. Chains of trust allow distributed systems to scale without having
to reconfigure each node every time the system grows or shrinks. With a
little more upfront cost and bookkeeping to run a CA, the system will
greatly decrease the amount of configuration required on each device.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="further-concerns">Further Concerns<a href="#further-concerns" class="hash-link" aria-label="Direct link to Further Concerns" title="Direct link to Further Concerns">​</a></h4><p>Once configured, there are still other concerns that need to be taken
into account. Consider the following list of events that may happen to a
CA, and it's certificates:</p><ul><li>What happens when a certificate expires?</li><li>How does a system know not to trust a certificate anymore?</li><li>What happens when private keys need to regenerate?</li></ul><p>CAs do not automatically handle the propagation of these types of
events. CAs are files on a storage device or HSM. Issuing or revoking
certificates does not generate any kind of event without additional
software. There is also the issue of certificates expiring. That "-days
360", used in the example above, puts a lifetime on each certificate.
The lifetime can be extended far into the future, but this is a bad
practice. Limiting the life span of a certificate reduces attack windows
and can be used as a trigger to adopt strong encryption.</p><p>Even if we ignore all of those concerns, who did we trust to get this
system setup? What was the seed of trust used to bootstrap trust? So
far, you could have imagined that a human was doing all of this work. In
that case, a human operator is trusted to properly configure all of the
systems - trusting them with access to all of the private keys. The seed
of trust is in that human. If this is a software system performing these
actions, that means that the system has to be trusted and most likely
have access to every other system coming online. That is workable, but
what happens when your system can have external systems request to be
added to the network? How can that be handled? How do you trust that
system in the first place? Using a secret password creates a single,
exploitable, weak point. Public-key cryptography could be put in place,
but then we are in a chicken-and-egg scenario. We are putting public-key
cryptography in place to automate public-key cryptography.</p><p>There are many caveats to bootstrapping trust. In a dynamic distributed
system where pieces of software can come and go at the whim of network
operators, the issues become a mountain of concerns. Thankfully in Ziti,
a mechanism is provided that abstracts all of these issues. To
understand how Ziti accomplishes this, we have a few more topics to
discuss. In
<a href="/blog/bootstrapping-trust/part-02.a-primer-on-public-key-cryptography">part two</a>, we will
chip away at those topics by covering public-key cryptography in more
detail to understand its powers and applications.</p><hr><p>Written By: Andrew Martinez<br>
<!-- -->June 2020</p>]]></content>
        <author>
            <name>Andrew Martinez</name>
            <uri>https://github.com/andrewpmartinez</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Bootstrapping Trust]]></title>
        <id>https://openziti.io/blog/bootstrapping-trust/part-02.a-primer-on-public-key-cryptography</id>
        <link href="https://openziti.io/blog/bootstrapping-trust/part-02.a-primer-on-public-key-cryptography"/>
        <updated>2023-10-14T16:50:51.000Z</updated>
        <summary type="html"><![CDATA[Part 2: A Primer On Public-Key Cryptography]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="part-2-a-primer-on-public-key-cryptography">Part 2: A Primer On Public-Key Cryptography<a href="#part-2-a-primer-on-public-key-cryptography" class="hash-link" aria-label="Direct link to Part 2: A Primer On Public-Key Cryptography" title="Direct link to Part 2: A Primer On Public-Key Cryptography">​</a></h2><p>If you have read through the entire series up to here, welcome! If you
have not, please consider reading the whole series:</p><ul><li><a href="/blog/bootstrapping-trust/part-01.encryption-everywhere">Part 1: Encryption Everywhere</a></li><li><a href="/blog/bootstrapping-trust/part-02.a-primer-on-public-key-cryptography">Part 2: A Primer On Public-Key Cryptography</a></li><li><a href="/blog/bootstrapping-trust/part-03.certificates">Part 3: Certificates</a></li><li><a href="/blog/bootstrapping-trust/part-04.certificate-authorities-and-chains-of-trust">Part 4: Certificate Authorities &amp; Chains Of Trust</a></li><li><a href="/blog/bootstrapping-trust/part-05.bootstrapping-trust">Part 5: Bootstrapping Trust</a></li></ul><p>It isn't easy to talk about bootstrapping trust without covering the
basics of public-key cryptography. The reader may skip this article if
the concepts of encryption, signing, and public/private keys are
familiar. However, if not, I implore that you bear the brunt of this
article as later parts will heavily rely on it.</p><p>If you wish, you can dive into the mathematics behind it to prove it to
yourself, but I promise, no math here. When necessary, I will wave my
hands at it, point into the distance, and let the reader journey out.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="keys">Keys<a href="#keys" class="hash-link" aria-label="Direct link to Keys" title="Direct link to Keys">​</a></h3><p>Keys are blobs of data containing rather large numbers. They can be
stored anywhere data can be stored, but are commonly stored as files. A
set of public and private keys is referred to as a "key set" or "key
pair."</p><p>Within a key pair, there is only one private key and one public key. The
two keys are mathematically entangled, given a particular function and
its parameters. Today, those functions and parameters are generally
elliptical curves and are the basis of a "trapdoor function." Trapdoor
functions are attractive to the cryptographically inclined for two main
reasons:</p><ol><li>they make it easy to encrypt with one key of a key pair and decrypt
with the other.</li><li>one key cannot be derived from the other</li></ol><p>Of the two keys, the private key is the most important. It must be kept
tucked away from prying eyes and attackers. Some secure environments
store the private key in hardware such as
<a href="https://en.wikipedia.org/wiki/Hardware_security_module" target="_blank" rel="noopener noreferrer">Hardware Security Modules (HSMs)</a>
or
<a href="https://en.wikipedia.org/wiki/Trusted_Platform_Module" target="_blank" rel="noopener noreferrer">Trusted Platform Modules (TPMs)</a>.
Mobile devices, such as laptops and smartphones, use hardware technology
similar to TPMs. Apple has its Secure Enclave, and Android has its
Keymaster Hardware Abstraction Layer. The goal of all of these pieces of
hardware is to keep sensitive secrets (e.g., private keys) safe. The
fact that an entire industry of embedded hardware has been developed to
keep private keys safe should tip the reader off to how important they
are.</p><p>As stated above, these two keys have some impressive capabilities. It is
not possible to derive one from the other. This allows the public key to
be handed out freely without compromising the private key. Also, both
keys can generate encrypted data that only the other key can decrypt.
More clearly:</p><ol><li>Anyone with the public key can encrypt data only the private key
holder can decrypt</li><li>Anyone with the public key can decrypt data from the private key
holder</li></ol><p>Number one can succinctly be called "Public Key Encryption" and number
two "Private Key Encryption." This article explores the merits of both.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="public-key-encryption">Public Key Encryption<a href="#public-key-encryption" class="hash-link" aria-label="Direct link to Public Key Encryption" title="Direct link to Public Key Encryption">​</a></h4><p>From the list above, number one is what most people think of as
"encryption." It is "secure" as it allows anyone with the widely
available public key to send messages only the private key holder can
read. This property ensures that communication from the public key
holder to the private key holder is being read exclusively by the
intended target.</p><p>There is quite a bit of pressure to keep the private key extremely safe.
Whoever holds the private key, has a guaranteed identity that is tied to
and verifiable by the public key. It is verifiable because if one can
use the public key to encrypt data, only the private key holder can
decrypt it. This fact means that data can be encrypted and sent that
coordinates on an additional secret. Since only the private key holder
can decrypt the data to see this second level secret, future
communication can use the new secret to encrypted and verify traffic in
both directions. This additional exchange is roughly how part of the TLS
negotiation works for HTTPs. TLS, and by proxy HTTPS, use other
technologies and strategies to provide an incredible security
proposition.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="private-key-encryption">Private Key Encryption<a href="#private-key-encryption" class="hash-link" aria-label="Direct link to Private Key Encryption" title="Direct link to Private Key Encryption">​</a></h4><p>For private key encryption, the same principles apply as with public key
encryption with the roles reversed. The private key encrypts data only
the public key can decrypt. On the surface, this seems absurd. When the
server encrypts data with its private key, the public key can decrypt
it. The public key is not protected and expected to be widely available.
It seems as if private key encryption is nearly useless as everyone can
read it!</p><p>Except it isn't. Private key encryption verifies the identity of the
private key holder. The public key cannot interact with anyone else.
Additionally, this property allows us to generate encrypted data that
could only have come from the private key holder. If that data happens
to be small and describe another document, we call that a "digital
signature" or "signature" for short.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="digital-signatures">Digital Signatures<a href="#digital-signatures" class="hash-link" aria-label="Direct link to Digital Signatures" title="Direct link to Digital Signatures">​</a></h3><p>Digital signatures are similar to handwritten ones used to sign legal
documents and checkbooks, but with a significant advantage. They
validate that a document has not been altered since it was signed. With
today's computer's graphical abilities, the nefarious can forge images
and handwritten signatures. That puts handwritten signatures at a
significant disadvantage. So how does this work?</p><p>The data that will be signed can be anything. What it represents is not
important. It can be text, JSON, an image, a PDF, or anything at all!
That data is processed by a one-way
<a href="https://en.wikipedia.org/wiki/Cryptographic_hash_function" target="_blank" rel="noopener noreferrer">cryptographic hashing algorithm</a>,
such as SHA-256. This process is idempotent, meaning running it
repeatedly on the same data, parameters, and hashing algorithm gives the
same result. The output of this process is a hash, a string of
characters that uniquely identifies the input data. With sufficiently
large input data, the hash is much shorter than the input data as the
hash size is usually fixed length.</p><p>For example, here is the Ziti logo:</p><p><img loading="lazy" alt="Ziti" src="/assets/images/ziti-c5f4e9ffa46a5294f79389ed04b812ea.png" width="839" height="839" class="img_ev3q"></p><p>This logo's file can be hashed using SHA-256 via the <code>sha256sum</code> command
commonly found on Linux.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$&gt; sha256sum ziti.png</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">c3a6681cc81f9c0fa44b3e2921495882c55f0a86c54cd60ee0fdc7d200ad26db  ziti.png</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>That long string "c3a....6db" is the hash of that file! The string is 64
characters long and is comprised of hex characters (a base 16 numbering
system of 0-9 and a-f). Each character takes four bits to represent (4^2
= 16). Since there are 64 characters at 4 bits each we have: 64 x 4 =
256<!-- -->.<!-- --> This is where SHA-256 gets its name. SHA-256 is a fixed-length
cryptographic hashing algorithm who's output is 256 bits in length.</p><p>The hash itself is not encryption. It is "hashing." Hashing of this
nature is not reversible while encryption is. For cryptographic hashing,
it is impracticable to have two similar sets of data that have the same
function that produces the same hash. In essence, the hash uniquely
represents the data: all of it! Changing even a single character would
generate a different hash.</p><p>After hashing a data or document, the private key holder can encrypt the
hash to generate a signature. This process provides the following truths
when working with the signature:</p><ul><li>the private key is the only key capable of producing its signature of
the data's hash</li><li>the public key can validate the signature given the data and hashing
algorithm used</li></ul><p>Verifying a signature a straightforward process:</p><ul><li>Use the public key to decrypt the signature to reveal the original
hash</li><li>Use the hashing algorithm that was used initially on the data,
recreate the hash independently</li><li>Compare the two hashes, and if they are the same the signature is
valid</li></ul><p>Signing data is incredibly powerful. It allows a private key holder to
state that data was approved by them and not altered. It is also
publicly verifiable to anyone with the document, signature, and public
key. This allows many decentralized approaches to sharing data that can
have its source and content verified.</p><p>Bearer tokens are an example of the power of signatures. Bearer tokens
are a document that is signed by a trusted authentication system and
contain data that provides information about the client presenting the
token. Signing the token ensures that the content of the token has not
been changed and has been endorsed by a trusted system. An example of a
bearer token is a
<a href="https://en.wikipedia.org/wiki/JSON_Web_Token" target="_blank" rel="noopener noreferrer">JSON Web Token (JWT)</a></p><p>A JWT specifies the format of the bearer token as a header, payload, and
signature using JSON. A client can then present a JWT to any system
which can then verify that the contents are valid and from a trusted
identity. As long as the signature is valid, the JWT can grant access to
the client presenting it based on whatever information is inside the
JWT.</p><h1>Closing</h1><p>This article should have shed light on public-key cryptography by
explaining the roles of the public and private keys. It should have also
provided a glimpse at the power of encryption and digital signatures. In
<a href="/blog/bootstrapping-trust/part-03.certificates">part three</a> we will see how key pairs can
be combined with certificates!</p><hr><p>Written By: Andrew Martinez<br>
<!-- -->June 2020</p>]]></content>
        <author>
            <name>Andrew Martinez</name>
            <uri>https://github.com/andrewpmartinez</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Bootstrapping Trust]]></title>
        <id>https://openziti.io/blog/bootstrapping-trust/part-03.certificates</id>
        <link href="https://openziti.io/blog/bootstrapping-trust/part-03.certificates"/>
        <updated>2023-10-14T16:50:51.000Z</updated>
        <summary type="html"><![CDATA[Part 3: Certificates]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="part-3-certificates">Part 3: Certificates<a href="#part-3-certificates" class="hash-link" aria-label="Direct link to Part 3: Certificates" title="Direct link to Part 3: Certificates">​</a></h2><p>If you have read through the entire series up to here, welcome! If you
have not, please consider reading the whole series:</p><ul><li><a href="/blog/bootstrapping-trust/part-01.encryption-everywhere">Part 1: Encryption Everywhere</a></li><li><a href="/blog/bootstrapping-trust/part-02.a-primer-on-public-key-cryptography">Part 2: A Primer On Public-Key Cryptography</a></li><li><a href="/blog/bootstrapping-trust/part-03.certificates">Part 3: Certificates</a></li><li><a href="/blog/bootstrapping-trust/part-04.certificate-authorities-and-chains-of-trust">Part 4: Certificate Authorities &amp; Chains Of Trust</a></li><li><a href="/blog/bootstrapping-trust/part-05.bootstrapping-trust">Part 5: Bootstrapping Trust</a></li></ul><p>In the series, we have covered public-key cryptography, where we learned
about public keys, private keys, and their uses for encryption and
signing. Using keys to sign data will play an essential role in this
article. It is vital that the reader understand that signatures verify
both the content of the data and its source. For a refresher, see
<a href="/blog/bootstrapping-trust/part-02.a-primer-on-public-key-cryptography">part two</a> of this
series.</p><p>This article covers how certificates and certificate authorities (CAs)
work as "trust anchors." When a CA is a trust anchor, it means that a
system can trust the CA to sign certificates that it can, in turn,
trust. Throughout this entire article, "trusting certificates" is
mentioned. Trusting a certificate (CA or otherwise) is a software or
operating system configuration process. This configuration tells the
system that the specified certificates are trustworthy in the eyes of
the operator.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="certificates">Certificates<a href="#certificates" class="hash-link" aria-label="Direct link to Certificates" title="Direct link to Certificates">​</a></h3><p>Part two of this series covered keys, both public and private, but did
not mention certificates. It is common to hear "certificate" used
interchangeably with "public key" and, sometimes, "private key." A
certificate must have the public key inside of it. Some storage formats
allow certificates to be stored along with the matching private key.
One example of this is PFX files. PFX files, which are PKCS#12 archives,
are also sometimes generically referred to as a "certificates". In this
article "certificate" will always mean an x509 certificate that contains
only the public key.</p><p>Certificates are a simple concept, but years of expansions and
extensions have added to them and can be daunting uninitiated when you
get into the nitty-gritty details. This article will strive to sit above
that detail. If you venture into the realm of generating certificates,
using OpenSSL and its configuration files, it can be a cumbersome
experience to wade through. There are many great articles and tutorials
available to get you started.</p><p>For this article, the word "certificate" will mean an "x509
Certificate". x509 is a public standard and is the de-facto standard for
software systems dealing with public-key cryptography. There are other
formats, but they are usually environment-specific, such as Card
Verifiable Certificates. x509 good enough for general purpose use on
most systems.</p><p>So, what is a certificate? It is yet another blob of data that is
specially formatted. It can be stored anywhere data can be stored but is
usually a file. For this conversation, we will focus on the following
subset of information that a certificate contains:</p><ul><li>Subject information<ul><li>A public key</li><li>Distinguished Name</li></ul></li><li>Issuer Information</li><li>Validity Period</li><li>Usage/Extensions</li><li>Signatures</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="subject-information">Subject Information<a href="#subject-information" class="hash-link" aria-label="Direct link to Subject Information" title="Direct link to Subject Information">​</a></h4><p>Certificates contain more than keys. The Distinguished Name (DN) are
text fields. They are useful mainly to humans to know what/who owns a
certificate. It is sometimes used by software as display information or
for comparison checks. Since humans provide the DN values or configure
software with values, it is not always distinguishing. DN values have an
alternate name: relatively distinguished names.</p><p>Related to the Subject DN is the Issuer Information. The Issuer
Information is the subject of the certificate that issued the
certificate. Because of this, both the issuer information has similar
values to the subject DN. Both can include the following information:</p><ul><li>CN - common name - a name</li><li>SN - surname</li><li>SERIALNUMBER - a number that is usually unique per certificate issuer,
but not always</li><li>C - country</li><li>L - locality name</li><li>ST or S - state or province</li><li>STREET - street address</li><li>O - organization name</li><li>OU - organizational unit</li><li>T - title</li><li>G or GN - given name</li><li>E - email address</li><li>UID - user id</li><li>DC - domain component</li></ul><p>Do not worry about memorizing that list. Simply knowing they exist and
that they may or may not matter is good enough for now. If the reader is
wondering when they might matter, well, that is generally when the
system you are using complains about them.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="validity-period">Validity Period<a href="#validity-period" class="hash-link" aria-label="Direct link to Validity Period" title="Direct link to Validity Period">​</a></h4><p>The Validity Period specifies two points in time from when the
certificate is valid. Before and after this window of time, the
certificate is invalid and should not be trusted. Validity periods
should be as small as possible to fit their use case. Shorter periods
reduce the window of time that compromised private key can remain useful
for an attack. The cost of this is overhead reissuing certificates as
they reach the end of their validity period.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="usageextensions">Usage/Extensions<a href="#usageextensions" class="hash-link" aria-label="Direct link to Usage/Extensions" title="Direct link to Usage/Extensions">​</a></h4><p>Usage/Extension Data is interesting because it can limit what roles a
certificate fulfills. Depending on the system, this may be adhered to or
not. Some examples of usage that are common to see:</p><ul><li>key usage: client authentication, server authentication, signatures,
etc.</li><li>Subject Alternate Names (SANs)<ul><li>Limits what IP address, email address, domain name, etc. the
certificate can be associated with</li></ul></li><li>Certificate Authority (CA) flag</li><li>and more</li></ul><p>This series will not dive into the details of these usages. However, it
is essential to be aware of them and that they can affect the roles a
certificate can fulfill.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="signatures">Signatures<a href="#signatures" class="hash-link" aria-label="Direct link to Signatures" title="Direct link to Signatures">​</a></h4><p>The signature section of a certificate is a list of signatures from
other entities that trust this certificate. A certificate that signs
itself is a "self-signed certificate." Self-signed certificates must be
individually trusted as no other certificate has expressed trust in it
by signing it. Self-signed certificates are sometimes used for testing
purposes as they are easy to create. They are also used as Root
Certificate Authorities (root CAs).</p><p>Each signature on a certificate is the result of taking the contents of
the certificate (without signatures), one-way hashing it, and then
encrypting the hash with the signator's private key. The result is
appended to the end of the signature list. During this process, the
public certificate moves between systems to be signed.</p><p>The movement of the public certificate between systems is facilitated by
Certificate Signing Requests (CSRs). CSRs can be transmitted
electronically as files or as a data stream to the signer. CSRs contain
only the public information of a certificate and a signature from the
certificate's private key. Since CSRs only contain public information,
they are not considered sensitive. The signature in a CSR allows the
signer to verify that the CSR is from the subject specified in the CSR.
If the signature is valid, the signator processes the CSR, and the
result is a newly minted certificate with an additional signature.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h3><p>Certificates are keys, usually public ones, with additional metadata
that adds conventions and restrictions around certificate usages. They
provide a place for signatures to resides and, through CSRs, provide a
vehicle to request additional signatures. Certificates are useful
because they package all of these concerns into a neat single file. In
<a href="/blog/bootstrapping-trust/part-04.certificate-authorities-and-chains-of-trust">part four</a>, we
will explore how to create a formidable chain of trust by linking
multiple certificates together.</p><hr><p>Written By: Andrew Martinez<br>
<!-- -->June 2020</p>]]></content>
        <author>
            <name>Andrew Martinez</name>
            <uri>https://github.com/andrewpmartinez</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Bootstrapping Trust]]></title>
        <id>https://openziti.io/blog/bootstrapping-trust/part-04.certificate-authorities-and-chains-of-trust</id>
        <link href="https://openziti.io/blog/bootstrapping-trust/part-04.certificate-authorities-and-chains-of-trust"/>
        <updated>2023-10-14T16:50:51.000Z</updated>
        <summary type="html"><![CDATA[Part 4: Certificate Authorities & Chains of Trust]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="part-4-certificate-authorities--chains-of-trust">Part 4: Certificate Authorities &amp; Chains of Trust<a href="#part-4-certificate-authorities--chains-of-trust" class="hash-link" aria-label="Direct link to Part 4: Certificate Authorities &amp; Chains of Trust" title="Direct link to Part 4: Certificate Authorities &amp; Chains of Trust">​</a></h2><p>If you have read through the entire series up to here, welcome! If you
have not, please consider reading the whole series:</p><ul><li><a href="/blog/bootstrapping-trust/part-01.encryption-everywhere">Part 1: Encryption Everywhere</a></li><li><a href="/blog/bootstrapping-trust/part-02.a-primer-on-public-key-cryptography">Part 2: A Primer On Public-Key Cryptography</a></li><li><a href="/blog/bootstrapping-trust/part-03.certificates">Part 3: Certificates</a></li><li><a href="/blog/bootstrapping-trust/part-04.certificate-authorities-and-chains-of-trust">Part 4: Certificate Authorities &amp; Chains Of Trust</a></li><li><a href="/blog/bootstrapping-trust/part-05.bootstrapping-trust">Part 5: Bootstrapping Trust</a></li></ul><p>This article makes implicit heavy use of
<a href="/blog/bootstrapping-trust/part-02.a-primer-on-public-key-cryptography">part 2</a> and
<a href="/blog/bootstrapping-trust/part-03.certificates">part 3</a> of this series.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="root--intermediate-certificate-authorities-cas">Root &amp; Intermediate Certificate Authorities (CAs)<a href="#root--intermediate-certificate-authorities-cas" class="hash-link" aria-label="Direct link to Root &amp; Intermediate Certificate Authorities (CAs)" title="Direct link to Root &amp; Intermediate Certificate Authorities (CAs)">​</a></h3><p>Not all certificates are the same! Certificates have different
capabilities depending on their usage attributes and extensions. The
previous article in this series mentioned a few of those attributes and
extensions. Two of those were <code>clientAuth</code>, for client certificates, and
<code>serverAuth</code>, for server certificates, which play an essential role in
how a certificate is used during network authentication negotiations.
These roles are crucial, as they are a contract for what attributes and
extensions should be included in the certificate to make it useful. For
example, a server certificate usually finds it useful to include Subject
Alternate Names (SANs). A SAN can be used to tie a certificate to a
specific domain name (like ziti.dev). However, a client certificate will
not have use for those same fields.</p><p>The roles of certificates and the attributes/extensions they have are
not always strictly followed. Some systems, such as web browsers,
require SANs on a server certificate. That wasn't always the case.
Before that, the Common Name field in the subject information contained
the domain name. Some systems still rely on that convention.</p><p>Another type of certificate is a Certificate Authority (CA) certificate.
A CA is a key pair with a certificate that has a unique purpose: to sign
other certificates. CA certificates have a special CA flag set to
"true." This flag alone does not grant the CA certificate any power, but
if a system trusts that CA, it then allows that system to trust any
certificate that CA has signed. As mentioned in previous parts of this
series, trusting a CA is a software or operating system configuration
process. This process can be done in multiple ways depending on the
system: adding it to a store, a specific folder, or adding lines to a
configuration file.</p><p>Your operating system, right now, has its own set of trusted CAs. Most
operating systems come with a default list installed and maintained by
your OS developer. Over time this list is added to and removed from as
trust is granted or withdrawn. Some pieces of software come with a list
of CAs that are used instead of or in addition to the OS's CAs. The
power of a CA comes not by its creation but by it being trusted.</p><p>CAs come in two flavors: Root CAs and Intermediate CAs. Root CAs are the
egg or the chicken (depending on your viewpoint) of the CA trust
chicken-and-egg problem. Trust for CAs has to start somewhere. With CAs,
it is the Root CA. A Root CA can sign certificates that are themselves
CAs as well. Those certificates represent Intermediate CAs. Layers of
CAs starting with a root and adding intermediates along the way allows
the private key for the Root CAs to be kept in a highly secure
environment, which is not convenient to use for signing. This security
means that the Root CA has a far less likely chance of having its
private key compromised. Intermediate CAs are put into less secure
environments and, if compromised, can be revoked. Trust is usually put
into the Root CA, and since it was not compromised can remain trusted.
Compromised intermediate CAs can be blacklisted.</p><p>Running a public CA is serious business if you wish to be publicly
trusted. The organizations running a CA have to have strict protocols
that verify the security and safe handling of the CAs private keys. If
the private key is compromised, it can be used to sign other
certificates for malicious intents. Any system that trusted the
compromised CA will now trust any maliciously signed certificates. This
will compromise all certificates signed by that CA.</p><p>Public CAs are maintained by organizations such as DigiCert, Let's
Encrypt, and others. Anyone can create private CAs. The only difference
is that the number of systems that trust a private CA is much smaller
than that of a public one. CAs are a cornerstone of bootstrapping trust.
Trusting the proper CAs can grant trust to a large number of systems.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="chains-of-trust--pkis">Chains of Trust &amp; PKIs<a href="#chains-of-trust--pkis" class="hash-link" aria-label="Direct link to Chains of Trust &amp; PKIs" title="Direct link to Chains of Trust &amp; PKIs">​</a></h3><p><a href="/blog/bootstrapping-trust/part-03.certificates">Part three</a> of this series introduced that
certificates self-sign or sign another certificate. Certificates are
usually signed via Certificate Signing Requests (CSRs). A certificate
signing itself is called a "self-signed certificate" and is an indicator
of it being a root CA if the CA flag is also set to true. A root CA can
sign other certificates that also have the CA flag set to true. Those
types of certificates are intermediate CAs. Any CA, root or
intermediate, that fulfills a CSR and signs the enclosed certificate
will generate a non-CA certificate as long as the CA flag is false.
These certificates are "leaf certificates."</p><p>The term Public Key Infrastructure (PKI) is used to describe all of the
outputs that are generated when a CA is created. That includes the root,
intermediates, and leaf certificates. It also optionally includes all of
the systems, processes, procedures, and data used to manage them. For
the purpose of this article, and simplicity, let us stick to the
certificates only.</p><p>Consider the following PKI setup:</p><ul><li>Two root CAs:<ul><li>Root A</li><li>Root B</li></ul></li><li>The root CAs each sign an intermediate CA via CSR:<ul><li>Intermediate A</li><li>Intermediate B</li></ul></li><li>A server wishes to have a certificate to have Root A's trust extended
to it.<ul><li>A key pair is generated</li></ul></li><li>A CSR is created and submitted to Intermediate A to sign</li><li>The CSR is fulfilled.<ul><li>Server Cert A is created and signed by Intermediate A</li></ul></li></ul><p>Visually this would appear as follows:</p><p><img loading="lazy" alt="Chains" src="/assets/images/chains-05f3e840c1ce1d197e14b93538129e8d.png" width="1152" height="1484" class="img_ev3q"></p><p>This PKI has two chains of trust: Chain A and Chain B. They are called
chains because the signatures link the certificates together. Root A has
signed Intermediate A's certificate and Intermediate A has signed Server
A's certificate. Programmatically we can traverse these signatures and
verify them using the public certificates of each signatory. Trusting
Root A will trust Server A.</p><p>The second chain, Chain B, does not sign any of the certificates on
Chain A. As expected, Trusting either of the CAs from Chain B does not
grant any trust to the certificates on Chain A. Chain B highlights the
fact that any system may have multiple chains of trust that do not
interact in any fashion.</p><p>Returning to Chain A, trusting Intermediate A designates it as a "trust
anchor." Any certificate can be a trust anchor. The certificate used as
a trust anchor determines which certificates will additionally be
trusted. A leaf certificate as a trust anchor only trusts that one
certificate. Trusting a CA trusts all certificates that it has signed
itself or any of its intermediates. In the diagram above, trust only
flow downward.</p><ul><li>Trusting Server Cert A will only trust that one server certificate</li><li>Trusting Intermediate A will trust Server Cert A and any other
certificate it signs</li><li>Trust Root A will trust Intermediate A and Server Cert A and any other
certificate Root A signs (intermediate CA or not) and in turn, any of
the certificates they sign</li></ul><p>Trusting a CA that has signed many certificates allows public
certificate trust to scale. This is how trust scales for web traffic.
Companies like DigiCert, IdenTrust, GoDaddy, etc. have their root CA or
one of their large intermediate CAs trusted. Those CAs sign certificates
for websites. All of our devices trust those website certificates
because the CA has signed them.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="distributed-systems--cas">Distributed Systems &amp; CAs<a href="#distributed-systems--cas" class="hash-link" aria-label="Direct link to Distributed Systems &amp; CAs" title="Direct link to Distributed Systems &amp; CAs">​</a></h3><p>The goal for any private distributed system should be to have
certificates verified on both sides: clients verify servers and vice
versa. This behavior is a tenant of Zero Trust - do not trust, verify.
Verification should be done on every connection before any data
exchange. Over TLS, which secures HTTPS, this would be "mutual TLS" or
"mTLS." Most public websites do not require mTLS. Instead, they use TLS
with the client validating the server. For public web traffic, the
server wishes to be trusted widely. The reverse is not necessary. If it
is, websites use an additional form of authentications, like usernames
and passwords, to verify the client's identity. Public key cryptography
is a stronger authentication mechanism, but it is also difficult for the
general public to set up, manage, and maintain.</p><p>The same is true for distributed systems. Most don't secure anything at
all or only verify servers. It is inherently insecure and can cause
issues depending on the setup of the system. Ziti is a distributed
system that abstracts away this security setup for both its internal
routers and client SDKs. This setup allows application-specific
networking with strong identity verification, powerful policy
management, flexible mesh routing, and more. The goal of this series is
to focus on bootstrapping trust. So in the
<a href="/blog/bootstrapping-trust/part-05.bootstrapping-trust">last article</a> we will come full
circle and see how all of this relates to bootstrapping trust for Zero
Trust networks.</p><hr><p>Written By: Andrew Martinez<br>
<!-- -->June 2020</p>]]></content>
        <author>
            <name>Andrew Martinez</name>
            <uri>https://github.com/andrewpmartinez</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Bootstrapping Trust]]></title>
        <id>https://openziti.io/blog/bootstrapping-trust/part-05.bootstrapping-trust</id>
        <link href="https://openziti.io/blog/bootstrapping-trust/part-05.bootstrapping-trust"/>
        <updated>2023-10-14T16:50:51.000Z</updated>
        <summary type="html"><![CDATA[Part 5 Bootstrapping Trust]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="part-5-bootstrapping-trust">Part 5 Bootstrapping Trust<a href="#part-5-bootstrapping-trust" class="hash-link" aria-label="Direct link to Part 5 Bootstrapping Trust" title="Direct link to Part 5 Bootstrapping Trust">​</a></h2><p>If you have read through the entire series up to here, welcome! If you
have not, please consider reading the whole series:</p><ul><li><a href="/blog/bootstrapping-trust/part-01.encryption-everywhere">Part 1: Encryption Everywhere</a></li><li><a href="/blog/bootstrapping-trust/part-02.a-primer-on-public-key-cryptography">Part 2: A Primer On Public-Key Cryptography</a></li><li><a href="/blog/bootstrapping-trust/part-03.certificates">Part 3: Certificates</a></li><li><a href="/blog/bootstrapping-trust/part-04.certificate-authorities-and-chains-of-trust">Part 4: Certificate Authorities &amp; Chains Of Trust</a></li><li><a href="/blog/bootstrapping-trust/part-05.bootstrapping-trust">Part 5: Bootstrapping Trust</a></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ziti">Ziti<a href="#ziti" class="hash-link" aria-label="Direct link to Ziti" title="Direct link to Ziti">​</a></h3><p>In this series of articles, we are exploring bootstrapping trust, what
that means, and how it enables Zero Trust security methodologies. Ziti
provides a method to bootstrap trust via its enrollment process. For
Ziti, the enrollment process is bootstrapping trust. This trust must be
in place as all connections in Ziti require verification. All identities
in Ziti have a key pair that identifies that individual. The enrollment
process abstracts the steps of setting up keys, certificates, CSRs, CAs,
and deploying them to the proper locations. In addition, the Ziti SDKs
can be embedded within any application and enroll with a Ziti network in
the exact same fashion to bootstrap trust as part of Ziti's Zero Trust
model.</p><p>Ziti has a concept called the "Edge." The Edge is a set of software
features that sit on top of the "Fabric." The Fabric is the core of each
Ziti component, and it provides long haul mesh routing while the Edge
focuses on enrolling Ziti components, managing access via policies, and
maintaining the trust necessary to provide the foundation of a Zero
Trust network without the hassle of setting it up yourself. Together
they are a powerful combination of optimized long haul routing and trust
management.</p><p><img loading="lazy" alt="Fabric Edge" src="/assets/images/fabric-edge-debb01e86651a5d95f9260e8cbd13ecc.png" width="500" height="365" class="img_ev3q"></p><p>A small scale example Ziti system appears as follows:</p><p><img loading="lazy" alt="Ziti System" src="/assets/images/ziti-system-c36f11d4eaa20132bc62e5b899b00d2f.png" width="2910" height="479" class="img_ev3q"></p><p>Ziti Edge has the concepts of identities for endpoint SDKs and routers.
Both require certificates signed by a trusted CA. Ziti can generate the
PKI necessary to manage that trust. The PKI and its CAs will form the
backbone of the trust system that Ziti will deploy for you. In the
system diagram above, the Ziti Controller will manage an intermediate CA
and a secure enrollment process that will bootstrap trust for each
router and SDK. After bootstrapping trust, the controller will maintain
data to manage the entire life cycle of the certificates it generates.
This life cycle encompasses all the concerns from part one of this
series, including bootstrapping, revoking, renewing, and rotating keys.</p><p>So let us review the components a Ziti Controller must have to function:</p><ol><li>A CA (intermediate preferred)</li><li>A server certificate generated for the Controller's IP/hostname/etc.
Signed by the CA or a public CA</li><li>A Ziti Controller configured and ready to run</li></ol><p>This article series has touched on items one and two, but not three. For
information on how to configure a Ziti Controller refer to the Ziti
documentation repository on Github. You will also find details on how to
use the Ziti CLI to generate the PKI necessary to start a Ziti network.
However, here is a simple command that will help get the controller
started.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> ziti pki create ca test1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ziti pki create server --dns myserver.com</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="enrollment">Enrollment<a href="#enrollment" class="hash-link" aria-label="Direct link to Enrollment" title="Direct link to Enrollment">​</a></h2><p>Once a Ziti Controller is up and running, it is possible to create a new
identity and enroll it. Behind the scenes, many things happen, but for
now, let us focus on what an administrator would have to perform.</p><ol><li>Authenticate via the Ziti CLI, Ziti Admin Console (ZAC), or Edge REST
API</li><li>Issue a request to create a new identity for an SDK or router</li><li>Receive an enrollment JWT Use the JWT on the enrolling device/server
to enroll</li></ol><p>In those steps, we have performed many complex interactions.</p><ul><li>The enrolling identity:<ul><li>validated the enrollment JWT cryptographically</li><li>validated the Ziti Controller as a suitable trust anchor
cryptographically</li><li>bootstrapped its trust pool of CAs as additional trust anchors over
a secure connection</li><li>generated a key pair</li><li>generated a CSR</li></ul></li><li>The controller has:<ul><li>asserted its identity cryptographically</li><li>asserted the validity of the enrolling identity</li><li>provided a CA store of trust anchors</li><li>fulfilled the CSR request for the identity</li></ul></li></ul><p>All of these items are performed making no assumptions and securely
verifying each step. This process does not suffer from man-in-the-middle
attacks. It provides many benefits! Below is a detailed image of each
step of the enrollment process.</p><p><img loading="lazy" alt="Enrollment Full" src="/assets/images/enrollment-full-a4de028f2d23b9d3139ebff763361e7c.png" width="1906" height="913" class="img_ev3q"></p><p>Let's break those steps down:</p><ol><li>Via the Ziti CLI, ZAC, or Edge REST API the admin authenticates and
requests to create an identity</li><li>The admin receives a JWT that is signed by the controller and is
cryptographically verifiable. The JWT contains all the information
for the enrolling device/server to contact the controller and verify
its identity. It also includes a secret enrollment token.</li><li>The JWT is given to the enrolling device</li><li>The device parses the JWT, verifies all the information is present to
enroll</li><li>The device retrieves the public certificate from the controller at
the address specified in the JWT</li><li>The device confirms that the server is, in fact, the owner of the
private key for that certificate</li><li>The device uses the retrieved certificate to verify the signature on
the JWT</li><li>Verifies content has not changed</li><li>Verifies the issuing server is the server it is communicating with</li><li>Makes a secure connection to the server and requests the CAs to
trust</li><li>The enrolling identity generates a key pair, if necessary, and a
CSR. The CSR is submitted in a request with the JWT's enrollment
token.</li><li>The controller verifies the CSR, verifies the enrollment token,
verifies the client connection, and then returns the necessary
signed certificates.</li></ol><p>At the end of the process, which took four simple human steps, but
numerous cryptographically secure software steps, the controller now has
a record of the certificates issued to a specific identity. That
identity now has certificates that can be used to make connections to
other enrolled Ziti components. All components in the system can verify
the identity of any other Ziti component. At every step, every link is
verified. No individual piece of software blindly trusts any other for
inbound or outbound connections. Trust has been successfully
bootstrapped! Now we enter a maintenance window where trust has to be
verified continuously and maintained. The enrolled identity can now
interact with the Ziti Controller to either function as a Ziti Router or
as Zero Trust network client.</p><h1>Conclusion</h1><p>Thank you for reading this far! If you completed the entire series, I
hope it has been helpful. Zero Trust is a complicated topic, and it
requires a serious foundation in bootstrapping trust to get right.
Hopefully, this series starts you on your way. If you have time, please
checkout (Ziti)<!-- -->[https://github.com/openziti]<!-- -->! It is the Zero Trust
network overlay solution that I have personally worked on and was the
inspiration for this series.</p><hr><p>Written By: Andrew Martinez<br>
<!-- -->June 2020</p>]]></content>
        <author>
            <name>Andrew Martinez</name>
            <uri>https://github.com/andrewpmartinez</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Golang Aha! Moments]]></title>
        <id>https://openziti.io/blog/golang-aha/article</id>
        <link href="https://openziti.io/blog/golang-aha/article"/>
        <updated>2023-10-14T16:50:51.000Z</updated>
        <summary type="html"><![CDATA[Introduction]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">​</a></h2><p>As we (the OpenZiti team) progressed on our Go journey, we've stumbled on various
obstacles, settled on some best practices and hopefully gotten better at writing Go
code. This document is meant to share some of the 'Aha!' moments where we overcame
stumbling blocks and found solutions that sparked joy.
This is intended both for new team members and for anyone in the go community who
might be interested. We'd be very happy to hear from others about their own 'aha'
moments and also how the solutions presented strike your sensibilities.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="channels">Channels<a href="#channels" class="hash-link" aria-label="Direct link to Channels" title="Direct link to Channels">​</a></h2><p>Channels are a core feature of go. As is typical of go, the channel API is small and
simple, but provides a lot of power. </p><p>If you haven't read it yet, Dave Cheney's <a href="https://dave.cheney.net/2014/03/19/channel-axioms" target="_blank" rel="noopener noreferrer">Channel Axioms</a>
is worth a look.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="closing-channels">Closing Channels<a href="#closing-channels" class="hash-link" aria-label="Direct link to Closing Channels" title="Direct link to Closing Channels">​</a></h2><p>Closing channels can be complicated. On the reader side things are generally uncomplicated.
A closed channel read will return immediately with the zero value and flag indicating that
it is closed.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func main() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ch := make(chan interface{}, 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ch &lt;- "hello"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val, ok := &lt;- ch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fmt.Printf("%v, %v\n", val, ok) // prints hello, true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    close(ch)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val, ok = &lt;- ch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fmt.Printf("%v, %v\n", val, ok) // prints &lt;nil&gt;, false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>On the writer side, things can be more complicated. If you only have a single writer,
it can be responsible for closing the channel. This notifies any blocker readers that
the channel is closed. However, if there are multiple writers, this won't work. Writing
to a closed channel will cause a panic. Closing an already closed channel will also
cause a panic. So, what do we do?</p><p>The main thing is to realize that we don't have to close the channel. We only have to
make sure the readers and writers are safely notified that they should stop trying to
use the channel. For this, we can use a second channel.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "github.com/openziti/foundation/util/concurrenz"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "github.com/pkg/errors"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type Queue struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ch          chan int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    closeNotify chan struct{}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    closed      concurrenz.AtomicBoolean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *Queue) Push(val int) error {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    select {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case self.ch &lt;- val:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case &lt;-self.closeNotify:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return errors.New("queue closed")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *Queue) Pop() (int, error) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    select {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case val := &lt;-self.ch:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return val, nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case &lt;-self.closeNotify:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return 0, errors.New("queue closed")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *Queue) Close() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if self.closed.CompareAndSwap(false, true) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        close(self.closeNotify)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If there are several entities which all need to shutdown together, they can even
share a <code>closeNotify</code> channel.</p><p>A variation on this would let readers drain the channel once it's closed. Because
select case evaluation is random, we may not read a val from the channel once
the close notify channel is closed. We can ensure that we return a value if it's
available by modifying <code>Pop()</code> as follows:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func (self *Queue) Pop() (int, error) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    select {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case val := &lt;-self.ch:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return val, nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case &lt;-self.closeNotify:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        select {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case val := &lt;-self.ch:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return val, nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        default:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return 0, errors.New("queue closed")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Places used:</p><ul><li><a href="https://github.com/openziti/channel/blob/main/impl.go" target="_blank" rel="noopener noreferrer">https://github.com/openziti/channel/blob/main/impl.go</a> (see rxer, txer)</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="other-channel-uses">Other Channel Uses<a href="#other-channel-uses" class="hash-link" aria-label="Direct link to Other Channel Uses" title="Direct link to Other Channel Uses">​</a></h2><p>Let's look at how we can use channels in a few other ways.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="semaphores-and-pools">Semaphores and Pools<a href="#semaphores-and-pools" class="hash-link" aria-label="Direct link to Semaphores and Pools" title="Direct link to Semaphores and Pools">​</a></h3><p>Because channels have a sized buffer and have well defined blocking behavior,
creating a semaphore implementation is very straightforward. We can create a
channel with a buffer of the size we want our semaphore to have. We can then
read and write from the channel to acquire and release the semaphore. </p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package concurrenz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import "time"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type Semaphore interface {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Acquire()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AcquireWithTimeout(t time.Duration) bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TryAcquire() bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Release() bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func NewSemaphore(size int) Semaphore {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    result := &amp;semaphoreImpl{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        c: make(chan struct{}, size),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for result.Release() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type semaphoreImpl struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    c chan struct{}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *semaphoreImpl) Acquire() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;-self.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *semaphoreImpl) AcquireWithTimeout(t time.Duration) bool {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    select {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case &lt;-self.c:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case &lt;-time.After(t):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *semaphoreImpl) TryAcquire() bool {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    select {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case &lt;-self.c:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *semaphoreImpl) Release() bool {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    select {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case self.c &lt;- struct{}{}:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We could use mostly the same implementation for a resource pool. Instead of
a channel of struct{}, we could have a channel of connections or buffers
that are acquired and released.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="signal">Signal<a href="#signal" class="hash-link" aria-label="Direct link to Signal" title="Direct link to Signal">​</a></h3><p>We can use channels as signals. In this example we have something running
periodically, but we want to be able to trigger it to run sooner. With a
single element channel, we can notify a goroutine. By using <code>select</code> with
<code>default</code>, we can ensure that signalling code doesn't block and that the
receiving side only gets a single signal per loop.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "fmt"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "github.com/openziti/foundation/util/concurrenz"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "time"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func NewWorker() *Worker {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    w := &amp;Worker{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        signal:  make(chan struct{}, 1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    go w.run()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type Worker struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    signal chan struct{}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stopped concurrenz.AtomicBoolean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *Worker) run() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ticker := time.NewTicker(time.Minute)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    defer ticker.Stop()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for !self.stopped.Get() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        select {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case &lt;-ticker.C:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.work()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case &lt;-self.signal:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.work()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *Worker) work() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if !self.stopped.Get() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fmt.Println("working hard")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *Worker) RunNow() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    select {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case self.signal &lt;- struct{}{}:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="channel-loops-and-event-handler">Channel Loops and Event Handler<a href="#channel-loops-and-event-handler" class="hash-link" aria-label="Direct link to Channel Loops and Event Handler" title="Direct link to Channel Loops and Event Handler">​</a></h3><p>We often have a loop which is processing inputs from one or channel. Often we have a set of data
we want to keep local to a single goroutine, so we don't have to use any synchronization or worry
about cpu cache effects. We use channels to feed data to the goroutine and/or to trigger different
kinds of processing. A for with select loop can handle channels of different types. YOu can have
a channel per type of work, or per type of data. Sometimes it can be convenient to consolidate things
on a single channel, using an event API.</p><p>Here's a simple example where the processor is maintaining some cached data which can be updated
externally. Presumably the processor would be doing something with the cached data, but we've left
that out to focus on the pattern itself.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type Event interface {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // events are passed the processor so they don't each have to include it</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Handle(*Processor)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type Processor struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ch          chan Event</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    closeNotify chan struct{}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cache map[string]string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *Processor) run() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        select {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case event := &lt;-self.ch:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            event.Handle(self)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case &lt;-self.closeNotify:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *Processor) queueEvent(evt Event) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    select {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case self.ch &lt;- evt:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case &lt;-self.closeNotify:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *Processor) UpdateCache(k, v string) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self.queueEvent(&amp;updateCache{key: k, value: v})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *Processor) Invalidate(k string) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self.queueEvent(invalidate(k))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type updateCache struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    key string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    value string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *updateCache) Handle(p *Processor) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    p.cache[self.key] = self.value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type invalidate string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self invalidate) Handle(p *Processor) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    delete(p.cache, string(self))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="type-aliases">Type Aliases<a href="#type-aliases" class="hash-link" aria-label="Direct link to Type Aliases" title="Direct link to Type Aliases">​</a></h2><p>As we demonstrated in the previous example we can alias a type and add functions to it, usually
to satisfy some interface.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type invalidate string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self invalidate) Handle(p *Processor) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        delete(p.cache, string(self))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This can be useful if we only have a single piece of data. Rather than wrapping it in a struct,
we can just alias it and add our own funcs. </p><p>The main downside to this approach is that you have to unalias the data inside your functions
which can lead to code that is less clear. See for example this method from an <code>AtomicBoolean</code>
implementation:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type AtomicBoolean int32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (ab *AtomicBoolean) Set(val bool) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    atomic.StoreInt32((*int32)(ab), boolToInt(val))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="function-type-aliases">Function Type Aliases<a href="#function-type-aliases" class="hash-link" aria-label="Direct link to Function Type Aliases" title="Direct link to Function Type Aliases">​</a></h3><p>A go feature which can surprise developers is the ability to add function definitions to funcs.
The Event API in the Processor example above could be extended as follows:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type Event interface {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Handle(*Processor)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type EventF func(*Processor)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self EventF) Handle(p *Processor) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self(p)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <code>Invalidate</code> code could now be written as:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func (self *Processor) Invalidate(k string) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self.queueEvent(EventF(func(processor *Processor) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        delete(processor.cache, k)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The need for an <code>EventF</code> cast could be removed by adding a helper function.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func (self *Processor) queueEventF(evt EventF) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self.queueEvent(evt)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *Processor) UpdateCache(k, v string) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self.queueEventF(func(processor *Processor) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        processor.cache[k] = v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>I first encountered this style in the go http library where handlers can be defined
as structs implementing <code>Handler</code> or as functions matching <code>HandlerFunc</code>. This is
most useful when you may have both heavy implementations which carry a lot of state
as well as very simple implementations which make more sense as a function.</p><p>The processor event channel could also be implemented in terms of pure functions, if
all event implementations are lightweight.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="interfaces">Interfaces<a href="#interfaces" class="hash-link" aria-label="Direct link to Interfaces" title="Direct link to Interfaces">​</a></h2><p>A golang limitation that often trips people up is that packages cannot have circular
dependencies. There are a few ways to work around this, but the most common is to
introduce interfaces in the more independent of the packages.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="errors">Errors<a href="#errors" class="hash-link" aria-label="Direct link to Errors" title="Direct link to Errors">​</a></h2><p>In some situations, go's error handling can be excessively verbose. Especially in
cases where you're doing a series of I/O operations, your code can look something
like:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func WriteExample(w io.Writer) error {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if _, err := w.Write([]byte("one")); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if _, err := w.Write([]byte("two")); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if _, err := w.Write([]byte("three")); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if _, err := w.Write([]byte("four")); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>One way to clean this up is to wrap the error in the operation and only check it at
the end.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type WriterErr struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    err error</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    w io.Writer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *WriterErr) Write(s string) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if self.err == nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _, self.err = self.w.Write([]byte(s))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func (self *WriterErr) Error() error {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return self.err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func WriteExample2(w io.Writer) error {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    writer := &amp;WriterErr{w: w}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    writer.Write("one")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    writer.Write("two")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    writer.Write("three")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    writer.Write("four")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return writer.Error()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>See also: </p><ul><li><a href="https://go.dev/blog/errors-are-values" target="_blank" rel="noopener noreferrer">https://go.dev/blog/errors-are-values</a></li><li><a href="https://dave.cheney.net/2019/01/27/eliminate-error-handling-by-eliminating-errors" target="_blank" rel="noopener noreferrer">https://dave.cheney.net/2019/01/27/eliminate-error-handling-by-eliminating-errors</a></li></ul><p>Note: This pattern is could be viewed as an error monad implementation</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="gotchas">Gotchas<a href="#gotchas" class="hash-link" aria-label="Direct link to Gotchas" title="Direct link to Gotchas">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="loop-variables">Loop Variables<sup id="fnref-cam-a1cd95"><a href="#fn-cam-a1cd95" class="footnote-ref">cam</a></sup><a href="#loop-variables" class="hash-link" aria-label="Direct link to loop-variables" title="Direct link to loop-variables">​</a></h3><p>Like many other languages, it's possible to get into trouble when capturing loop variables,
both via pointer references and via closures.</p><p>The following snippet will print out <code>world world</code> since the loop variable
remains constant throughout loop iteration.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func main() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var list []*string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for _, v := range []string {"hello", "world"} {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        list = append(list, &amp;v)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for _, v := range list {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fmt.Printf("%v ", *v)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fmt.Println()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Similarly, the following will output <code>second second</code>:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func main() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for _, v := range []string {"first", "second"} {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        go func() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            time.Sleep(100 * time.Millisecond)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            fmt.Printf("%v ", v)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    time.Sleep(200 *time.Millisecond)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fmt.Println()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="common-deadlock-causes">Common Deadlock Causes<a href="#common-deadlock-causes" class="hash-link" aria-label="Direct link to Common Deadlock Causes" title="Direct link to Common Deadlock Causes">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="non-reentrant-mutexes">Non-reentrant Mutexes<a href="#non-reentrant-mutexes" class="hash-link" aria-label="Direct link to Non-reentrant Mutexes" title="Direct link to Non-reentrant Mutexes">​</a></h4><p>Unlike in some other languages, the mutexes provide in the sync package are non-reentrant. So if your code
grabs a lock and ends up calling back into something which gets the same lock, the goroutine will deadlock.
Typically, if you have to call back in, you'd either need an indicator that the lock is already acquired,
or do the work in a new go-routine, depending on how independent the second access was.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="channel-deadlocks">Channel Deadlocks<a href="#channel-deadlocks" class="hash-link" aria-label="Direct link to Channel Deadlocks" title="Direct link to Channel Deadlocks">​</a></h4><p>If you have a goroutine processing events from a channel, if the event submits an event back onto the channel,
that can cause a deadlock, if the channel is not buffered, or if the buffer is full.</p><p>Fixes include:</p><ul><li>Running the next event in-line, if you can detect that you're already in the event processing context</li><li>Ensure the channel is buffer is big enough that it will never block</li><li>Handing the new event submission off to a new go-routine</li></ul><p>One benefit to keeping your channel buffers at zero, is that you will detect these deadlocks very quickly.
If you have a small buffer, then the deadlock may not be caught until the system is under load.</p><div class="footnotes"><hr><ol><li id="fn-cam-a1cd95">Suggested by Cameron Otts<a href="#fnref-cam-a1cd95" class="footnote-backref">↩</a></li></ol></div>]]></content>
        <author>
            <name>Paul Lorenz</name>
            <uri>https://github.com/plorenz</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Wildcard DNS Cheatsheet]]></title>
        <id>https://openziti.io/blog/wildcard-dns/cheatsheet</id>
        <link href="https://openziti.io/blog/wildcard-dns/cheatsheet"/>
        <updated>2023-10-14T16:50:51.000Z</updated>
        <content type="html"><![CDATA[<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># ------------- start docker </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker-compose up</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># access the docker controller to create the necessary overlay</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker exec -it docker_ziti-controller_1 bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ------------- log into the ziti cli</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zitiLogin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ------------- make at least one router to be public </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge update edge-router ziti-edge-router -a "public"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ------------- allow all identities to use any edge router with the attribute "public"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge delete edge-router-policy all-endpoints-public-routers </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create edge-router-policy all-endpoints-public-routers --edge-router-roles "#public" --identity-roles "#all"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ------------- allows all edge-routers to access all services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge delete service-edge-router-policy all-routers-all-services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-edge-router-policy all-routers-all-services --edge-router-roles "#all" --service-roles "#all"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge delete identity zititunneller-blue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create identity device zititunneller-blue -o blue.jwt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge enroll blue.jwt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ------------- create a client - probably won't commit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create identity device zdewclint -o zdewclint.jwt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># from outside docker:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker cp docker_ziti-controller_1:/openziti/zdewclint.jwt /mnt/v/temp/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># attach a wholly different docker container with NET_ADMIN priv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># so we can make a tun and provide access to the __blue__ network</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker run --cap-add=NET_ADMIN --device /dev/net/tun --name ziti-tunneler-blue --user root --network docker_zitiblue -v docker_ziti-fs:/openziti --rm -it openziti/quickstart /bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ------------- zititunneller-blue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apt install wget unzip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wget https://github.com/openziti/ziti-tunnel-sdk-c/releases/latest/download/ziti-edge-tunnel-Linux_x86_64.zip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unzip ziti-edge-tunnel-Linux_x86_64.zip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clear</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./ziti-edge-tunnel run -i blue.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge delete config "basic.dial"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config "basic.dial" intercept.v1 '{"protocols":["tcp"],"addresses":["simple.web.test"], "portRanges":[{"low":80, "high":80}]}'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge delete config "basic.bind"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config "basic.bind" host.v1      '{"protocol":"tcp", "address":"web-test-blue","port":8000}'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge delete service "basic.web.test.service"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service "basic.web.test.service" --configs "basic.bind,basic.dial"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge delete service-policy basic.web.test.service.bind.blue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy basic.web.test.service.bind.blue Bind --service-roles "@basic.web.test.service" --identity-roles "@zititunneller-blue"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge delete service-policy basic.web.test.service.dial.zdew</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy basic.web.test.service.dial.zdew Dial --service-roles "@basic.web.test.service" --identity-roles "@zdewclint"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge delete config "wildcard.dial"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config "wildcard.dial" intercept.v1 '{"protocols":["tcp"],"addresses":["*.blue"], "portRanges":[{"low":8000, "high":8000}]}'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge delete config "wildcard.bind"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config "wildcard.bind" host.v1      '{"forwardProtocol":true, "allowedProtocols":["tcp","udp"], "forwardAddress":true, "allowedAddresses":["*.blue"], "forwardPort":true, "allowedPortRanges":[ {"low":1,"high":32768}] }'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge delete service "wildcard.web.test.service"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service "wildcard.web.test.service" --configs "wildcard.bind,wildcard.dial"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge delete service-policy wildcard.web.test.service.bind.blue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy wildcard.web.test.service.bind.blue Bind --service-roles "@wildcard.web.test.service" --identity-roles "@zititunneller-blue"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge delete service-policy wildcard.web.test.service.dial.zdew</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy wildcard.web.test.service.dial.zdew Dial --service-roles "@wildcard.web.test.service" --identity-roles "@zdewclint"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content>
        <author>
            <name>Clint Dovholuk</name>
            <uri>https://github.com/dovholuknf</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Zitification]]></title>
        <id>https://openziti.io/blog/zitification</id>
        <link href="https://openziti.io/blog/zitification"/>
        <updated>2023-10-14T16:50:51.000Z</updated>
        <summary type="html"><![CDATA["Zitification" or "zitifying" is the act of taking an application and incorporating a Ziti SDK into that application. Once an]]></summary>
        <content type="html"><![CDATA[<p>"Zitification" or "zitifying" is the act of taking an application and incorporating a Ziti SDK into that application. Once an
application has a Ziti SDK incorporated into it, that application can now access network resources securely from anywhere in
the world provided that the computer has internet access: NO VPN NEEDED, NO ADDITIONAL SOFTWARE NEEDED.</p><p>Integrating a Ziti SDK into your application and enrolling the application itself into a Ziti Network provides you with <em>
tremendous</em> additional security. An application using a <a href="/docs/learn/introduction/">Ziti Network</a> configured with a truly zero-trust mindset will be
<strong>IMMUNE</strong> to the "expand/multiply" phases of classic <a href="https://netfoundry.io/ztna-ransomware/" target="_blank" rel="noopener noreferrer">ransomware attacks</a>. As recent events have shown, it's probably not
a case of if your application will be attacked, but when.</p><p>In these posts we're going to explore how common applications can be "zitified". The first application we are going to focus
on will be <code>ssh</code> and it's corollary <code>scp</code>. At first, you might think, "why even bother" zitifying (of all things) <code>ssh</code>
and <code>scp</code>? These applications are vital to system administration, and we have been using <code>ssh</code> and
<code>scp</code> "safely" on the internet for years. Hopefully you're now interested enough to find out in the first post:
<a href="/blog/zitification/zitifying-ssh/">zitifying ssh</a></p><p>If you'd prefer to read about other zitifications, a running list of zitified apps will be updated below:</p><ul><li><a href="/blog/zitification/zitifying-ssh/">ssh-&gt;zssh</a></li><li><a href="/blog/zitification/zitifying-scp/">scp-&gt;zscp</a></li><li><a href="/blog/zitification/kubernetes/">Kubernetes cluster manager - kubectl</a></li></ul>]]></content>
        <author>
            <name>Clint Dovholuk</name>
            <uri>https://github.com/dovholuknf</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Zitifying Kubectl]]></title>
        <id>https://openziti.io/blog/zitification/kubernetes</id>
        <link href="https://openziti.io/blog/zitification/kubernetes"/>
        <updated>2023-10-14T16:50:51.000Z</updated>
        <summary type="html"><![CDATA[The previous post showed how to use a zero trust overlay like Ziti for transferring files by zitifying scp. Next up in the list of zitifications is kubectl. Kubernetes is a container orchestration system. Its purpose is to deploy, scale, and manage the deployment containers. Containers are self-contained, pre-built images of software generally with a singular purpose. Developers often like using containers for various reasons. One major reason developers like containers is because it simplifies the deployment of the solutions they are developing. This is where Kubernetes starts to come into focus.]]></summary>
        <content type="html"><![CDATA[<p>The <a href="/blog/zitification/zitifying-scp/">previous post</a> showed how to use a zero trust overlay like Ziti for transferring files by zitifying <code>scp</code>. Next up in the list of zitifications is <code>kubectl</code>. <a href="https://Kubernetes.io/" target="_blank" rel="noopener noreferrer">Kubernetes</a> is a container orchestration system. Its purpose is to deploy, scale, and manage the deployment containers. Containers are self-contained, pre-built images of software generally with a singular purpose. <a href="https://appfleet.com/blog/10-reasons-why-developers-love-docker/" target="_blank" rel="noopener noreferrer">Developers often like using containers for various reasons</a>. One major reason developers like containers is because it simplifies the deployment of the solutions they are developing. This is where Kubernetes starts to come into focus.</p><p>In this article we'll use a cloud provider to create a Kubernetes cluster to use. I'm using Oracle OKE in this article but there are <a href="https://www.google.com/search?q=kubernetes+cloud+providers&amp;oq=kubernetes+cloud+providers" target="_blank" rel="noopener noreferrer">numerous Kubernetes providers</a> and any of them will work but clearly the commands I'm running here are Oracle specific. Once created we will then access the cluster three ways:</p><ol><li>Via the public Kubernetes API secured via mTLS. This is the default, out-of-the-box mechanism provided by Kubernetes.</li><li>Via a tunneling app. I run Windows, so I'll use the Ziti Desktop Edge for Windows.</li><li>Via a zitified <code>kubectl</code>. Here's where we'll get to see the power of a truly zitified application. We'll be able to access our cluster extremely securely using the Ziti overlay network without installing an additional agent. Once access to the cluster comes entirely from the <a href="/docs/learn/introduction/">Ziti Network</a>, we will be able to turn public access to the Kubernetes management API <strong>off</strong> entirely!</li></ol><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="about-kubernetes">About Kubernetes<a href="#about-kubernetes" class="hash-link" aria-label="Direct link to About Kubernetes" title="Direct link to About Kubernetes">​</a></h2><p>If you are not already familiar with Kubernetes then it's probably best for you to stop reading and learn a little about it first. Though this article only expects you to understand the most rudimentary of commands, it won't teach you enough about Kubernetes to understand the what's and why's. Lots of documentation on this topic already exist and are just a search away in your search engine of choice.</p><p>Kubernetes itself is not a container engine, it's an orchestrator. This means that Kubernetes knows how to interface with container engines to perform deployments and management of workloads on the behalf of operators. This provides people with a common abstraction to use when doing this management and deployment. Interacting with the Kubernetes API is made easy by using the command-line tool: <code>kubectl</code>.</p><p><a href="https://Kubernetes.io/docs/reference/kubectl/overview/" target="_blank" rel="noopener noreferrer">kubectl</a> provides numerous commands and utilities to interact with your Kubernetes cluster. It does this by creating REST requests to a well-known endpoint. This endpoint is a highly-valuable target as it is the entry-point to the cluster. Plenty of blogs exist already on the internet addressing how to secure this endpoint but in this post we'll take it one step further than ever before by removing the Kubernetes control plane from the internet entirely. Following that we will even go one step further by replacing the existing <code>kubectl</code> command with a zero-trust implementation leveraging the ziti golang sdk.</p><p>If you'd prefer to watch a video that goes over the same content contained in the rest of this article you can go ahead and click here to watch.</p><p><a href="https://youtu.be/CRoansolpR0" target="_blank" rel="noopener noreferrer"><img loading="lazy" src="https://img.youtube.com/vi/CRoansolpR0/0.jpg" alt="Secure Kubernetes" class="img_ev3q"></a></p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="setup">Setup<a href="#setup" class="hash-link" aria-label="Direct link to Setup" title="Direct link to Setup">​</a></h2><p>Below is an overview of the <a href="/docs/learn/introduction/">Ziti Network</a> I created for this article. On the left you can see that the client, my computer, runs Windows 10. Inside Windows 10 I run linux and bash using Ubuntu via <a href="https://docs.microsoft.com/en-us/windows/wsl/install" target="_blank" rel="noopener noreferrer">Windows Subsystem For Linux (WSL)</a>. If you run Windows and don't have WSL installed I would encourage you to install and learn it!  In my bash shell I have downloaded the linux version of <code>kubectl</code> created by combining the Ziti Golang SDK into it. You can grab it from <a href="https://github.com/openziti-incubator/kubectl/releases/latest/download/kubectl-linux-amd64" target="_blank" rel="noopener noreferrer">this link</a> if you like or go check out <a href="https://github.com/openziti-incubator/kubectl" target="_blank" rel="noopener noreferrer">the code on GitHub</a> and build it yourself! :)</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="solution-overview">Solution Overview<a href="#solution-overview" class="hash-link" aria-label="Direct link to Solution Overview" title="Direct link to Solution Overview">​</a></h3><p><img loading="lazy" alt="private-kubernetes.svg" src="/assets/images/private-kubernetes-046834ce3b35e4a1a28557d6f474c6a7.svg" width="1087" height="474" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="basic-ziti-setup">Basic Ziti Setup<a href="#basic-ziti-setup" class="hash-link" aria-label="Direct link to Basic Ziti Setup" title="Direct link to Basic Ziti Setup">​</a></h3><p>To accomplish our stated goals, we will need not only an existing <a href="/docs/learn/introduction/">Ziti Network</a> but we'll also have to configure that network accordingly. Here's a list of the components necessary to deliver Kubernetes with our zero-trust network:</p><ol><li>A configuration for the <code>Bind</code> side of the service. This informs the identity within Kubernetes where to send traffic and how.</li><li>A configuration for the <code>Dial</code> side of the service. This is strictly <strong>only</strong> necessary for tunneling apps. In this example, for the Ziti Desktop Edge for Windows and specifies what host and port will be intercepted on the machine running the stock <code>kubectl</code>. for Windows.</li><li>The service itself which ties our polices mentioned above together.</li><li>A <code>Bind</code> service-policy which specifies which identities are allowed to act as a "host" for the service (meaning an identity to send traffic to which knows where and how to offload that traffic). In our example this will be the <code>ziti-edge-tunnel</code> running in a Kubernetes pod.</li><li>A <code>Dial</code> service-policy which specifies the identities allowed to access the service. This will be the identity using
<code>kubectl</code>.</li><li>Create two identities - one for the <code>Bind</code> side of the service (deployed within the Kubernetes cluster) and one for the <code>Dial</code> or client side.</li></ol><p>Here are some example commands using the <a href="https://github.com/openziti/ziti/releases/latest" target="_blank" rel="noopener noreferrer">ziti cli</a> which illustrate how to create these services. Some things of note worth mentioning. I'm setting a variable to make my configuration easier. I reuse these code blocks a lot and by extracting some variables it makes it easy for me to delete/recreate services. First I set the <code>service_name</code>
variable. I use this variable in all the names of the Ziti objects I create just to make it more clear and obvious if I have to look back at my configuration again.</p><p>Since I'm going to be accessing my Kubernetes API which I've deployed using the Oracle cloud I chose to use <code>k8s.oci</code>
as my service name. When deployed by a cloud provider, the Kubernetes API is generated or updated with numerous SANS and IP address I can choose from to represent the <code>Dial</code> side which will be intercepted by the Ziti Desktop Edge for Windows. The Oracle cloud console informs me that the private IP of <code>10.0.0.6</code> was assigned to my cluster when I click on the 'Access Cluster' button which is why I chose to use that value below. I could have chosen to use any of the DNS names provided by OKE. There are at least five I could choose from, all visible as SANS on the cert that the server returns: <code>kubernetes</code>, <code>kubernetes.default</code>, <code>kubernetes.default.svc</code>, <code>kubernetes.default.svc.cluster</code>
, <code>kubernetes.default.svc.cluster.local</code>. I chose the IP since it's pretty obvious that it's an internal IP, not on my local network. Also worth pointing out is that I'm mapping the port as well, changing it from the port that the server provides, 6443, to the common HTTPS port of 443 for the local intercept. With zitified <code>kubectl</code> we don't even need these intercepts, but we'll keep it here so that we can use the unmodified <code>kubectl</code> as well. Finally, these commands are all executed inside a bash shell since I'm using WSL.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="example-ziti-cli-commands">Example Ziti CLI commands<a href="#example-ziti-cli-commands" class="hash-link" aria-label="Direct link to Example Ziti CLI commands" title="Direct link to Example Ziti CLI commands">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># the name of the service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">service_name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">k8s.oci</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># the name of the identity you'd like to see on the kubectl client</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">the_user_identity</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">${service_name}</span><span class="token string" style="color:#e3116c">"</span><span class="token plain">.client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># the name of the identity deployed into the kubernetes cluster</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">the_kubernetes_identity</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">${service_name}</span><span class="token string" style="color:#e3116c">"</span><span class="token plain">.private</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">${service_name}</span><span class="token string" style="color:#e3116c">"</span><span class="token plain">-host.v1 host.v1 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">'{"protocol":"tcp", "address":"10.0.0.6","port":6443 }'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">${service_name}</span><span class="token string" style="color:#e3116c">"</span><span class="token plain">-client-config intercept.v1 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">'{"protocols":["tcp"],"addresses":["10.0.0.6","kubernetes"], "portRanges":[{"low":443, "high":443}]}'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create </span><span class="token function" style="color:#d73a49">service</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">${service_name}</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --configs </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">${service_name}</span><span class="token string" style="color:#e3116c">"</span><span class="token plain">-client-config,</span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">${service_name}</span><span class="token string" style="color:#e3116c">"</span><span class="token plain">-host.v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy </span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">${service_name}</span><span class="token string" style="color:#e3116c">"</span><span class="token plain">-binding Bind </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --service-roles </span><span class="token string" style="color:#e3116c">'@'</span><span class="token string" style="color:#e3116c">"</span><span class="token string variable" style="color:#36acaa">${service_name}</span><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --identity-roles </span><span class="token string" style="color:#e3116c">'#'</span><span class="token plain">"</span><span class="token variable" style="color:#36acaa">${service_name}</span><span class="token string" style="color:#e3116c">"'ServerEndpoints'</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">ziti edge create service-policy "</span><span class="token variable" style="color:#36acaa">${service_name}</span><span class="token string" style="color:#e3116c">"-dialing Dial \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    --service-roles '@'"</span><span class="token variable" style="color:#36acaa">${service_name}</span><span class="token string" style="color:#e3116c">" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    --identity-roles '#'"</span><span class="token variable" style="color:#36acaa">${service_name}</span><span class="token string" style="color:#e3116c">"'ClientEndpoints'</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">ziti edge create identity device "</span><span class="token variable" style="color:#36acaa">${the_kubernetes_identity}</span><span class="token string" style="color:#e3116c">" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    -a "</span><span class="token variable" style="color:#36acaa">${service_name}</span><span class="token string" style="color:#e3116c">"ServerEndpoints \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    -o "</span><span class="token variable" style="color:#36acaa">${the_kubernetes_identity}</span><span class="token string" style="color:#e3116c">".jwt</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">ziti edge create identity device "</span><span class="token variable" style="color:#36acaa">${the_user_identity}</span><span class="token string" style="color:#e3116c">" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    -a "</span><span class="token variable" style="color:#36acaa">${service_name}</span><span class="token string" style="color:#e3116c">"ClientEndpoints \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    -o "</span><span class="token variable" style="color:#36acaa">${the_user_identity}</span><span class="token plain">".jwt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="kubernetes-config-files">Kubernetes Config Files<a href="#kubernetes-config-files" class="hash-link" aria-label="Direct link to Kubernetes Config Files" title="Direct link to Kubernetes Config Files">​</a></h2><p>Once we have established the pieces of the <a href="/docs/learn/introduction/">Ziti Network</a>, we'll want to get the Kubernetes config files from OKE so that we can test access, make sure the cluster works etc. Oracle provides a CLI command which makes it pretty easy to get those config files called <code>oci</code>. As of this writing - the guide from <a href="https://docs.oracle.com/en-us/iaas/Content/API/SDKDocs/cliinstall.htm" target="_blank" rel="noopener noreferrer">Oracle is here</a>. Once <code>oci</code> is installed and configured the Oracle cloud gives you very easy commands to run which will generate two files. One file will be for accessing the Kubernetes API through the public endpoint. The other will get you the file for private access. We're going to want both since we're on a journey here from "public API endpoint" to tunneling-app-based access, to the final stage of app-embedded zero-trust directly into <code>kubeztl</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="getting-the-kubernetes-config-files">Getting the Kubernetes Config Files<a href="#getting-the-kubernetes-config-files" class="hash-link" aria-label="Direct link to Getting the Kubernetes Config Files" title="Direct link to Getting the Kubernetes Config Files">​</a></h3><p>Notice that we are changing the file location output by these commands and they are being output as two separate Kubernetes config files. If you prefer to merge them all into one big config file and change contexts - feel free. I left them as separate files here because it provides a very clear separation as to which config is being used or modified.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Get this value directly from Oracle</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">oci_cluster_id</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"put-your-cluster-id-here"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">oci ce cluster create-kubeconfig </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --cluster-id </span><span class="token variable" style="color:#36acaa">${oci_cluster_id}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --file /tmp/oci/config.oci.public </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --region us-ashburn-1 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --token-version </span><span class="token number" style="color:#36acaa">2.0</span><span class="token plain">.0 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --kube-endpoint PUBLIC_ENDPOINT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">600</span><span class="token plain"> /tmp/oci/config.oci.public</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">oci ce cluster create-kubeconfig </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --cluster-id </span><span class="token variable" style="color:#36acaa">${oci_cluster_id}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --file /tmp/oci/config.oci.private </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --region us-ashburn-1 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --token-version </span><span class="token number" style="color:#36acaa">2.0</span><span class="token plain">.0 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --kube-endpoint PRIVATE_ENDPOINT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">600</span><span class="token plain"> /tmp/oci/config.oci.private</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="connecting-the-pieces">Connecting the Pieces<a href="#connecting-the-pieces" class="hash-link" aria-label="Direct link to Connecting the Pieces" title="Direct link to Connecting the Pieces">​</a></h2><p>At this point we should have all the pieces in place so that we can start putting them together to test the overall solution. In this section we'll access our public Kubernetes api to make sure it works. Then we'll install Ziti into the Kubernetes cluster and verify private access works. Finally we'll disable public access <strong>entirely</strong> and use the zitified <code>kubeztl</code> command to access the cluster with true, app-embedded zero-trust binary.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="testing-the-public-api">Testing the Public API<a href="#testing-the-public-api" class="hash-link" aria-label="Direct link to Testing the Public API" title="Direct link to Testing the Public API">​</a></h3><p>This step is very straight-forward for anyone who's used Kubernetes before. Issue the following commands, making sure the path is correct for your public Kubernetes config file, and verify Kubernetes works as expected.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">KUBECONFIG</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/oci/config.oci.public</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods -v6 --request-timeout</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">'5s'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I1019 </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:57:31.910962    </span><span class="token number" style="color:#36acaa">3211</span><span class="token plain"> loader.go:372</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Config loaded from file:  /tmp/oci/config.oci.public</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I1019 </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:57:33.676047    </span><span class="token number" style="color:#36acaa">3211</span><span class="token plain"> round_trippers.go:454</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> GET https://150.230.150.0:6443/api/v1/namespaces/default/pods?limit</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">500</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token assign-left variable" style="color:#36acaa">timeout</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">5s </span><span class="token number" style="color:#36acaa">200</span><span class="token plain"> OK </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1752</span><span class="token plain"> milliseconds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                        READY   STATUS    RESTARTS   AGE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If your output looks something similar to the above (with or without the pods you expect to see) then great! That means your Kubernetes cluster is indeed up and running. Let's move on!</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="deploying-ziti-to-kubernetes">Deploying Ziti to Kubernetes<a href="#deploying-ziti-to-kubernetes" class="hash-link" aria-label="Direct link to Deploying Ziti to Kubernetes" title="Direct link to Deploying Ziti to Kubernetes">​</a></h4><p>Next we'll grab a few lines from the excellent guide NetFoundry put out for integrating with Kubernetes. There's a section in that guide for <a href="https://developer.netfoundry.io/guides/kubernetes/#install-ziti-with-helm" target="_blank" rel="noopener noreferrer">installing Ziti with Helm</a>. This comes down to just these steps:</p><ol><li>install the <code>helm</code> CLI tool <a href="https://helm.sh/docs/intro/install/" target="_blank" rel="noopener noreferrer">using this guide</a></li><li>add the NetFoundry helm repo: <code>helm repo add netfoundry https://netfoundry.github.io/charts/</code></li><li>locate the jwt file for the Kubernetes identity. If you followed the steps above the file will be named: <code>"${the_kubernetes_identity}".jwt</code> (make sure you replace the variable with the correct value)</li><li>use the jwt to add Ziti: <code>helm install ziti-host netfoundry/ziti-host --set-file enrollmentToken="${the_kubernetes_identity}".jwt</code> (again make sure you replace the variable name) If you need to, make sure you create a persistent volume. The ziti pod requires storage to store a secret.</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: PersistentVolume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: ziti-host-pv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type: </span><span class="token builtin class-name">local</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  storageClassName: oci</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  capacity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    storage: 100Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  accessModes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - ReadWriteMany</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hostPath:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    path: </span><span class="token string" style="color:#e3116c">"/netfoundry"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="addenroll-the-client-identity">Add/Enroll the Client Identity<a href="#addenroll-the-client-identity" class="hash-link" aria-label="Direct link to Add/Enroll the Client Identity" title="Direct link to Add/Enroll the Client Identity">​</a></h4><p>Now consume the one time token (the jwt file) to enroll and create a client-side identity using the Ziti Desktop Edge for Windows (or MacOS or via the <code>ziti-edge-tunnel</code> if you prefer). Once you can see the identity in your tunneling app, you should be able to use the private kubernetes config file to access the same exact cluster. Remember though, we have mapped the port on the client side to use 443. That means you'll need to update your config file and change 6443 --&gt; 443. Now when you run <code>get pods</code> you'll see the ziti-host pod deployed:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">KUBECONFIG</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/oci/config.oci.private</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                        READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti-host-976b84c66-kr4bc   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          90m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-big-finale---zitified-kubectl">The Big Finale - Zitified kubectl<a href="#the-big-finale---zitified-kubectl" class="hash-link" aria-label="Direct link to The Big Finale - Zitified kubectl" title="Direct link to The Big Finale - Zitified kubectl">​</a></h2><p>If you have made it this far, you've seen us access the Kubernetes API via the public IP. We've even accessed it via the private IP (which btw - is pretty cool in my opinion!). Now we're going to download the zitified kubectl command, turn off the public IP and even turn off the locally running tunneling app and still access the API!</p><ol><li><p>Disable the cluster's public IP address in OKE (go to the cluster in Oracle Cloud, click Edit and remove the public IP and click save)</p></li><li><p>Turn off the Ziti Desktop Edge for Windows</p></li><li><p>Build <code>kubeztl</code> from <a href="https://github.com/openziti-test-kitchen/kubeztl" target="_blank" rel="noopener noreferrer">the GitHub repo</a></p></li><li><p>Use <code>kubeztl</code> to get pods!</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./kubeztl -zConfig ./id.json -service k8s.oci get pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                        READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti-host-976b84c66-kr4bc   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          101m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="modifying-kubeconfig">Modifying KUBECONFIG<a href="#modifying-kubeconfig" class="hash-link" aria-label="Direct link to Modifying KUBECONFIG" title="Direct link to Modifying KUBECONFIG">​</a></h3><p>The <code>kubeztl</code> command has also been modified to allow you to add the service name and config file directly into the file itself. This is convenient since you will not need to supply the ziti identity file, nor will you need to specify which service to use. Modifying the file is straight-forward. Open the config file, find the context listed under the contexts root and add two rows as shown here.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">contexts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- context:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cluster: cluster-cjw4arxuolq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    user: user-cjw4arxuolq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    zConfig: /tmp/oci/k8s.id.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    service: k8s.oci</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Once done - you can now simply use the context the same way you have always - <code>kubeztl get pods</code>!</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./kubeztl get pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                        READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti-host-976b84c66-kr4bc   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          114m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2><p>We've seen in this post how you can not only secure your Kubernetes API with the normal Kubernetes mechanisms. You can also take your Kubernetes API off the internet <strong>ENTIRELY</strong>. No need to deploy and maintain a special bastian node. Now by having a secure, zero-trust overlay in place you can safely and securely access your Kubernetes API without the fear of that public, high-value API getting attacked.</p><p><img loading="lazy" src="https://i.imgur.com/JRBQMkN.jpg" alt="But Wait, There's More" class="img_ev3q"></p><p>Once you've deployed Ziti into the Kubernetes cluster you're not done there. Now you can also use Ziti to span cloud networks. You can use it to easily link private data centers or other private Kubernetes clusters all into one secure, zero-trust overlay network! Use Ziti to expose workloads that are <strong>TRULY</strong> private!  In future articles we might explore how we can bring Ziti to bear on these topics, stay tuned!</p><hr>]]></content>
        <author>
            <name>Clint Dovholuk</name>
            <uri>https://github.com/dovholuknf</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Enable Prometheus to Scrape Anything from Anywhere]]></title>
        <id>https://openziti.io/blog/zitification/prometheus/part1</id>
        <link href="https://openziti.io/blog/zitification/prometheus/part1"/>
        <updated>2023-10-14T16:50:51.000Z</updated>
        <summary type="html"><![CDATA[_This is part one of a three-part article. This article provides the necessary background and rationale of the series.]]></summary>
        <content type="html"><![CDATA[<p><em>This is part one of a three-part article. This article provides the necessary background and rationale of the series.
<a href="/blog/zitification/prometheus/part2">The next article</a> will be a detailed explanation of the actual steps necessary to implement the solution.
In <a href="/blog/zitification/prometheus/part3">the final article</a>, we will explore what we have just created and understand what was just created</em></p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-problem-with-pulling">The Problem With Pulling<a href="#the-problem-with-pulling" class="hash-link" aria-label="Direct link to The Problem With Pulling" title="Direct link to The Problem With Pulling">​</a></h2><p>Prometheus is a server which wants to reach out and pull data from "scrape targets". It will generally do this using http requests. One
problem with this design is that these targets are often inaccessible, hidden from Prometheus behind a firewall.</p><p>If not hidden, it means some port was exposed on some network, thereby giving Prometheus the ability to pull the data it needs. Exposing
that port on a "trusted" network is a possible attack vector for bad actors. Exposing that port on the open internet (as is often the case)
is an open invitation for attack. It's much better to keep these servers totally dark to all networks.</p><p>OpenZiti solves this problem of reach elegantly and natively while also keeping your service dark to all networks. This gives an
OpenZiti-enabled Prometheus the ability to literally scrape any target, anywhere. As long as the target is participates on an OpenZiti
overlay network, and as long as the proper polices are in place allowing the traffic to flow, Prometheus will be able to reach out and
pull the data it needs from anything, anywhere.</p><p>It doesn't matter if the target is in some private cloud data center, some private data center protected by a corporate firewall, or heck
even running inside my local docker environment! As long as the target participates on that OpenZiti Prometheus can scrape it! That sort of
reach is impossible with classic networks.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="prometheus">Prometheus<a href="#prometheus" class="hash-link" aria-label="Direct link to Prometheus" title="Direct link to Prometheus">​</a></h2><p><a href="https://prometheus.io/" target="_blank" rel="noopener noreferrer">Prometheus</a> is an incredibly popular <a href="https://www.cncf.io/projects/prometheus/" target="_blank" rel="noopener noreferrer">CNCF</a>
project which has graduated the gauntlet of progressions to emerge as a "graduated" CNCF project. If you're familiar with Prometheus, there
are probably a couple of reasons people mainly choose to deploy it:
metrics collection and visualization and alerting.</p><p>Prometheus is also tremendously flexible. It has numerous available plugins and supports integrating with a wide number of systems.
According
to <a href="https://www.cncf.io/blog/2022/03/08/cloud-native-observability-microsurvey-prometheus-leads-the-way-but-hurdles-remain-to-understanding-the-health-of-systems/" target="_blank" rel="noopener noreferrer">this CNCF survey</a>
, Prometheus leads the pack when it comes to the project people go to for observability. Its popularity is probably because Prometheus is a
CNCF project and is often considered the "default" solution to deploy on another wildly popular CNCF project
called <a href="https://kubernetes.io" target="_blank" rel="noopener noreferrer">Kubernetes</a>. One interesting aspect of Prometheus is that it generally favors a poll-based approach to
metrics collection instead of a push-based model.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="poll-based">Poll-based?<a href="#poll-based" class="hash-link" aria-label="Direct link to Poll-based?" title="Direct link to Poll-based?">​</a></h3><p>I don't know about you, but historically when I've thought about a metrics collection agent, I tend to think of an agent that reads a log
file or some library that pushes rows into a giant data lake in the cloud. I don't generally think about a solution that implements
poll-based metrics. Often, this is because the target of a poll-based collecting agent will probably be behind a firewall.</p><p><img loading="lazy" alt="FW" src="/assets/images/fw-b1c8555546b90b5151f6ede0e27d7111.png" width="489" height="276" class="img_ev3q"></p><p>As you would expect, firewalls make it exceptionally difficult to implement a poll-based solution as firewalls have been known to make a
habit of preventing external actors from accessing random http servers behind it! After all, that is their primary function!</p><p>The Prometheus project makes <a href="https://prometheus.io/docs/practices/pushing/" target="_blank" rel="noopener noreferrer">strong arguments</a> explaining the benefits of a poll-based
solution. They also realize that firewalls are important in creating a safe network and understand the challenges firewalls create for such
a solution. To deal with these situations, the project also provides a <a href="https://prometheus.io/docs/instrumenting/pushing/" target="_blank" rel="noopener noreferrer">PushGateway</a>.
This allows solutions to push their data to a location outbound of the firewall. Pushing data out of the firewall allows metrics and
alerting to function without the worry (and maintenance heartache) of an open, inbound firewall hole.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="acceptable-risk">Acceptable Risk<a href="#acceptable-risk" class="hash-link" aria-label="Direct link to Acceptable Risk" title="Direct link to Acceptable Risk">​</a></h3><p>Prometheus is often deployed into Kubernetes clusters, but it can be deployed anywhere. Taking the operational differences out of the
equation, there is little difference between deploying Prometheus in a Kubernetes cluster and deploying it in one's data center. Once
deployed, the needs will be the same. Prometheus will need to be authorized to reach out and scrape the targets it needs to scrape. All too
often, this is done with relatively open network permissions. Even though we all know it's not the most secure way of authorizing
Prometheus, this is often considered "safe enough" because we deployed Prometheus into a zone considered "safe". Managing firewall rules to
all the computers Prometheus needs access to, feels like an impossible feat. There are just too many.</p><p>To add to our acceptable risk, we will need to be able to access the Prometheus server in some way. We'll want to get at the UI, see the
charts and graphs and data it provides and use the server to its fullest. For that, we'll <strong>of course</strong>
need a hole in our firewall, or in the case of Kubernetes we will probably deploy some form of
<a href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/" target="_blank" rel="noopener noreferrer">Kubernetes Ingress Controller</a> to provide users access
the service.</p><p>What we need are better and richer controls over our network. We need a better way of authorizing Prometheus without the hassle of
maintaining firewall rules on individual machines. We also need a way to do this across multiple clouds, multiple Kubernetes clusters and
multiple data centers. Let's see how OpenZiti can solve this problem while also enhancing our overall security.</p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="openziti">OpenZiti<a href="#openziti" class="hash-link" aria-label="Direct link to OpenZiti" title="Direct link to OpenZiti">​</a></h2><p>The <a href="https://openziti.github.io" target="_blank" rel="noopener noreferrer">OpenZiti</a> project allows us to solve all the problems outlined above. It is a fully-featured, zero trust
overlay network and enables <a href="https://en.wikipedia.org/wiki/Zero_trust_security_model" target="_blank" rel="noopener noreferrer">zero trust networking principles</a> to be applied
anywhere. This includes bringing those zero trust principles directly into your application through one of the many SDKs provided
by the project. Let's look at an example and see what a setup might look like before and after applying OpenZiti.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h3><p>Let's imagine that we have already deployed a solution using two Kubernetes clusters, ClusterA and ClusterB. It doesn't matter where the
clusters are deployed. We are trying to illustrate a real-world situation where we have two separate Kubernetes clusters that we want to
manage. The clusters could be deployed in the same cloud provider, in a private data center, in different cloud providers, it really does
not matter. What is important, is that these clusters are available over the network. To enable access to the workloads inside the
clusters, some form of Kubernetes ingress controller will be required on both clusters. In our example, we will have a workload deployed
which exposes a prometheus scrape target we want Prometheus to monitor.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="figure-1---before-openziti">Figure 1 - Before OpenZiti<a href="#figure-1---before-openziti" class="hash-link" aria-label="Direct link to Figure 1 - Before OpenZiti" title="Direct link to Figure 1 - Before OpenZiti">​</a></h4><p><img loading="lazy" alt="Before OpenZiti" src="/assets/images/kubernetes-prometheus-before-15c1791d4c7ba9b5960fa1af5bacb258.svg" width="1099" height="534" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="taking-a-closer-look">Taking a Closer Look<a href="#taking-a-closer-look" class="hash-link" aria-label="Direct link to Taking a Closer Look" title="Direct link to Taking a Closer Look">​</a></h3><p>Looking at the diagram above with a discerning eye towards security, there are some immediate observations one can make.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="listening-ports">Listening Ports<a href="#listening-ports" class="hash-link" aria-label="Direct link to Listening Ports" title="Direct link to Listening Ports">​</a></h4><p>One observation we have already accepted from the overview, is that these clusters must be exposed via the internet. At first that doesn't
seem like a big deal, we expose workloads like this to the internet all the time. This is a perfectly normal action, it's likely
done every day somewhere in the world. It's so common, we almost don't even think about it until the time comes when we <strong>need</strong> to
think about it. This ends up in an exposed port, listening somewhere in the world. There might be a firewall with complex rules to
protect this port, but it's just as likely that this isn't the case. People might need to access the resources inside these clusters
from anywhere. </p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="kubernetes-api-exposed">Kubernetes API Exposed<a href="#kubernetes-api-exposed" class="hash-link" aria-label="Direct link to Kubernetes API Exposed" title="Direct link to Kubernetes API Exposed">​</a></h4><p>Another observation is that the Kubernetes API is fully exposed to the internet. This API is a very high-value target and should be
secured as strongly as possible. That probably means yet another complex firewall rule to maintain.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="trusted-intra-cluster-traffic">"Trusted" Intra-cluster Traffic<a href="#trusted-intra-cluster-traffic" class="hash-link" aria-label="Direct link to &quot;Trusted&quot; Intra-cluster Traffic" title="Direct link to &quot;Trusted&quot; Intra-cluster Traffic">​</a></h4><p>The final point to note is that the traffic within the cluster is considered safe. As mentioned above, the Prometheus server needs to be
able to scrape the target workloads. That traffic is necessary to be considered safe. Also, notice that the pod for Prometheus contains a
container named "configmap-reload" which is used to trigger a webhook on the Prometheus server when the
<a href="https://kubernetes.io/docs/concepts/configuration/configmap/" target="_blank" rel="noopener noreferrer">Kubernetes config map</a> changes. This is necessary when changing the
Prometheus config, adding new scrape configs etc.</p><hr><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="authors-dovholuknf">authors: dovholuknf<a href="#authors-dovholuknf" class="hash-link" aria-label="Direct link to authors: dovholuknf" title="Direct link to authors: dovholuknf">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="applying-zero-trust-networking-principles-using-openziti">Applying Zero Trust Networking Principles Using OpenZiti<a href="#applying-zero-trust-networking-principles-using-openziti" class="hash-link" aria-label="Direct link to Applying Zero Trust Networking Principles Using OpenZiti" title="Direct link to Applying Zero Trust Networking Principles Using OpenZiti">​</a></h3><p>Now that we understand the basic setup and understand some possible problems, let's see if OpenZiti can address one or more of these
issues. When applying OpenZiti, the goal will be to strengthen our security posture for each of the above items.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="figure-2---after-openziti">Figure 2 - After OpenZiti<a href="#figure-2---after-openziti" class="hash-link" aria-label="Direct link to Figure 2 - After OpenZiti" title="Direct link to Figure 2 - After OpenZiti">​</a></h4><p><img loading="lazy" alt="after" src="/assets/images/kubernetes-prometheus-after-1c432161cd5ceac47eadc4149cae35fb.svg" width="1264" height="531" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="taking-a-closer-look-after-openziti">Taking a Closer Look After OpenZiti<a href="#taking-a-closer-look-after-openziti" class="hash-link" aria-label="Direct link to Taking a Closer Look After OpenZiti" title="Direct link to Taking a Closer Look After OpenZiti">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="no-external-listening-ports">No External Listening Ports<a href="#no-external-listening-ports" class="hash-link" aria-label="Direct link to No External Listening Ports" title="Direct link to No External Listening Ports">​</a></h4><p>With a classic deployment as shown in the initial design, we know there will be ports exposed to the open internet. In an ideal scenario,
there would be absolutely no ports exposed on the open internet <strong>nor</strong> in the "trusted networking zone". It's immediately obvious after
applying a solution using OpenZiti that those listening ports exposed by the Kubernetes ingress controller are no longer deployed and thus
are no longer exposed to the internet. That's one attack vector eliminated. OpenZiti will initiate outbound mTLS connections among all the
constituent pieces of the overlay network. This means connections will begin inside the trusted network zone and only create outbound
links. Once established, those connections can be used to safely transfer data between any participating edge node.</p><p>This capability really can't be emphasized enough. With OpenZiti and with applications that use an OpenZiti SDK, such as the ones shown,
there are no open ports to attack. This network is nearly impervious to the classical "land and expand" technique so many bad actors
look to exploit.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="kubernetes-api-no-longer-exposed">Kubernetes API no Longer Exposed<a href="#kubernetes-api-no-longer-exposed" class="hash-link" aria-label="Direct link to Kubernetes API no Longer Exposed" title="Direct link to Kubernetes API no Longer Exposed">​</a></h4><p>Another significant benefit provided by OpenZiti is starting to come into focus. By having access to our clusters provided
through OpenZiti, we can <strong>stop exposing</strong> the Kubernetes APIs for both clusters to the open internet. Prometheus will still be able to
monitor each Kubernetes cluster through the private Kubernetes network. Accessing Prometheus will be provided via OpenZiti, instead of
using a Kubernetes ingress controller. Later, we can ues the built-in capability Prometheus already provides to federate information
from the clusters to a centralized, <a href="/blog/zitification">zitified</a> Prometheus server.</p><p>Once no longer exposed to the open internet, to maintain our Kubernetes cluster we could then turn to <!-- -->[zitified]<!-- -->
(/zitification/index.md) tools. The OpenZiti project provides zitified versions of <code>kubectl</code> -
<a href="https://github.com/openziti-test-kitchen/kubectl" target="_blank" rel="noopener noreferrer">kubeztl</a> and <code>helm</code> -
<a href="https://github.com/openziti-test-kitchen/helm" target="_blank" rel="noopener noreferrer">helmz</a>. Each of these tools have an OpenZiti SDK embedded inside them. This allows both
tools to connect to the private Kubernetes API over the OpenZiti overlay network. To use them, you will need a strong, OpenZiti identity
as well as be authorized to access the service. Also note that we're also not replacing the existing security constraints the
Kubernetes ecosystem already provides. You can (and should) still secure your Kubernetes clusters using namespaces, roles, etc. </p><p>We'll explore <code>kubeztl</code> and <code>helmz</code> in future articles.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="trusted-intra-cluster-traffic-1">"Trusted" Intra-cluster Traffic<a href="#trusted-intra-cluster-traffic-1" class="hash-link" aria-label="Direct link to &quot;Trusted&quot; Intra-cluster Traffic" title="Direct link to &quot;Trusted&quot; Intra-cluster Traffic">​</a></h4><p>Lastly, let's turn our eyes toward the traffic running inside the Kubernetes cluster. Pay attention to the lines in orange and the lines in
dark blue. Orange lines represent "private" traffic, traffic that needs to traverse the private network space.</p><p>At this point we cannot send traffic to the Kubernetes API via the overlay network. The Kubernetes API doesn't have an OpenZiti SDK
embedded within it. That means when we deploy Prometheus into ClusterA and ClusterB to monitor the cluster, Prometheus will be forced to
connect to a port exposed on the cluster's underlay network. Still, while not ideal, we have greatly improved the overall security
posture of the cluster. We're no longer able to access the Kubernetes API without first gaining access to the zero trust overlay
network. Accessing the Kubernetes API will also require the identity to be properly authorized to access the service attaching to the
Kubernetes API. </p><p>Let's now focus on ClusterA. It contains a Prometheus server that decided against listening on the OpenZiti overlay. This means it
will need to expose ports to the Kubernetes underlay network. The container inside the Prometheus pod will watch for configmap
changes. To trigger the webhook, it will be forced to send unauthenticated webhook traffic to the Prometheus server on the underlay
network in order to trigger the config to reload.</p><p>Still, accessing this cluster and the listening Prometheus server will require being on the OpenZiti overlay. Also, this Prometheus
server does have an OpenZiti SDK built into it. We also deployed the "reflectz" workload with an OpenZiti SDK built into it as well.
That means the Prometheus server must scrape the "reflectz" workload exclusively over the OpenZiti overlay. <strong>Only</strong> authorized
identities can access that scrape data.</p><p>Contrast ClusterA with ClusterB. ClusterB deployed a Prometheus server with an embedded OpenZiti SDK and chose to provide its services
exclusively on the OpenZiti overlay. We've also deployed a zitified "reflectz" workload here. Notice how little traffic traverses the
Kubernetes cluster underlay network. The only traffic which needs to traverse the cluster's underlay network in ClusterB is the traffic
which monitors the Kubernetes API. All other traffic in the cluster is now secured by the OpenZiti overlay network. You will
need a strong identity, and you will need to be authorized on the overlay before even being allowed to connect to the target service.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="openziti-enabled-prometheus">OpenZiti-Enabled Prometheus<a href="#openziti-enabled-prometheus" class="hash-link" aria-label="Direct link to OpenZiti-Enabled Prometheus" title="Direct link to OpenZiti-Enabled Prometheus">​</a></h2><p>We are now coming to the final piece of the puzzle. We have protected both Kubernetes clusters using OpenZiti. Now we want to bring all
this data back to a centralized Prometheus server to make it easier on our user base. To do this, we'll again deploy an OpenZiti-enabled
Prometheus server. This time we don't care where it is deployed except that we know we are not deploying it into either of the Kubernetes
clusters we are already using. Since the Prometheus servers are all now accessible via the overlay network, we can literally deploy our
server anywhere in the world. It could be on development server, it could be deployed in some other cloud, it could be deployed in our
private data center. Because it's part of the overlay network, it no longer matters where we deploy the server. Wherever deployed,
all it will need is outbound internet access, a strong identity, and access and authorization to services defined in the OpenZiti overlay
network. Once that's done, OpenZiti will take care of the rest.</p><p>If you have made it this far you're might want to try all this for yourself. The <a href="/blog/zitification/prometheus/part2">next article</a> will go into the details
necessary to implement this solution. When complete you'll be able to deploy a zitified version of Prometheus and give Prometheus the power
to scrape anything from anywhere using OpenZiti.</p>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Configuring OpenZiti to Enable Prometheus]]></title>
        <id>https://openziti.io/blog/zitification/prometheus/part2</id>
        <link href="https://openziti.io/blog/zitification/prometheus/part2"/>
        <updated>2023-10-14T16:50:51.000Z</updated>
        <summary type="html"><![CDATA[_This is part two of a three-part article. This article provides the technical deep dive into the steps necessary to implement the vision]]></summary>
        <content type="html"><![CDATA[<p><em>This is part two of a three-part article. This article provides the technical deep dive into the steps necessary to implement the vision
outlined in <a href="/blog/zitification/prometheus/part1">part one</a>. This article will be heavy on OpenZiti CLI commands, explaining what we are doing to configure the
overlay network, and why. In <a href="/blog/zitification/prometheus/part3">the final article</a>, we will explore what we have just created and understand what was just
created</em></p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="goals">Goals<a href="#goals" class="hash-link" aria-label="Direct link to Goals" title="Direct link to Goals">​</a></h2><ul><li>Incredibly easy to deploy Prometheus servers</li><li>No ports exposed to the internet</li><li>Prometheus servers can be deployed listening on the overlay, not on the underlay</li><li>Private Kubernetes API</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="zitified-prometheus">Zitified Prometheus<a href="#zitified-prometheus" class="hash-link" aria-label="Direct link to Zitified Prometheus" title="Direct link to Zitified Prometheus">​</a></h2><p>As described in <a href="/blog/zitification/prometheus/part1">the previous article</a>, Prometheus really prefers to be able to gather metrics from the targets it is
monitoring. When the target is behind a firewall, you will be left with two choices.
<img loading="lazy" src="https://github.com/openziti/branding/raw/main/images/ziggy/svg/Ziggy%20The%20Superhero.svg" alt="superhero" class="img_ev3q">
You can choose to open a hole in the firewall granting access (a generally bad idea), or you can use a PushGateway. Even if you choose to
use the PushGateway, Prometheus will still need to be able to access and pull from the PushGateway so you'll still need some port open and
listening for Prometheus to collect data.</p><p>What we really want is to enable Prometheus to scrape data from targets without needing to expose any ports to the internet. It would be <strong>
even better</strong> if we didn't have to expose any ports at all, even to the local "trusted" network. This capability is something that is
unique to an OpenZiti-enabled application. You can take an OpenZiti SDK and embed it into your application, and give your app zero trust
superpowers! If we take an OpenZiti SDK and embed it into Prometheus, we can give Prometheus the superpower of invisibility and
addressability. Embedding an OpenZiti SDK produces a <a href="/blog/zitification">zitified</a> version of Prometheus. With an
OpenZiti-powered Prometheus, no ports need to be open.</p><p>The OpenZiti project has done the work to produce an OpenZiti-enabled version of Prometheus. It's also entirely open source. Check it out
from the OpenZiti Test Kitchen hosted on GitHub <a href="https://github.com/openziti-test-kitchen/prometheus" target="_blank" rel="noopener noreferrer">https://github.com/openziti-test-kitchen/prometheus</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="solution-overview">Solution Overview<a href="#solution-overview" class="hash-link" aria-label="Direct link to Solution Overview" title="Direct link to Solution Overview">​</a></h2><p>As you'll recall from <a href="/blog/zitification/prometheus/part1">part1</a>, we are trying to use Prometheus to monitor workloads in two different
Kubernetes clusters. We are going to deploy one cluster which will represent a first step of an OpenZiti solution.
It will use a Prometheus sever which is OpenZiti-enabled, but it will still listen on the underlay network and be
available to local devices on an ip:port. This Prometheus server will use OpenZiti to scrape targets which
are available anywhere on the OpenZiti overlay network and we'll refer to this as "ClusterA".</p><p>We'll also deploy a second OpenZiti-enabled Prometheus server, in a totally separate Kubernetes cluster. This
Prometheus server will <strong>not</strong> listen on an ip:port. Instead, it will listen exclusively on the OpenZiti overlay.
This Prometheus server will have no ports available to attack and will only be accessible via a properly authorized
and authenticated OpenZiti client. This will be our "ClusterB"</p><p>Finally, we'll stand up a third Prometheus server and use it to federate metrics back to a "central" Prometheus
server. This emulates what one might do to provide a central location for humans to go to in order to visualize data
or use the Prometheus server. We won't care where this is deployed, we'll actually deploy it in locally and then
move it to a private server in AWS just to show how easy it that is. </p><p>This is what the solution we'll build looks like:
<img loading="lazy" alt="after" src="/assets/images/kubernetes-prometheus-after-1c432161cd5ceac47eadc4149cae35fb.svg" width="1264" height="531" class="img_ev3q"></p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="digging-in">Digging In<a href="#digging-in" class="hash-link" aria-label="Direct link to Digging In" title="Direct link to Digging In">​</a></h2><p>Let's get to work and build this solution. We'll need some legwork done first. </p><blockquote><p>[!NOTE]<!-- -->
It's going to get deep in this article with CLI commands. You'll see what the OpenZiti objects are that get created and learn why.
You might not want to replicate the solution on your own and instead are looking for "the big reveal". If that describes you, just
skim this article lightly and get on to <a href="/blog/zitification/prometheus/part3">part3</a>. In part 3 we'll explore the deployed solution and see what makes it so
interesting and cool.</p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a href="#prerequisites" class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites">​</a></h3><p><img loading="lazy" src="https://github.com/openziti/branding/raw/main/images/ziggy/svg/Ziggy%20The%20Construction%20Worker.svg" alt="construction worker" class="img_ev3q"></p><ul><li>You have an OpenZiti overlay network available. If not, for this scenario you will want to use
<a href="/docs/learn/quickstarts/network/hosted">"host your own"</a>. You'll also want to have the ziti cli tool on your path</li><li>Two Kubernetes clusters provisioned</li><li>Necessary tooling installed and available on the path<ul><li>kubectl</li><li>helm</li></ul></li><li>bash/zsh shell - tested in bash and some commands will use variables. If you use another shell, change accordingly</li><li>a machine with <a href="https://docs.docker.com/get-docker/" target="_blank" rel="noopener noreferrer">docker installed</a> to run the final Prometheus sever on (your local machine is fine)</li><li>Ziti Desktop Edge installed on the development machine. I use
<a href="https://github.com/openziti/desktop-edge-win/releases/latest/" target="_blank" rel="noopener noreferrer">Ziti Desktop Edge for Windows</a>.</li><li>A temporary folder exists to house files as we need them: /tmp/prometheus</li></ul><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="clustera---using-ziti-host">ClusterA - Using <code>ziti-host</code><a href="#clustera---using-ziti-host" class="hash-link" aria-label="Direct link to clustera---using-ziti-host" title="Direct link to clustera---using-ziti-host">​</a></h2><p><img loading="lazy" alt="clusterA" src="/assets/images/clusterA-71f957b6205e44af29d35d4d65efc06b.svg" width="349" height="505" class="img_ev3q"></p><p>We start with an empty OpenZiti network, and two empty Kubernetes clusters. Let's start by populating ClusterA. We will deploy three
pods into this Kubernetes cluster. When done, the Kubernetes cluster will look similar to the image to the right.</p><ul><li>Pod 1. <strong>ziti-host</strong>. This pod will provide what is effectively the equivalent of a Kubernetes ingress controller. We'll install this
using helm from a NetFoundry provided chart</li><li>Pod 2. <strong>prometheuz</strong>. This pod will be our Prometheus server with OpenZiti embedded in it. We won't use OpenZiti to listen on the
overlay network. Instead, we will follow a more traditional model of listening on the underlay at a known ip:port combination. We'll
install this pod using a chart from the OpenZiti charts repository.</li><li>Pod 3. <strong>reflectz</strong>. This pod represents the workload which we want to monitor. This is another chart provided by the OpenZiti chart
repository and will also be installed with helm. If you are interested in viewing the source code for this project you can find it on
<a href="https://github.com/nf-npieros/sdk-golang/tree/feature/reflect-prometheus" target="_blank" rel="noopener noreferrer">GitHub here</a></li></ul><blockquote><p>[!NOTE]<!-- -->
Running the ziti cli commands shown below as shown will expect you to have the ziti binary on your path. Also it is expected that all
the commands run will run from the same "development" machine with the expected tools available. Reach out on discourse if you get stuck.</p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pod-1---ziti-host">Pod 1 - <code>ziti-host</code><a href="#pod-1---ziti-host" class="hash-link" aria-label="Direct link to pod-1---ziti-host" title="Direct link to pod-1---ziti-host">​</a></h3><p>We will start off deploying Pod 1, ziti-host, to provide access to Kubernetes ClusterA.  The ziti-host pod will require a single
identity to be provisioned. We will use a shortened name for the cluster and we'll embed that name into the identity to make it easier
for us to understand what identity we provisioned and why, should we ever need to reference these identities later.  We'll refer to
ClusterA as simply "kubeA". Let's make the identity now. Notice we are also passing the "-a" attribute during creation to add a role
attribute to the identity of <code>kubeA.services</code>. This will be used later when setting up policies.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-the-identity">Create the Identity<a href="#create-the-identity" class="hash-link" aria-label="Direct link to Create the Identity" title="Direct link to Create the Identity">​</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create identity device kubeA.ziti.id -o /tmp/prometheus/kubeA.ziti.id.jwt -a "kubeA.services"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You should see confirmation output such as:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">New identity kubeA.ziti.id created with id: BeyyFUZFDR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Enrollment expires at 2022-04-22T01:18:53.402Z</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-ziti-host-into-clustera">Deploy <code>ziti-host</code> into ClusterA<a href="#deploy-ziti-host-into-clustera" class="hash-link" aria-label="Direct link to deploy-ziti-host-into-clustera" title="Direct link to deploy-ziti-host-into-clustera">​</a></h4><p>Once created, we can use helm to install the <code>ziti-host</code> pod. The jwt is a one-use token and will be useless after being consumed by
<code>ziti-host</code>. As this is probably your first time running this helm chart, you will need to install it. The command is idempotent to
running it over and over is of no concern. Run the following:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">helm repo add netfoundry https://netfoundry.github.io/charts/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm repo update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm install ziti-host netfoundry/ziti-host --set-file enrollmentToken="/tmp/prometheus/kubeA.ziti.id.jwt"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You will see the confirmation output from helm. Now when you look at your Kubernetes cluster with <code>kubectl</code>, you will see a pod deployed:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                        READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti-host-db55b5c4b-rpc7f   1/1     Running   0          2m40s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Awesome, we have our first deployed pod. It's useless at the moment as we have defined no services, nor authorized any services. Right
now there's nothing to connect to, so we can simply move on and install the next pod, <code>reflectz</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pod-2---reflectz">Pod 2 - <code>reflectz</code><a href="#pod-2---reflectz" class="hash-link" aria-label="Direct link to pod-2---reflectz" title="Direct link to pod-2---reflectz">​</a></h3><p>The first pod we want to have access to is the <code>reflectz</code> pod. It is a workload we will deploy that will do two things. First, it will
listen on the OpenZiti overlay network for connections. When a connection is made, and when bytes are sent, the workload sill simply
return back to the caller whatever was sent to it adding "you sent me: " to the payload. It's not much, but it's a demo after all. The
second service provided is a scrape target for Prometheus. There is one metric exposed by <code>reflectz</code> we will care about, the total number of connections established to this workload. This pod also needs an identity provisioned, and this time around we will also provision some services. We will also use the <code>ziti</code> cli to enroll this identity. This helm chart wants you to provide an enrolled identity as part of the helm command. Let's do all this now.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-and-enroll-the-identity">Create and Enroll the Identity<a href="#create-and-enroll-the-identity" class="hash-link" aria-label="Direct link to Create and Enroll the Identity" title="Direct link to Create and Enroll the Identity">​</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create identity user kubeA.reflect.id -o /tmp/prometheus/kubeA.reflect.id.jwt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge enroll /tmp/prometheus/kubeA.reflect.id.jwt -o /tmp/prometheus/kubeA.reflect.id.json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-configs-and-services-including-tunneling-based-access">Create Configs and Services (including Tunneling-based Access)<a href="#create-configs-and-services-including-tunneling-based-access" class="hash-link" aria-label="Direct link to Create Configs and Services (including Tunneling-based Access)" title="Direct link to Create Configs and Services (including Tunneling-based Access)">​</a></h4><p>The <code>reflectz</code> chart also needs two services to be declared and specified at the time of the helm chart installation. We will want to be
able to test the service to ensure they work. To enable testing the services, we will create two configs of type <code>intercept.v1</code>. This
will allow identities using tunneling apps to be able to access the services, this is how we'll verify the services work. Make the
configs and services now.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create intercept configs for the two services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config kubeA.reflect.svc-intercept.v1 intercept.v1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  '{"protocols":["tcp"],"addresses":["kubeA.reflect.svc.ziti"],"portRanges":[{"low":80, "high":80}]}'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config "kubeA.reflect.svc-intercept.v1.scrape" intercept.v1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  '{"protocols":["tcp"],"addresses":["kubeA.reflect.scrape.svc.ziti"], "portRanges":[{"low":80, "high":80}], "dialOptions":{"identity":"kubeA.reflect.id"}}'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># create the two services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service "kubeA.reflect.svc" --configs "kubeA.reflect.svc-intercept.v1" -a "kubeA.reflect.svc.services"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service "kubeA.reflect.scrape.svc" --configs "kubeA.reflect.svc-intercept.v1.scrape"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="authorize-the-workload-and-clients">Authorize the Workload and Clients<a href="#authorize-the-workload-and-clients" class="hash-link" aria-label="Direct link to Authorize the Workload and Clients" title="Direct link to Authorize the Workload and Clients">​</a></h4><p>Services are not valuable if there are no identities which can use the services. The identity used in the helm installation will also
need to be authorized to bind these services. Tunneling apps will need to be authorized to dial these services but also remember
Prometheus servers will need to be able to dial these services too. We will now create <code>service-policies</code> to authorize the tunneling
clients, Prometheus scrapes, and the <code>reflectz</code> server to bind the service.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create the bind service policies and authorize the reflect id to bind these services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy "kubeA.reflect.svc.bind" Bind \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles "@kubeA.reflect.svc" --identity-roles "@kubeA.reflect.id"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy "kubeA.reflect.scrape.svc.bind" Bind \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles "@kubeA.reflect.scrape.svc" --identity-roles "@kubeA.reflect.id"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># create the dial service policies and authorize the reflect id to bind these services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy "kubeA.reflect.svc.dial" Dial \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles "@kubeA.reflect.svc" --identity-roles "#reflectz-clients"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy "kubeA.reflect.svc.dial.scrape" Dial \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles "@kubeA.reflect.scrape.svc" --identity-roles "#reflectz-clients"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-reflectz">Deploy <code>reflectz</code><a href="#deploy-reflectz" class="hash-link" aria-label="Direct link to deploy-reflectz" title="Direct link to deploy-reflectz">​</a></h4><p>With the identity enrolled, we can now install the helm chart from openziti, and install our demonstration workload: <code>reflectz</code>. Notice
that to deploy <code>reflectz</code> we need to supply an identity to the workload using <code>--set-file reflectIdentity</code>. This identity will be used
to 'Bind' the services the workload exposes. We also need to define what the service names are we want to allow that identity to bind.
We do this using the <code>--set serviceName</code> and <code>--set prometheusServiceName</code> flags.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">helm repo add openziti-test-kitchen https://openziti-test-kitchen.github.io/helm-charts/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm repo update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm install reflectz openziti-test-kitchen/reflect \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set-file reflectIdentity="/tmp/prometheus/kubeA.reflect.id.json" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set serviceName="kubeA.reflect.svc" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set prometheusServiceName="kubeA.reflect.scrape.svc"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After running helm, pod 2 should be up and running. Let's take a look using <code>kubectl</code></p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                        READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reflectz-775bd45d86-4sjwh   1/1     Running   0          7s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti-host-db55b5c4b-rpc7f   1/1     Running   0          4m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pod-3---prometheuz">Pod 3 - <code>Prometheuz</code><a href="#pod-3---prometheuz" class="hash-link" aria-label="Direct link to pod-3---prometheuz" title="Direct link to pod-3---prometheuz">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="overlay-work---setting-up-openziti">Overlay Work - Setting Up OpenZiti<a href="#overlay-work---setting-up-openziti" class="hash-link" aria-label="Direct link to Overlay Work - Setting Up OpenZiti" title="Direct link to Overlay Work - Setting Up OpenZiti">​</a></h4><p>Now we have access to the cluster and a workload to monitor. Now we want to deploy Prometheus and monitor this workload. Remember that
the workload only exposes a scrape target over the OpenZiti overlay. For Prometheus to be able to scrape the workload, even when
resident inside the Kubernetes cluster (!), Prometheus will need to be OpenZiti-enabled. That will require a few things. We'll need a
new identity for Prometheus, we'll need to authorize Prometheus to access the workload's target, and we'll need to configure Prometheus
to scrape that workload. When we create this identity we'll assign two attributes. The <code>reflectz-clients</code> attribute gives this identity
the ability to dial the two services defined above. The <code>prometheus-clients</code> attribute is currently unused. We'll put that to use later,
but we can define it now.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-and-enroll-the-identity-1">Create and Enroll the Identity<a href="#create-and-enroll-the-identity-1" class="hash-link" aria-label="Direct link to Create and Enroll the Identity" title="Direct link to Create and Enroll the Identity">​</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create and enroll the identity.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create identity user kubeA.prometheus.id -o /tmp/prometheus/kubeA.prometheus.id.jwt -a "reflectz-clients","prometheus-clients"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge enroll /tmp/prometheus/kubeA.prometheus.id.jwt -o /tmp/prometheus/kubeA.prometheus.id.json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-configs-and-services-including-tunneling-based-access-1">Create Configs and Services (including Tunneling-based Access)<a href="#create-configs-and-services-including-tunneling-based-access-1" class="hash-link" aria-label="Direct link to Create Configs and Services (including Tunneling-based Access)" title="Direct link to Create Configs and Services (including Tunneling-based Access)">​</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create the config and service for the kubeA prometheus server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config "kubeA.prometheus.svc-intercept.v1" intercept.v1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  '{"protocols":["tcp"],"addresses":["kubeA.prometheus.svc"],"portRanges":[{"low":80, "high":80}]}'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config "kubeA.prometheus.svc-host.v1" host.v1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  '{"protocol":"tcp", "address":"prometheuz-prometheus-server","port":80}'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service "kubeA.prometheus.svc" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --configs "kubeA.prometheus.svc-intercept.v1","kubeA.prometheus.svc-host.v1"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="authorize-the-workload-and-clients-1">Authorize the Workload and Clients<a href="#authorize-the-workload-and-clients-1" class="hash-link" aria-label="Direct link to Authorize the Workload and Clients" title="Direct link to Authorize the Workload and Clients">​</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># grant the prometheus clients the ability to dial the service and the kubeA.prometheus.id the ability to bind</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy "kubeA.prometheus.svc.dial" Dial \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles "@kubeA.prometheus.svc" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --identity-roles "#prometheus-clients"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy "kubeA.prometheus.svc.bind" Bind \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles "@kubeA.prometheus.svc" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --identity-roles "@kubeA.ziti.id"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="deploying-prometheuz-1">Deploying <code>Prometheuz</code><a href="#deploying-prometheuz-1" class="hash-link" aria-label="Direct link to deploying-prometheuz-1" title="Direct link to deploying-prometheuz-1">​</a></h4><p>With our services, configs and service-policies in place we are now ready to start our Prometheus server. Remember this server will not
listen on a the OpenZiti overlay. It's going to listen exclusively on the underlay. We are still exploring OpenZiti, and we are not yet
comfortable deploying our Prometheus server dark. We'll change this soon, don't worry. For now, we'll imagine that we're still
evaluating the tech and chose to deploy it on the underlay, not on the overlay. </p><p>Although Prometheus is listening on the underlay, we <strong>have</strong> deployed our workload listening on the overlay network. It won't be
available on the underlay at all. The workload has <strong>no listening ports</strong>. This means that we'll still need an OpenZiti-enabled
Prometheus to access and scrape that workload. To do this we'll use helm, and use a chart provided by the OpenZiti charts repo.</p><p>Some interesting things to notice below in the <code>helm install</code> command. Notice that we are passing helm two <code>--set</code> parameters. These
parameters are informing the helm chart that the Prometheus server is not "zitified", meaning it will be accessible via the underlay
network. We're also passing one <code>--set-file</code> parameter to tell Prometheus what identity we want to be stored in the pod (as a secret).
This secret will be used when we configure Prometheus to scrape the workload. Go ahead and run this command now and run
<code>kubectl get pods</code> until all the containers are running.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">helm repo add openziti-test-kitchen https://openziti-test-kitchen.github.io/helm-charts/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm repo update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm install prometheuz openziti-test-kitchen/prometheus \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set server.ziti.enabled="false" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set-file server.scrape.id.contents="/tmp/prometheus/kubeA.prometheus.id.json"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="clusterb---fully-dark">ClusterB - Fully Dark<a href="#clusterb---fully-dark" class="hash-link" aria-label="Direct link to ClusterB - Fully Dark" title="Direct link to ClusterB - Fully Dark">​</a></h2><p><img loading="lazy" alt="clusterB" src="/assets/images/clusterB-9e8019e9f78c665bd67f52585250b986.svg" width="349" height="447" class="img_ev3q"></p><p>Now that we have deployed our first Kubernetes cluster, it's now time to deploy the second Kubernetes cluster. This time, we are going
to keep our entire deployment <strong>fully dark</strong>! There will be no listening ports, not even local to the Kubernetes cluster itself. To get
any traffic to this Prometheus server, you will need a strong identity and need to be authorized on the OpenZiti overlay. When complete,
ClusterB will look like the image to the right.</p><p>This time, "Pod1" will be the <code>reflectz</code> workload. Since this is a <strong>fully dark</strong> deployment, listening entirely on the OpenZiti overlay,
we won't need a <code>ziti-host</code> pod. Remember, in ClusterA <code>ziti-host</code> is used to provide internal access to the Kubernetes cluster via the
OpenZiti overlay. It's similar in role to an ingress controller, but doesn't require you to expose your workloads to the internet. While
that's pretty good we want to go fully dark this time. We'll have no <code>ziti-host</code>. We'll only need to deploy two pods: <code>reflectz</code> and
<code>prometheuz</code>.</p><p>The good news is that the same commands you've run for ClusterA, will mostly be used for ClusterB. You will want to beware that where
you used "kubeA" before, make sure you change those to "kubeB". There will be small other changes we'll make along the way too, we'll see
those changes and explain them below. </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pod1---reflectz">Pod1 - <code>reflectz</code><a href="#pod1---reflectz" class="hash-link" aria-label="Direct link to pod1---reflectz" title="Direct link to pod1---reflectz">​</a></h3><p>The <code>relectz</code> workload we'll deploy for ClusterB will be nearly identical to the ClusterA workload. We will create a service for
the actual 'reflect' service. We will make a service for Prometheus to scrape the workload. We'll also need another identity, so
we'll create that identity, authorize it to bind the services, and authorize clients to access the workload. Since this process is very
similar to what we did for ClusterA, there's not much to explain. Setup ClusterB's <code>reflectz</code> now.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-the-identity-1">Create the Identity<a href="#create-the-identity-1" class="hash-link" aria-label="Direct link to Create the Identity" title="Direct link to Create the Identity">​</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create identity user kubeB.reflect.id -o /tmp/prometheus/kubeB.reflect.id.jwt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge enroll /tmp/prometheus/kubeB.reflect.id.jwt -o /tmp/prometheus/kubeB.reflect.id.json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-configs-and-services-including-tunneling-based-access-2">Create Configs and Services (including Tunneling-based Access)<a href="#create-configs-and-services-including-tunneling-based-access-2" class="hash-link" aria-label="Direct link to Create Configs and Services (including Tunneling-based Access)" title="Direct link to Create Configs and Services (including Tunneling-based Access)">​</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create intercept configs for the two services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config kubeB.reflect.svc-intercept.v1 intercept.v1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  '{"protocols":["tcp"],"addresses":["kubeB.reflect.svc.ziti"],"portRanges":[{"low":80, "high":80}]}'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config "kubeB.reflect.svc-intercept.v1.scrape" intercept.v1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  '{"protocols":["tcp"],"addresses":["kubeB.reflect.scrape.svc.ziti"], "portRanges":[{"low":80, "high":80}], "dialOptions":{"identity":"kubeB.reflect.id"}}'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># create the two services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service "kubeB.reflect.svc" --configs "kubeB.reflect.svc-intercept.v1" -a "kubeB.reflect.svc.services"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service "kubeB.reflect.scrape.svc" --configs "kubeB.reflect.svc-intercept.v1.scrape"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="authorize-the-workload-to-bind-the-services">Authorize the Workload to Bind the Services<a href="#authorize-the-workload-to-bind-the-services" class="hash-link" aria-label="Direct link to Authorize the Workload to Bind the Services" title="Direct link to Authorize the Workload to Bind the Services">​</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create the bind service policies and authorize the reflect id to bind these services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy "kubeB.reflect.svc.bind" Bind \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles "@kubeB.reflect.svc" --identity-roles "@kubeB.reflect.id"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy "kubeB.reflect.scrape.svc.bind" Bind \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles "@kubeB.reflect.scrape.svc" --identity-roles "@kubeB.reflect.id"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="authorize-clients-to-access-the-services">Authorize Clients to Access the Services<a href="#authorize-clients-to-access-the-services" class="hash-link" aria-label="Direct link to Authorize Clients to Access the Services" title="Direct link to Authorize Clients to Access the Services">​</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create the dial service policies and authorize the reflect id to bind these services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy "kubeB.reflect.svc.dial" Dial \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles "@kubeB.reflect.svc" --identity-roles "#reflectz-clients"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy "kubeB.reflect.svc.dial.scrape" Dial \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles "@kubeB.reflect.scrape.svc" --identity-roles "#reflectz-clients"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-reflectz-1">Deploy <code>reflectz</code><a href="#deploy-reflectz-1" class="hash-link" aria-label="Direct link to deploy-reflectz-1" title="Direct link to deploy-reflectz-1">​</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">helm repo add openziti-test-kitchen https://openziti-test-kitchen.github.io/helm-charts/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm repo update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm install reflectz openziti-test-kitchen/reflect \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set-file reflectIdentity="/tmp/prometheus/kubeB.reflect.id.json" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set serviceName="kubeB.reflect.svc" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set prometheusServiceName="kubeB.reflect.scrape.svc"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pod-2---prometheuz">Pod 2 - <code>Prometheuz</code><a href="#pod-2---prometheuz" class="hash-link" aria-label="Direct link to pod-2---prometheuz" title="Direct link to pod-2---prometheuz">​</a></h3><p>For ClusterB we want <code>Prometheuz</code> to be <strong>totally dark</strong>. It will exclusively listen on the OpenZiti overlay and there will be no
listening ports on the underlay. We will need another identity, of course, and most of the configuration and commands appear the same on
the surface with very subtle differences. We'll explore these differences as we go. In this section we'll be making an identity, <strong>one
config</strong> (a difference from the ClusterA install), a service, and two service-policies. Let's get to it.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-the-identity-2">Create the Identity<a href="#create-the-identity-2" class="hash-link" aria-label="Direct link to Create the Identity" title="Direct link to Create the Identity">​</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create identity user kubeB.prometheus.id -o /tmp/prometheus/kubeB.prometheus.id.jwt -a "reflectz-clients","prometheus-clients"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge enroll /tmp/prometheus/kubeB.prometheus.id.jwt -o /tmp/prometheus/kubeB.prometheus.id.json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-one-config-and-service">Create <strong>One</strong> Config and Service<a href="#create-one-config-and-service" class="hash-link" aria-label="Direct link to create-one-config-and-service" title="Direct link to create-one-config-and-service">​</a></h4><p>Here's a difference from ClusterA. Since we are going to listen on the OpenZiti overlay, we are not installing <code>ziti-host</code>. That means
we don't need to create a <code>host.v1</code> config. A <code>host.v1</code> config is necessary for services which have a 'Bind' configuration and are being
bound by a tunneling application. We're not doing that, here Prometheus will 'Bind' this service, thus we don't need that <code>host.v1</code>
config.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create the config and service for the kubeB prometheus server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config "kubeB.prometheus.svc-intercept.v1" intercept.v1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  '{"protocols":["tcp"],"addresses":["kubeB.prometheus.svc"],"portRanges":[{"low":80, "high":80}], "dialOptions": {"identity":"kubeB.prometheus.id"}}'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># no need for the host.v1 config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service "kubeB.prometheus.svc" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --configs "kubeB.prometheus.svc-intercept.v1"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="authorize-clients-and-prometheus-to-bind-the-service">Authorize Clients and Prometheus to Bind the Service<a href="#authorize-clients-and-prometheus-to-bind-the-service" class="hash-link" aria-label="Direct link to Authorize Clients and Prometheus to Bind the Service" title="Direct link to Authorize Clients and Prometheus to Bind the Service">​</a></h4><p>At first, these commands appear identical. You need to look very closely to notice the difference between these command and the ones we
ran for ClusterA, other than the obvious changes from "kubeA" to "kubeB". Pay close attention to the supplied <code>--identity-roles</code> for the
bind policy specified below. With ClusterA, we did not have Prometheus listen on the overlay and we allowed Prometheus to listen on the
underlay. That meant we needed to deploy <code>ziti-host</code> into that cluster to provide access to the service, and that means the service had
to be bound by the <code>ziti-host</code> identity.</p><p>Here we are flipping that script. We are allowing Prometheus to bind this service! That means we'll need to authorize the
<code>kubeB.prometheus.id</code> to be able to bind the service.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># grant the prometheus clients the ability to dial the service and the kubeB.prometheus.id the ability to bind</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy "kubeB.prometheus.svc.dial" Dial \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles "@kubeB.prometheus.svc" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --identity-roles "#prometheus-clients"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy "kubeB.prometheus.svc.bind" Bind \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles "@kubeB.prometheus.svc" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --identity-roles "@kubeB.prometheus.id"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="deploying-prometheuz">Deploying <code>Prometheuz</code><a href="#deploying-prometheuz" class="hash-link" aria-label="Direct link to deploying-prometheuz" title="Direct link to deploying-prometheuz">​</a></h4><p>At this point we have the OpenZiti overlay all configured. What's left, is to deploy Prometheus into ClusterB. This command is substantially
different from what we ran while deploying Prometheus into ClusterA. You'll see that we need to supply two other identities for this
installation. Remember, Prometheus will be entirely dark once deployed into ClusterB, listening only on the OpenZiti overlay. The container
in the pod which monitors configmap changes won't be able to trigger a webhook using the underlay! This <code>configmap-reloadz</code> is a second
"zitification" we didn't realize we were deploying in ClusterA, because we did not need it. We need it for ClusterB.</p><p>You'll see for configmapReload we need to supply the identity which the container will use to hit the Prometheus webhook. We do that by
passing <code>--set-file configmapReload.ziti.id.contents="/tmp/prometheus/kubeB.prometheus.id.json"</code>. Then we'll supply the service which
<code>configmap-reloadz</code> will dial, and we'll also specify what identity we expect to be hosting the service.</p><p>Next you'll see we need to supply the identity to the Prometheus server we want to allow to listen on the OpenZiti overlay (
<code>-set-file server.ziti.id.contents</code>). Similar to <code>configmap-reloadz</code> we will also specify the service and identity name to bind.</p><p>Finally, to allow the server to scrape targets we need to supply a final identity which will be used when scraping targets with
<code>--set-file server.scrape.id.contents</code>.</p><p>You'll notice for simplicities sake, we are using the same identity for all three needs which is perfectly fine. If you wanted to use a
different identity, you could. That choice is up to you. To keep it simple we just authorized this identity for all these purposes.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># install prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm repo add openziti-test-kitchen https://openziti-test-kitchen.github.io/helm-charts/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm repo update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm install prometheuz openziti-test-kitchen/prometheus \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set-file configmapReload.ziti.id.contents="/tmp/prometheus/kubeB.prometheus.id.json" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       --set configmapReload.ziti.targetService="kubeB.prometheus.svc" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       --set configmapReload.ziti.targetIdentity="kubeB.prometheus.id" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set-file server.ziti.id.contents="/tmp/prometheus/kubeB.prometheus.id.json" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       --set server.ziti.service="kubeB.prometheus.svc" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       --set server.ziti.identity="kubeB.prometheus.id" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set-file server.scrape.id.contents="/tmp/prometheus/kubeB.prometheus.id.json"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="whats-next">What's Next<a href="#whats-next" class="hash-link" aria-label="Direct link to What's Next" title="Direct link to What's Next">​</a></h2><p>In this article we've done a lot of OpenZiti CLI work, run some <code>kubectl</code> and <code>helm</code> commands but we still haven't explored what it is
we are building and why it's so cool. We'll do that in the <a href="/blog/zitification/prometheus/part3">last, and final</a> article. Hopefully, the payoff for you will be
as rewarding as it was for me while building this article series.</p><hr><h4 class="anchor anchorWithStickyNavbar_LWe7" id="addendum---a-quicker-start">Addendum - a Quicker Start<a href="#addendum---a-quicker-start" class="hash-link" aria-label="Direct link to Addendum - a Quicker Start" title="Direct link to Addendum - a Quicker Start">​</a></h4><p>All the commands above are also available in github as <code>.sh</code> scripts. If you would prefer, you can clone the
<a href="https://github.com/openziti/ziti-doc" target="_blank" rel="noopener noreferrer">ziti-doc repository</a> and access the scripts from the path mentioned below. "Cleanup" scripts are
provided if desired. </p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">${checkout_root}/docusaurus/blog/zitification/prometheus/scripts</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content>
        <author>
            <name>Clint Dovholuk</name>
            <uri>https://github.com/dovholuknf</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Scraping Anything, Anywhere in Action]]></title>
        <id>https://openziti.io/blog/zitification/prometheus/part3</id>
        <link href="https://openziti.io/blog/zitification/prometheus/part3"/>
        <updated>2023-10-14T16:50:51.000Z</updated>
        <summary type="html"><![CDATA[_This is part three of a three-part article. This article builds on the previous two articles. Here we will take a look at what we built]]></summary>
        <content type="html"><![CDATA[<p><em>This is part three of a three-part article. This article builds on the previous two articles. Here we will take a look at what we built
and use it to explore the power of a zitified Prometheus. See <a href="/blog/zitification/prometheus/part1">part one</a> for the necessary background about the series. See
<a href="/blog/zitification/prometheus/part2">part two</a> for detailed instructions covering how to setup the environment you're about to explore</em></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-payoff">The Payoff<a href="#the-payoff" class="hash-link" aria-label="Direct link to The Payoff" title="Direct link to The Payoff">​</a></h2><p>Ok. Here it is. We are at the end of the series and here is where we'll put it all together and really start to understand the sort of
innovations you can create when you zitify an application. As a reminder, we are working with <a href="https://prometheus.io/" target="_blank" rel="noopener noreferrer">Prometheus</a>, a
CNCF project which we will use to monitor a workload deployed in two separate <a href="https://kubernetes.io" target="_blank" rel="noopener noreferrer">Kubernetes</a> clusters. To save you
from flipping back to a previous article, here is what that solution looks like.</p><p><img loading="lazy" alt="overview" src="/assets/images/kubernetes-prometheus-after-1c432161cd5ceac47eadc4149cae35fb.svg" width="1264" height="531" class="img_ev3q"></p><p>Now we are ready to start using our Prometheus servers. We'll use our OpenZiti overlay network to connect to a workload which will
generate a metric we want to display in Prometheus. We'll then configure Prometheus to scrape the workload and put it on a graph to
prove it works. Once that's complete, we'll play around with the setup and see if we really can scrape anything, anywhere. Let's begin.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="developer-access">Developer Access<a href="#developer-access" class="hash-link" aria-label="Direct link to Developer Access" title="Direct link to Developer Access">​</a></h2><p>In the <a href="/blog/zitification/prometheus/part2">previous article</a>, we established our entire solution using the OpenZiti overlay, <code>kubectl</code> and <code>helm</code>. We saw
everything get installed and it all "seems to work". But how do we <strong>know</strong> it works?  Let's provision an identity for yourself now and
let's enroll it in your local tunneling app and find out. Go out and get <a href="/docs/learn/core-concepts/clients/choose">a tunneling client</a> running
locally. Once you have that installed, provision an identity and enroll it with your tunneling client. </p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create identity user dev.client -a "prometheus-clients","reflectz-clients"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You should have access to six total services when this identity is enrolled:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Service Name: kubeA.prometheus.svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Intercept: kubeA.prometheus.svc:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Service Name: kubeA.reflect.svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Intercept: kubeA.reflect.svc.ziti:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Service Name: kubeA.reflect.scrape.svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Intercept: kubeA.reflect.scrape.svc.ziti:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Service Name: kubeB.prometheus.svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Intercept: kubeB.prometheus.svc:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Service Name: kubeB.reflect.svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Intercept: kubeB.reflect.svc.ziti:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Service Name: kubeB.reflect.scrape.svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Intercept: kubeB.reflect.scrape.svc.ziti:80</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="clustera">ClusterA<a href="#clustera" class="hash-link" aria-label="Direct link to ClusterA" title="Direct link to ClusterA">​</a></h2><p>With your developer access you should be able to navigate your browser to <a href="http://kubea.prometheus.svc/targets" target="_blank" rel="noopener noreferrer">http://kubea.prometheus.svc/targets</a>. </p><blockquote><p>[!NOTE]<!-- -->
We won't dwell on this for long in this article but notice that this is showing off another superpower of OpenZiti, private DNS.
Notice that you were able to browse to a totally fictitious domain name: kubea.prometheus.svc. ".svc" is <strong>not</strong> a legitimate top level
domain.
<a href="https://en.wikipedia.org/wiki/List_of_Internet_top-level_domains#S" target="_blank" rel="noopener noreferrer">Look at the full list of top level domains starting with S</a>. You
won't find ".svc" on that list at this time</p></blockquote><p><img loading="lazy" alt="kubea.prom.init" src="/assets/images/kubea.prom.init-4d7855b727621c1778b9a8a6b6d7a25d.png" width="510" height="433" class="img_ev3q"></p><p>You should see the following. You might have noticed that the chart deployed has a few other containers we have not discussed yet. We'll
not go into those containers in this article. What's important is that this Prometheus server has a few targets already for us to access.
Neat, but this isn't what we want to actually monitor.</p><p>What we really want to monitor is the workload we deployed: <code>reflectz</code>. We can do this by editing the Prometheus configmap using
<code>kubectl</code>. Let's go ahead and do this now:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl edit cm prometheuz-prometheus-server</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This will open an editor in your terminal and allow you to update the config map for the pod. Once the editor is open, find the section
labeled "scrape_config" and add the following entry:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    - job_name: 'kubeA.reflectz'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      scrape_interval: 5s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      honor_labels: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      scheme: 'ziti'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      params:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        'match[]':</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - '{job!=""}'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        'ziti-config':</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - '/etc/prometheus/scrape.json'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      static_configs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - targets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - 'kubeA.reflect.scrape.svc-kubeA.reflect.id'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This is yaml and yaml is sensitive to spaces. The block above is properly indented for the config that the helm chart installs. You
should be able to simply copy it and add it under the scrape_config. Remember, there is a <code>configmap-reload</code> container in
the pod which monitors the configmap. On successful edit, this container will notice and will issue a web hook to the
<code>prometheus-server</code> container. The trigger is not immediate, don't worry if it takes a while. It can take around a minute for the
trigger to fire. </p><p>While we wait for the trigger, let's explain what this is doing. This is informing the Prometheus server to monitor a workload which can
be found at the provided target of <code>kubeA.reflect.scrape.svc-kubeA.reflect.id</code>. Notice that no port is included in this target, and also
notice that this is a very strange looking FQDN. That's because this is a zitified version of Prometheus. We have extended Prometheus to
understand a "scheme" of <code>ziti</code>. When we configure this job with a scheme of ziti, we can then supply targets to the job which represent
an OpenZiti service.  We need to supply the <code>ziti-config</code> node with the path to the identity we want Prometheus to use to issue the
scrape. This will always be <code>/etc/prometheus/scrape.json</code> at this time. Should the community desire it, we can look into changing the
location of the identity.</p><p>If you would like to tail the <code>configmap-reloadz</code> container, you can issue this one liner. This will instruct <code>kubectl</code> to tail the logs
from <code>configmap-reloadz</code>. </p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pod=$(kubectl get pods | grep server | cut -d " " -f1); echo POD: $pod; kubectl logs -f "$pod" prometheus-server-configmap-reload</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>When the trigger happens for ClusterA you will see a message like the one below. Notice that <code>configmap-reloadz</code> is using the underlay
network: <code>http://127.0.0.1:9090/-/reload</code></p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2022/04/23 20:01:23 config map updated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/04/23 20:01:23 performing webhook request (1/1/http://127.0.0.1:9090/-/reload)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/04/23 20:01:23 successfully triggered reload</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="config-reloaded">Config Reloaded<a href="#config-reloaded" class="hash-link" aria-label="Direct link to Config Reloaded" title="Direct link to Config Reloaded">​</a></h3><p>Once you've correctly updated the configmap, and <code>configmap-reloadz</code> detected the change and told Prometheus to reload. You'll see a new
target has been reported by Prometheus at <a href="http://kubea.prometheus.svc/targets" target="_blank" rel="noopener noreferrer">http://kubea.prometheus.svc/targets</a>. You should now see "kubeA.reflectz (1/1 up)" showing.
Congratulations! You have just successfully scraped a target from zitified Prometheus! Remember this workload does not listen on the
Kubernetes underlay network. It's only accessible from the OpenZiti overlay. </p><p><img loading="lazy" alt="kubea.target1.png" src="/assets/images/kubea.target1-8f5a33a23d13709763eeff7c98afecf1.png" width="1055" height="197" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="lets-graph-it">Let's Graph It!<a href="#lets-graph-it" class="hash-link" aria-label="Direct link to Let's Graph It!" title="Direct link to Let's Graph It!">​</a></h3><p>Cool, we have a target. The target can be scraped by Prometheus over the OpenZiti overlay. We're also able to securely access the
Prometheus UI over the same OpenZiti overlay. Let's use the Prometheus UI to graph the data point we want to see, the
<code>reflect_total_connections</code> metric. </p><ol><li>Navigate to <a href="http://kubea.prometheus.svc/graph" target="_blank" rel="noopener noreferrer">http://kubea.prometheus.svc/graph</a></li><li>enter <code>reflect_total_connections</code></li><li>click Graph (notice I changed my time to '10s', located just under Graph)</li><li>click Execute</li><li>Notice there are no connections (0)</li></ol><p><img loading="lazy" alt="grpah it" src="/assets/images/kubea.graph-a39d9acca67d92b279c388dfda2fda53.png" width="1050" height="706" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="generate-some-data">Generate Some Data<a href="#generate-some-data" class="hash-link" aria-label="Direct link to Generate Some Data" title="Direct link to Generate Some Data">​</a></h3><p>Now let's change that graph of <code>reflect_total_connections</code> from 0 to 1 (or more). One of the services you will have access to will
intercept <code>kubeA.reflect.svc.ziti:80</code>. </p><blockquote><p>[!NOTE]<!-- -->
If you are using Windows and Windows Subsystem for Linux (WSL) as I am, you <strong>might</strong> need to understand how get WSL to use your Ziti
Desktop Edge for Windows as your DNS resolver when inside WSL. Generally speaking this is as easy as editing /etc/resolv.conf and
adding the IP as the first nameserver: <code>nameserver 100.64.0.1</code> (or whatever the DNS IP is). Try it first, depending on how you setup
WSL it might 'just work' for you. You can also just use cygwin or any other netcat tool from Windows (not WSL) too.</p></blockquote><p>Now we can use netcat to open a connection through this intercept a few times. The metric tracks the total number of connections to the
reflect service. Connect, send some text, the use ctrl-c to disconnect. Do that a few times then click 'execute' again on the graph page.
You can see I did this over a minute and moved my total count on kubeA to 8, shown below.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/tmp/prometheus$ nc kubeA.reflect.svc.ziti 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeA reflect test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">you sent me: kubeA reflect test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">^C</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/tmp/prometheus$ nc kubeA.reflect.svc.ziti 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">another reflect test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">you sent me: another reflect test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">^C</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/tmp/prometheus$ nc kubeA.reflect.svc.ziti 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">another reflect test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">you sent me: another reflect test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">^C</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="kubea.more.total.conn.png" src="/assets/images/kubea.more.total.conn-056a41b592c79bd2b5efc64c4b45efbf.png" width="878" height="784" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="scrape-something-else">Scrape Something Else<a href="#scrape-something-else" class="hash-link" aria-label="Direct link to Scrape Something Else" title="Direct link to Scrape Something Else">​</a></h3><p>Hopefully you agree with me that this is pretty neat. Well what if we take it to the next level? What if we tried to scrape the
workload we deployed to ClusterB? Could we get that to work? Recall from above how we enabled the job named 'kubeA.reflectz'. What if we
simply copied/pasted that into the configmap changing kubeA --&gt; kubeB. Would it work? Let's see. </p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># edit the configmap on ClusterA:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl edit cm prometheuz-prometheus-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#add the job - and wait for the configmap to reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - job_name: 'kubeB.reflectz'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      scrape_interval: 5s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      honor_labels: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      scheme: 'ziti'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      params:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        'match[]':</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - '{job!=""}'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        'ziti-config':</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - '/etc/prometheus/scrape.json'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      static_configs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - targets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - 'kubeB.reflect.scrape.svc-kubeB.reflect.id'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After watching the logs from <code>configmap-reloadz</code> on ClusterA and seeing the webhook trigger. Just go back to the Prometheus server in
the browser. You should be at the 'graph' url but if not navigate back and execute another graph for <code>reflect_total_connections</code>. When
we do that it probably doesn't look much different but... Wait a second? In the legend? Can it be? That's right. From Kubernetes
ClusterA, we have just scraped a workload from Kubernetes ClusterB, entirely over the OpenZiti overlay.</p><p><img loading="lazy" alt="kubeA-and-kubeB.png" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAkUAAABJCAYAAAAzI1KTAAAcnElEQVR4Xu2dva7dRpLH51UsQAPYT7GvItuAJ5gNPZk3mhtcOJvUoQNb8AU29Y4TYVNLlhYDL/YJZFiDzTcSl1Vd1V1VXU02z/06V/f/Aw5Gl6dJdtfnn+Tx8A8LAAAAAABY/hA3AAAAAAA8RiCKAAAAAAAWiCIAAAAAAAaiCAAAAABggSgCAAAAAGAgigAAAAAAFogiAAAAAAAGoggAAAAAYDkgil6+fDn9AQAAAAB4aBwSRTPMjgMAAAAAOCcOi6L//c9/GX7suJvg1eXHy0dPP16eXf1z/fcny8XL93HIWUPzf2hzziDbkw9uhd+ulmerjy9+Xu308nJ58sfV55e/xFEPnndXf+JYKHFctpX48OO2eb1c/PFyeXViSL27+mL56LOr5fcT93eI3z56erm8fLv++6aO+wg5XickDuLmSSgOntyUv9Y4+JRy1sTBuzjmmpB9qP5k06W1pLVJawnF6OVr88U/l+efyfanXyzfv5WjUjzTuHU/Pz6i+3+xPP8tfhfQHFnrWTb3XcKc6BhUR55dvTt0vON1xsB2XH175IRDVtt9/gnb/uLlGsNPT4/hGV5d/mn10bvVX8VXrCcm4v58RREFhEmw64iimaCYGaPMjj1e7M6Du5y3FjU+mxSyZz+cWlapWXxyehG6Re5fFFExv1wubsi3bu7UGCeKTYrk+Un7fiAcz7friKKbjgNTl0PNPsSJMZSLIrLP2ghZ8BQRY3PO1Rs952FRNGH/D0AUkbC4uCQbn+RVD9m72vY6oojElfp3TBRFLRa294MoEmbGKLNjjxe78+Au501FbcaWU1DSyZ2mu5n9PPcuikyBpcJ0yiEsEEU3x/F8u4Yokjh4f2NxcIaiKByrjYmN2DTXaVF0gAcvilZ7fb768+01/Gq5d1E0l2t3LIqKIZ7Tbfx6+7HdUuPbavQYRYNJbnGWW18h+er33rA07ol8R3ccyAh6bLp1ljk2HUOJpbdf+XZfNvYHTjwKVD2nnc++A+ytXFk7QUlQj2du00qyv6Lb3+G7kviv1+OJLWVuhcF5lmIv3V4eU/brs43c294eS4LczL0lYvCxCREniihp9E6RnmcN6Ha+dhuXbF7nSXb4ezuvHevW8zRcJdK5PqNYlO9tfAz8733jbXkUW6xK3CaPIFyjkWb4c3s04BqCm7O/5d3sPBZWJYauVj9+3Aq52Mnax9mUxsWGZm1kt4f5vRrGUoEf99XzaANPYkls9JznRev2Y1qTkxi19nN3Jcd5kn7/kv72F2uuSTs72Hz02DqhcfCKz2Uf0dhGID40x9+KA1sfZ+Kgt+fS+VTjoNY9iQMXu6P1x/pNf9tcC3b3TZ3mrb4tvaSs3dor3imS7XF+S+grU2gMNLv6+m98oX5wNcz69DhWFJUaqP3R11W7rvIdxX7iiyyflNV/n3K9lNhL513i6PkPpqcH/2r81DrCtguiaFi7Yk6SyPG57epEt79nvyffiyiyCSwBWxWfJCr9MwRwdbIUYJd4UvT4WXly9RMDJsONYQeFeZlg3jqeLYp7DqDvu2flXEh8sDzTvyVwqJCXpPjCrb09Iy+BXs4di2srhpzMyVVRnHcVRTyXeCxTqCVIGVqHNkRKiMQvhLOlJI4XRcXX7FuKHVq7Jlice92eXZm1YuaSVH6/pI1e11mKWWhk7BudrxaTpGnUz6iQFHTtLm5jfLs8kIZQ12fiUsZZYTK6Khs1ghJDJvaC3/rYli9kzupr65eyD8WrjRVDnHclFE2B5t5dKUus5DkZmiXHqLEfzYm/G+dJJaxNtzUbhQaczD9D803zsTuW/u1EEcWB9W87bydQD8ZBtae5SLN1wsfB4E5RFwfazH0trcR5G1qslZxr/i/+7EXR0nLYxoXLpcLQBkPyOuJqss6pzkHG1rrSLry5xoVPFIWWakc6r+uPPv6jKLJ53XLIxhRh48N/V84bH1MSJRZ1/Z2NbX6MalL0vRmnPdIT593Y82c53vadtnsQRbZQSJHKGkkwbl2sBKHbh8dFgdWIAZMRm3NRyI1hQ2CkSOl8jEPHDoq2KJTHLH5bPV8MHmMjnZ9+pckzsvH3b+W24tBebXsVRatdYoD6Yhd9K01FikH8rZC7qibEt04UaRKp3/XOhLvq8PtHUaSCp629xZHOyRYzFWCxOPnjhOOdACco3akywkN9PBZFvlFXG67r6ea2irqsQblCZYj+iFfA/HGxLQNNXKod/T6/jB/XyPr6ZijNxzWxfv1MLMSExoLMoczVxKTQiv0oT8xgiUmfA2ZO9L3YJ9pSoVzS49t60sVBbPKdKPK1o+Z/WDd/1DaTcRB9sh0HuSjaioNOWBKxthlarL0uj3Oy+LfQusyxamNN4mSvifZ4UUT7P7FxYuuW1qlaj4qoczXrIByvFCvBVrEnRVHkekq1dehb/BmI68R2hZCTgzpkL47rfmqHNGapdsWeogxE0cu+b/cM9jWcgShKihwRnOBEUZZUG8fqgiLhdFFEQWGMbJI+igvHIMhuRxRlgTVoMEs/72uLIjOWAt4nr7f7lCjiDVqcykfn58boMWReRdRcVxQlV7knUpth8OnJoihrcIvOO376W8yxwTTf9ji/mbiMx1CGx5L1Zc2QMXHQPaazY6zNyLdmnGuqSUw2UZTlSY/Giq5fa1PNE962X3OUNA6uI4quGQfRJ62W9GyJonEc9Nu72mYY1r8lP08ndOq8ov/3G2TP/YuiJ2tc8F1IM+0Yb/OiKO8BqRBOa184htShFInNgsm3UczGvK4kfturIwLnWlaHDIdF0R7b42LhKQGWTjIYpDqZAy1zTlnwk+TRSRcUCV2Rn318xmNbUHDhmRFFde0HH59ZxydFSL9qhaydJ8IJLY+P/PaBKOK5WNtbQRh9GwuQEJKG5n2aKCpYMdMVIbalrl2L2b4oqucKj890TJv/esyrNr++4eRxqmgcsQirfhWbyn58zpoH9N0n4XdcMlZ90xX46JcC+ZTzLomhCtshaZpLkgM6/xi/SpdTbbstZl1DYzSWSlPp6kWoFVzQa5Glfa0osmLX2no7T7o5SRzzVlrb5eVyYQv4yA4Jmm+l4XkxV+fj7CdxUGuaj4PUzjtx4GwYfKJxEPclRqJouP6uhrTtrraJfYkWa8X/zRfFny2/y7qjHTmHzLFq/NC67Dmn8KLI1hH60wlmrUdhbK0fbItYM2x89tSLi+ATXWPZ09cJ25PK3/bxmfjfkYiOxdqx2bqcy9T5kX8JmnMmioYxO8rJOL88tjNib8s4JIpmP2OyyRcH1qDQW/6h0Lnk44RrQdSMVpxct+vjGh1vi1YkjtEA1kC1y6pj2w+RVVVfrMVxThQRJaljMtTmyx8TYLFwGBuNRRHhz9OafbCX2lHXnv3QOti++6G1/FX/pq+dLb3/TxJFwTcx4Ysv5Ae3XMDos9pnVhTZ8+k6ZY7eNzIfOfdRrLAoV2ZlbnpHjeezxlPLg1KA6D+njvNiwpx5beQvYx83lmLpbR9DlnjFqOcbiiLex9vI/Tali4PmIxrX8jzkhhUApl5o87G1wo8p9mqiKNjPNaA8T+qcXOzbOM6bi7ND/H2awdYJjYMmdHX/dd6hEU3HgQj9rTh4tyWKljKvtnYbBwNRxPuM46C3Y6tFPM7M19XRKjTKvt0PraVR2prs676Pja3yXP7rpTggiKKlzxEvZNv2MhfpbydSRRH9IXZssd3sYv8vF9h+1Jf0e1ezYv9tsdDFK8cj+WtDFBHOv00wcqxloki/i7WrjmvbW48Um6/HY9FnxnSPvQ37PfmAKALgNohiDoDbwwh1ADZZG/9ldhHdiyLwUCi+gyhyhCtB/sQ7VzePu2pRxbt1Q+0xIVfDW7eMAbgZIIrAJHSXpz6OskgPye6kgLOG7yhN+O2RiSIAwOMFogicTnscePsX0uD+gCgCAAAAAFggigAAAAAAGIgiAAAAAIAFoggAAAAAgIEoAgAAAABYIIoAAAAAAJhpURT/X6u3PgAAAAAAD41DomiG2XEAAAAAAOfEYVH07//zf8OPHXcT6DtN6DUQ6UsZz5yZ96w8BMoLBONL+W4I+/9ore+/SV5S+9Chd/VQLNj3yLn3h02RvGdoguE7qE7Gvq/sl5PmBArHa8RpMTB8H9XJ2HeV3U4M2Be5dtB6su/s+8bC++bsO7LcOxs/D+9+G6E2zM4bKOcav4Nrm9fl5cLhfXTuvZcT+PdfzhLe+rDxzr5ptK6vx/rv5P2KN4r+P5HLe9b4hdfk7wN19nxFUQjS64iimeYzM0aZHXu84J0Hdzlv9+4zSZ72MsCjyMsNr/GS1tvivkWRf0nl8WM4XEM6bU4FebFk9kbtR8LxXDvR3p3PsreSH0CbDv9x4pyY+MbzSdx6lCLU2otQ20t6ncByOXBcFM009Yctipov1YYHThvw/i1z2rdfiou5AVEU0Tby255vDRBFwswYZXbs8YJ3HtzlvKlYzdhyCkoEudN0N7Of52xE0alNyNI12ONzKkAUHc+1E+0dRMR16injGtSJc2JOjMewnkKYh8wxi7O2/gOi6AAfiiiaEiKbnIEoOujbOxZFxeDP+Xa+Bmm7DVtva8otr7KtjHNJ7L6/dO+hsS9fpTsOJTjlMzBMOoavJtp228ja2HJrkRzdXvja5rNf8NpjiLp2ghK+Hs8ksyTGq9V+5Xztu9L4Xq/HE1u6256D8yzFXrq9PKbs12cbube9PZYkk5l7a/jBxyZEnCiiQNY7RXqetZi187U3U5PN6zzJDn9v57Vj3XqeljXyIfRcn5lHSzY+Bv73vvG2PIoVRSVu1zm/DQnsElqK/s8i/mQ9FTdnaysjikaFRc7znO0l+4bjcVy79dO4vhHt25OO5WMyCln3yC8085rfvCZfU6gJbecjPeo5liNKnNPvlIfWlqGJPTNzGJUBWyNqDLyPTdw2lhYDOhffZAa5Rn5RO0od6Rtsb8veb8t+DAzXHue2HwNezOu+69x+aOtpeVTGWHtW4WPigFDB0JlgC1m3yyVTI+xjfxVFzzbWdwjrM/EJ10nrV8Lkd1kj9QSdw0avrHa2omgsWNnmVz+wn/VRbOwl0d80jnLGxqutz+6Rbqwjztar//9rjTFr+6e+rzhcDd3nHkSRdYAkfzW6JBf9MyykBrgER12gCQpKoqzgz1yRuzEcdGFeRoBsHc8m8p4oou9rk1Y4GEzwcoFpNtFkKEHfbgmXgq1XJrY4xALbChg3D5tQQpx3FUU8l3gsU6wpOPV4tA5NYpOoEWdLCXwvioqv2beaOJogce51e1Z8tABLkTZjCU1OXSc3gvg8nX3jC7A9nk1QTd6tuyC6dhe3Mb5dHpC97eNBE5cyrs5XbE64Zj66ehV7uxwIx3O+rbY3DdFtb7nw3sWJJcam0jcxQuPVH6XVlHh0IuZjER3lO4rrciUd5xGavG7r5uTHtatgXy+20Fzza4vziaKoxEDBnis2MTPnEJ+Z6OtsuRMD6Z2i2IDMuGZvS5xzw/tubeA17iX3ZC6+Hot9tFbotpsWRVojdE60TlOTtJ5YwUD1q9hda1H4pHVLqL4IuRRyztq7XBy0ONJ+ofNpNd7GW4mBvTlxLpn6OD6e96+9U+T9ZsaxbWOuLSHm/PauF1hsD53gHkSRnVxwAH98ke9EkQaf3YfHiSOS5NoSMUpszp+GIhuLqz9eS8QSSDZZ+/kUoi0K5TGL31bPF4uUsVFrQIV26zS38fdv3+3Yq22vomi1i1X5RCsucT3yNx1GCkj8rZC/Elyqb50oskVYi5AWJF6LOacdo9uWVqDa2lsc6ZxUONB8VIDFxuGPE453AnQ8vlNlE118PBZFvllXG67r6ea2Fi0bG4XSULq4zJpZmmflu0wU+bt38qG10bGyYtY1f7vdnE+3pc0zxp1sm8nHautRjthzZXOyzYDmZwRIUqSzK/M0Bjq72LWPY6CIT7NuWQcfJ8xJBYq3ZrDlTgykomgQh6WZ+3kXRn61cSu2tUMyG2szlXHtoq+PkeuKor5GiO3FPqVWmBgSW8YaOA3HKt01D7aKdjB+aT1A0ZpcakD0U+k7pm4TdDzbcwSfS1vHG4kiyae4z8/lAqEXz0uIOeV1edTotiVEO21wBqIoS5SlK9JOFKWLGx+rFzE9p4siSgYTqMb4XRG2xCYk3I4oik2DGBWpft7XFkVmbEuWQrT7lCjiDT6pdH5ujB5D5uUKlT3XckQUZU38NGpDDD49WRR1BaMQxWfaEGI8kn0Gx/MFps3JXgVa0vMx4wsZxsRAafhZvCZxN5uPThRlOZLg5rQ0O8n/EtHeW6QxcC1RlNlo6ZtC6t9gh3SM4L4z543nUWLtqsyIomRdyXnKeBtnsl9nT9NPjkDnHNYIOtcti6I1rulxnJt3tIPxSy8utCaPbd7X7cT2S8ylreNtiaK8lg5908Xj+BgOztnJ/F5OEEV7bI+Lxac0trRgjkSRBEdmCHJUu8Xqt0ehEXFj9BzVyTTvds5+bAsaToZREXbo2g8+Pjssitp5InpLOhLnXUURz8Xa3jag6NuYXEJIYpr3aaKoYMVM8YUZw7bUtauI2hdF9Vzh8ZmOafNfj3nV5qcCrX3yOFU0jrjAVr+KTe0tbyeKPgm/45Kx6pukMPkmTUUqeRQd8q3PAYPzYWiIWfEZHiuIIrJ714RbHPlHKOF7/XMnH+3+erdkL0f6HLaxTfa8XC4uyQ8yrsuTMZprfFfD5DaLJZ2Ps99GDIhv03oa8q7dKZKmxftntsz8tgRfmRgYrr3Nrd9uzmFi0satv7NVjuXr7CJ5a37DRH+bY9X1hxiZRnJ8VGu4ntT5lhpQHp/JfKtI0loUPl1sG8Qu5Y6b8T/bu/nM5ojGlFpcbUDf5blEhLotNtSfQYx626iXRP/aCyebmw7xY1dHXMxpbroRObG27XBIFM1+xsTGKdvsLV+55R8X4oqTBKd+YsGv21WV6/gtw8QxEuR6LGf8Orb9EFlvi19cXg4Dp4fsYc4hgV6bL39MgamJ0f7eF0WEP09r9sFeakdde/ZD62D77ofW8pdLLmdL7/+TRFHwTSz2xRf6g1UdV66ypkSRPZ+uU+bofSPzkXMfxYprLmAyN72jxvNZ4yneKbq47OfFhDnHtdntPGfTgGK+MfF4xjZaXF1DXPpz1fgYxAALQrUjjeHjhryoa8ziNcbdTj7S33ps57s8R1rdGc2pNR93F8TlydwPrW0M1Pjnuaw+r+JxJwa6etrqWZvPx2btG6JI9hvFQCqK5Dt7rhpvYW4+9mVOA1Hk9x390Nociz/hR96mFmw+8n7ZPynQ7Z0NXB2KP7T2n3jn+RCu9ost5Hz2XBrvNIx7ANUPnYPLb59LLSdDHlgb0vqHvW10vLEo6sWh/Y9DzKN4V/9EXP7HOhdr+6fFL6mFs9q2wbQoAuA2iGIOgNuiL+QA9Ly7ukzudC29KAIPA/IbRNGIqIKtor097JWrfqZu+z0G5Ir4WldRAEwAUQT2obsX+aM1vQuK2v2A0P5ywGePTBQBAB4rEEXgNNqjO9wl+vCBKAIAAAAAWCCKAAAAAAAYiCIAAAAAgAWiCAAAAACAgSgCAAAAAFggigAAAAAAGIgiAAAAAIAFoggAAAAAgIEoAgAAAABYIIoAAAAAABiIIgAAAACABaIIAAAAAIC5YVH06/LNl39bfvy9/PXm26+WP3/767L1CkYa89ef3sXNN8pvP/2N53HOvPn233Zt9bhZY+svGlv076+Wb/4Rx3jIprcdW9fhLmJ/i+28UBtPROTvL5a/fvnd8mZi6M1C9WY/DgAAYJYTRVEpRn+uHy2IXhTNcBeNYbv4T6BFP25/MOT+Yru47fL5+sXydnm3/Ph1v/03e8y/3GUjtKJojlNE0V3Eo3KX58pweXGdGL83UQQAADfLcVH0j++4Qbqrs7UofsPFHaLo7Nj0l1IEkL/ipm3el95Xx0UR+eH0q3qIopsGoggAADwHRdGe6Okfn9mi7+5MyF0HN2Zt4P+qDZyaubszYeAibO56jLZLke5EURzXvqkion7n/h41sfKooYyx9hlslybyo9iDHlHEBu5sNTv3jj1/KXOiiG1T53KbosjfpSp2saKoF0gxtt4uQRRVcfi+xJmMacQ7YyF+6vZoT+tjiZeRv9ZzvlmPpXPazI+hiJe1/9TiUvOFcqeuUceGGCGb6Pc1L9IY9zYuc/3V2KiP5xYLdN5kXCTGsu4ft8vmMt8XMgfa3sc3P4Z26zD76jHxmBoAMOCYKNoSKsxYFHFRMvu++SmIIi6EpsANz9U3xLo97E+Nj/b3oijsb8/DzcEW4Rfl35tX0SooYpkN2+0xpOjbot01cGurasfR2gcMbRiZEUVxzG2JonKeZpu1EXdr93bQ2FKR02JLbJrEVi+KClGoFLFhfO8EQPS9iIFRrAW/dxcEdg1xHhURYXoOFTTa6HW+/MekKCK6GO9FkRM49jypTWRcJ5iUXtDU7Ul+kl2KsLH7+GPoesqpzDym8wAA8Ng5LoqGV7DESBTFBtsoY15wM+mFRUZszgVfEAlp2ua74ThpBjSXeFymaxieeJeHMcW8YGyQHK8dI1kfNSCec2zCO+z6S0nO2d05if6bFUXSxOtx+jsADrJN2sBGomgrtsimGlvx2xwvRnJ7lzh53wkZxti8j7WyrRdFyXmGvguioRMXwU5JnJ0qinyMmzlb4dMJkJF/spiLFzCErOF9Zk+79mgXY+tubQAAkHNcFKUNSxmJonEDLVegR29p03nKflpUy1VkbLxlLp0oSseNivcyUVSbgLBX/v15ZL7J8aIoivs1gdVERmwoHbv+UrIG5e3BforNauDTEWT7mTmTAOwZiaK+8Sv1UUp6vJxeFPUxUZttFauGIIqiWN4SRZnPe9/F5n9fosgcK4qiuA6O1SxQbB6bOXX7+zwei6K431dtfXVex2IWAPC4OCaKugIc8d97UZTvV8aU3yrEortPO1/WgJQoivJxmTAQuoYxwhwja5hKcjwvinJbefZ8QcyMIbK1x3nEY5FPjzWYaVG0KwZi48/XWGx6LLZ6UdQ39K07RTHWoti3dxW9KMrX0BNzKa4/2qaPs5sRRWbOURQdEKGFdq5xfmb2tGufjMfEZwAAoBwURXolFwr47/l/fWYLKV+1m2bX/aaIi1q405I2R4tp5lyY88bSF/+NcaYxzP2myBPXExsqkxzPNkuex5G1b7DtLyU7VtKonU8mm5BhShTFOFj2f1PEd7FMo+t+U8Rx6WNr1Bhj848x4QRA5+NynmGs8d82J9q/1efZnDx+7THn/PfBr7TueFfmgCjqfvSs84024XPIwCmM+Iw2M2yLIqkxowsRxc0VAAA8h0URE2+R20c7A1FU/m7/ZYgWYzdGmgZ/NxRFpRHpcdxVpRT9eA5X/DfG1bHdurQpxKtlIjz6sOfR9Zjj8Xq6BuRFUfnb7PelNrLB2uXqfFjnh/5SJkWRrpXP5efi1ndtRFzUtcu2gSginL3EFs6mJrbeb4ii5rPWOF1MRHHsfPxd/1+f2Vj7evu/PnP5UdcdiWvfEkWL9/06r3qXa+nzwsd4L4r091l1rRpwUWgkcd/b2vs45rG1g/pzTxR1uajfuePFmAYAgMZpogicFXN3YMBdQL7ohXOjPL6KW8+fKOAAAOBDBKLowUNXx3OP9sAts/Hoh+G7Rg/TVxBFAIDHAEQRACfTP0J0d4HiY6QtwXTmQBQBAB4DEEUAAAAAAAtEEQAAAAAAA1EEAAAAALBAFAEAAAAAMBBFAAAAAAAr/w8vO8B7gauEEwAAAABJRU5ErkJggg==" width="581" height="73" class="img_ev3q"></p><p>Generate some data like you did before by running a few netcat connection/disconnects and click 'Execute' again. Don't forget to send
the connection request to kubeB though!</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nc kubeB.reflect.svc.ziti 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">this is kubeb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">you sent me: this is kubeb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">^C</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nc kubeB.reflect.svc.ziti 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">another to kube b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">you sent me: another to kube b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">^C</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nc kubeB.reflect.svc.ziti 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">one more for fun and profit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">you sent me: one more for fun and profit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">^C</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="kubeB from kubeA" src="/assets/images/kubeB-from-kubeA-0f78d64d83a2d8b02e25a72167d20de1.png" width="880" height="946" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="scraping-all-the-things">Scraping All the Things!<a href="#scraping-all-the-things" class="hash-link" aria-label="Direct link to Scraping All the Things!" title="Direct link to Scraping All the Things!">​</a></h2><p>By now, you are probably starting to get the idea just how powerful this is for Prometheus. A zitified Prometheus can scrape things
easily and natively by just deploying a <code>Prometheuz</code> instance into the location you want to scrape. Or, you can just enable a scrape
target using a tunneling app, or in Kubernetes using the <code>ziti-host</code> helm chart.  Let's complete our vision now and stand up a
Prometheus server on our local workstation using Docker.</p><p>When we run <code>Prometheuz</code> locally using docker we'll need a config file to give to docker using a volume mount. We also provide the
identity used to connect to the OpenZiti overlay in the same fashion. Let's start up a docker container locally and see if we can grab
data from our two Prometheus instances using a locally deployed <code>Prometheuz</code> via docker.</p><p>GitHub has a sample Prometheus <a href="https://raw.githubusercontent.com/openziti/ziti-doc/main/docusaurus/blog/zitification/prometheus/scripts/local.prometheus.yml" target="_blank" rel="noopener noreferrer">file you can download</a>.
Below, I used curl to download it and put it into the expected location.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -s https://raw.githubusercontent.com/openziti/ziti-doc/main/docusaurus/blog/zitification/prometheus/scripts/local.prometheus.yml &gt; /tmp/prometheus/prometheus.config.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create identity user local.prometheus.id -o /tmp/prometheus/local.prometheus.id.jwt -a "reflectz-clients","prometheus-clients"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge enroll /tmp/prometheus/local.prometheus.id.jwt -o /tmp/prometheus/local.prometheus.id.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker run \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -v /tmp/prometheus/local.prometheus.id.json:/etc/prometheus/ziti.id.json \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -v /tmp/prometheus/prometheus.config.yml:/etc/prometheus/prometheus.yml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -p 9090:9090 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  openziti/prometheuz</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="local-docker-targets.png" src="/assets/images/local-docker-targets-8dc1e23a53a77339ddc8926ac5d7327a.png" width="458" height="316" class="img_ev3q"></p><p>Look at what we've just done. We have started a Prometheus instance locally, and used it to connect to four Prometheus targets via
scrape configurations when all four targets are hidden entirely from my local computer (and any computer) unless the computer has an
OpenZiti identity. I personally think that is incredibly cool!</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="taking-it-to-11">Taking it to 11<a href="#taking-it-to-11" class="hash-link" aria-label="Direct link to Taking it to 11" title="Direct link to Taking it to 11">​</a></h2><p>But wait, I'm not done. That docker instance is listening on an underlay network. It's exposed to attack by anything on my local network.
I want to fix that too. Let's start this docker container up listening only on the OpenZiti overlay. Just like in <a href="/blog/zitification/prometheus/part2">part 2</a>
we will make a config, a service and two policies to enable identities on the OpenZiti overlay.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -s https://raw.githubusercontent.com/openziti/ziti-doc/main/docusaurus/blog/zitification/prometheus/scripts/local.prometheus.yml &gt; /tmp/prometheus/prometheus.config.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># create the config and service for the local prometheus server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config "local.prometheus.svc-intercept.v1" intercept.v1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  '{"protocols":["tcp"],"addresses":["local.prometheus.svc"],"portRanges":[{"low":80, "high":80}], "dialOptions": {"identity":"local.prometheus.id"}}'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service "local.prometheus.svc" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --configs "local.prometheus.svc-intercept.v1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># grant the prometheus clients the ability to dial the service and the local.prometheus.id the ability to bind</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy "local.prometheus.svc.dial" Dial \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles "@local.prometheus.svc" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --identity-roles "#prometheus-clients"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy "local.prometheus.svc.bind" Bind \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles "@local.prometheus.svc" \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --identity-roles "@local.prometheus.id"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Once that's done - let's see if we can start the docker container. The helm charts are configured to translate the <code>--set</code> flags
provided into "container friendly" settings like environment variables, volumes and mounts etc. In docker we need to provide those. If
you're familiar with docker these will probably all make sense. The most important part of the command below is the <strong>lack</strong> of a <code>-p</code>
flag. The <code>-p</code> flag is used to expose a port from inside docker, outside docker. Look at the previous docker sample and you'll find we
were mapping local underlay port 9090 to port 9090 in the docker container. In this example, <strong>we will do no such thing</strong>! :)</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">docker run \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -e ZITI_LISTENER_SERVICE_NAME=local.prometheus.svc \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -e ZITI_LISTENER_IDENTITY_FILE=/etc/prometheus/ziti.server.json \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -e ZITI_LISTENER_IDENTITY_NAME=local.prometheus.id \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -v /tmp/prometheus/prometheus.config.yml:/etc/prometheus/prometheus.yml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -v /tmp/prometheus/local.prometheus.id.json:/etc/prometheus/ziti.id.json \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -v /tmp/prometheus/local.prometheus.id.json:/etc/prometheus/ziti.server.json \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    openziti/prometheuz</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="but---does-it-work">But - Does It Work?<a href="#but---does-it-work" class="hash-link" aria-label="Direct link to But - Does It Work?" title="Direct link to But - Does It Work?">​</a></h3><p>After configuring the OpenZiti overlay, we just need to open a browser and navigate to <a href="http://local.prometheus.svc/targets" target="_blank" rel="noopener noreferrer">http://local.prometheus.svc/targets</a>. SUCCESS!</p><p><img loading="lazy" alt="local-docker-targets-no-listener.png" src="/assets/images/local-docker-targets-no-listener-c80c0b90432aa76d510ab4684613c0f2.png" width="495" height="405" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="success">SUCCESS!<a href="#success" class="hash-link" aria-label="Direct link to SUCCESS!" title="Direct link to SUCCESS!">​</a></h3><p><img loading="lazy" alt="local-docker-graph-no-listener.png" src="/assets/images/local-docker-graph-no-listener-bf6c6577b99852b0c9df5935da209c7b.png" width="891" height="953" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="wrap-up">Wrap Up<a href="#wrap-up" class="hash-link" aria-label="Direct link to Wrap Up" title="Direct link to Wrap Up">​</a></h2><p>This was quite the journey and a lot of fun. We have taken a wildly popular open source project and brought OpenZiti to it with really
not much code at all. Then using OpenZiti we were able to give Prometheus superpowers and enable it to scrape any target regardless of
where that target is or what network it is on. </p><p>Think of the possibilities here. Are you a cloud provider looking to monitor your client's services which are deployed on-prem? That's
so easy with OpenZiti and without sacrificing security <strong>at all</strong>. In fact, using OpenZiti like this provides amazing reach while
<strong>strengthening</strong> the security posture of the solution because you're now using the concepts of
<a href="https://en.wikipedia.org/wiki/Zero_trust_security_model" target="_blank" rel="noopener noreferrer">zero trust networking principles</a> and applying them to your alerting and
monitoring solution.</p><p>What do you think? Was this series interesting? Do you think OpenZiti is cool and you are looking to try it out? What are you going to
zitify? Tell us on twitter or on discourse! Both links are included in this page. Let us know what you think! Go star the
<a href="http://github.com/openziti/ziti" target="_blank" rel="noopener noreferrer">openziti/ziti</a> repo and help us spread the word of OpenZiti to the world!</p>]]></content>
        <author>
            <name>Clint Dovholuk</name>
            <uri>https://github.com/dovholuknf</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Zitifying SCP]]></title>
        <id>https://openziti.io/blog/zitification/zitifying-scp</id>
        <link href="https://openziti.io/blog/zitification/zitifying-scp"/>
        <updated>2023-10-14T16:50:51.000Z</updated>
        <summary type="html"><![CDATA[In the previous post we talked about how we could take a well-known application and improve its security by zitifying it, producing zssh. The logical next step after zitifying ssh would be to extend the functionality of zssh to cover moving files securely as well, enter zscp. A zitified scp effectively creates a more secure command line tool for sending and receiving files between ziti-empowered devices. Once zitified, we can use zscp using ziti identity names just like we did in zitifying ssh. I recommend reading the previous article) if you haven't to learn more about the benefits of zitifying tools like ssh and scp.]]></summary>
        <content type="html"><![CDATA[<p>In the <a href="/blog/zitification/zitifying-ssh/">previous post</a> we talked about how we could take a well-known application and improve its security by zitifying it, producing <code>zssh</code>. The logical next step after zitifying <code>ssh</code> would be to extend the functionality of <code>zssh</code> to cover moving files securely as well, enter <code>zscp</code>. A zitified <code>scp</code> effectively creates a more secure command line tool for sending and receiving files between ziti-empowered devices. Once zitified, we can use <code>zscp</code> using ziti identity names just like we did in <a href="/blog/zitification/zitifying-ssh/">zitifying ssh</a>. I recommend reading the <a href="/blog/zitification/zitifying-ssh/">previous article</a>) if you haven't to learn more about the benefits of zitifying tools like <code>ssh</code> and <code>scp</code>.</p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="first-things-first">First Things First<a href="#first-things-first" class="hash-link" aria-label="Direct link to First Things First" title="Direct link to First Things First">​</a></h2><p><code>zscp</code> functions with the same prerequisites as <code>zssh</code>:</p><ul><li>Establish a <a href="/docs/learn/quickstarts/network/hosted">Ziti Network</a></li><li>Create and enroll two Ziti Endpoints (one for our <code>ssh</code> server, one for the client)<ul><li>the <code>sshd</code> server will run <code>ziti-tunnel</code> for this demonstration. Conveniently it will run on the same machine I used to setup the <a href="/docs/learn/introduction/">Ziti Network</a>.</li><li>the client, in this case, is my local machine and I'll <code>zscp</code> files both to and from both the remote machine.</li></ul></li><li>Create the <a href="/docs/learn/core-concepts/services/overview">Ziti Service</a> we'll use and authorize the two endpoints to use this service</li><li>Use the <code>zscp</code> binary from the client side and the <code>ziti-tunnel</code> binary from the serving side to connect</li><li>Harden <code>sshd</code> further by removing port 22 from any internet-based firewall configuration (for example, from within the security-groups wizard in AWS) or by forcing <code>sshd</code> to only listen on <code>localhost/127.0.0.1</code></li></ul><p>After ensuring these steps are complete, you will have the ability to copy files across your Ziti Network. The traffic will be even more secure since now a Ziti Network is required for the connection, requiring that strong identity before even being able to access the <code>sshd</code> server. And of course now <code>sshd</code> is 'dark' - it no longer needs the typical port 22 to be exposed to any network.</p><p>Given all the prerequisites are satisfied, we can put <code>zscp</code> to use. Simply download the binary for your platform:</p><ul><li><a href="https://github.com/openziti-test-kitchen/zssh/releases/latest/download/zscp-linux-amd64" target="_blank" rel="noopener noreferrer">linux</a></li><li><a href="https://github.com/openziti-test-kitchen/zssh/releases/latest/download/zscp-windows-amd64.exe" target="_blank" rel="noopener noreferrer">windows</a></li><li><a href="https://github.com/openziti-test-kitchen/zssh/releases/latest/download/zscp-macos-amd64" target="_blank" rel="noopener noreferrer">MacOs</a></li></ul><span></span><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="sending-and-receiving-files-with-zscp">Sending and Receiving Files with Zscp<a href="#sending-and-receiving-files-with-zscp" class="hash-link" aria-label="Direct link to Sending and Receiving Files with Zscp" title="Direct link to Sending and Receiving Files with Zscp">​</a></h2><p>Once you have the executable downloaded, make sure it is named <code>zscp</code> and for simplicity's sake we'll assume it's on the path. Just like <code>zssh</code> to <code>ssh</code>, <code>zscp</code> provides the same basic functionality as <code>scp</code>. As with most tooling, executing the binary with no arguments will display the expected usage.</p><p>There are two main functions of <code>zscp</code>. Just like <code>scp</code> you can send and receive from the remote host.</p><p>To send files we use this basic syntax:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./zscp LOCAL_FILEPATHS... &lt;REMOTE_USERNAME&gt;@TARGET_IDENTITY:REMOTE_FILEPATH</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then, to retrieve remote files we use a similar syntax:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./zscp &lt;REMOTE_USERNAME&gt;@TARGET_IDENTITY:REMOTE_FILEPATH LOCAL_FILEPATH</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Below is a working example of using <code>zscp</code> to send a file to a remote machine. In this case the remote username is not the same as my local username. Just like with <code>scp</code>, I'll need to supply the username in my command and it will use the same syntax that regular <code>scp</code> uses. Here I am <code>zscp'ing</code> as username <code>ubuntu</code> to the remote computer that is joined to the Ziti Network using the identity named <code>ziti-tunnel-aws</code>.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./zscp local/1.txt ubuntu@ziti-tunnel-aws:remote</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO    connection to edge router using token 6c2e8b79-ce8e-483e-a9f8-a930530e706a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO    sent file: /Users/name/local/1.txt ==&gt; /home/ubuntu/remote/1.txt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This is only a basic example on how we can use <code>zscp</code> to send a singular file to a remote computer. In the next section, we will go over how to use <code>zscp</code> flags for extended functionality.</p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="zscp-flags">Zscp Flags<a href="#zscp-flags" class="hash-link" aria-label="Direct link to Zscp Flags" title="Direct link to Zscp Flags">​</a></h2><p>Just like <code>zssh</code>, <code>zscp</code> has the same flags to pass in: ssh key, ziti configuration file, service name, and one to toggle debug logging. All the defaults are the same as with <code>zssh</code>, thus both <code>zscp</code> and <code>zssh</code> will work without the <code>-i</code> and <code>-c</code> flag providing the files exist at the default locations. Refer to <!-- -->[<!-- -->zitifying-ssh<!-- -->]<!-- -->[<!-- -->2<!-- -->]<!-- --> for instructions on how to use the flags below.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    -i, --SshKeyPath string   Path to ssh key. default: $HOME/.ssh/id_rsa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -c, --ZConfig string      Path to ziti config file. default: $HOME/.ziti/zssh.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -d, --debug               pass to enable additional debug information</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -s, --service string      service name. (default "zssh")</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In addition to the flags above, <code>zscp</code> has a flag to enable recursive copying:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    -r, --recursive           pass to enable recursive file transfer</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To use the recursive flag, you must input a directory into the <code>LOCAL_FILEPATH</code> argument. Just like <code>scp</code>, <code>zscp</code> will copy all file contents under the provided directory. You can see below how we can use the <code>-r</code> flag to send all contents of <code>big_directory</code>.</p><p>Contents of <code>big_directory</code> on local computer:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">tree local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── big_directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── 1.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── 2.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── 3.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── small_directory1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │   └── 4.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── small_directory2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │   └── 5.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    └── small_directory3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        └── 6.txt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Here is the command and output:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ zscp -r big_directory ubuntu@ziti-tunnel-aws:remote</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO    connection to edge router using token d6c268ee-e4f5-4836-bd38-2fc1558257aa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO    sent file: /Users/name/local/big_directory/1.txt ==&gt; /home/ubuntu/remote/big_directory/1.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO    sent file: /Users/name/local/big_directory/2.txt ==&gt; /home/ubuntu/remote/big_directory/2.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO    sent file: /Users/name/local/big_directory/3.txt ==&gt; /home/ubuntu/remote/big_directory/3.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO    sent file: /Users/name/local/big_directory/small_directory1/4.txt ==&gt; /home/ubuntu/remote/big_directory/small_directory1/4.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO    sent file: /Users/name/local/big_directory/small_directory2/5.txt ==&gt; /home/ubuntu/remote/big_directory/small_directory2/5.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO    sent file: /Users/name/local/big_directory/small_directory3/6.txt ==&gt; /home/ubuntu/remote/big_directory/small_directory3/6.txt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After <code>zssh'ing</code> to the remote machine, we can prove that all files have been transferred to remote device:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ubuntu@IP:~$ tree remote/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">remote/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── big_directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── 1.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── 2.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── 3.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── small_directory1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │   └── 4.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── small_directory2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │   └── 5.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    └── small_directory3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        └── 6.txt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Recursive copying also works to retrieve all contents of a directory on the remote machine.</p><hr><p>I hope this post has helped you get familiar with another ziti-empowered developer's tool and hopefully it's becoming more clear why zitifying your application will make it more resilient to attack and make the act of connecting to remote services trivial.</p><p>Have a look at the code over at <a href="https://github.com/openziti-test-kitchen/zssh/tree/main/zssh/zscp" target="_blank" rel="noopener noreferrer">GitHub</a> or continue reading on to the next zitification - <a href="/blog/zitification/kubernetes/">kubectl</a>!</p>]]></content>
        <author>
            <name>Clint Dovholuk</name>
            <uri>https://github.com/dovholuknf</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[zscp Cheat Sheet]]></title>
        <id>https://openziti.io/blog/zitification/zitifying-scp/zscp-cheatsheat</id>
        <link href="https://openziti.io/blog/zitification/zitifying-scp/zscp-cheatsheat"/>
        <updated>2023-10-14T16:50:51.000Z</updated>
        <content type="html"><![CDATA[<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># establish some variables which are used below</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service_name=zscpSvc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client_identity="${service_name}"Client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server_identity="${service_name}"Server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">the_port=22</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># create two identities. one host - one client. Only necessary if you want/need them. Skippable if you</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># already have an identity. provided here to just 'make it easy' to test/try</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create identity device "${server_identity}" -a "${service_name}"ServerEndpoints -o "${server_identity}".jwt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create identity device "${client_identity}" -a "${service_name}"ClientEndpoints -o "${client_identity}".jwt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># if you want to modify anything, often deleting the configs/services is easier than updating them</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># it's easier to delete all the items too - so until you understand exactly how ziti works, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># make sure you clean them all up before making a change</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge delete config "${service_name}"-host.v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge delete config "${service_name}"-client-config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge delete service "${service_name}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge delete service-policy "${service_name}"-binding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge delete service-policy "${service_name}"-dialing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config "${service_name}"-host.v1 host.v1 '{"protocol":"tcp", "address":"localhost","port":'"${the_port}"', "listenOptions": {"bindUsingEdgeIdentity":true}}'# intercept is not needed for zscp/zssh but make it for testing if you like</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config "${service_name}"-client-config intercept.v1 '{"protocols":["tcp"],"addresses":["'"${service_name}.ziti"'"], "portRanges":[{"low":'"${the_port}"', "high":"'${the_port}"'}]}'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service "${service_name}" --configs "${service_name}"-client-config,"${service_name}"-host.v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy "${service_name}"-binding Bind --service-roles '@'"${service_name}" --identity-roles '#'"${service_name}"'ServerEndpoints'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy "${service_name}"-dialing Dial --service-roles '@'"${service_name}" --identity-roles '#'"${service_name}"'ClientEndpoints'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content>
        <author>
            <name>Clint Dovholuk</name>
            <uri>https://github.com/dovholuknf</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Zitifying SSH]]></title>
        <id>https://openziti.io/blog/zitification/zitifying-ssh</id>
        <link href="https://openziti.io/blog/zitification/zitifying-ssh"/>
        <updated>2023-10-14T16:50:51.000Z</updated>
        <summary type="html"><![CDATA[As we learned in the opening post, "zitifying" an application means to embed a Ziti SDK into an application and leverage the power of a Ziti Network to provide secure, truly zero-trust access to your application no matter where in the world that application goes. In this post we are going to see how we have zitified ssh and why. Future posts will expand on this even further by showing how NetFoundry uses zssh to support our customers.]]></summary>
        <content type="html"><![CDATA[<p>As we learned in the <a href="/blog/zitification/">opening post</a>, "zitifying" an application means to embed a Ziti SDK into an application and leverage the power of a <a href="/docs/learn/introduction/">Ziti Network</a> to provide secure, truly zero-trust access to your application no matter where in the world that application goes. In this post we are going to see how we have zitified <code>ssh</code> and why. Future posts will expand on this even further by showing how NetFoundry uses <code>zssh</code> to support our customers.</p><iframe width="560" height="315" src="https://www.youtube.com/embed/WyZ8GRvtgGs" title="YouTube video player" allow="autoplay; picture-in-picture"></iframe><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="why-ssh">Why SSH?<a href="#why-ssh" class="hash-link" aria-label="Direct link to Why SSH?" title="Direct link to Why SSH?">​</a></h2><p>As I sit here typing these words, I can tell you're skeptical. I can tell you're wondering why in the world we would even attempt to mess with <code>ssh</code> at all. After all, <code>ssh</code> has been a foundation of the administration of not only home networks but also corporate networks and the internet itself. Surely if millions (billions?) of computers can interact every day safely and securely using <code>ssh</code> there is "no need" for us to be spending time zitifying <code>ssh</code> right? (Spoiler alert: wrong)</p><p>I'm sure you've guessed that this is not the case whatsoever. After all, attackers don't leave <code>ssh</code> alone just because it's not worth it to try! Put a machine on the open internet, expose <code>ssh</code> on port 22 and watch for yourself all the attempts to access <code>ssh</code> using known default/weak/bad passwords flood in. Attacks don't only come from the internet either! Attacks from a single compromised machine on your network very well could behave in the same way as an outside attacker. This is particularly true for ransomware-style attacks as the compromised machine attempts to expand/multiply. The problems don't just stop here either. DoS attacks, other zero-day type bugs and more are all waiting for any service sitting on the open internet.</p><p>A zitified <code>ssh</code> client is superior since the port used by <code>ssh</code> can be eliminated from the internet-based firewall preventing any connections whatsoever from any network client. In this configuration the <code>ssh</code> process is effectively "
dark". The only way to <code>ssh</code> to a machine configured in this way is to have an identity authorized for that <a href="/docs/learn/introduction/">Ziti Network</a>.</p><p>It doesn't stop there though. A Ziti Network mandates the use of a strong identity. You cannot access any services defined in a <a href="/docs/learn/introduction/">Ziti Network</a> without having gone through the enrollment process to create a strong identity used for bidirectional authentication and authorization. With Ziti, you can't even connect to SSH without first being authorized to connect to the remote SSH server.</p><p>Contrast that to SSH. With SSH you need access the sshd port before starting the authentication process. This requires the port to be exposed to the network, exposing it to attack. With SSH you are also usually allowed to authenticate without providing a strong identity using a username and password. Even if you are choosing to use the more secure pub/private key authentication for SSH, the remote machine still needed the public key added to the authorized_keys file before allowing connections to it via SSH. This is all-too-often a step which a human will do, making the process of authorizing a user or revoking access relatively cumbersome. Ziti provides a secure, centralized location to manage authorization of users to services. Ziti makes it trivial to grant or revoke access to a given set of services to users immediately.</p><p>Lastly, Ziti provides support for continual authorization through the use of policy checks. These policy checks run continuously. If a user suddenly fails to meet a particular policy, access to the services provided via the <a href="/docs/learn/introduction/">Ziti Network</a> are revoked immediately.</p><p>Cool right? Let's see how we did it and how you can do the same thing using a <a href="/docs/learn/introduction/">Ziti Network</a>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="overview-of-ssh---notice-how-port-22-is-open-to-inbound-connections">Overview of SSH - notice how port 22 is open to inbound connections:<a href="#overview-of-ssh---notice-how-port-22-is-open-to-inbound-connections" class="hash-link" aria-label="Direct link to Overview of SSH - notice how port 22 is open to inbound connections:" title="Direct link to Overview of SSH - notice how port 22 is open to inbound connections:">​</a></h4><p><img loading="lazy" alt="ssh-overview.svg" src="/assets/images/ssh-overview-45937eb23dc9f3295bd27452dda3b660.svg" width="723" height="249" class="img_ev3q"></p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-its-done">How It's Done<a href="#how-its-done" class="hash-link" aria-label="Direct link to How It's Done" title="Direct link to How It's Done">​</a></h2><p>There are a few steps necessary before being able to use <code>zssh</code>:</p><ul><li>Establish a <a href="/docs/learn/quickstarts/network/hosted">Ziti Network</a></li><li>Create and enroll two Ziti Endpoints (one for our <code>ssh</code> server, one for the client)<ul><li>the <code>sshd</code> server will run <code>ziti-tunnel</code> for this demonstration. Conveniently it will run on the same machine I used to setup the <a href="/docs/learn/introduction/">Ziti Network</a>.</li><li>the client will run <code>zssh</code> from my local machine, and I'll <code>zssh</code> to the other endpoint</li></ul></li><li>Create the <a href="/docs/learn/core-concepts/services/overview">Ziti Service</a> we'll use and authorize the two endpoints to use this service</li><li>Use the <code>zssh</code> binary from the client side and the <code>ziti-tunnel</code> binary from the serving side to connect</li><li>Harden <code>sshd</code> further by removing port 22 from any internet-based firewall configuration (for example, from within the security-groups wizard in AWS) or by forcing <code>sshd</code> to only listen on <code>localhost/127.0.0.1</code></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="overview-of-zssh---notice-port-22-is-no-longer-open-to-inbound-connections">Overview of ZSSH - notice port 22 is no longer open to inbound connections:<a href="#overview-of-zssh---notice-port-22-is-no-longer-open-to-inbound-connections" class="hash-link" aria-label="Direct link to Overview of ZSSH - notice port 22 is no longer open to inbound connections:" title="Direct link to Overview of ZSSH - notice port 22 is no longer open to inbound connections:">​</a></h4><p><img loading="lazy" alt="zssh-overview.svg" src="/assets/images/zssh-overview-e793e9a4cdc8275a8375ff45d73d44c3.svg" width="723" height="249" class="img_ev3q"></p><p>After performing these steps you'll have an <code>sshd</code> server that is dark to the internet. Accessing the server via <code>ssh</code>
must now occur using the Ziti Network. Since the service is no longer accessible directly through a network, it is no longer susceptible to the types of attacks mentioned previously!</p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="zssh-in-action">Zssh in Action<a href="#zssh-in-action" class="hash-link" aria-label="Direct link to Zssh in Action" title="Direct link to Zssh in Action">​</a></h2><p>Once the prerequisites are satisfied, we can see <code>zssh</code> in action. Simply download the binary for your platform:</p><ul><li><a href="https://github.com/openziti-test-kitchen/zssh/releases/latest/download/zssh-linux-amd64" target="_blank" rel="noopener noreferrer">linux</a></li><li><a href="https://github.com/openziti-test-kitchen/zssh/releases/latest/download/zssh-windows-amd64.exe" target="_blank" rel="noopener noreferrer">windows</a></li><li><a href="https://github.com/openziti-test-kitchen/zssh/releases/latest/download/zssh-macos-amd64" target="_blank" rel="noopener noreferrer">MacOs</a></li></ul><p>Once you have the executable download, make sure it is named <code>zssh</code> and for simplicity's sake we'll assume it's on the path. A goal for <code>zssh</code> is to make the usage of the command very similar to the usage of <code>ssh</code>. Anyone familiar with <code>ssh</code> should be able to pick up <code>zssh</code> easily. As with most tooling, executing the binary with no arguments will display the expected usage. The general format when using <code>zssh</code> will be similar to that of <code>ssh</code>: <code>zssh &lt;remoteUsername&gt;@&lt;targetIdentity&gt;</code></p><p>Below you can see me <code>zssh</code> from my local machine to the AWS machine secured by <code>ziti-tunnel</code>:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./zssh ubuntu@ziti-tunnel-aws</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO[0000] connection to edge router using token 95c45123-9415-49d6-930a-275ada9ae06f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">connected.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ubuntu@ip-172-31-27-154:~$</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It really was that simple! Now let's break down the current flags for <code>zssh</code> and exactly how this worked.</p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="zssh-flags">Zssh Flags<a href="#zssh-flags" class="hash-link" aria-label="Direct link to Zssh Flags" title="Direct link to Zssh Flags">​</a></h2><p>We know that <code>zssh</code> requires access to a <a href="/docs/learn/introduction/">Ziti Network</a> but it is not clear from the example above is where <code>zzsh</code>
found the credentials required to access the network. <code>zssh</code> supports three basic flags:</p><p>-i, --SshKeyPath string Path to ssh key. default: $HOME/.ssh/id_rsa -c, --ZConfig string Path to ziti config file. default: $HOME/.ziti/zssh.json -d, --debug pass to enable additional debug information -h, --help help for this command -s, --service string service name. default: zssh (default "zssh")</p><p>What you see above is exactly the output <code>zssh</code> provides should you pass the <code>-h/--help</code> flag or execute <code>zssh</code> without any parameters. The <code>-i/--SshKeyPath</code> flag is congruent to the <code>-i</code> flag for <code>ssh</code>. You would use it to supply your key to the <code>ssh</code> client. Under the hood of <code>zssh</code> is a full-fledged <code>ssh</code> client that works similarly to how <code>ssh</code> does. If your <code>~/.ssh/id_rsa</code> file is in the <code>authorized_keys</code> of the remote machine, then you won't need to specify the <code>-i/</code>
flag (as I didn't in my example). Using <code>zssh</code> requires the use of a public/private key in order for the <code>zssh</code> client to connect to the remote machine.</p><p>The <code>-c/--ZConfig</code> flag controls access to the network. A configuration file must be supplied to use <code>zssh</code> but does not need to be supplied as part of the command. By default, <code>zssh</code> will look at your home directory in a folder named <code>.ziti</code> for a file named <code>zssh.json</code>. In bash this is would be the equivalent of <code>$HOME</code>. In Windows this is the equivalent the environment variable named <code>USERPROFILE</code>. You do not need to supply this flag if a file exists at the default location. You can specify this flag to use <code>zssh</code> with other networks.</p><p>The <code>-s/--service</code> flag is for passing in a different service name other than "zssh". By default, the service name will be "zssh", but if you would like to access a different service use the <code>-s</code> flag followed by the service name.</p><p>The <code>-d/--debug</code> flag outputs additional information to assist you with debugging. For example:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./zssh ubuntu@ziti-tunnel-aws -d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO[0000]     sshKeyPath set to: /home/myUser/.ssh/id_rsa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO[0000]        ZConfig set to: /home/myUser/.ziti/zssh.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO[0000]       username set to: ubuntu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO[0000] targetIdentity set to: ziti-tunnel-aws</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO[0000] connection to edge router using token 95c45123-a234-412e-8997-96139fbd1938</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">connected.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ubuntu@ip-172-31-27-154:~$</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Shown above is also one additional piece of information, the remote username. Shown in the example above I have <code>zssh</code>ed to an ubuntu image in AWS. When it was provisioned AWS used the username <code>ubuntu</code>. In order to <code>zssh</code> to this machine I need to tell the remote <code>sshd</code> server that I wish to attach as the <code>ubuntu</code> user. If your username is the same for your local environment as the remote machine you do not need to specify the username. For example, my local username is <code>cd</code> (my initials). When I <code>zssh</code> to my dev machine I can simply use <code>zssh ClintLinux</code>:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./zssh ClintLinux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO[0000] connection to edge router using token 909dfb4f-fa83-4f73-af8e-ed251bcd30be</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">connected.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd@clint-linux-vm ~</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Hopefully this post has been helpful and insightful. Zitifying an application is <em>POWERFUL</em>!!!!</p><p>The next post in this series will cover how we extended the same code we used for <code>zssh</code> and <a href="/blog/zitification/zitifying-scp/">zitified scp</a>.</p><p>Have a look at the code over at <a href="https://github.com/openziti-test-kitchen/zssh/tree/main/zssh/zssh" target="_blank" rel="noopener noreferrer">GitHub</a></p>]]></content>
        <author>
            <name>Clint Dovholuk</name>
            <uri>https://github.com/dovholuknf</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[zssh Cheat Sheet]]></title>
        <id>https://openziti.io/blog/zitification/zitifying-ssh/zssh-cheat-sheet</id>
        <link href="https://openziti.io/blog/zitification/zitifying-ssh/zssh-cheat-sheet"/>
        <updated>2023-10-14T16:50:51.000Z</updated>
        <content type="html"><![CDATA[<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># establish some variables which are used below</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service_name=zsshSvc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client_identity="${service_name}"Client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server_identity="${service_name}"Server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">the_port=22</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># create two identities. one host - one client. Only necessary if you want/need them. Skippable if you</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># already have an identity. provided here to just 'make it easy' to test/try</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create identity device "${server_identity}" -a "${service_name}"ServerEndpoints -o "${server_identity}".jwt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create identity device "${client_identity}" -a "${service_name}"ClientEndpoints -o "${client_identity}".jwt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># if you want to modify anything, often deleting the configs/services is easier than updating them</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># it's easier to delete all the items too - so until you understand exactly how ziti works,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># make sure you clean them all up before making a change</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge delete config "${service_name}"-host.v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge delete config "${service_name}"-client-config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge delete service "${service_name}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge delete service-policy "${service_name}"-binding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge delete service-policy "${service_name}"-dialing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config "${service_name}"-host.v1 host.v1 '{"protocol":"tcp", "address":"localhost","port":'"${the_port}"', "listenOptions": {"bindUsingEdgeIdentity":true}}'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># intercept is not needed for zscp/zssh but make it for testing if you like</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config "${service_name}"-client-config intercept.v1 '{"protocols":["tcp"],"addresses":["'"${service_name}.ziti"'"], "portRanges":[{"low":'"${the_port}"', "high":'"${the_port}"'}]}'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service "${service_name}" --configs "${service_name}"-client-config,"${service_name}"-host.v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy "${service_name}"-binding Bind --service-roles '@'"${service_name}" --identity-roles '#'"${service_name}"'ServerEndpoints'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy "${service_name}"-dialing Dial --service-roles '@'"${service_name}" --identity-roles '#'"${service_name}"'ClientEndpoints'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content>
        <author>
            <name>Clint Dovholuk</name>
            <uri>https://github.com/dovholuknf</uri>
        </author>
    </entry>
</feed>