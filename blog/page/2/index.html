<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">OpenZiti Technical Blog | OpenZiti</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://openziti.io/blog/page/2"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="robots" content="index, follow"><meta data-rh="true" property="og:title" content="OpenZiti Technical Blog | OpenZiti"><meta data-rh="true" name="description" content="Technical articles about OpenZiti"><meta data-rh="true" property="og:description" content="Technical articles about OpenZiti"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://openziti.io/blog/page/2"><link data-rh="true" rel="alternate" href="https://openziti.io/blog/page/2" hreflang="en"><link data-rh="true" rel="alternate" href="https://openziti.io/blog/page/2" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://EXWPKK5PV4-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="OpenZiti RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="OpenZiti Atom Feed">


<link rel="preconnect" href="https://www.googletagmanager.com">
<script>window.dataLayer=window.dataLayer||[]</script>
<script>!function(e,t,a,n,g){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var m=t.getElementsByTagName(a)[0],r=t.createElement(a);r.async=!0,r.src="https://www.googletagmanager.com/gtm.js?id=GTM-5SF399H3",m.parentNode.insertBefore(r,m)}(window,document,"script","dataLayer")</script>




<link rel="search" type="application/opensearchdescription+xml" title="OpenZiti" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.d43ad171.css">
<link rel="preload" href="/assets/js/runtime~main.d0af056d.js" as="script">
<link rel="preload" href="/assets/js/main.964fe104.js" as="script">
</head>
<body class="navigation-with-keyboard">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5SF399H3" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>



<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="root_VOM9"><span style="color:whitesmoke">Star us on GitHubÂ </span><span style="height:20px"><span><a href="https://github.com/openziti/ziti" data-icon="octicon-star" data-show-count="true" aria-label="Star buttons/github-buttons on GitHub">Star</a></span></span></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://openziti.io" target="_self" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/img/ziti-logo-dark.svg" alt="The OpenZiti logo, an open source zero trust network overlay" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/ziti-logo-light.svg" alt="The OpenZiti logo, an open source zero trust network overlay" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/learn/introduction/">Documentation</a><a class="navbar__item navbar__link" href="/docs/downloads">Downloads</a><a href="https://blog.openziti.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Blog</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Links</a><ul class="dropdown__menu"><li><div class="text-divider"><p>Socials</p></div></li><li><a href="https://www.youtube.com/OpenZiti" target="_blank" title="OpenZiti on YouTube"><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/yt.svg">YouTube</span></a></li><li><a href="https://twitter.com/OpenZiti" target="_blank" title="OpenZiti on Twitter"><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/twit.svg">Twitter</span></a></li><li><a href="https://www.reddit.com/r/openziti" target="_blank" title="OpenZiti Subreddit"><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/reddit-logo.png">Reddit</span></a></li><li><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/ziggy.png"><a href="https://twitter.com/OpenZiggy" target="_blank" title="OpenZiggy on Twitter">Ziggy</a></span></li><li><div class="text-divider"><p>Other</p></div></li><li><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/blog-icon.png"><a href="https://blog.openziti.io/" target="_blank" title="Blog">Blog</a></span></li><li><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/oz-test-kitchen.png"><a href="https://github.com/openziti-test-kitchen" target="_blank" title="Git project for the test kitchen">Test Kitchen</a></span></li><li><a href="https://zeds.openziti.org" target="_blank" title="Developer Sandbox"><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/zeds.png">ZEDS</span></a></li><li><a href="https://netfoundry.io/pricing/" target="_blank" title="NetFoundry-hosted Ziti"><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/nf.svg">CloudZiti</span></a></li></ul></div><a href="https://openziti.discourse.group/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-discourse-link" title="Discourse"></a><a href="https://github.com/openziti/ziti" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" title="GitHub"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_eExm"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/articles">Articles</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/c-sdk-on-beaglebone">Building the Ziti C SDK and Sample Apps for arm (BeagleBone)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/bootstrapping-trust/part-01.encryption-everywhere">Bootstrapping Trust</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/bootstrapping-trust/part-02.a-primer-on-public-key-cryptography">Bootstrapping Trust</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/bootstrapping-trust/part-03.certificates">Bootstrapping Trust</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="The previous post showed how to use a zero trust overlay like Ziti for transferring files by zitifying scp. Next up in the list of zitifications is kubectl. Kubernetes is a container orchestration system. Its purpose is to deploy, scale, and manage the deployment containers. Containers are self-contained, pre-built images of software generally with a singular purpose. Developers often like using containers for various reasons. One major reason developers like containers is because it simplifies the deployment of the solutions they are developing. This is where Kubernetes starts to come into focus."><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/zitification/kubernetes">Zitifying Kubectl</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-01-15T15:50:26.000Z" itemprop="datePublished">January 15, 2024</time> Â· <!-- -->13 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/dovholuknf" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/46322585?v=4" alt="Clint Dovholuk" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/dovholuknf" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Clint Dovholuk</span></a></div><small class="avatar__subtitle" itemprop="description">OpenZiti Maintainer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>The <a href="/blog/zitification/zitifying-scp/">previous post</a> showed how to use a zero trust overlay like Ziti for transferring files by zitifying <code>scp</code>. Next up in the list of zitifications is <code>kubectl</code>. <a href="https://Kubernetes.io/" target="_blank" rel="noopener noreferrer">Kubernetes</a> is a container orchestration system. Its purpose is to deploy, scale, and manage the deployment containers. Containers are self-contained, pre-built images of software generally with a singular purpose. <a href="https://appfleet.com/blog/10-reasons-why-developers-love-docker/" target="_blank" rel="noopener noreferrer">Developers often like using containers for various reasons</a>. One major reason developers like containers is because it simplifies the deployment of the solutions they are developing. This is where Kubernetes starts to come into focus.</p><p>In this article we&#x27;ll use a cloud provider to create a Kubernetes cluster to use. I&#x27;m using Oracle OKE in this article but there are <a href="https://www.google.com/search?q=kubernetes+cloud+providers&amp;oq=kubernetes+cloud+providers" target="_blank" rel="noopener noreferrer">numerous Kubernetes providers</a> and any of them will work but clearly the commands I&#x27;m running here are Oracle specific. Once created we will then access the cluster three ways:</p><ol><li>Via the public Kubernetes API secured via mTLS. This is the default, out-of-the-box mechanism provided by Kubernetes.</li><li>Via a tunneling app. I run Windows, so I&#x27;ll use the Ziti Desktop Edge for Windows.</li><li>Via a zitified <code>kubectl</code>. Here&#x27;s where we&#x27;ll get to see the power of a truly zitified application. We&#x27;ll be able to access our cluster extremely securely using the Ziti overlay network without installing an additional agent. Once access to the cluster comes entirely from the <a href="/docs/learn/introduction/">Ziti Network</a>, we will be able to turn public access to the Kubernetes management API <strong>off</strong> entirely!</li></ol><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="about-kubernetes">About Kubernetes<a href="#about-kubernetes" class="hash-link" aria-label="Direct link to About Kubernetes" title="Direct link to About Kubernetes">â</a></h2><p>If you are not already familiar with Kubernetes then it&#x27;s probably best for you to stop reading and learn a little about it first. Though this article only expects you to understand the most rudimentary of commands, it won&#x27;t teach you enough about Kubernetes to understand the what&#x27;s and why&#x27;s. Lots of documentation on this topic already exist and are just a search away in your search engine of choice.</p><p>Kubernetes itself is not a container engine, it&#x27;s an orchestrator. This means that Kubernetes knows how to interface with container engines to perform deployments and management of workloads on the behalf of operators. This provides people with a common abstraction to use when doing this management and deployment. Interacting with the Kubernetes API is made easy by using the command-line tool: <code>kubectl</code>.</p><p><a href="https://Kubernetes.io/docs/reference/kubectl/overview/" target="_blank" rel="noopener noreferrer">kubectl</a> provides numerous commands and utilities to interact with your Kubernetes cluster. It does this by creating REST requests to a well-known endpoint. This endpoint is a highly-valuable target as it is the entry-point to the cluster. Plenty of blogs exist already on the internet addressing how to secure this endpoint but in this post we&#x27;ll take it one step further than ever before by removing the Kubernetes control plane from the internet entirely. Following that we will even go one step further by replacing the existing <code>kubectl</code> command with a zero-trust implementation leveraging the ziti golang sdk.</p><p>If you&#x27;d prefer to watch a video that goes over the same content contained in the rest of this article you can go ahead and click here to watch.</p><p><a href="https://youtu.be/CRoansolpR0" target="_blank" rel="noopener noreferrer"><img loading="lazy" src="https://img.youtube.com/vi/CRoansolpR0/0.jpg" alt="Secure Kubernetes" class="img_ev3q"></a></p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="setup">Setup<a href="#setup" class="hash-link" aria-label="Direct link to Setup" title="Direct link to Setup">â</a></h2><p>Below is an overview of the <a href="/docs/learn/introduction/">Ziti Network</a> I created for this article. On the left you can see that the client, my computer, runs Windows 10. Inside Windows 10 I run linux and bash using Ubuntu via <a href="https://docs.microsoft.com/en-us/windows/wsl/install" target="_blank" rel="noopener noreferrer">Windows Subsystem For Linux (WSL)</a>. If you run Windows and don&#x27;t have WSL installed I would encourage you to install and learn it!  In my bash shell I have downloaded the linux version of <code>kubectl</code> created by combining the Ziti Golang SDK into it. You can grab it from <a href="https://github.com/openziti-incubator/kubectl/releases/latest/download/kubectl-linux-amd64" target="_blank" rel="noopener noreferrer">this link</a> if you like or go check out <a href="https://github.com/openziti-incubator/kubectl" target="_blank" rel="noopener noreferrer">the code on GitHub</a> and build it yourself! :)</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="solution-overview">Solution Overview<a href="#solution-overview" class="hash-link" aria-label="Direct link to Solution Overview" title="Direct link to Solution Overview">â</a></h3><p><img loading="lazy" alt="private-kubernetes.svg" src="/assets/images/private-kubernetes-046834ce3b35e4a1a28557d6f474c6a7.svg" width="1087" height="474" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="basic-ziti-setup">Basic Ziti Setup<a href="#basic-ziti-setup" class="hash-link" aria-label="Direct link to Basic Ziti Setup" title="Direct link to Basic Ziti Setup">â</a></h3><p>To accomplish our stated goals, we will need not only an existing <a href="/docs/learn/introduction/">Ziti Network</a> but we&#x27;ll also have to configure that network accordingly. Here&#x27;s a list of the components necessary to deliver Kubernetes with our zero-trust network:</p><ol><li>A configuration for the <code>Bind</code> side of the service. This informs the identity within Kubernetes where to send traffic and how.</li><li>A configuration for the <code>Dial</code> side of the service. This is strictly <strong>only</strong> necessary for tunneling apps. In this example, for the Ziti Desktop Edge for Windows and specifies what host and port will be intercepted on the machine running the stock <code>kubectl</code>. for Windows.</li><li>The service itself which ties our polices mentioned above together.</li><li>A <code>Bind</code> service-policy which specifies which identities are allowed to act as a &quot;host&quot; for the service (meaning an identity to send traffic to which knows where and how to offload that traffic). In our example this will be the <code>ziti-edge-tunnel</code> running in a Kubernetes pod.</li><li>A <code>Dial</code> service-policy which specifies the identities allowed to access the service. This will be the identity using
<code>kubectl</code>.</li><li>Create two identities - one for the <code>Bind</code> side of the service (deployed within the Kubernetes cluster) and one for the <code>Dial</code> or client side.</li></ol><p>Here are some example commands using the <a href="https://github.com/openziti/ziti/releases/latest" target="_blank" rel="noopener noreferrer">ziti cli</a> which illustrate how to create these services. Some things of note worth mentioning. I&#x27;m setting a variable to make my configuration easier. I reuse these code blocks a lot and by extracting some variables it makes it easy for me to delete/recreate services. First I set the <code>service_name</code>
variable. I use this variable in all the names of the Ziti objects I create just to make it more clear and obvious if I have to look back at my configuration again.</p><p>Since I&#x27;m going to be accessing my Kubernetes API which I&#x27;ve deployed using the Oracle cloud I chose to use <code>k8s.oci</code>
as my service name. When deployed by a cloud provider, the Kubernetes API is generated or updated with numerous SANS and IP address I can choose from to represent the <code>Dial</code> side which will be intercepted by the Ziti Desktop Edge for Windows. The Oracle cloud console informs me that the private IP of <code>10.0.0.6</code> was assigned to my cluster when I click on the &#x27;Access Cluster&#x27; button which is why I chose to use that value below. I could have chosen to use any of the DNS names provided by OKE. There are at least five I could choose from, all visible as SANS on the cert that the server returns: <code>kubernetes</code>, <code>kubernetes.default</code>, <code>kubernetes.default.svc</code>, <code>kubernetes.default.svc.cluster</code>
, <code>kubernetes.default.svc.cluster.local</code>. I chose the IP since it&#x27;s pretty obvious that it&#x27;s an internal IP, not on my local network. Also worth pointing out is that I&#x27;m mapping the port as well, changing it from the port that the server provides, 6443, to the common HTTPS port of 443 for the local intercept. With zitified <code>kubectl</code> we don&#x27;t even need these intercepts, but we&#x27;ll keep it here so that we can use the unmodified <code>kubectl</code> as well. Finally, these commands are all executed inside a bash shell since I&#x27;m using WSL.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="example-ziti-cli-commands">Example Ziti CLI commands<a href="#example-ziti-cli-commands" class="hash-link" aria-label="Direct link to Example Ziti CLI commands" title="Direct link to Example Ziti CLI commands">â</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># the name of the service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">service_name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">k8s.oci</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># the name of the identity you&#x27;d like to see on the kubectl client</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">the_user_identity</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${service_name}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain">.client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># the name of the identity deployed into the kubernetes cluster</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">the_kubernetes_identity</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${service_name}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain">.private</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${service_name}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain">-host.v1 host.v1 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;{&quot;protocol&quot;:&quot;tcp&quot;, &quot;address&quot;:&quot;10.0.0.6&quot;,&quot;port&quot;:6443 }&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${service_name}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain">-client-config intercept.v1 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;{&quot;protocols&quot;:[&quot;tcp&quot;],&quot;addresses&quot;:[&quot;10.0.0.6&quot;,&quot;kubernetes&quot;], &quot;portRanges&quot;:[{&quot;low&quot;:443, &quot;high&quot;:443}]}&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create </span><span class="token function" style="color:#d73a49">service</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${service_name}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --configs </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${service_name}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain">-client-config,</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${service_name}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain">-host.v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${service_name}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain">-binding Bind </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --service-roles </span><span class="token string" style="color:#e3116c">&#x27;@&#x27;</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${service_name}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --identity-roles </span><span class="token string" style="color:#e3116c">&#x27;#&#x27;</span><span class="token plain">&quot;</span><span class="token variable" style="color:#36acaa">${service_name}</span><span class="token string" style="color:#e3116c">&quot;&#x27;ServerEndpoints&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">ziti edge create service-policy &quot;</span><span class="token variable" style="color:#36acaa">${service_name}</span><span class="token string" style="color:#e3116c">&quot;-dialing Dial \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    --service-roles &#x27;@&#x27;&quot;</span><span class="token variable" style="color:#36acaa">${service_name}</span><span class="token string" style="color:#e3116c">&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    --identity-roles &#x27;#&#x27;&quot;</span><span class="token variable" style="color:#36acaa">${service_name}</span><span class="token string" style="color:#e3116c">&quot;&#x27;ClientEndpoints&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">ziti edge create identity device &quot;</span><span class="token variable" style="color:#36acaa">${the_kubernetes_identity}</span><span class="token string" style="color:#e3116c">&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    -a &quot;</span><span class="token variable" style="color:#36acaa">${service_name}</span><span class="token string" style="color:#e3116c">&quot;ServerEndpoints \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    -o &quot;</span><span class="token variable" style="color:#36acaa">${the_kubernetes_identity}</span><span class="token string" style="color:#e3116c">&quot;.jwt</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">ziti edge create identity device &quot;</span><span class="token variable" style="color:#36acaa">${the_user_identity}</span><span class="token string" style="color:#e3116c">&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    -a &quot;</span><span class="token variable" style="color:#36acaa">${service_name}</span><span class="token string" style="color:#e3116c">&quot;ClientEndpoints \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    -o &quot;</span><span class="token variable" style="color:#36acaa">${the_user_identity}</span><span class="token plain">&quot;.jwt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="kubernetes-config-files">Kubernetes Config Files<a href="#kubernetes-config-files" class="hash-link" aria-label="Direct link to Kubernetes Config Files" title="Direct link to Kubernetes Config Files">â</a></h2><p>Once we have established the pieces of the <a href="/docs/learn/introduction/">Ziti Network</a>, we&#x27;ll want to get the Kubernetes config files from OKE so that we can test access, make sure the cluster works etc. Oracle provides a CLI command which makes it pretty easy to get those config files called <code>oci</code>. As of this writing - the guide from <a href="https://docs.oracle.com/en-us/iaas/Content/API/SDKDocs/cliinstall.htm" target="_blank" rel="noopener noreferrer">Oracle is here</a>. Once <code>oci</code> is installed and configured the Oracle cloud gives you very easy commands to run which will generate two files. One file will be for accessing the Kubernetes API through the public endpoint. The other will get you the file for private access. We&#x27;re going to want both since we&#x27;re on a journey here from &quot;public API endpoint&quot; to tunneling-app-based access, to the final stage of app-embedded zero-trust directly into <code>kubeztl</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="getting-the-kubernetes-config-files">Getting the Kubernetes Config Files<a href="#getting-the-kubernetes-config-files" class="hash-link" aria-label="Direct link to Getting the Kubernetes Config Files" title="Direct link to Getting the Kubernetes Config Files">â</a></h3><p>Notice that we are changing the file location output by these commands and they are being output as two separate Kubernetes config files. If you prefer to merge them all into one big config file and change contexts - feel free. I left them as separate files here because it provides a very clear separation as to which config is being used or modified.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Get this value directly from Oracle</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">oci_cluster_id</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;put-your-cluster-id-here&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">oci ce cluster create-kubeconfig </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --cluster-id </span><span class="token variable" style="color:#36acaa">${oci_cluster_id}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --file /tmp/oci/config.oci.public </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --region us-ashburn-1 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --token-version </span><span class="token number" style="color:#36acaa">2.0</span><span class="token plain">.0 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --kube-endpoint PUBLIC_ENDPOINT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">600</span><span class="token plain"> /tmp/oci/config.oci.public</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">oci ce cluster create-kubeconfig </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --cluster-id </span><span class="token variable" style="color:#36acaa">${oci_cluster_id}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --file /tmp/oci/config.oci.private </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --region us-ashburn-1 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --token-version </span><span class="token number" style="color:#36acaa">2.0</span><span class="token plain">.0 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --kube-endpoint PRIVATE_ENDPOINT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">600</span><span class="token plain"> /tmp/oci/config.oci.private</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="connecting-the-pieces">Connecting the Pieces<a href="#connecting-the-pieces" class="hash-link" aria-label="Direct link to Connecting the Pieces" title="Direct link to Connecting the Pieces">â</a></h2><p>At this point we should have all the pieces in place so that we can start putting them together to test the overall solution. In this section we&#x27;ll access our public Kubernetes api to make sure it works. Then we&#x27;ll install Ziti into the Kubernetes cluster and verify private access works. Finally we&#x27;ll disable public access <strong>entirely</strong> and use the zitified <code>kubeztl</code> command to access the cluster with true, app-embedded zero-trust binary.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="testing-the-public-api">Testing the Public API<a href="#testing-the-public-api" class="hash-link" aria-label="Direct link to Testing the Public API" title="Direct link to Testing the Public API">â</a></h3><p>This step is very straight-forward for anyone who&#x27;s used Kubernetes before. Issue the following commands, making sure the path is correct for your public Kubernetes config file, and verify Kubernetes works as expected.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">KUBECONFIG</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/oci/config.oci.public</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods -v6 --request-timeout</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;5s&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I1019 </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:57:31.910962    </span><span class="token number" style="color:#36acaa">3211</span><span class="token plain"> loader.go:372</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Config loaded from file:  /tmp/oci/config.oci.public</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I1019 </span><span class="token number" style="color:#36acaa">13</span><span class="token plain">:57:33.676047    </span><span class="token number" style="color:#36acaa">3211</span><span class="token plain"> round_trippers.go:454</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> GET https://150.230.150.0:6443/api/v1/namespaces/default/pods?limit</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">500</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token assign-left variable" style="color:#36acaa">timeout</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">5s </span><span class="token number" style="color:#36acaa">200</span><span class="token plain"> OK </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1752</span><span class="token plain"> milliseconds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                        READY   STATUS    RESTARTS   AGE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If your output looks something similar to the above (with or without the pods you expect to see) then great! That means your Kubernetes cluster is indeed up and running. Let&#x27;s move on!</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="deploying-ziti-to-kubernetes">Deploying Ziti to Kubernetes<a href="#deploying-ziti-to-kubernetes" class="hash-link" aria-label="Direct link to Deploying Ziti to Kubernetes" title="Direct link to Deploying Ziti to Kubernetes">â</a></h4><p>Next we&#x27;ll grab a few lines from the excellent guide NetFoundry put out for integrating with Kubernetes. There&#x27;s a section in that guide for <a href="https://developer.netfoundry.io/guides/kubernetes/#install-ziti-with-helm" target="_blank" rel="noopener noreferrer">installing Ziti with Helm</a>. This comes down to just these steps:</p><ol><li>install the <code>helm</code> CLI tool <a href="https://helm.sh/docs/intro/install/" target="_blank" rel="noopener noreferrer">using this guide</a></li><li>add the NetFoundry helm repo: <code>helm repo add netfoundry https://netfoundry.github.io/charts/</code></li><li>locate the jwt file for the Kubernetes identity. If you followed the steps above the file will be named: <code>&quot;${the_kubernetes_identity}&quot;.jwt</code> (make sure you replace the variable with the correct value)</li><li>use the jwt to add Ziti: <code>helm install ziti-host netfoundry/ziti-host --set-file enrollmentToken=&quot;${the_kubernetes_identity}&quot;.jwt</code> (again make sure you replace the variable name) If you need to, make sure you create a persistent volume. The ziti pod requires storage to store a secret.</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: PersistentVolume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: ziti-host-pv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type: </span><span class="token builtin class-name">local</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  storageClassName: oci</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  capacity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    storage: 100Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  accessModes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - ReadWriteMany</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hostPath:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    path: </span><span class="token string" style="color:#e3116c">&quot;/netfoundry&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="addenroll-the-client-identity">Add/Enroll the Client Identity<a href="#addenroll-the-client-identity" class="hash-link" aria-label="Direct link to Add/Enroll the Client Identity" title="Direct link to Add/Enroll the Client Identity">â</a></h4><p>Now consume the one time token (the jwt file) to enroll and create a client-side identity using the Ziti Desktop Edge for Windows (or MacOS or via the <code>ziti-edge-tunnel</code> if you prefer). Once you can see the identity in your tunneling app, you should be able to use the private kubernetes config file to access the same exact cluster. Remember though, we have mapped the port on the client side to use 443. That means you&#x27;ll need to update your config file and change 6443 --&gt; 443. Now when you run <code>get pods</code> you&#x27;ll see the ziti-host pod deployed:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">KUBECONFIG</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/oci/config.oci.private</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                        READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti-host-976b84c66-kr4bc   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          90m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-big-finale---zitified-kubectl">The Big Finale - Zitified kubectl<a href="#the-big-finale---zitified-kubectl" class="hash-link" aria-label="Direct link to The Big Finale - Zitified kubectl" title="Direct link to The Big Finale - Zitified kubectl">â</a></h2><p>If you have made it this far, you&#x27;ve seen us access the Kubernetes API via the public IP. We&#x27;ve even accessed it via the private IP (which btw - is pretty cool in my opinion!). Now we&#x27;re going to download the zitified kubectl command, turn off the public IP and even turn off the locally running tunneling app and still access the API!</p><ol><li><p>Disable the cluster&#x27;s public IP address in OKE (go to the cluster in Oracle Cloud, click Edit and remove the public IP and click save)</p></li><li><p>Turn off the Ziti Desktop Edge for Windows</p></li><li><p>Build <code>kubeztl</code> from <a href="https://github.com/openziti-test-kitchen/kubeztl" target="_blank" rel="noopener noreferrer">the GitHub repo</a></p></li><li><p>Use <code>kubeztl</code> to get pods!</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./kubeztl -zConfig ./id.json -service k8s.oci get pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                        READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti-host-976b84c66-kr4bc   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          101m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="modifying-kubeconfig">Modifying KUBECONFIG<a href="#modifying-kubeconfig" class="hash-link" aria-label="Direct link to Modifying KUBECONFIG" title="Direct link to Modifying KUBECONFIG">â</a></h3><p>The <code>kubeztl</code> command has also been modified to allow you to add the service name and config file directly into the file itself. This is convenient since you will not need to supply the ziti identity file, nor will you need to specify which service to use. Modifying the file is straight-forward. Open the config file, find the context listed under the contexts root and add two rows as shown here.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">contexts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- context:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cluster: cluster-cjw4arxuolq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    user: user-cjw4arxuolq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    zConfig: /tmp/oci/k8s.id.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    service: k8s.oci</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Once done - you can now simply use the context the same way you have always - <code>kubeztl get pods</code>!</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./kubeztl get pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                        READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti-host-976b84c66-kr4bc   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          114m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">â</a></h2><p>We&#x27;ve seen in this post how you can not only secure your Kubernetes API with the normal Kubernetes mechanisms. You can also take your Kubernetes API off the internet <strong>ENTIRELY</strong>. No need to deploy and maintain a special bastian node. Now by having a secure, zero-trust overlay in place you can safely and securely access your Kubernetes API without the fear of that public, high-value API getting attacked.</p><p><img loading="lazy" src="https://i.imgur.com/JRBQMkN.jpg" alt="But Wait, There&#x27;s More" class="img_ev3q"></p><p>Once you&#x27;ve deployed Ziti into the Kubernetes cluster you&#x27;re not done there. Now you can also use Ziti to span cloud networks. You can use it to easily link private data centers or other private Kubernetes clusters all into one secure, zero-trust overlay network! Use Ziti to expose workloads that are <strong>TRULY</strong> private!  In future articles we might explore how we can bring Ziti to bear on these topics, stay tuned!</p><hr></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="_This is part one of a three-part article. This article provides the necessary background and rationale of the series."><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/zitification/prometheus/part1">Enable Prometheus to Scrape Anything from Anywhere</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-01-15T15:50:26.000Z" itemprop="datePublished">January 15, 2024</time> Â· <!-- -->13 min read</div></header><div class="markdown" itemprop="articleBody"><p><em>This is part one of a three-part article. This article provides the necessary background and rationale of the series.
<a href="/blog/zitification/prometheus/part2">The next article</a> will be a detailed explanation of the actual steps necessary to implement the solution.
In <a href="/blog/zitification/prometheus/part3">the final article</a>, we will explore what we have just created and understand what was just created</em></p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-problem-with-pulling">The Problem With Pulling<a href="#the-problem-with-pulling" class="hash-link" aria-label="Direct link to The Problem With Pulling" title="Direct link to The Problem With Pulling">â</a></h2><p>Prometheus is a server which wants to reach out and pull data from &quot;scrape targets&quot;. It will generally do this using http requests. One
problem with this design is that these targets are often inaccessible, hidden from Prometheus behind a firewall.</p><p>If not hidden, it means some port was exposed on some network, thereby giving Prometheus the ability to pull the data it needs. Exposing
that port on a &quot;trusted&quot; network is a possible attack vector for bad actors. Exposing that port on the open internet (as is often the case)
is an open invitation for attack. It&#x27;s much better to keep these servers totally dark to all networks.</p><p>OpenZiti solves this problem of reach elegantly and natively while also keeping your service dark to all networks. This gives an
OpenZiti-enabled Prometheus the ability to literally scrape any target, anywhere. As long as the target is participates on an OpenZiti
overlay network, and as long as the proper polices are in place allowing the traffic to flow, Prometheus will be able to reach out and
pull the data it needs from anything, anywhere.</p><p>It doesn&#x27;t matter if the target is in some private cloud data center, some private data center protected by a corporate firewall, or heck
even running inside my local docker environment! As long as the target participates on that OpenZiti Prometheus can scrape it! That sort of
reach is impossible with classic networks.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="prometheus">Prometheus<a href="#prometheus" class="hash-link" aria-label="Direct link to Prometheus" title="Direct link to Prometheus">â</a></h2><p><a href="https://prometheus.io/" target="_blank" rel="noopener noreferrer">Prometheus</a> is an incredibly popular <a href="https://www.cncf.io/projects/prometheus/" target="_blank" rel="noopener noreferrer">CNCF</a>
project which has graduated the gauntlet of progressions to emerge as a &quot;graduated&quot; CNCF project. If you&#x27;re familiar with Prometheus, there
are probably a couple of reasons people mainly choose to deploy it:
metrics collection and visualization and alerting.</p><p>Prometheus is also tremendously flexible. It has numerous available plugins and supports integrating with a wide number of systems.
According
to <a href="https://www.cncf.io/blog/2022/03/08/cloud-native-observability-microsurvey-prometheus-leads-the-way-but-hurdles-remain-to-understanding-the-health-of-systems/" target="_blank" rel="noopener noreferrer">this CNCF survey</a>
, Prometheus leads the pack when it comes to the project people go to for observability. Its popularity is probably because Prometheus is a
CNCF project and is often considered the &quot;default&quot; solution to deploy on another wildly popular CNCF project
called <a href="https://kubernetes.io" target="_blank" rel="noopener noreferrer">Kubernetes</a>. One interesting aspect of Prometheus is that it generally favors a poll-based approach to
metrics collection instead of a push-based model.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="poll-based">Poll-based?<a href="#poll-based" class="hash-link" aria-label="Direct link to Poll-based?" title="Direct link to Poll-based?">â</a></h3><p>I don&#x27;t know about you, but historically when I&#x27;ve thought about a metrics collection agent, I tend to think of an agent that reads a log
file or some library that pushes rows into a giant data lake in the cloud. I don&#x27;t generally think about a solution that implements
poll-based metrics. Often, this is because the target of a poll-based collecting agent will probably be behind a firewall.</p><p><img loading="lazy" alt="FW" src="/assets/images/fw-b1c8555546b90b5151f6ede0e27d7111.png" width="489" height="276" class="img_ev3q"></p><p>As you would expect, firewalls make it exceptionally difficult to implement a poll-based solution as firewalls have been known to make a
habit of preventing external actors from accessing random http servers behind it! After all, that is their primary function!</p><p>The Prometheus project makes <a href="https://prometheus.io/docs/practices/pushing/" target="_blank" rel="noopener noreferrer">strong arguments</a> explaining the benefits of a poll-based
solution. They also realize that firewalls are important in creating a safe network and understand the challenges firewalls create for such
a solution. To deal with these situations, the project also provides a <a href="https://prometheus.io/docs/instrumenting/pushing/" target="_blank" rel="noopener noreferrer">PushGateway</a>.
This allows solutions to push their data to a location outbound of the firewall. Pushing data out of the firewall allows metrics and
alerting to function without the worry (and maintenance heartache) of an open, inbound firewall hole.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="acceptable-risk">Acceptable Risk<a href="#acceptable-risk" class="hash-link" aria-label="Direct link to Acceptable Risk" title="Direct link to Acceptable Risk">â</a></h3><p>Prometheus is often deployed into Kubernetes clusters, but it can be deployed anywhere. Taking the operational differences out of the
equation, there is little difference between deploying Prometheus in a Kubernetes cluster and deploying it in one&#x27;s data center. Once
deployed, the needs will be the same. Prometheus will need to be authorized to reach out and scrape the targets it needs to scrape. All too
often, this is done with relatively open network permissions. Even though we all know it&#x27;s not the most secure way of authorizing
Prometheus, this is often considered &quot;safe enough&quot; because we deployed Prometheus into a zone considered &quot;safe&quot;. Managing firewall rules to
all the computers Prometheus needs access to, feels like an impossible feat. There are just too many.</p><p>To add to our acceptable risk, we will need to be able to access the Prometheus server in some way. We&#x27;ll want to get at the UI, see the
charts and graphs and data it provides and use the server to its fullest. For that, we&#x27;ll <strong>of course</strong>
need a hole in our firewall, or in the case of Kubernetes we will probably deploy some form of
<a href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/" target="_blank" rel="noopener noreferrer">Kubernetes Ingress Controller</a> to provide users access
the service.</p><p>What we need are better and richer controls over our network. We need a better way of authorizing Prometheus without the hassle of
maintaining firewall rules on individual machines. We also need a way to do this across multiple clouds, multiple Kubernetes clusters and
multiple data centers. Let&#x27;s see how OpenZiti can solve this problem while also enhancing our overall security.</p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="openziti">OpenZiti<a href="#openziti" class="hash-link" aria-label="Direct link to OpenZiti" title="Direct link to OpenZiti">â</a></h2><p>The <a href="https://openziti.github.io" target="_blank" rel="noopener noreferrer">OpenZiti</a> project allows us to solve all the problems outlined above. It is a fully-featured, zero trust
overlay network and enables <a href="https://en.wikipedia.org/wiki/Zero_trust_security_model" target="_blank" rel="noopener noreferrer">zero trust networking principles</a> to be applied
anywhere. This includes bringing those zero trust principles directly into your application through one of the many SDKs provided
by the project. Let&#x27;s look at an example and see what a setup might look like before and after applying OpenZiti.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">â</a></h3><p>Let&#x27;s imagine that we have already deployed a solution using two Kubernetes clusters, ClusterA and ClusterB. It doesn&#x27;t matter where the
clusters are deployed. We are trying to illustrate a real-world situation where we have two separate Kubernetes clusters that we want to
manage. The clusters could be deployed in the same cloud provider, in a private data center, in different cloud providers, it really does
not matter. What is important, is that these clusters are available over the network. To enable access to the workloads inside the
clusters, some form of Kubernetes ingress controller will be required on both clusters. In our example, we will have a workload deployed
which exposes a prometheus scrape target we want Prometheus to monitor.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="figure-1---before-openziti">Figure 1 - Before OpenZiti<a href="#figure-1---before-openziti" class="hash-link" aria-label="Direct link to Figure 1 - Before OpenZiti" title="Direct link to Figure 1 - Before OpenZiti">â</a></h4><p><img loading="lazy" alt="Before OpenZiti" src="/assets/images/kubernetes-prometheus-before-15c1791d4c7ba9b5960fa1af5bacb258.svg" width="1099" height="534" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="taking-a-closer-look">Taking a Closer Look<a href="#taking-a-closer-look" class="hash-link" aria-label="Direct link to Taking a Closer Look" title="Direct link to Taking a Closer Look">â</a></h3><p>Looking at the diagram above with a discerning eye towards security, there are some immediate observations one can make.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="listening-ports">Listening Ports<a href="#listening-ports" class="hash-link" aria-label="Direct link to Listening Ports" title="Direct link to Listening Ports">â</a></h4><p>One observation we have already accepted from the overview, is that these clusters must be exposed via the internet. At first that doesn&#x27;t
seem like a big deal, we expose workloads like this to the internet all the time. This is a perfectly normal action, it&#x27;s likely
done every day somewhere in the world. It&#x27;s so common, we almost don&#x27;t even think about it until the time comes when we <strong>need</strong> to
think about it. This ends up in an exposed port, listening somewhere in the world. There might be a firewall with complex rules to
protect this port, but it&#x27;s just as likely that this isn&#x27;t the case. People might need to access the resources inside these clusters
from anywhere. </p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="kubernetes-api-exposed">Kubernetes API Exposed<a href="#kubernetes-api-exposed" class="hash-link" aria-label="Direct link to Kubernetes API Exposed" title="Direct link to Kubernetes API Exposed">â</a></h4><p>Another observation is that the Kubernetes API is fully exposed to the internet. This API is a very high-value target and should be
secured as strongly as possible. That probably means yet another complex firewall rule to maintain.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="trusted-intra-cluster-traffic">&quot;Trusted&quot; Intra-cluster Traffic<a href="#trusted-intra-cluster-traffic" class="hash-link" aria-label="Direct link to &quot;Trusted&quot; Intra-cluster Traffic" title="Direct link to &quot;Trusted&quot; Intra-cluster Traffic">â</a></h4><p>The final point to note is that the traffic within the cluster is considered safe. As mentioned above, the Prometheus server needs to be
able to scrape the target workloads. That traffic is necessary to be considered safe. Also, notice that the pod for Prometheus contains a
container named &quot;configmap-reload&quot; which is used to trigger a webhook on the Prometheus server when the
<a href="https://kubernetes.io/docs/concepts/configuration/configmap/" target="_blank" rel="noopener noreferrer">Kubernetes config map</a> changes. This is necessary when changing the
Prometheus config, adding new scrape configs etc.</p><hr><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="authors-dovholuknf">authors: dovholuknf<a href="#authors-dovholuknf" class="hash-link" aria-label="Direct link to authors: dovholuknf" title="Direct link to authors: dovholuknf">â</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="applying-zero-trust-networking-principles-using-openziti">Applying Zero Trust Networking Principles Using OpenZiti<a href="#applying-zero-trust-networking-principles-using-openziti" class="hash-link" aria-label="Direct link to Applying Zero Trust Networking Principles Using OpenZiti" title="Direct link to Applying Zero Trust Networking Principles Using OpenZiti">â</a></h3><p>Now that we understand the basic setup and understand some possible problems, let&#x27;s see if OpenZiti can address one or more of these
issues. When applying OpenZiti, the goal will be to strengthen our security posture for each of the above items.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="figure-2---after-openziti">Figure 2 - After OpenZiti<a href="#figure-2---after-openziti" class="hash-link" aria-label="Direct link to Figure 2 - After OpenZiti" title="Direct link to Figure 2 - After OpenZiti">â</a></h4><p><img loading="lazy" alt="after" src="/assets/images/kubernetes-prometheus-after-1c432161cd5ceac47eadc4149cae35fb.svg" width="1264" height="531" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="taking-a-closer-look-after-openziti">Taking a Closer Look After OpenZiti<a href="#taking-a-closer-look-after-openziti" class="hash-link" aria-label="Direct link to Taking a Closer Look After OpenZiti" title="Direct link to Taking a Closer Look After OpenZiti">â</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="no-external-listening-ports">No External Listening Ports<a href="#no-external-listening-ports" class="hash-link" aria-label="Direct link to No External Listening Ports" title="Direct link to No External Listening Ports">â</a></h4><p>With a classic deployment as shown in the initial design, we know there will be ports exposed to the open internet. In an ideal scenario,
there would be absolutely no ports exposed on the open internet <strong>nor</strong> in the &quot;trusted networking zone&quot;. It&#x27;s immediately obvious after
applying a solution using OpenZiti that those listening ports exposed by the Kubernetes ingress controller are no longer deployed and thus
are no longer exposed to the internet. That&#x27;s one attack vector eliminated. OpenZiti will initiate outbound mTLS connections among all the
constituent pieces of the overlay network. This means connections will begin inside the trusted network zone and only create outbound
links. Once established, those connections can be used to safely transfer data between any participating edge node.</p><p>This capability really can&#x27;t be emphasized enough. With OpenZiti and with applications that use an OpenZiti SDK, such as the ones shown,
there are no open ports to attack. This network is nearly impervious to the classical &quot;land and expand&quot; technique so many bad actors
look to exploit.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="kubernetes-api-no-longer-exposed">Kubernetes API no Longer Exposed<a href="#kubernetes-api-no-longer-exposed" class="hash-link" aria-label="Direct link to Kubernetes API no Longer Exposed" title="Direct link to Kubernetes API no Longer Exposed">â</a></h4><p>Another significant benefit provided by OpenZiti is starting to come into focus. By having access to our clusters provided
through OpenZiti, we can <strong>stop exposing</strong> the Kubernetes APIs for both clusters to the open internet. Prometheus will still be able to
monitor each Kubernetes cluster through the private Kubernetes network. Accessing Prometheus will be provided via OpenZiti, instead of
using a Kubernetes ingress controller. Later, we can ues the built-in capability Prometheus already provides to federate information
from the clusters to a centralized, <a href="/blog/zitification">zitified</a> Prometheus server.</p><p>Once no longer exposed to the open internet, to maintain our Kubernetes cluster we could then turn to <!-- -->[zitified]<!-- -->
(/zitification/index.md) tools. The OpenZiti project provides zitified versions of <code>kubectl</code> -
<a href="https://github.com/openziti-test-kitchen/kubectl" target="_blank" rel="noopener noreferrer">kubeztl</a> and <code>helm</code> -
<a href="https://github.com/openziti-test-kitchen/helm" target="_blank" rel="noopener noreferrer">helmz</a>. Each of these tools have an OpenZiti SDK embedded inside them. This allows both
tools to connect to the private Kubernetes API over the OpenZiti overlay network. To use them, you will need a strong, OpenZiti identity
as well as be authorized to access the service. Also note that we&#x27;re also not replacing the existing security constraints the
Kubernetes ecosystem already provides. You can (and should) still secure your Kubernetes clusters using namespaces, roles, etc. </p><p>We&#x27;ll explore <code>kubeztl</code> and <code>helmz</code> in future articles.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="trusted-intra-cluster-traffic-1">&quot;Trusted&quot; Intra-cluster Traffic<a href="#trusted-intra-cluster-traffic-1" class="hash-link" aria-label="Direct link to &quot;Trusted&quot; Intra-cluster Traffic" title="Direct link to &quot;Trusted&quot; Intra-cluster Traffic">â</a></h4><p>Lastly, let&#x27;s turn our eyes toward the traffic running inside the Kubernetes cluster. Pay attention to the lines in orange and the lines in
dark blue. Orange lines represent &quot;private&quot; traffic, traffic that needs to traverse the private network space.</p><p>At this point we cannot send traffic to the Kubernetes API via the overlay network. The Kubernetes API doesn&#x27;t have an OpenZiti SDK
embedded within it. That means when we deploy Prometheus into ClusterA and ClusterB to monitor the cluster, Prometheus will be forced to
connect to a port exposed on the cluster&#x27;s underlay network. Still, while not ideal, we have greatly improved the overall security
posture of the cluster. We&#x27;re no longer able to access the Kubernetes API without first gaining access to the zero trust overlay
network. Accessing the Kubernetes API will also require the identity to be properly authorized to access the service attaching to the
Kubernetes API. </p><p>Let&#x27;s now focus on ClusterA. It contains a Prometheus server that decided against listening on the OpenZiti overlay. This means it
will need to expose ports to the Kubernetes underlay network. The container inside the Prometheus pod will watch for configmap
changes. To trigger the webhook, it will be forced to send unauthenticated webhook traffic to the Prometheus server on the underlay
network in order to trigger the config to reload.</p><p>Still, accessing this cluster and the listening Prometheus server will require being on the OpenZiti overlay. Also, this Prometheus
server does have an OpenZiti SDK built into it. We also deployed the &quot;reflectz&quot; workload with an OpenZiti SDK built into it as well.
That means the Prometheus server must scrape the &quot;reflectz&quot; workload exclusively over the OpenZiti overlay. <strong>Only</strong> authorized
identities can access that scrape data.</p><p>Contrast ClusterA with ClusterB. ClusterB deployed a Prometheus server with an embedded OpenZiti SDK and chose to provide its services
exclusively on the OpenZiti overlay. We&#x27;ve also deployed a zitified &quot;reflectz&quot; workload here. Notice how little traffic traverses the
Kubernetes cluster underlay network. The only traffic which needs to traverse the cluster&#x27;s underlay network in ClusterB is the traffic
which monitors the Kubernetes API. All other traffic in the cluster is now secured by the OpenZiti overlay network. You will
need a strong identity, and you will need to be authorized on the overlay before even being allowed to connect to the target service.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="openziti-enabled-prometheus">OpenZiti-Enabled Prometheus<a href="#openziti-enabled-prometheus" class="hash-link" aria-label="Direct link to OpenZiti-Enabled Prometheus" title="Direct link to OpenZiti-Enabled Prometheus">â</a></h2><p>We are now coming to the final piece of the puzzle. We have protected both Kubernetes clusters using OpenZiti. Now we want to bring all
this data back to a centralized Prometheus server to make it easier on our user base. To do this, we&#x27;ll again deploy an OpenZiti-enabled
Prometheus server. This time we don&#x27;t care where it is deployed except that we know we are not deploying it into either of the Kubernetes
clusters we are already using. Since the Prometheus servers are all now accessible via the overlay network, we can literally deploy our
server anywhere in the world. It could be on development server, it could be deployed in some other cloud, it could be deployed in our
private data center. Because it&#x27;s part of the overlay network, it no longer matters where we deploy the server. Wherever deployed,
all it will need is outbound internet access, a strong identity, and access and authorization to services defined in the OpenZiti overlay
network. Once that&#x27;s done, OpenZiti will take care of the rest.</p><p>If you have made it this far you&#x27;re might want to try all this for yourself. The <a href="/blog/zitification/prometheus/part2">next article</a> will go into the details
necessary to implement this solution. When complete you&#x27;ll be able to deploy a zitified version of Prometheus and give Prometheus the power
to scrape anything from anywhere using OpenZiti.</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="_This is part two of a three-part article. This article provides the technical deep dive into the steps necessary to implement the vision"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/zitification/prometheus/part2">Configuring OpenZiti to Enable Prometheus</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-01-15T15:50:26.000Z" itemprop="datePublished">January 15, 2024</time> Â· <!-- -->20 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/dovholuknf" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/46322585?v=4" alt="Clint Dovholuk" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/dovholuknf" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Clint Dovholuk</span></a></div><small class="avatar__subtitle" itemprop="description">OpenZiti Maintainer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><em>This is part two of a three-part article. This article provides the technical deep dive into the steps necessary to implement the vision
outlined in <a href="/blog/zitification/prometheus/part1">part one</a>. This article will be heavy on OpenZiti CLI commands, explaining what we are doing to configure the
overlay network, and why. In <a href="/blog/zitification/prometheus/part3">the final article</a>, we will explore what we have just created and understand what was just
created</em></p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="goals">Goals<a href="#goals" class="hash-link" aria-label="Direct link to Goals" title="Direct link to Goals">â</a></h2><ul><li>Incredibly easy to deploy Prometheus servers</li><li>No ports exposed to the internet</li><li>Prometheus servers can be deployed listening on the overlay, not on the underlay</li><li>Private Kubernetes API</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="zitified-prometheus">Zitified Prometheus<a href="#zitified-prometheus" class="hash-link" aria-label="Direct link to Zitified Prometheus" title="Direct link to Zitified Prometheus">â</a></h2><p>As described in <a href="/blog/zitification/prometheus/part1">the previous article</a>, Prometheus really prefers to be able to gather metrics from the targets it is
monitoring. When the target is behind a firewall, you will be left with two choices.
<img loading="lazy" src="https://github.com/openziti/branding/raw/main/images/ziggy/svg/Ziggy%20The%20Superhero.svg" alt="superhero" class="img_ev3q">
You can choose to open a hole in the firewall granting access (a generally bad idea), or you can use a PushGateway. Even if you choose to
use the PushGateway, Prometheus will still need to be able to access and pull from the PushGateway so you&#x27;ll still need some port open and
listening for Prometheus to collect data.</p><p>What we really want is to enable Prometheus to scrape data from targets without needing to expose any ports to the internet. It would be <strong>
even better</strong> if we didn&#x27;t have to expose any ports at all, even to the local &quot;trusted&quot; network. This capability is something that is
unique to an OpenZiti-enabled application. You can take an OpenZiti SDK and embed it into your application, and give your app zero trust
superpowers! If we take an OpenZiti SDK and embed it into Prometheus, we can give Prometheus the superpower of invisibility and
addressability. Embedding an OpenZiti SDK produces a <a href="/blog/zitification">zitified</a> version of Prometheus. With an
OpenZiti-powered Prometheus, no ports need to be open.</p><p>The OpenZiti project has done the work to produce an OpenZiti-enabled version of Prometheus. It&#x27;s also entirely open source. Check it out
from the OpenZiti Test Kitchen hosted on GitHub <a href="https://github.com/openziti-test-kitchen/prometheus" target="_blank" rel="noopener noreferrer">https://github.com/openziti-test-kitchen/prometheus</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="solution-overview">Solution Overview<a href="#solution-overview" class="hash-link" aria-label="Direct link to Solution Overview" title="Direct link to Solution Overview">â</a></h2><p>As you&#x27;ll recall from <a href="/blog/zitification/prometheus/part1">part1</a>, we are trying to use Prometheus to monitor workloads in two different
Kubernetes clusters. We are going to deploy one cluster which will represent a first step of an OpenZiti solution.
It will use a Prometheus sever which is OpenZiti-enabled, but it will still listen on the underlay network and be
available to local devices on an ip:port. This Prometheus server will use OpenZiti to scrape targets which
are available anywhere on the OpenZiti overlay network and we&#x27;ll refer to this as &quot;ClusterA&quot;.</p><p>We&#x27;ll also deploy a second OpenZiti-enabled Prometheus server, in a totally separate Kubernetes cluster. This
Prometheus server will <strong>not</strong> listen on an ip:port. Instead, it will listen exclusively on the OpenZiti overlay.
This Prometheus server will have no ports available to attack and will only be accessible via a properly authorized
and authenticated OpenZiti client. This will be our &quot;ClusterB&quot;</p><p>Finally, we&#x27;ll stand up a third Prometheus server and use it to federate metrics back to a &quot;central&quot; Prometheus
server. This emulates what one might do to provide a central location for humans to go to in order to visualize data
or use the Prometheus server. We won&#x27;t care where this is deployed, we&#x27;ll actually deploy it in locally and then
move it to a private server in AWS just to show how easy it that is. </p><p>This is what the solution we&#x27;ll build looks like:
<img loading="lazy" alt="after" src="/assets/images/kubernetes-prometheus-after-1c432161cd5ceac47eadc4149cae35fb.svg" width="1264" height="531" class="img_ev3q"></p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="digging-in">Digging In<a href="#digging-in" class="hash-link" aria-label="Direct link to Digging In" title="Direct link to Digging In">â</a></h2><p>Let&#x27;s get to work and build this solution. We&#x27;ll need some legwork done first. </p><blockquote><p>[!NOTE]<!-- -->
It&#x27;s going to get deep in this article with CLI commands. You&#x27;ll see what the OpenZiti objects are that get created and learn why.
You might not want to replicate the solution on your own and instead are looking for &quot;the big reveal&quot;. If that describes you, just
skim this article lightly and get on to <a href="/blog/zitification/prometheus/part3">part3</a>. In part 3 we&#x27;ll explore the deployed solution and see what makes it so
interesting and cool.</p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a href="#prerequisites" class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites">â</a></h3><p><img loading="lazy" src="https://github.com/openziti/branding/raw/main/images/ziggy/svg/Ziggy%20The%20Construction%20Worker.svg" alt="construction worker" class="img_ev3q"></p><ul><li>You have an OpenZiti overlay network available. If not, for this scenario you will want to use
<a href="/docs/learn/quickstarts/network/hosted">&quot;host your own&quot;</a>. You&#x27;ll also want to have the ziti cli tool on your path</li><li>Two Kubernetes clusters provisioned</li><li>Necessary tooling installed and available on the path<ul><li>kubectl</li><li>helm</li></ul></li><li>bash/zsh shell - tested in bash and some commands will use variables. If you use another shell, change accordingly</li><li>a machine with <a href="https://docs.docker.com/get-docker/" target="_blank" rel="noopener noreferrer">docker installed</a> to run the final Prometheus sever on (your local machine is fine)</li><li>Ziti Desktop Edge installed on the development machine. I use
<a href="https://github.com/openziti/desktop-edge-win/releases/latest/" target="_blank" rel="noopener noreferrer">Ziti Desktop Edge for Windows</a>.</li><li>A temporary folder exists to house files as we need them: /tmp/prometheus</li></ul><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="clustera---using-ziti-host">ClusterA - Using <code>ziti-host</code><a href="#clustera---using-ziti-host" class="hash-link" aria-label="Direct link to clustera---using-ziti-host" title="Direct link to clustera---using-ziti-host">â</a></h2><p><img loading="lazy" alt="clusterA" src="/assets/images/clusterA-71f957b6205e44af29d35d4d65efc06b.svg" width="349" height="505" class="img_ev3q"></p><p>We start with an empty OpenZiti network, and two empty Kubernetes clusters. Let&#x27;s start by populating ClusterA. We will deploy three
pods into this Kubernetes cluster. When done, the Kubernetes cluster will look similar to the image to the right.</p><ul><li>Pod 1. <strong>ziti-host</strong>. This pod will provide what is effectively the equivalent of a Kubernetes ingress controller. We&#x27;ll install this
using helm from a NetFoundry provided chart</li><li>Pod 2. <strong>prometheuz</strong>. This pod will be our Prometheus server with OpenZiti embedded in it. We won&#x27;t use OpenZiti to listen on the
overlay network. Instead, we will follow a more traditional model of listening on the underlay at a known ip:port combination. We&#x27;ll
install this pod using a chart from the OpenZiti charts repository.</li><li>Pod 3. <strong>reflectz</strong>. This pod represents the workload which we want to monitor. This is another chart provided by the OpenZiti chart
repository and will also be installed with helm. If you are interested in viewing the source code for this project you can find it on
<a href="https://github.com/nf-npieros/sdk-golang/tree/feature/reflect-prometheus" target="_blank" rel="noopener noreferrer">GitHub here</a></li></ul><blockquote><p>[!NOTE]<!-- -->
Running the ziti cli commands shown below as shown will expect you to have the ziti binary on your path. Also it is expected that all
the commands run will run from the same &quot;development&quot; machine with the expected tools available. Reach out on discourse if you get stuck.</p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pod-1---ziti-host">Pod 1 - <code>ziti-host</code><a href="#pod-1---ziti-host" class="hash-link" aria-label="Direct link to pod-1---ziti-host" title="Direct link to pod-1---ziti-host">â</a></h3><p>We will start off deploying Pod 1, ziti-host, to provide access to Kubernetes ClusterA.  The ziti-host pod will require a single
identity to be provisioned. We will use a shortened name for the cluster and we&#x27;ll embed that name into the identity to make it easier
for us to understand what identity we provisioned and why, should we ever need to reference these identities later.  We&#x27;ll refer to
ClusterA as simply &quot;kubeA&quot;. Let&#x27;s make the identity now. Notice we are also passing the &quot;-a&quot; attribute during creation to add a role
attribute to the identity of <code>kubeA.services</code>. This will be used later when setting up policies.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-the-identity">Create the Identity<a href="#create-the-identity" class="hash-link" aria-label="Direct link to Create the Identity" title="Direct link to Create the Identity">â</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create identity device kubeA.ziti.id -o /tmp/prometheus/kubeA.ziti.id.jwt -a &quot;kubeA.services&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You should see confirmation output such as:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">New identity kubeA.ziti.id created with id: BeyyFUZFDR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Enrollment expires at 2022-04-22T01:18:53.402Z</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-ziti-host-into-clustera">Deploy <code>ziti-host</code> into ClusterA<a href="#deploy-ziti-host-into-clustera" class="hash-link" aria-label="Direct link to deploy-ziti-host-into-clustera" title="Direct link to deploy-ziti-host-into-clustera">â</a></h4><p>Once created, we can use helm to install the <code>ziti-host</code> pod. The jwt is a one-use token and will be useless after being consumed by
<code>ziti-host</code>. As this is probably your first time running this helm chart, you will need to install it. The command is idempotent to
running it over and over is of no concern. Run the following:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">helm repo add netfoundry https://netfoundry.github.io/charts/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm repo update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm install ziti-host netfoundry/ziti-host --set-file enrollmentToken=&quot;/tmp/prometheus/kubeA.ziti.id.jwt&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You will see the confirmation output from helm. Now when you look at your Kubernetes cluster with <code>kubectl</code>, you will see a pod deployed:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                        READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti-host-db55b5c4b-rpc7f   1/1     Running   0          2m40s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Awesome, we have our first deployed pod. It&#x27;s useless at the moment as we have defined no services, nor authorized any services. Right
now there&#x27;s nothing to connect to, so we can simply move on and install the next pod, <code>reflectz</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pod-2---reflectz">Pod 2 - <code>reflectz</code><a href="#pod-2---reflectz" class="hash-link" aria-label="Direct link to pod-2---reflectz" title="Direct link to pod-2---reflectz">â</a></h3><p>The first pod we want to have access to is the <code>reflectz</code> pod. It is a workload we will deploy that will do two things. First, it will
listen on the OpenZiti overlay network for connections. When a connection is made, and when bytes are sent, the workload sill simply
return back to the caller whatever was sent to it adding &quot;you sent me: &quot; to the payload. It&#x27;s not much, but it&#x27;s a demo after all. The
second service provided is a scrape target for Prometheus. There is one metric exposed by <code>reflectz</code> we will care about, the total number of connections established to this workload. This pod also needs an identity provisioned, and this time around we will also provision some services. We will also use the <code>ziti</code> cli to enroll this identity. This helm chart wants you to provide an enrolled identity as part of the helm command. Let&#x27;s do all this now.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-and-enroll-the-identity">Create and Enroll the Identity<a href="#create-and-enroll-the-identity" class="hash-link" aria-label="Direct link to Create and Enroll the Identity" title="Direct link to Create and Enroll the Identity">â</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create identity user kubeA.reflect.id -o /tmp/prometheus/kubeA.reflect.id.jwt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge enroll /tmp/prometheus/kubeA.reflect.id.jwt -o /tmp/prometheus/kubeA.reflect.id.json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-configs-and-services-including-tunneling-based-access">Create Configs and Services (including Tunneling-based Access)<a href="#create-configs-and-services-including-tunneling-based-access" class="hash-link" aria-label="Direct link to Create Configs and Services (including Tunneling-based Access)" title="Direct link to Create Configs and Services (including Tunneling-based Access)">â</a></h4><p>The <code>reflectz</code> chart also needs two services to be declared and specified at the time of the helm chart installation. We will want to be
able to test the service to ensure they work. To enable testing the services, we will create two configs of type <code>intercept.v1</code>. This
will allow identities using tunneling apps to be able to access the services, this is how we&#x27;ll verify the services work. Make the
configs and services now.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create intercept configs for the two services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config kubeA.reflect.svc-intercept.v1 intercept.v1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;{&quot;protocols&quot;:[&quot;tcp&quot;],&quot;addresses&quot;:[&quot;kubeA.reflect.svc.ziti&quot;],&quot;portRanges&quot;:[{&quot;low&quot;:80, &quot;high&quot;:80}]}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config &quot;kubeA.reflect.svc-intercept.v1.scrape&quot; intercept.v1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;{&quot;protocols&quot;:[&quot;tcp&quot;],&quot;addresses&quot;:[&quot;kubeA.reflect.scrape.svc.ziti&quot;], &quot;portRanges&quot;:[{&quot;low&quot;:80, &quot;high&quot;:80}], &quot;dialOptions&quot;:{&quot;identity&quot;:&quot;kubeA.reflect.id&quot;}}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># create the two services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service &quot;kubeA.reflect.svc&quot; --configs &quot;kubeA.reflect.svc-intercept.v1&quot; -a &quot;kubeA.reflect.svc.services&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service &quot;kubeA.reflect.scrape.svc&quot; --configs &quot;kubeA.reflect.svc-intercept.v1.scrape&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="authorize-the-workload-and-clients">Authorize the Workload and Clients<a href="#authorize-the-workload-and-clients" class="hash-link" aria-label="Direct link to Authorize the Workload and Clients" title="Direct link to Authorize the Workload and Clients">â</a></h4><p>Services are not valuable if there are no identities which can use the services. The identity used in the helm installation will also
need to be authorized to bind these services. Tunneling apps will need to be authorized to dial these services but also remember
Prometheus servers will need to be able to dial these services too. We will now create <code>service-policies</code> to authorize the tunneling
clients, Prometheus scrapes, and the <code>reflectz</code> server to bind the service.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create the bind service policies and authorize the reflect id to bind these services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy &quot;kubeA.reflect.svc.bind&quot; Bind \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles &quot;@kubeA.reflect.svc&quot; --identity-roles &quot;@kubeA.reflect.id&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy &quot;kubeA.reflect.scrape.svc.bind&quot; Bind \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles &quot;@kubeA.reflect.scrape.svc&quot; --identity-roles &quot;@kubeA.reflect.id&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># create the dial service policies and authorize the reflect id to bind these services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy &quot;kubeA.reflect.svc.dial&quot; Dial \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles &quot;@kubeA.reflect.svc&quot; --identity-roles &quot;#reflectz-clients&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy &quot;kubeA.reflect.svc.dial.scrape&quot; Dial \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles &quot;@kubeA.reflect.scrape.svc&quot; --identity-roles &quot;#reflectz-clients&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-reflectz">Deploy <code>reflectz</code><a href="#deploy-reflectz" class="hash-link" aria-label="Direct link to deploy-reflectz" title="Direct link to deploy-reflectz">â</a></h4><p>With the identity enrolled, we can now install the helm chart from openziti, and install our demonstration workload: <code>reflectz</code>. Notice
that to deploy <code>reflectz</code> we need to supply an identity to the workload using <code>--set-file reflectIdentity</code>. This identity will be used
to &#x27;Bind&#x27; the services the workload exposes. We also need to define what the service names are we want to allow that identity to bind.
We do this using the <code>--set serviceName</code> and <code>--set prometheusServiceName</code> flags.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">helm repo add openziti-test-kitchen https://openziti-test-kitchen.github.io/helm-charts/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm repo update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm install reflectz openziti-test-kitchen/reflect \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set-file reflectIdentity=&quot;/tmp/prometheus/kubeA.reflect.id.json&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set serviceName=&quot;kubeA.reflect.svc&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set prometheusServiceName=&quot;kubeA.reflect.scrape.svc&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After running helm, pod 2 should be up and running. Let&#x27;s take a look using <code>kubectl</code></p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                        READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reflectz-775bd45d86-4sjwh   1/1     Running   0          7s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti-host-db55b5c4b-rpc7f   1/1     Running   0          4m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pod-3---prometheuz">Pod 3 - <code>Prometheuz</code><a href="#pod-3---prometheuz" class="hash-link" aria-label="Direct link to pod-3---prometheuz" title="Direct link to pod-3---prometheuz">â</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="overlay-work---setting-up-openziti">Overlay Work - Setting Up OpenZiti<a href="#overlay-work---setting-up-openziti" class="hash-link" aria-label="Direct link to Overlay Work - Setting Up OpenZiti" title="Direct link to Overlay Work - Setting Up OpenZiti">â</a></h4><p>Now we have access to the cluster and a workload to monitor. Now we want to deploy Prometheus and monitor this workload. Remember that
the workload only exposes a scrape target over the OpenZiti overlay. For Prometheus to be able to scrape the workload, even when
resident inside the Kubernetes cluster (!), Prometheus will need to be OpenZiti-enabled. That will require a few things. We&#x27;ll need a
new identity for Prometheus, we&#x27;ll need to authorize Prometheus to access the workload&#x27;s target, and we&#x27;ll need to configure Prometheus
to scrape that workload. When we create this identity we&#x27;ll assign two attributes. The <code>reflectz-clients</code> attribute gives this identity
the ability to dial the two services defined above. The <code>prometheus-clients</code> attribute is currently unused. We&#x27;ll put that to use later,
but we can define it now.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-and-enroll-the-identity-1">Create and Enroll the Identity<a href="#create-and-enroll-the-identity-1" class="hash-link" aria-label="Direct link to Create and Enroll the Identity" title="Direct link to Create and Enroll the Identity">â</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create and enroll the identity.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create identity user kubeA.prometheus.id -o /tmp/prometheus/kubeA.prometheus.id.jwt -a &quot;reflectz-clients&quot;,&quot;prometheus-clients&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge enroll /tmp/prometheus/kubeA.prometheus.id.jwt -o /tmp/prometheus/kubeA.prometheus.id.json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-configs-and-services-including-tunneling-based-access-1">Create Configs and Services (including Tunneling-based Access)<a href="#create-configs-and-services-including-tunneling-based-access-1" class="hash-link" aria-label="Direct link to Create Configs and Services (including Tunneling-based Access)" title="Direct link to Create Configs and Services (including Tunneling-based Access)">â</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create the config and service for the kubeA prometheus server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config &quot;kubeA.prometheus.svc-intercept.v1&quot; intercept.v1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;{&quot;protocols&quot;:[&quot;tcp&quot;],&quot;addresses&quot;:[&quot;kubeA.prometheus.svc&quot;],&quot;portRanges&quot;:[{&quot;low&quot;:80, &quot;high&quot;:80}]}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config &quot;kubeA.prometheus.svc-host.v1&quot; host.v1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;{&quot;protocol&quot;:&quot;tcp&quot;, &quot;address&quot;:&quot;prometheuz-prometheus-server&quot;,&quot;port&quot;:80}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service &quot;kubeA.prometheus.svc&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --configs &quot;kubeA.prometheus.svc-intercept.v1&quot;,&quot;kubeA.prometheus.svc-host.v1&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="authorize-the-workload-and-clients-1">Authorize the Workload and Clients<a href="#authorize-the-workload-and-clients-1" class="hash-link" aria-label="Direct link to Authorize the Workload and Clients" title="Direct link to Authorize the Workload and Clients">â</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># grant the prometheus clients the ability to dial the service and the kubeA.prometheus.id the ability to bind</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy &quot;kubeA.prometheus.svc.dial&quot; Dial \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles &quot;@kubeA.prometheus.svc&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --identity-roles &quot;#prometheus-clients&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy &quot;kubeA.prometheus.svc.bind&quot; Bind \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles &quot;@kubeA.prometheus.svc&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --identity-roles &quot;@kubeA.ziti.id&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="deploying-prometheuz-1">Deploying <code>Prometheuz</code><a href="#deploying-prometheuz-1" class="hash-link" aria-label="Direct link to deploying-prometheuz-1" title="Direct link to deploying-prometheuz-1">â</a></h4><p>With our services, configs and service-policies in place we are now ready to start our Prometheus server. Remember this server will not
listen on a the OpenZiti overlay. It&#x27;s going to listen exclusively on the underlay. We are still exploring OpenZiti, and we are not yet
comfortable deploying our Prometheus server dark. We&#x27;ll change this soon, don&#x27;t worry. For now, we&#x27;ll imagine that we&#x27;re still
evaluating the tech and chose to deploy it on the underlay, not on the overlay. </p><p>Although Prometheus is listening on the underlay, we <strong>have</strong> deployed our workload listening on the overlay network. It won&#x27;t be
available on the underlay at all. The workload has <strong>no listening ports</strong>. This means that we&#x27;ll still need an OpenZiti-enabled
Prometheus to access and scrape that workload. To do this we&#x27;ll use helm, and use a chart provided by the OpenZiti charts repo.</p><p>Some interesting things to notice below in the <code>helm install</code> command. Notice that we are passing helm two <code>--set</code> parameters. These
parameters are informing the helm chart that the Prometheus server is not &quot;zitified&quot;, meaning it will be accessible via the underlay
network. We&#x27;re also passing one <code>--set-file</code> parameter to tell Prometheus what identity we want to be stored in the pod (as a secret).
This secret will be used when we configure Prometheus to scrape the workload. Go ahead and run this command now and run
<code>kubectl get pods</code> until all the containers are running.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">helm repo add openziti-test-kitchen https://openziti-test-kitchen.github.io/helm-charts/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm repo update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm install prometheuz openziti-test-kitchen/prometheus \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set server.ziti.enabled=&quot;false&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set-file server.scrape.id.contents=&quot;/tmp/prometheus/kubeA.prometheus.id.json&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="clusterb---fully-dark">ClusterB - Fully Dark<a href="#clusterb---fully-dark" class="hash-link" aria-label="Direct link to ClusterB - Fully Dark" title="Direct link to ClusterB - Fully Dark">â</a></h2><p><img loading="lazy" alt="clusterB" src="/assets/images/clusterB-9e8019e9f78c665bd67f52585250b986.svg" width="349" height="447" class="img_ev3q"></p><p>Now that we have deployed our first Kubernetes cluster, it&#x27;s now time to deploy the second Kubernetes cluster. This time, we are going
to keep our entire deployment <strong>fully dark</strong>! There will be no listening ports, not even local to the Kubernetes cluster itself. To get
any traffic to this Prometheus server, you will need a strong identity and need to be authorized on the OpenZiti overlay. When complete,
ClusterB will look like the image to the right.</p><p>This time, &quot;Pod1&quot; will be the <code>reflectz</code> workload. Since this is a <strong>fully dark</strong> deployment, listening entirely on the OpenZiti overlay,
we won&#x27;t need a <code>ziti-host</code> pod. Remember, in ClusterA <code>ziti-host</code> is used to provide internal access to the Kubernetes cluster via the
OpenZiti overlay. It&#x27;s similar in role to an ingress controller, but doesn&#x27;t require you to expose your workloads to the internet. While
that&#x27;s pretty good we want to go fully dark this time. We&#x27;ll have no <code>ziti-host</code>. We&#x27;ll only need to deploy two pods: <code>reflectz</code> and
<code>prometheuz</code>.</p><p>The good news is that the same commands you&#x27;ve run for ClusterA, will mostly be used for ClusterB. You will want to beware that where
you used &quot;kubeA&quot; before, make sure you change those to &quot;kubeB&quot;. There will be small other changes we&#x27;ll make along the way too, we&#x27;ll see
those changes and explain them below. </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pod1---reflectz">Pod1 - <code>reflectz</code><a href="#pod1---reflectz" class="hash-link" aria-label="Direct link to pod1---reflectz" title="Direct link to pod1---reflectz">â</a></h3><p>The <code>relectz</code> workload we&#x27;ll deploy for ClusterB will be nearly identical to the ClusterA workload. We will create a service for
the actual &#x27;reflect&#x27; service. We will make a service for Prometheus to scrape the workload. We&#x27;ll also need another identity, so
we&#x27;ll create that identity, authorize it to bind the services, and authorize clients to access the workload. Since this process is very
similar to what we did for ClusterA, there&#x27;s not much to explain. Setup ClusterB&#x27;s <code>reflectz</code> now.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-the-identity-1">Create the Identity<a href="#create-the-identity-1" class="hash-link" aria-label="Direct link to Create the Identity" title="Direct link to Create the Identity">â</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create identity user kubeB.reflect.id -o /tmp/prometheus/kubeB.reflect.id.jwt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge enroll /tmp/prometheus/kubeB.reflect.id.jwt -o /tmp/prometheus/kubeB.reflect.id.json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-configs-and-services-including-tunneling-based-access-2">Create Configs and Services (including Tunneling-based Access)<a href="#create-configs-and-services-including-tunneling-based-access-2" class="hash-link" aria-label="Direct link to Create Configs and Services (including Tunneling-based Access)" title="Direct link to Create Configs and Services (including Tunneling-based Access)">â</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create intercept configs for the two services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config kubeB.reflect.svc-intercept.v1 intercept.v1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;{&quot;protocols&quot;:[&quot;tcp&quot;],&quot;addresses&quot;:[&quot;kubeB.reflect.svc.ziti&quot;],&quot;portRanges&quot;:[{&quot;low&quot;:80, &quot;high&quot;:80}]}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config &quot;kubeB.reflect.svc-intercept.v1.scrape&quot; intercept.v1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;{&quot;protocols&quot;:[&quot;tcp&quot;],&quot;addresses&quot;:[&quot;kubeB.reflect.scrape.svc.ziti&quot;], &quot;portRanges&quot;:[{&quot;low&quot;:80, &quot;high&quot;:80}], &quot;dialOptions&quot;:{&quot;identity&quot;:&quot;kubeB.reflect.id&quot;}}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># create the two services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service &quot;kubeB.reflect.svc&quot; --configs &quot;kubeB.reflect.svc-intercept.v1&quot; -a &quot;kubeB.reflect.svc.services&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service &quot;kubeB.reflect.scrape.svc&quot; --configs &quot;kubeB.reflect.svc-intercept.v1.scrape&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="authorize-the-workload-to-bind-the-services">Authorize the Workload to Bind the Services<a href="#authorize-the-workload-to-bind-the-services" class="hash-link" aria-label="Direct link to Authorize the Workload to Bind the Services" title="Direct link to Authorize the Workload to Bind the Services">â</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create the bind service policies and authorize the reflect id to bind these services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy &quot;kubeB.reflect.svc.bind&quot; Bind \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles &quot;@kubeB.reflect.svc&quot; --identity-roles &quot;@kubeB.reflect.id&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy &quot;kubeB.reflect.scrape.svc.bind&quot; Bind \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles &quot;@kubeB.reflect.scrape.svc&quot; --identity-roles &quot;@kubeB.reflect.id&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="authorize-clients-to-access-the-services">Authorize Clients to Access the Services<a href="#authorize-clients-to-access-the-services" class="hash-link" aria-label="Direct link to Authorize Clients to Access the Services" title="Direct link to Authorize Clients to Access the Services">â</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create the dial service policies and authorize the reflect id to bind these services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy &quot;kubeB.reflect.svc.dial&quot; Dial \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles &quot;@kubeB.reflect.svc&quot; --identity-roles &quot;#reflectz-clients&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy &quot;kubeB.reflect.svc.dial.scrape&quot; Dial \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles &quot;@kubeB.reflect.scrape.svc&quot; --identity-roles &quot;#reflectz-clients&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-reflectz-1">Deploy <code>reflectz</code><a href="#deploy-reflectz-1" class="hash-link" aria-label="Direct link to deploy-reflectz-1" title="Direct link to deploy-reflectz-1">â</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">helm repo add openziti-test-kitchen https://openziti-test-kitchen.github.io/helm-charts/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm repo update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm install reflectz openziti-test-kitchen/reflect \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set-file reflectIdentity=&quot;/tmp/prometheus/kubeB.reflect.id.json&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set serviceName=&quot;kubeB.reflect.svc&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set prometheusServiceName=&quot;kubeB.reflect.scrape.svc&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pod-2---prometheuz">Pod 2 - <code>Prometheuz</code><a href="#pod-2---prometheuz" class="hash-link" aria-label="Direct link to pod-2---prometheuz" title="Direct link to pod-2---prometheuz">â</a></h3><p>For ClusterB we want <code>Prometheuz</code> to be <strong>totally dark</strong>. It will exclusively listen on the OpenZiti overlay and there will be no
listening ports on the underlay. We will need another identity, of course, and most of the configuration and commands appear the same on
the surface with very subtle differences. We&#x27;ll explore these differences as we go. In this section we&#x27;ll be making an identity, <strong>one
config</strong> (a difference from the ClusterA install), a service, and two service-policies. Let&#x27;s get to it.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-the-identity-2">Create the Identity<a href="#create-the-identity-2" class="hash-link" aria-label="Direct link to Create the Identity" title="Direct link to Create the Identity">â</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create identity user kubeB.prometheus.id -o /tmp/prometheus/kubeB.prometheus.id.jwt -a &quot;reflectz-clients&quot;,&quot;prometheus-clients&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge enroll /tmp/prometheus/kubeB.prometheus.id.jwt -o /tmp/prometheus/kubeB.prometheus.id.json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-one-config-and-service">Create <strong>One</strong> Config and Service<a href="#create-one-config-and-service" class="hash-link" aria-label="Direct link to create-one-config-and-service" title="Direct link to create-one-config-and-service">â</a></h4><p>Here&#x27;s a difference from ClusterA. Since we are going to listen on the OpenZiti overlay, we are not installing <code>ziti-host</code>. That means
we don&#x27;t need to create a <code>host.v1</code> config. A <code>host.v1</code> config is necessary for services which have a &#x27;Bind&#x27; configuration and are being
bound by a tunneling application. We&#x27;re not doing that, here Prometheus will &#x27;Bind&#x27; this service, thus we don&#x27;t need that <code>host.v1</code>
config.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create the config and service for the kubeB prometheus server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config &quot;kubeB.prometheus.svc-intercept.v1&quot; intercept.v1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;{&quot;protocols&quot;:[&quot;tcp&quot;],&quot;addresses&quot;:[&quot;kubeB.prometheus.svc&quot;],&quot;portRanges&quot;:[{&quot;low&quot;:80, &quot;high&quot;:80}], &quot;dialOptions&quot;: {&quot;identity&quot;:&quot;kubeB.prometheus.id&quot;}}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># no need for the host.v1 config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service &quot;kubeB.prometheus.svc&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --configs &quot;kubeB.prometheus.svc-intercept.v1&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="authorize-clients-and-prometheus-to-bind-the-service">Authorize Clients and Prometheus to Bind the Service<a href="#authorize-clients-and-prometheus-to-bind-the-service" class="hash-link" aria-label="Direct link to Authorize Clients and Prometheus to Bind the Service" title="Direct link to Authorize Clients and Prometheus to Bind the Service">â</a></h4><p>At first, these commands appear identical. You need to look very closely to notice the difference between these command and the ones we
ran for ClusterA, other than the obvious changes from &quot;kubeA&quot; to &quot;kubeB&quot;. Pay close attention to the supplied <code>--identity-roles</code> for the
bind policy specified below. With ClusterA, we did not have Prometheus listen on the overlay and we allowed Prometheus to listen on the
underlay. That meant we needed to deploy <code>ziti-host</code> into that cluster to provide access to the service, and that means the service had
to be bound by the <code>ziti-host</code> identity.</p><p>Here we are flipping that script. We are allowing Prometheus to bind this service! That means we&#x27;ll need to authorize the
<code>kubeB.prometheus.id</code> to be able to bind the service.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># grant the prometheus clients the ability to dial the service and the kubeB.prometheus.id the ability to bind</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy &quot;kubeB.prometheus.svc.dial&quot; Dial \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles &quot;@kubeB.prometheus.svc&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --identity-roles &quot;#prometheus-clients&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy &quot;kubeB.prometheus.svc.bind&quot; Bind \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles &quot;@kubeB.prometheus.svc&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --identity-roles &quot;@kubeB.prometheus.id&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="deploying-prometheuz">Deploying <code>Prometheuz</code><a href="#deploying-prometheuz" class="hash-link" aria-label="Direct link to deploying-prometheuz" title="Direct link to deploying-prometheuz">â</a></h4><p>At this point we have the OpenZiti overlay all configured. What&#x27;s left, is to deploy Prometheus into ClusterB. This command is substantially
different from what we ran while deploying Prometheus into ClusterA. You&#x27;ll see that we need to supply two other identities for this
installation. Remember, Prometheus will be entirely dark once deployed into ClusterB, listening only on the OpenZiti overlay. The container
in the pod which monitors configmap changes won&#x27;t be able to trigger a webhook using the underlay! This <code>configmap-reloadz</code> is a second
&quot;zitification&quot; we didn&#x27;t realize we were deploying in ClusterA, because we did not need it. We need it for ClusterB.</p><p>You&#x27;ll see for configmapReload we need to supply the identity which the container will use to hit the Prometheus webhook. We do that by
passing <code>--set-file configmapReload.ziti.id.contents=&quot;/tmp/prometheus/kubeB.prometheus.id.json&quot;</code>. Then we&#x27;ll supply the service which
<code>configmap-reloadz</code> will dial, and we&#x27;ll also specify what identity we expect to be hosting the service.</p><p>Next you&#x27;ll see we need to supply the identity to the Prometheus server we want to allow to listen on the OpenZiti overlay (
<code>-set-file server.ziti.id.contents</code>). Similar to <code>configmap-reloadz</code> we will also specify the service and identity name to bind.</p><p>Finally, to allow the server to scrape targets we need to supply a final identity which will be used when scraping targets with
<code>--set-file server.scrape.id.contents</code>.</p><p>You&#x27;ll notice for simplicities sake, we are using the same identity for all three needs which is perfectly fine. If you wanted to use a
different identity, you could. That choice is up to you. To keep it simple we just authorized this identity for all these purposes.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># install prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm repo add openziti-test-kitchen https://openziti-test-kitchen.github.io/helm-charts/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm repo update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm install prometheuz openziti-test-kitchen/prometheus \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set-file configmapReload.ziti.id.contents=&quot;/tmp/prometheus/kubeB.prometheus.id.json&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       --set configmapReload.ziti.targetService=&quot;kubeB.prometheus.svc&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       --set configmapReload.ziti.targetIdentity=&quot;kubeB.prometheus.id&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set-file server.ziti.id.contents=&quot;/tmp/prometheus/kubeB.prometheus.id.json&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       --set server.ziti.service=&quot;kubeB.prometheus.svc&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       --set server.ziti.identity=&quot;kubeB.prometheus.id&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set-file server.scrape.id.contents=&quot;/tmp/prometheus/kubeB.prometheus.id.json&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="whats-next">What&#x27;s Next<a href="#whats-next" class="hash-link" aria-label="Direct link to What&#x27;s Next" title="Direct link to What&#x27;s Next">â</a></h2><p>In this article we&#x27;ve done a lot of OpenZiti CLI work, run some <code>kubectl</code> and <code>helm</code> commands but we still haven&#x27;t explored what it is
we are building and why it&#x27;s so cool. We&#x27;ll do that in the <a href="/blog/zitification/prometheus/part3">last, and final</a> article. Hopefully, the payoff for you will be
as rewarding as it was for me while building this article series.</p><hr><h4 class="anchor anchorWithStickyNavbar_LWe7" id="addendum---a-quicker-start">Addendum - a Quicker Start<a href="#addendum---a-quicker-start" class="hash-link" aria-label="Direct link to Addendum - a Quicker Start" title="Direct link to Addendum - a Quicker Start">â</a></h4><p>All the commands above are also available in github as <code>.sh</code> scripts. If you would prefer, you can clone the
<a href="https://github.com/openziti/ziti-doc" target="_blank" rel="noopener noreferrer">ziti-doc repository</a> and access the scripts from the path mentioned below. &quot;Cleanup&quot; scripts are
provided if desired. </p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">${checkout_root}/docusaurus/blog/zitification/prometheus/scripts</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="_This is part three of a three-part article. This article builds on the previous two articles. Here we will take a look at what we built"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/zitification/prometheus/part3">Scraping Anything, Anywhere in Action</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-01-15T15:50:26.000Z" itemprop="datePublished">January 15, 2024</time> Â· <!-- -->12 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/dovholuknf" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/46322585?v=4" alt="Clint Dovholuk" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/dovholuknf" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Clint Dovholuk</span></a></div><small class="avatar__subtitle" itemprop="description">OpenZiti Maintainer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><em>This is part three of a three-part article. This article builds on the previous two articles. Here we will take a look at what we built
and use it to explore the power of a zitified Prometheus. See <a href="/blog/zitification/prometheus/part1">part one</a> for the necessary background about the series. See
<a href="/blog/zitification/prometheus/part2">part two</a> for detailed instructions covering how to setup the environment you&#x27;re about to explore</em></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-payoff">The Payoff<a href="#the-payoff" class="hash-link" aria-label="Direct link to The Payoff" title="Direct link to The Payoff">â</a></h2><p>Ok. Here it is. We are at the end of the series and here is where we&#x27;ll put it all together and really start to understand the sort of
innovations you can create when you zitify an application. As a reminder, we are working with <a href="https://prometheus.io/" target="_blank" rel="noopener noreferrer">Prometheus</a>, a
CNCF project which we will use to monitor a workload deployed in two separate <a href="https://kubernetes.io" target="_blank" rel="noopener noreferrer">Kubernetes</a> clusters. To save you
from flipping back to a previous article, here is what that solution looks like.</p><p><img loading="lazy" alt="overview" src="/assets/images/kubernetes-prometheus-after-1c432161cd5ceac47eadc4149cae35fb.svg" width="1264" height="531" class="img_ev3q"></p><p>Now we are ready to start using our Prometheus servers. We&#x27;ll use our OpenZiti overlay network to connect to a workload which will
generate a metric we want to display in Prometheus. We&#x27;ll then configure Prometheus to scrape the workload and put it on a graph to
prove it works. Once that&#x27;s complete, we&#x27;ll play around with the setup and see if we really can scrape anything, anywhere. Let&#x27;s begin.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="developer-access">Developer Access<a href="#developer-access" class="hash-link" aria-label="Direct link to Developer Access" title="Direct link to Developer Access">â</a></h2><p>In the <a href="/blog/zitification/prometheus/part2">previous article</a>, we established our entire solution using the OpenZiti overlay, <code>kubectl</code> and <code>helm</code>. We saw
everything get installed and it all &quot;seems to work&quot;. But how do we <strong>know</strong> it works?  Let&#x27;s provision an identity for yourself now and
let&#x27;s enroll it in your local tunneling app and find out. Go out and get <a href="/docs/learn/core-concepts/clients/choose">a tunneling client</a> running
locally. Once you have that installed, provision an identity and enroll it with your tunneling client. </p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create identity user dev.client -a &quot;prometheus-clients&quot;,&quot;reflectz-clients&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You should have access to six total services when this identity is enrolled:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Service Name: kubeA.prometheus.svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Intercept: kubeA.prometheus.svc:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Service Name: kubeA.reflect.svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Intercept: kubeA.reflect.svc.ziti:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Service Name: kubeA.reflect.scrape.svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Intercept: kubeA.reflect.scrape.svc.ziti:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Service Name: kubeB.prometheus.svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Intercept: kubeB.prometheus.svc:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Service Name: kubeB.reflect.svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Intercept: kubeB.reflect.svc.ziti:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Service Name: kubeB.reflect.scrape.svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Intercept: kubeB.reflect.scrape.svc.ziti:80</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="clustera">ClusterA<a href="#clustera" class="hash-link" aria-label="Direct link to ClusterA" title="Direct link to ClusterA">â</a></h2><p>With your developer access you should be able to navigate your browser to <a href="http://kubea.prometheus.svc/targets" target="_blank" rel="noopener noreferrer">http://kubea.prometheus.svc/targets</a>. </p><blockquote><p>[!NOTE]<!-- -->
We won&#x27;t dwell on this for long in this article but notice that this is showing off another superpower of OpenZiti, private DNS.
Notice that you were able to browse to a totally fictitious domain name: kubea.prometheus.svc. &quot;.svc&quot; is <strong>not</strong> a legitimate top level
domain.
<a href="https://en.wikipedia.org/wiki/List_of_Internet_top-level_domains#S" target="_blank" rel="noopener noreferrer">Look at the full list of top level domains starting with S</a>. You
won&#x27;t find &quot;.svc&quot; on that list at this time</p></blockquote><p><img loading="lazy" alt="kubea.prom.init" src="/assets/images/kubea.prom.init-4d7855b727621c1778b9a8a6b6d7a25d.png" width="510" height="433" class="img_ev3q"></p><p>You should see the following. You might have noticed that the chart deployed has a few other containers we have not discussed yet. We&#x27;ll
not go into those containers in this article. What&#x27;s important is that this Prometheus server has a few targets already for us to access.
Neat, but this isn&#x27;t what we want to actually monitor.</p><p>What we really want to monitor is the workload we deployed: <code>reflectz</code>. We can do this by editing the Prometheus configmap using
<code>kubectl</code>. Let&#x27;s go ahead and do this now:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl edit cm prometheuz-prometheus-server</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This will open an editor in your terminal and allow you to update the config map for the pod. Once the editor is open, find the section
labeled &quot;scrape_config&quot; and add the following entry:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    - job_name: &#x27;kubeA.reflectz&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      scrape_interval: 5s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      honor_labels: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      scheme: &#x27;ziti&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      params:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;match[]&#x27;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - &#x27;{job!=&quot;&quot;}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;ziti-config&#x27;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - &#x27;/etc/prometheus/scrape.json&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      static_configs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - targets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - &#x27;kubeA.reflect.scrape.svc-kubeA.reflect.id&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This is yaml and yaml is sensitive to spaces. The block above is properly indented for the config that the helm chart installs. You
should be able to simply copy it and add it under the scrape_config. Remember, there is a <code>configmap-reload</code> container in
the pod which monitors the configmap. On successful edit, this container will notice and will issue a web hook to the
<code>prometheus-server</code> container. The trigger is not immediate, don&#x27;t worry if it takes a while. It can take around a minute for the
trigger to fire. </p><p>While we wait for the trigger, let&#x27;s explain what this is doing. This is informing the Prometheus server to monitor a workload which can
be found at the provided target of <code>kubeA.reflect.scrape.svc-kubeA.reflect.id</code>. Notice that no port is included in this target, and also
notice that this is a very strange looking FQDN. That&#x27;s because this is a zitified version of Prometheus. We have extended Prometheus to
understand a &quot;scheme&quot; of <code>ziti</code>. When we configure this job with a scheme of ziti, we can then supply targets to the job which represent
an OpenZiti service.  We need to supply the <code>ziti-config</code> node with the path to the identity we want Prometheus to use to issue the
scrape. This will always be <code>/etc/prometheus/scrape.json</code> at this time. Should the community desire it, we can look into changing the
location of the identity.</p><p>If you would like to tail the <code>configmap-reloadz</code> container, you can issue this one liner. This will instruct <code>kubectl</code> to tail the logs
from <code>configmap-reloadz</code>. </p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pod=$(kubectl get pods | grep server | cut -d &quot; &quot; -f1); echo POD: $pod; kubectl logs -f &quot;$pod&quot; prometheus-server-configmap-reload</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>When the trigger happens for ClusterA you will see a message like the one below. Notice that <code>configmap-reloadz</code> is using the underlay
network: <code>http://127.0.0.1:9090/-/reload</code></p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2022/04/23 20:01:23 config map updated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/04/23 20:01:23 performing webhook request (1/1/http://127.0.0.1:9090/-/reload)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2022/04/23 20:01:23 successfully triggered reload</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="config-reloaded">Config Reloaded<a href="#config-reloaded" class="hash-link" aria-label="Direct link to Config Reloaded" title="Direct link to Config Reloaded">â</a></h3><p>Once you&#x27;ve correctly updated the configmap, and <code>configmap-reloadz</code> detected the change and told Prometheus to reload. You&#x27;ll see a new
target has been reported by Prometheus at <a href="http://kubea.prometheus.svc/targets" target="_blank" rel="noopener noreferrer">http://kubea.prometheus.svc/targets</a>. You should now see &quot;kubeA.reflectz (1/1 up)&quot; showing.
Congratulations! You have just successfully scraped a target from zitified Prometheus! Remember this workload does not listen on the
Kubernetes underlay network. It&#x27;s only accessible from the OpenZiti overlay. </p><p><img loading="lazy" alt="kubea.target1.png" src="/assets/images/kubea.target1-8f5a33a23d13709763eeff7c98afecf1.png" width="1055" height="197" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="lets-graph-it">Let&#x27;s Graph It!<a href="#lets-graph-it" class="hash-link" aria-label="Direct link to Let&#x27;s Graph It!" title="Direct link to Let&#x27;s Graph It!">â</a></h3><p>Cool, we have a target. The target can be scraped by Prometheus over the OpenZiti overlay. We&#x27;re also able to securely access the
Prometheus UI over the same OpenZiti overlay. Let&#x27;s use the Prometheus UI to graph the data point we want to see, the
<code>reflect_total_connections</code> metric. </p><ol><li>Navigate to <a href="http://kubea.prometheus.svc/graph" target="_blank" rel="noopener noreferrer">http://kubea.prometheus.svc/graph</a></li><li>enter <code>reflect_total_connections</code></li><li>click Graph (notice I changed my time to &#x27;10s&#x27;, located just under Graph)</li><li>click Execute</li><li>Notice there are no connections (0)</li></ol><p><img loading="lazy" alt="grpah it" src="/assets/images/kubea.graph-a39d9acca67d92b279c388dfda2fda53.png" width="1050" height="706" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="generate-some-data">Generate Some Data<a href="#generate-some-data" class="hash-link" aria-label="Direct link to Generate Some Data" title="Direct link to Generate Some Data">â</a></h3><p>Now let&#x27;s change that graph of <code>reflect_total_connections</code> from 0 to 1 (or more). One of the services you will have access to will
intercept <code>kubeA.reflect.svc.ziti:80</code>. </p><blockquote><p>[!NOTE]<!-- -->
If you are using Windows and Windows Subsystem for Linux (WSL) as I am, you <strong>might</strong> need to understand how get WSL to use your Ziti
Desktop Edge for Windows as your DNS resolver when inside WSL. Generally speaking this is as easy as editing /etc/resolv.conf and
adding the IP as the first nameserver: <code>nameserver 100.64.0.1</code> (or whatever the DNS IP is). Try it first, depending on how you setup
WSL it might &#x27;just work&#x27; for you. You can also just use cygwin or any other netcat tool from Windows (not WSL) too.</p></blockquote><p>Now we can use netcat to open a connection through this intercept a few times. The metric tracks the total number of connections to the
reflect service. Connect, send some text, the use ctrl-c to disconnect. Do that a few times then click &#x27;execute&#x27; again on the graph page.
You can see I did this over a minute and moved my total count on kubeA to 8, shown below.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/tmp/prometheus$ nc kubeA.reflect.svc.ziti 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeA reflect test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">you sent me: kubeA reflect test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">^C</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/tmp/prometheus$ nc kubeA.reflect.svc.ziti 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">another reflect test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">you sent me: another reflect test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">^C</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/tmp/prometheus$ nc kubeA.reflect.svc.ziti 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">another reflect test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">you sent me: another reflect test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">^C</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="kubea.more.total.conn.png" src="/assets/images/kubea.more.total.conn-056a41b592c79bd2b5efc64c4b45efbf.png" width="878" height="784" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="scrape-something-else">Scrape Something Else<a href="#scrape-something-else" class="hash-link" aria-label="Direct link to Scrape Something Else" title="Direct link to Scrape Something Else">â</a></h3><p>Hopefully you agree with me that this is pretty neat. Well what if we take it to the next level? What if we tried to scrape the
workload we deployed to ClusterB? Could we get that to work? Recall from above how we enabled the job named &#x27;kubeA.reflectz&#x27;. What if we
simply copied/pasted that into the configmap changing kubeA --&gt; kubeB. Would it work? Let&#x27;s see. </p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># edit the configmap on ClusterA:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl edit cm prometheuz-prometheus-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#add the job - and wait for the configmap to reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - job_name: &#x27;kubeB.reflectz&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      scrape_interval: 5s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      honor_labels: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      scheme: &#x27;ziti&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      params:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;match[]&#x27;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - &#x27;{job!=&quot;&quot;}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &#x27;ziti-config&#x27;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - &#x27;/etc/prometheus/scrape.json&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      static_configs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - targets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - &#x27;kubeB.reflect.scrape.svc-kubeB.reflect.id&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After watching the logs from <code>configmap-reloadz</code> on ClusterA and seeing the webhook trigger. Just go back to the Prometheus server in
the browser. You should be at the &#x27;graph&#x27; url but if not navigate back and execute another graph for <code>reflect_total_connections</code>. When
we do that it probably doesn&#x27;t look much different but... Wait a second? In the legend? Can it be? That&#x27;s right. From Kubernetes
ClusterA, we have just scraped a workload from Kubernetes ClusterB, entirely over the OpenZiti overlay.</p><p><img loading="lazy" alt="kubeA-and-kubeB.png" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAkUAAABJCAYAAAAzI1KTAAAcnElEQVR4Xu2dva7dRpLH51UsQAPYT7GvItuAJ5gNPZk3mhtcOJvUoQNb8AU29Y4TYVNLlhYDL/YJZFiDzTcSl1Vd1V1VXU02z/06V/f/Aw5Gl6dJdtfnn+Tx8A8LAAAAAABY/hA3AAAAAAA8RiCKAAAAAAAWiCIAAAAAAAaiCAAAAABggSgCAAAAAGAgigAAAAAAFogiAAAAAAAGoggAAAAAYDkgil6+fDn9AQAAAAB4aBwSRTPMjgMAAAAAOCcOi6L//c9/GX7suJvg1eXHy0dPP16eXf1z/fcny8XL93HIWUPzf2hzziDbkw9uhd+ulmerjy9+Xu308nJ58sfV55e/xFEPnndXf+JYKHFctpX48OO2eb1c/PFyeXViSL27+mL56LOr5fcT93eI3z56erm8fLv++6aO+wg5XickDuLmSSgOntyUv9Y4+JRy1sTBuzjmmpB9qP5k06W1pLVJawnF6OVr88U/l+efyfanXyzfv5WjUjzTuHU/Pz6i+3+xPP8tfhfQHFnrWTb3XcKc6BhUR55dvTt0vON1xsB2XH175IRDVtt9/gnb/uLlGsNPT4/hGV5d/mn10bvVX8VXrCcm4v58RREFhEmw64iimaCYGaPMjj1e7M6Du5y3FjU+mxSyZz+cWlapWXxyehG6Re5fFFExv1wubsi3bu7UGCeKTYrk+Un7fiAcz7friKKbjgNTl0PNPsSJMZSLIrLP2ghZ8BQRY3PO1Rs952FRNGH/D0AUkbC4uCQbn+RVD9m72vY6oojElfp3TBRFLRa294MoEmbGKLNjjxe78+Au501FbcaWU1DSyZ2mu5n9PPcuikyBpcJ0yiEsEEU3x/F8u4Yokjh4f2NxcIaiKByrjYmN2DTXaVF0gAcvilZ7fb768+01/Gq5d1E0l2t3LIqKIZ7Tbfx6+7HdUuPbavQYRYNJbnGWW18h+er33rA07ol8R3ccyAh6bLp1ljk2HUOJpbdf+XZfNvYHTjwKVD2nnc++A+ytXFk7QUlQj2du00qyv6Lb3+G7kviv1+OJLWVuhcF5lmIv3V4eU/brs43c294eS4LczL0lYvCxCREniihp9E6RnmcN6Ha+dhuXbF7nSXb4ezuvHevW8zRcJdK5PqNYlO9tfAz8733jbXkUW6xK3CaPIFyjkWb4c3s04BqCm7O/5d3sPBZWJYauVj9+3Aq52Mnax9mUxsWGZm1kt4f5vRrGUoEf99XzaANPYkls9JznRev2Y1qTkxi19nN3Jcd5kn7/kv72F2uuSTs72Hz02DqhcfCKz2Uf0dhGID40x9+KA1sfZ+Kgt+fS+VTjoNY9iQMXu6P1x/pNf9tcC3b3TZ3mrb4tvaSs3dor3imS7XF+S+grU2gMNLv6+m98oX5wNcz69DhWFJUaqP3R11W7rvIdxX7iiyyflNV/n3K9lNhL513i6PkPpqcH/2r81DrCtguiaFi7Yk6SyPG57epEt79nvyffiyiyCSwBWxWfJCr9MwRwdbIUYJd4UvT4WXly9RMDJsONYQeFeZlg3jqeLYp7DqDvu2flXEh8sDzTvyVwqJCXpPjCrb09Iy+BXs4di2srhpzMyVVRnHcVRTyXeCxTqCVIGVqHNkRKiMQvhLOlJI4XRcXX7FuKHVq7Jlice92eXZm1YuaSVH6/pI1e11mKWWhk7BudrxaTpGnUz6iQFHTtLm5jfLs8kIZQ12fiUsZZYTK6Khs1ghJDJvaC3/rYli9kzupr65eyD8WrjRVDnHclFE2B5t5dKUus5DkZmiXHqLEfzYm/G+dJJaxNtzUbhQaczD9D803zsTuW/u1EEcWB9W87bydQD8ZBtae5SLN1wsfB4E5RFwfazH0trcR5G1qslZxr/i/+7EXR0nLYxoXLpcLQBkPyOuJqss6pzkHG1rrSLry5xoVPFIWWakc6r+uPPv6jKLJ53XLIxhRh48N/V84bH1MSJRZ1/Z2NbX6MalL0vRmnPdIT593Y82c53vadtnsQRbZQSJHKGkkwbl2sBKHbh8dFgdWIAZMRm3NRyI1hQ2CkSOl8jEPHDoq2KJTHLH5bPV8MHmMjnZ9+pckzsvH3b+W24tBebXsVRatdYoD6Yhd9K01FikH8rZC7qibEt04UaRKp3/XOhLvq8PtHUaSCp629xZHOyRYzFWCxOPnjhOOdACco3akywkN9PBZFvlFXG67r6ea2irqsQblCZYj+iFfA/HGxLQNNXKod/T6/jB/XyPr6ZijNxzWxfv1MLMSExoLMoczVxKTQiv0oT8xgiUmfA2ZO9L3YJ9pSoVzS49t60sVBbPKdKPK1o+Z/WDd/1DaTcRB9sh0HuSjaioNOWBKxthlarL0uj3Oy+LfQusyxamNN4mSvifZ4UUT7P7FxYuuW1qlaj4qoczXrIByvFCvBVrEnRVHkekq1dehb/BmI68R2hZCTgzpkL47rfmqHNGapdsWeogxE0cu+b/cM9jWcgShKihwRnOBEUZZUG8fqgiLhdFFEQWGMbJI+igvHIMhuRxRlgTVoMEs/72uLIjOWAt4nr7f7lCjiDVqcykfn58boMWReRdRcVxQlV7knUpth8OnJoihrcIvOO376W8yxwTTf9ji/mbiMx1CGx5L1Zc2QMXHQPaazY6zNyLdmnGuqSUw2UZTlSY/Giq5fa1PNE962X3OUNA6uI4quGQfRJ62W9GyJonEc9Nu72mYY1r8lP08ndOq8ov/3G2TP/YuiJ2tc8F1IM+0Yb/OiKO8BqRBOa184htShFInNgsm3UczGvK4kfturIwLnWlaHDIdF0R7b42LhKQGWTjIYpDqZAy1zTlnwk+TRSRcUCV2Rn318xmNbUHDhmRFFde0HH59ZxydFSL9qhaydJ8IJLY+P/PaBKOK5WNtbQRh9GwuQEJKG5n2aKCpYMdMVIbalrl2L2b4oqucKj890TJv/esyrNr++4eRxqmgcsQirfhWbyn58zpoH9N0n4XdcMlZ90xX46JcC+ZTzLomhCtshaZpLkgM6/xi/SpdTbbstZl1DYzSWSlPp6kWoFVzQa5Glfa0osmLX2no7T7o5SRzzVlrb5eVyYQv4yA4Jmm+l4XkxV+fj7CdxUGuaj4PUzjtx4GwYfKJxEPclRqJouP6uhrTtrraJfYkWa8X/zRfFny2/y7qjHTmHzLFq/NC67Dmn8KLI1hH60wlmrUdhbK0fbItYM2x89tSLi+ATXWPZ09cJ25PK3/bxmfjfkYiOxdqx2bqcy9T5kX8JmnMmioYxO8rJOL88tjNib8s4JIpmP2OyyRcH1qDQW/6h0Lnk44RrQdSMVpxct+vjGh1vi1YkjtEA1kC1y6pj2w+RVVVfrMVxThQRJaljMtTmyx8TYLFwGBuNRRHhz9OafbCX2lHXnv3QOti++6G1/FX/pq+dLb3/TxJFwTcx4Ysv5Ae3XMDos9pnVhTZ8+k6ZY7eNzIfOfdRrLAoV2ZlbnpHjeezxlPLg1KA6D+njvNiwpx5beQvYx83lmLpbR9DlnjFqOcbiiLex9vI/Tali4PmIxrX8jzkhhUApl5o87G1wo8p9mqiKNjPNaA8T+qcXOzbOM6bi7ND/H2awdYJjYMmdHX/dd6hEU3HgQj9rTh4tyWKljKvtnYbBwNRxPuM46C3Y6tFPM7M19XRKjTKvt0PraVR2prs676Pja3yXP7rpTggiKKlzxEvZNv2MhfpbydSRRH9IXZssd3sYv8vF9h+1Jf0e1ezYv9tsdDFK8cj+WtDFBHOv00wcqxloki/i7WrjmvbW48Um6/HY9FnxnSPvQ37PfmAKALgNohiDoDbwwh1ADZZG/9ldhHdiyLwUCi+gyhyhCtB/sQ7VzePu2pRxbt1Q+0xIVfDW7eMAbgZIIrAJHSXpz6OskgPye6kgLOG7yhN+O2RiSIAwOMFogicTnscePsX0uD+gCgCAAAAAFggigAAAAAAGIgiAAAAAIAFoggAAAAAgIEoAgAAAABYIIoAAAAAAJhpURT/X6u3PgAAAAAAD41DomiG2XEAAAAAAOfEYVH07//zf8OPHXcT6DtN6DUQ6UsZz5yZ96w8BMoLBONL+W4I+/9ore+/SV5S+9Chd/VQLNj3yLn3h02RvGdoguE7qE7Gvq/sl5PmBArHa8RpMTB8H9XJ2HeV3U4M2Be5dtB6su/s+8bC++bsO7LcOxs/D+9+G6E2zM4bKOcav4Nrm9fl5cLhfXTuvZcT+PdfzhLe+rDxzr5ptK6vx/rv5P2KN4r+P5HLe9b4hdfk7wN19nxFUQjS64iimeYzM0aZHXu84J0Hdzlv9+4zSZ72MsCjyMsNr/GS1tvivkWRf0nl8WM4XEM6bU4FebFk9kbtR8LxXDvR3p3PsreSH0CbDv9x4pyY+MbzSdx6lCLU2otQ20t6ncByOXBcFM009Yctipov1YYHThvw/i1z2rdfiou5AVEU0Tby255vDRBFwswYZXbs8YJ3HtzlvKlYzdhyCkoEudN0N7Of52xE0alNyNI12ONzKkAUHc+1E+0dRMR16injGtSJc2JOjMewnkKYh8wxi7O2/gOi6AAfiiiaEiKbnIEoOujbOxZFxeDP+Xa+Bmm7DVtva8otr7KtjHNJ7L6/dO+hsS9fpTsOJTjlMzBMOoavJtp228ja2HJrkRzdXvja5rNf8NpjiLp2ghK+Hs8ksyTGq9V+5Xztu9L4Xq/HE1u6256D8yzFXrq9PKbs12cbube9PZYkk5l7a/jBxyZEnCiiQNY7RXqetZi187U3U5PN6zzJDn9v57Vj3XqeljXyIfRcn5lHSzY+Bv73vvG2PIoVRSVu1zm/DQnsElqK/s8i/mQ9FTdnaysjikaFRc7znO0l+4bjcVy79dO4vhHt25OO5WMyCln3yC8085rfvCZfU6gJbecjPeo5liNKnNPvlIfWlqGJPTNzGJUBWyNqDLyPTdw2lhYDOhffZAa5Rn5RO0od6Rtsb8veb8t+DAzXHue2HwNezOu+69x+aOtpeVTGWHtW4WPigFDB0JlgC1m3yyVTI+xjfxVFzzbWdwjrM/EJ10nrV8Lkd1kj9QSdw0avrHa2omgsWNnmVz+wn/VRbOwl0d80jnLGxqutz+6Rbqwjztar//9rjTFr+6e+rzhcDd3nHkSRdYAkfzW6JBf9MyykBrgER12gCQpKoqzgz1yRuzEcdGFeRoBsHc8m8p4oou9rk1Y4GEzwcoFpNtFkKEHfbgmXgq1XJrY4xALbChg3D5tQQpx3FUU8l3gsU6wpOPV4tA5NYpOoEWdLCXwvioqv2beaOJogce51e1Z8tABLkTZjCU1OXSc3gvg8nX3jC7A9nk1QTd6tuyC6dhe3Mb5dHpC97eNBE5cyrs5XbE64Zj66ehV7uxwIx3O+rbY3DdFtb7nw3sWJJcam0jcxQuPVH6XVlHh0IuZjER3lO4rrciUd5xGavG7r5uTHtatgXy+20Fzza4vziaKoxEDBnis2MTPnEJ+Z6OtsuRMD6Z2i2IDMuGZvS5xzw/tubeA17iX3ZC6+Hot9tFbotpsWRVojdE60TlOTtJ5YwUD1q9hda1H4pHVLqL4IuRRyztq7XBy0ONJ+ofNpNd7GW4mBvTlxLpn6OD6e96+9U+T9ZsaxbWOuLSHm/PauF1hsD53gHkSRnVxwAH98ke9EkQaf3YfHiSOS5NoSMUpszp+GIhuLqz9eS8QSSDZZ+/kUoi0K5TGL31bPF4uUsVFrQIV26zS38fdv3+3Yq22vomi1i1X5RCsucT3yNx1GCkj8rZC/Elyqb50oskVYi5AWJF6LOacdo9uWVqDa2lsc6ZxUONB8VIDFxuGPE453AnQ8vlNlE118PBZFvllXG67r6ea2Fi0bG4XSULq4zJpZmmflu0wU+bt38qG10bGyYtY1f7vdnE+3pc0zxp1sm8nHautRjthzZXOyzYDmZwRIUqSzK/M0Bjq72LWPY6CIT7NuWQcfJ8xJBYq3ZrDlTgykomgQh6WZ+3kXRn61cSu2tUMyG2szlXHtoq+PkeuKor5GiO3FPqVWmBgSW8YaOA3HKt01D7aKdjB+aT1A0ZpcakD0U+k7pm4TdDzbcwSfS1vHG4kiyae4z8/lAqEXz0uIOeV1edTotiVEO21wBqIoS5SlK9JOFKWLGx+rFzE9p4siSgYTqMb4XRG2xCYk3I4oik2DGBWpft7XFkVmbEuWQrT7lCjiDT6pdH5ujB5D5uUKlT3XckQUZU38NGpDDD49WRR1BaMQxWfaEGI8kn0Gx/MFps3JXgVa0vMx4wsZxsRAafhZvCZxN5uPThRlOZLg5rQ0O8n/EtHeW6QxcC1RlNlo6ZtC6t9gh3SM4L4z543nUWLtqsyIomRdyXnKeBtnsl9nT9NPjkDnHNYIOtcti6I1rulxnJt3tIPxSy8utCaPbd7X7cT2S8ylreNtiaK8lg5908Xj+BgOztnJ/F5OEEV7bI+Lxac0trRgjkSRBEdmCHJUu8Xqt0ehEXFj9BzVyTTvds5+bAsaToZREXbo2g8+Pjssitp5InpLOhLnXUURz8Xa3jag6NuYXEJIYpr3aaKoYMVM8YUZw7bUtauI2hdF9Vzh8ZmOafNfj3nV5qcCrX3yOFU0jrjAVr+KTe0tbyeKPgm/45Kx6pukMPkmTUUqeRQd8q3PAYPzYWiIWfEZHiuIIrJ714RbHPlHKOF7/XMnH+3+erdkL0f6HLaxTfa8XC4uyQ8yrsuTMZprfFfD5DaLJZ2Ps99GDIhv03oa8q7dKZKmxftntsz8tgRfmRgYrr3Nrd9uzmFi0satv7NVjuXr7CJ5a37DRH+bY9X1hxiZRnJ8VGu4ntT5lhpQHp/JfKtI0loUPl1sG8Qu5Y6b8T/bu/nM5ojGlFpcbUDf5blEhLotNtSfQYx626iXRP/aCyebmw7xY1dHXMxpbroRObG27XBIFM1+xsTGKdvsLV+55R8X4oqTBKd+YsGv21WV6/gtw8QxEuR6LGf8Orb9EFlvi19cXg4Dp4fsYc4hgV6bL39MgamJ0f7eF0WEP09r9sFeakdde/ZD62D77ofW8pdLLmdL7/+TRFHwTSz2xRf6g1UdV66ypkSRPZ+uU+bofSPzkXMfxYprLmAyN72jxvNZ4yneKbq47OfFhDnHtdntPGfTgGK+MfF4xjZaXF1DXPpz1fgYxAALQrUjjeHjhryoa8ziNcbdTj7S33ps57s8R1rdGc2pNR93F8TlydwPrW0M1Pjnuaw+r+JxJwa6etrqWZvPx2btG6JI9hvFQCqK5Dt7rhpvYW4+9mVOA1Hk9x390Nociz/hR96mFmw+8n7ZPynQ7Z0NXB2KP7T2n3jn+RCu9ost5Hz2XBrvNIx7ANUPnYPLb59LLSdDHlgb0vqHvW10vLEo6sWh/Y9DzKN4V/9EXP7HOhdr+6fFL6mFs9q2wbQoAuA2iGIOgNuiL+QA9Ly7ukzudC29KAIPA/IbRNGIqIKtor097JWrfqZu+z0G5Ir4WldRAEwAUQT2obsX+aM1vQuK2v2A0P5ywGePTBQBAB4rEEXgNNqjO9wl+vCBKAIAAAAAWCCKAAAAAAAYiCIAAAAAgAWiCAAAAACAgSgCAAAAAFggigAAAAAAGIgiAAAAAIAFoggAAAAAgIEoAgAAAABYIIoAAAAAABiIIgAAAACABaIIAAAAAIC5YVH06/LNl39bfvy9/PXm26+WP3/767L1CkYa89ef3sXNN8pvP/2N53HOvPn233Zt9bhZY+svGlv076+Wb/4Rx3jIprcdW9fhLmJ/i+28UBtPROTvL5a/fvnd8mZi6M1C9WY/DgAAYJYTRVEpRn+uHy2IXhTNcBeNYbv4T6BFP25/MOT+Yru47fL5+sXydnm3/Ph1v/03e8y/3GUjtKJojlNE0V3Eo3KX58pweXGdGL83UQQAADfLcVH0j++4Qbqrs7UofsPFHaLo7Nj0l1IEkL/ipm3el95Xx0UR+eH0q3qIopsGoggAADwHRdGe6Okfn9mi7+5MyF0HN2Zt4P+qDZyaubszYeAibO56jLZLke5EURzXvqkion7n/h41sfKooYyx9hlslybyo9iDHlHEBu5sNTv3jj1/KXOiiG1T53KbosjfpSp2saKoF0gxtt4uQRRVcfi+xJmMacQ7YyF+6vZoT+tjiZeRv9ZzvlmPpXPazI+hiJe1/9TiUvOFcqeuUceGGCGb6Pc1L9IY9zYuc/3V2KiP5xYLdN5kXCTGsu4ft8vmMt8XMgfa3sc3P4Z26zD76jHxmBoAMOCYKNoSKsxYFHFRMvu++SmIIi6EpsANz9U3xLo97E+Nj/b3oijsb8/DzcEW4Rfl35tX0SooYpkN2+0xpOjbot01cGurasfR2gcMbRiZEUVxzG2JonKeZpu1EXdr93bQ2FKR02JLbJrEVi+KClGoFLFhfO8EQPS9iIFRrAW/dxcEdg1xHhURYXoOFTTa6HW+/MekKCK6GO9FkRM49jypTWRcJ5iUXtDU7Ul+kl2KsLH7+GPoesqpzDym8wAA8Ng5LoqGV7DESBTFBtsoY15wM+mFRUZszgVfEAlp2ua74ThpBjSXeFymaxieeJeHMcW8YGyQHK8dI1kfNSCec2zCO+z6S0nO2d05if6bFUXSxOtx+jsADrJN2sBGomgrtsimGlvx2xwvRnJ7lzh53wkZxti8j7WyrRdFyXmGvguioRMXwU5JnJ0qinyMmzlb4dMJkJF/spiLFzCErOF9Zk+79mgXY+tubQAAkHNcFKUNSxmJonEDLVegR29p03nKflpUy1VkbLxlLp0oSseNivcyUVSbgLBX/v15ZL7J8aIoivs1gdVERmwoHbv+UrIG5e3BforNauDTEWT7mTmTAOwZiaK+8Sv1UUp6vJxeFPUxUZttFauGIIqiWN4SRZnPe9/F5n9fosgcK4qiuA6O1SxQbB6bOXX7+zwei6K431dtfXVex2IWAPC4OCaKugIc8d97UZTvV8aU3yrEortPO1/WgJQoivJxmTAQuoYxwhwja5hKcjwvinJbefZ8QcyMIbK1x3nEY5FPjzWYaVG0KwZi48/XWGx6LLZ6UdQ39K07RTHWoti3dxW9KMrX0BNzKa4/2qaPs5sRRWbOURQdEKGFdq5xfmb2tGufjMfEZwAAoBwURXolFwr47/l/fWYLKV+1m2bX/aaIi1q405I2R4tp5lyY88bSF/+NcaYxzP2myBPXExsqkxzPNkuex5G1b7DtLyU7VtKonU8mm5BhShTFOFj2f1PEd7FMo+t+U8Rx6WNr1Bhj848x4QRA5+NynmGs8d82J9q/1efZnDx+7THn/PfBr7TueFfmgCjqfvSs84024XPIwCmM+Iw2M2yLIqkxowsRxc0VAAA8h0URE2+R20c7A1FU/m7/ZYgWYzdGmgZ/NxRFpRHpcdxVpRT9eA5X/DfG1bHdurQpxKtlIjz6sOfR9Zjj8Xq6BuRFUfnb7PelNrLB2uXqfFjnh/5SJkWRrpXP5efi1ndtRFzUtcu2gSginL3EFs6mJrbeb4ii5rPWOF1MRHHsfPxd/1+f2Vj7evu/PnP5UdcdiWvfEkWL9/06r3qXa+nzwsd4L4r091l1rRpwUWgkcd/b2vs45rG1g/pzTxR1uajfuePFmAYAgMZpogicFXN3YMBdQL7ohXOjPL6KW8+fKOAAAOBDBKLowUNXx3OP9sAts/Hoh+G7Rg/TVxBFAIDHAEQRACfTP0J0d4HiY6QtwXTmQBQBAB4DEEUAAAAAAAtEEQAAAAAAA1EEAAAAALBAFAEAAAAAMBBFAAAAAAAr/w8vO8B7gauEEwAAAABJRU5ErkJggg==" width="581" height="73" class="img_ev3q"></p><p>Generate some data like you did before by running a few netcat connection/disconnects and click &#x27;Execute&#x27; again. Don&#x27;t forget to send
the connection request to kubeB though!</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nc kubeB.reflect.svc.ziti 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">this is kubeb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">you sent me: this is kubeb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">^C</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nc kubeB.reflect.svc.ziti 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">another to kube b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">you sent me: another to kube b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">^C</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nc kubeB.reflect.svc.ziti 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">one more for fun and profit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">you sent me: one more for fun and profit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">^C</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="kubeB from kubeA" src="/assets/images/kubeB-from-kubeA-0f78d64d83a2d8b02e25a72167d20de1.png" width="880" height="946" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="scraping-all-the-things">Scraping All the Things!<a href="#scraping-all-the-things" class="hash-link" aria-label="Direct link to Scraping All the Things!" title="Direct link to Scraping All the Things!">â</a></h2><p>By now, you are probably starting to get the idea just how powerful this is for Prometheus. A zitified Prometheus can scrape things
easily and natively by just deploying a <code>Prometheuz</code> instance into the location you want to scrape. Or, you can just enable a scrape
target using a tunneling app, or in Kubernetes using the <code>ziti-host</code> helm chart.  Let&#x27;s complete our vision now and stand up a
Prometheus server on our local workstation using Docker.</p><p>When we run <code>Prometheuz</code> locally using docker we&#x27;ll need a config file to give to docker using a volume mount. We also provide the
identity used to connect to the OpenZiti overlay in the same fashion. Let&#x27;s start up a docker container locally and see if we can grab
data from our two Prometheus instances using a locally deployed <code>Prometheuz</code> via docker.</p><p>GitHub has a sample Prometheus <a href="https://raw.githubusercontent.com/openziti/ziti-doc/main/docusaurus/blog/zitification/prometheus/scripts/local.prometheus.yml" target="_blank" rel="noopener noreferrer">file you can download</a>.
Below, I used curl to download it and put it into the expected location.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -s https://raw.githubusercontent.com/openziti/ziti-doc/main/docusaurus/blog/zitification/prometheus/scripts/local.prometheus.yml &gt; /tmp/prometheus/prometheus.config.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create identity user local.prometheus.id -o /tmp/prometheus/local.prometheus.id.jwt -a &quot;reflectz-clients&quot;,&quot;prometheus-clients&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge enroll /tmp/prometheus/local.prometheus.id.jwt -o /tmp/prometheus/local.prometheus.id.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker run \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -v /tmp/prometheus/local.prometheus.id.json:/etc/prometheus/ziti.id.json \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -v /tmp/prometheus/prometheus.config.yml:/etc/prometheus/prometheus.yml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -p 9090:9090 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  openziti/prometheuz</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="local-docker-targets.png" src="/assets/images/local-docker-targets-8dc1e23a53a77339ddc8926ac5d7327a.png" width="458" height="316" class="img_ev3q"></p><p>Look at what we&#x27;ve just done. We have started a Prometheus instance locally, and used it to connect to four Prometheus targets via
scrape configurations when all four targets are hidden entirely from my local computer (and any computer) unless the computer has an
OpenZiti identity. I personally think that is incredibly cool!</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="taking-it-to-11">Taking it to 11<a href="#taking-it-to-11" class="hash-link" aria-label="Direct link to Taking it to 11" title="Direct link to Taking it to 11">â</a></h2><p>But wait, I&#x27;m not done. That docker instance is listening on an underlay network. It&#x27;s exposed to attack by anything on my local network.
I want to fix that too. Let&#x27;s start this docker container up listening only on the OpenZiti overlay. Just like in <a href="/blog/zitification/prometheus/part2">part 2</a>
we will make a config, a service and two policies to enable identities on the OpenZiti overlay.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -s https://raw.githubusercontent.com/openziti/ziti-doc/main/docusaurus/blog/zitification/prometheus/scripts/local.prometheus.yml &gt; /tmp/prometheus/prometheus.config.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># create the config and service for the local prometheus server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config &quot;local.prometheus.svc-intercept.v1&quot; intercept.v1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;{&quot;protocols&quot;:[&quot;tcp&quot;],&quot;addresses&quot;:[&quot;local.prometheus.svc&quot;],&quot;portRanges&quot;:[{&quot;low&quot;:80, &quot;high&quot;:80}], &quot;dialOptions&quot;: {&quot;identity&quot;:&quot;local.prometheus.id&quot;}}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service &quot;local.prometheus.svc&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --configs &quot;local.prometheus.svc-intercept.v1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># grant the prometheus clients the ability to dial the service and the local.prometheus.id the ability to bind</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy &quot;local.prometheus.svc.dial&quot; Dial \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles &quot;@local.prometheus.svc&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --identity-roles &quot;#prometheus-clients&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy &quot;local.prometheus.svc.bind&quot; Bind \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles &quot;@local.prometheus.svc&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --identity-roles &quot;@local.prometheus.id&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Once that&#x27;s done - let&#x27;s see if we can start the docker container. The helm charts are configured to translate the <code>--set</code> flags
provided into &quot;container friendly&quot; settings like environment variables, volumes and mounts etc. In docker we need to provide those. If
you&#x27;re familiar with docker these will probably all make sense. The most important part of the command below is the <strong>lack</strong> of a <code>-p</code>
flag. The <code>-p</code> flag is used to expose a port from inside docker, outside docker. Look at the previous docker sample and you&#x27;ll find we
were mapping local underlay port 9090 to port 9090 in the docker container. In this example, <strong>we will do no such thing</strong>! :)</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">docker run \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -e ZITI_LISTENER_SERVICE_NAME=local.prometheus.svc \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -e ZITI_LISTENER_IDENTITY_FILE=/etc/prometheus/ziti.server.json \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -e ZITI_LISTENER_IDENTITY_NAME=local.prometheus.id \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -v /tmp/prometheus/prometheus.config.yml:/etc/prometheus/prometheus.yml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -v /tmp/prometheus/local.prometheus.id.json:/etc/prometheus/ziti.id.json \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -v /tmp/prometheus/local.prometheus.id.json:/etc/prometheus/ziti.server.json \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    openziti/prometheuz</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="but---does-it-work">But - Does It Work?<a href="#but---does-it-work" class="hash-link" aria-label="Direct link to But - Does It Work?" title="Direct link to But - Does It Work?">â</a></h3><p>After configuring the OpenZiti overlay, we just need to open a browser and navigate to <a href="http://local.prometheus.svc/targets" target="_blank" rel="noopener noreferrer">http://local.prometheus.svc/targets</a>. SUCCESS!</p><p><img loading="lazy" alt="local-docker-targets-no-listener.png" src="/assets/images/local-docker-targets-no-listener-c80c0b90432aa76d510ab4684613c0f2.png" width="495" height="405" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="success">SUCCESS!<a href="#success" class="hash-link" aria-label="Direct link to SUCCESS!" title="Direct link to SUCCESS!">â</a></h3><p><img loading="lazy" alt="local-docker-graph-no-listener.png" src="/assets/images/local-docker-graph-no-listener-bf6c6577b99852b0c9df5935da209c7b.png" width="891" height="953" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="wrap-up">Wrap Up<a href="#wrap-up" class="hash-link" aria-label="Direct link to Wrap Up" title="Direct link to Wrap Up">â</a></h2><p>This was quite the journey and a lot of fun. We have taken a wildly popular open source project and brought OpenZiti to it with really
not much code at all. Then using OpenZiti we were able to give Prometheus superpowers and enable it to scrape any target regardless of
where that target is or what network it is on. </p><p>Think of the possibilities here. Are you a cloud provider looking to monitor your client&#x27;s services which are deployed on-prem? That&#x27;s
so easy with OpenZiti and without sacrificing security <strong>at all</strong>. In fact, using OpenZiti like this provides amazing reach while
<strong>strengthening</strong> the security posture of the solution because you&#x27;re now using the concepts of
<a href="https://en.wikipedia.org/wiki/Zero_trust_security_model" target="_blank" rel="noopener noreferrer">zero trust networking principles</a> and applying them to your alerting and
monitoring solution.</p><p>What do you think? Was this series interesting? Do you think OpenZiti is cool and you are looking to try it out? What are you going to
zitify? Tell us on twitter or on discourse! Both links are included in this page. Let us know what you think! Go star the
<a href="http://github.com/openziti/ziti" target="_blank" rel="noopener noreferrer">openziti/ziti</a> repo and help us spread the word of OpenZiti to the world!</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="In the previous post we talked about how we could take a well-known application and improve its security by zitifying it, producing zssh. The logical next step after zitifying ssh would be to extend the functionality of zssh to cover moving files securely as well, enter zscp. A zitified scp effectively creates a more secure command line tool for sending and receiving files between ziti-empowered devices. Once zitified, we can use zscp using ziti identity names just like we did in zitifying ssh. I recommend reading the previous article) if you haven&#x27;t to learn more about the benefits of zitifying tools like ssh and scp."><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/zitification/zitifying-scp">Zitifying SCP</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-01-15T15:50:26.000Z" itemprop="datePublished">January 15, 2024</time> Â· <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/dovholuknf" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/46322585?v=4" alt="Clint Dovholuk" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/dovholuknf" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Clint Dovholuk</span></a></div><small class="avatar__subtitle" itemprop="description">OpenZiti Maintainer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>In the <a href="/blog/zitification/zitifying-ssh/">previous post</a> we talked about how we could take a well-known application and improve its security by zitifying it, producing <code>zssh</code>. The logical next step after zitifying <code>ssh</code> would be to extend the functionality of <code>zssh</code> to cover moving files securely as well, enter <code>zscp</code>. A zitified <code>scp</code> effectively creates a more secure command line tool for sending and receiving files between ziti-empowered devices. Once zitified, we can use <code>zscp</code> using ziti identity names just like we did in <a href="/blog/zitification/zitifying-ssh/">zitifying ssh</a>. I recommend reading the <a href="/blog/zitification/zitifying-ssh/">previous article</a>) if you haven&#x27;t to learn more about the benefits of zitifying tools like <code>ssh</code> and <code>scp</code>.</p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="first-things-first">First Things First<a href="#first-things-first" class="hash-link" aria-label="Direct link to First Things First" title="Direct link to First Things First">â</a></h2><p><code>zscp</code> functions with the same prerequisites as <code>zssh</code>:</p><ul><li>Establish a <a href="/docs/learn/quickstarts/network/hosted">Ziti Network</a></li><li>Create and enroll two Ziti Endpoints (one for our <code>ssh</code> server, one for the client)<ul><li>the <code>sshd</code> server will run <code>ziti-tunnel</code> for this demonstration. Conveniently it will run on the same machine I used to setup the <a href="/docs/learn/introduction/">Ziti Network</a>.</li><li>the client, in this case, is my local machine and I&#x27;ll <code>zscp</code> files both to and from both the remote machine.</li></ul></li><li>Create the <a href="/docs/learn/core-concepts/services/overview">Ziti Service</a> we&#x27;ll use and authorize the two endpoints to use this service</li><li>Use the <code>zscp</code> binary from the client side and the <code>ziti-tunnel</code> binary from the serving side to connect</li><li>Harden <code>sshd</code> further by removing port 22 from any internet-based firewall configuration (for example, from within the security-groups wizard in AWS) or by forcing <code>sshd</code> to only listen on <code>localhost/127.0.0.1</code></li></ul><p>After ensuring these steps are complete, you will have the ability to copy files across your Ziti Network. The traffic will be even more secure since now a Ziti Network is required for the connection, requiring that strong identity before even being able to access the <code>sshd</code> server. And of course now <code>sshd</code> is &#x27;dark&#x27; - it no longer needs the typical port 22 to be exposed to any network.</p><p>Given all the prerequisites are satisfied, we can put <code>zscp</code> to use. Simply download the binary for your platform:</p><ul><li><a href="https://github.com/openziti-test-kitchen/zssh/releases/latest/download/zscp-linux-amd64" target="_blank" rel="noopener noreferrer">linux</a></li><li><a href="https://github.com/openziti-test-kitchen/zssh/releases/latest/download/zscp-windows-amd64.exe" target="_blank" rel="noopener noreferrer">windows</a></li><li><a href="https://github.com/openziti-test-kitchen/zssh/releases/latest/download/zscp-macos-amd64" target="_blank" rel="noopener noreferrer">MacOs</a></li></ul><span></span><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="sending-and-receiving-files-with-zscp">Sending and Receiving Files with Zscp<a href="#sending-and-receiving-files-with-zscp" class="hash-link" aria-label="Direct link to Sending and Receiving Files with Zscp" title="Direct link to Sending and Receiving Files with Zscp">â</a></h2><p>Once you have the executable downloaded, make sure it is named <code>zscp</code> and for simplicity&#x27;s sake we&#x27;ll assume it&#x27;s on the path. Just like <code>zssh</code> to <code>ssh</code>, <code>zscp</code> provides the same basic functionality as <code>scp</code>. As with most tooling, executing the binary with no arguments will display the expected usage.</p><p>There are two main functions of <code>zscp</code>. Just like <code>scp</code> you can send and receive from the remote host.</p><p>To send files we use this basic syntax:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./zscp LOCAL_FILEPATHS... &lt;REMOTE_USERNAME&gt;@TARGET_IDENTITY:REMOTE_FILEPATH</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then, to retrieve remote files we use a similar syntax:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./zscp &lt;REMOTE_USERNAME&gt;@TARGET_IDENTITY:REMOTE_FILEPATH LOCAL_FILEPATH</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Below is a working example of using <code>zscp</code> to send a file to a remote machine. In this case the remote username is not the same as my local username. Just like with <code>scp</code>, I&#x27;ll need to supply the username in my command and it will use the same syntax that regular <code>scp</code> uses. Here I am <code>zscp&#x27;ing</code> as username <code>ubuntu</code> to the remote computer that is joined to the Ziti Network using the identity named <code>ziti-tunnel-aws</code>.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./zscp local/1.txt ubuntu@ziti-tunnel-aws:remote</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO    connection to edge router using token 6c2e8b79-ce8e-483e-a9f8-a930530e706a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO    sent file: /Users/name/local/1.txt ==&gt; /home/ubuntu/remote/1.txt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This is only a basic example on how we can use <code>zscp</code> to send a singular file to a remote computer. In the next section, we will go over how to use <code>zscp</code> flags for extended functionality.</p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="zscp-flags">Zscp Flags<a href="#zscp-flags" class="hash-link" aria-label="Direct link to Zscp Flags" title="Direct link to Zscp Flags">â</a></h2><p>Just like <code>zssh</code>, <code>zscp</code> has the same flags to pass in: ssh key, ziti configuration file, service name, and one to toggle debug logging. All the defaults are the same as with <code>zssh</code>, thus both <code>zscp</code> and <code>zssh</code> will work without the <code>-i</code> and <code>-c</code> flag providing the files exist at the default locations. Refer to <!-- -->[<!-- -->zitifying-ssh<!-- -->]<!-- -->[<!-- -->2<!-- -->]<!-- --> for instructions on how to use the flags below.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    -i, --SshKeyPath string   Path to ssh key. default: $HOME/.ssh/id_rsa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -c, --ZConfig string      Path to ziti config file. default: $HOME/.ziti/zssh.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -d, --debug               pass to enable additional debug information</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -s, --service string      service name. (default &quot;zssh&quot;)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In addition to the flags above, <code>zscp</code> has a flag to enable recursive copying:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    -r, --recursive           pass to enable recursive file transfer</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To use the recursive flag, you must input a directory into the <code>LOCAL_FILEPATH</code> argument. Just like <code>scp</code>, <code>zscp</code> will copy all file contents under the provided directory. You can see below how we can use the <code>-r</code> flag to send all contents of <code>big_directory</code>.</p><p>Contents of <code>big_directory</code> on local computer:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">tree local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">âââ big_directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    âââ 1.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    âââ 2.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    âââ 3.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    âââ small_directory1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    â   âââ 4.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    âââ small_directory2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    â   âââ 5.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    âââ small_directory3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        âââ 6.txt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Here is the command and output:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ zscp -r big_directory ubuntu@ziti-tunnel-aws:remote</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO    connection to edge router using token d6c268ee-e4f5-4836-bd38-2fc1558257aa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO    sent file: /Users/name/local/big_directory/1.txt ==&gt; /home/ubuntu/remote/big_directory/1.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO    sent file: /Users/name/local/big_directory/2.txt ==&gt; /home/ubuntu/remote/big_directory/2.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO    sent file: /Users/name/local/big_directory/3.txt ==&gt; /home/ubuntu/remote/big_directory/3.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO    sent file: /Users/name/local/big_directory/small_directory1/4.txt ==&gt; /home/ubuntu/remote/big_directory/small_directory1/4.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO    sent file: /Users/name/local/big_directory/small_directory2/5.txt ==&gt; /home/ubuntu/remote/big_directory/small_directory2/5.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO    sent file: /Users/name/local/big_directory/small_directory3/6.txt ==&gt; /home/ubuntu/remote/big_directory/small_directory3/6.txt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After <code>zssh&#x27;ing</code> to the remote machine, we can prove that all files have been transferred to remote device:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ubuntu@IP:~$ tree remote/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">remote/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">âââ big_directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    âââ 1.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    âââ 2.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    âââ 3.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    âââ small_directory1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    â   âââ 4.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    âââ small_directory2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    â   âââ 5.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    âââ small_directory3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        âââ 6.txt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Recursive copying also works to retrieve all contents of a directory on the remote machine.</p><hr><p>I hope this post has helped you get familiar with another ziti-empowered developer&#x27;s tool and hopefully it&#x27;s becoming more clear why zitifying your application will make it more resilient to attack and make the act of connecting to remote services trivial.</p><p>Have a look at the code over at <a href="https://github.com/openziti-test-kitchen/zssh/tree/main/zssh/zscp" target="_blank" rel="noopener noreferrer">GitHub</a> or continue reading on to the next zitification - <a href="/blog/zitification/kubernetes/">kubectl</a>!</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/zitification/zitifying-scp/zscp-cheatsheat">zscp Cheat Sheet</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-01-15T15:50:26.000Z" itemprop="datePublished">January 15, 2024</time> Â· <!-- -->One min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/dovholuknf" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/46322585?v=4" alt="Clint Dovholuk" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/dovholuknf" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Clint Dovholuk</span></a></div><small class="avatar__subtitle" itemprop="description">OpenZiti Maintainer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># establish some variables which are used below</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service_name=zscpSvc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client_identity=&quot;${service_name}&quot;Client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server_identity=&quot;${service_name}&quot;Server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">the_port=22</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># create two identities. one host - one client. Only necessary if you want/need them. Skippable if you</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># already have an identity. provided here to just &#x27;make it easy&#x27; to test/try</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create identity device &quot;${server_identity}&quot; -a &quot;${service_name}&quot;ServerEndpoints -o &quot;${server_identity}&quot;.jwt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create identity device &quot;${client_identity}&quot; -a &quot;${service_name}&quot;ClientEndpoints -o &quot;${client_identity}&quot;.jwt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># if you want to modify anything, often deleting the configs/services is easier than updating them</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># it&#x27;s easier to delete all the items too - so until you understand exactly how ziti works, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># make sure you clean them all up before making a change</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge delete config &quot;${service_name}&quot;-host.v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge delete config &quot;${service_name}&quot;-client-config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge delete service &quot;${service_name}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge delete service-policy &quot;${service_name}&quot;-binding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge delete service-policy &quot;${service_name}&quot;-dialing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config &quot;${service_name}&quot;-host.v1 host.v1 &#x27;{&quot;protocol&quot;:&quot;tcp&quot;, &quot;address&quot;:&quot;localhost&quot;,&quot;port&quot;:&#x27;&quot;${the_port}&quot;&#x27;, &quot;listenOptions&quot;: {&quot;bindUsingEdgeIdentity&quot;:true}}&#x27;# intercept is not needed for zscp/zssh but make it for testing if you like</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config &quot;${service_name}&quot;-client-config intercept.v1 &#x27;{&quot;protocols&quot;:[&quot;tcp&quot;],&quot;addresses&quot;:[&quot;&#x27;&quot;${service_name}.ziti&quot;&#x27;&quot;], &quot;portRanges&quot;:[{&quot;low&quot;:&#x27;&quot;${the_port}&quot;&#x27;, &quot;high&quot;:&quot;&#x27;${the_port}&quot;&#x27;}]}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service &quot;${service_name}&quot; --configs &quot;${service_name}&quot;-client-config,&quot;${service_name}&quot;-host.v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy &quot;${service_name}&quot;-binding Bind --service-roles &#x27;@&#x27;&quot;${service_name}&quot; --identity-roles &#x27;#&#x27;&quot;${service_name}&quot;&#x27;ServerEndpoints&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy &quot;${service_name}&quot;-dialing Dial --service-roles &#x27;@&#x27;&quot;${service_name}&quot; --identity-roles &#x27;#&#x27;&quot;${service_name}&quot;&#x27;ClientEndpoints&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="As we learned in the opening post, &quot;zitifying&quot; an application means to embed a Ziti SDK into an application and leverage the power of a Ziti Network to provide secure, truly zero-trust access to your application no matter where in the world that application goes. In this post we are going to see how we have zitified ssh and why. Future posts will expand on this even further by showing how NetFoundry uses zssh to support our customers."><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/zitification/zitifying-ssh">Zitifying SSH</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-01-15T15:50:26.000Z" itemprop="datePublished">January 15, 2024</time> Â· <!-- -->8 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/dovholuknf" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/46322585?v=4" alt="Clint Dovholuk" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/dovholuknf" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Clint Dovholuk</span></a></div><small class="avatar__subtitle" itemprop="description">OpenZiti Maintainer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>As we learned in the <a href="/blog/zitification/">opening post</a>, &quot;zitifying&quot; an application means to embed a Ziti SDK into an application and leverage the power of a <a href="/docs/learn/introduction/">Ziti Network</a> to provide secure, truly zero-trust access to your application no matter where in the world that application goes. In this post we are going to see how we have zitified <code>ssh</code> and why. Future posts will expand on this even further by showing how NetFoundry uses <code>zssh</code> to support our customers.</p><iframe width="560" height="315" src="https://www.youtube.com/embed/WyZ8GRvtgGs" title="YouTube video player" allow="autoplay; picture-in-picture"></iframe><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="why-ssh">Why SSH?<a href="#why-ssh" class="hash-link" aria-label="Direct link to Why SSH?" title="Direct link to Why SSH?">â</a></h2><p>As I sit here typing these words, I can tell you&#x27;re skeptical. I can tell you&#x27;re wondering why in the world we would even attempt to mess with <code>ssh</code> at all. After all, <code>ssh</code> has been a foundation of the administration of not only home networks but also corporate networks and the internet itself. Surely if millions (billions?) of computers can interact every day safely and securely using <code>ssh</code> there is &quot;no need&quot; for us to be spending time zitifying <code>ssh</code> right? (Spoiler alert: wrong)</p><p>I&#x27;m sure you&#x27;ve guessed that this is not the case whatsoever. After all, attackers don&#x27;t leave <code>ssh</code> alone just because it&#x27;s not worth it to try! Put a machine on the open internet, expose <code>ssh</code> on port 22 and watch for yourself all the attempts to access <code>ssh</code> using known default/weak/bad passwords flood in. Attacks don&#x27;t only come from the internet either! Attacks from a single compromised machine on your network very well could behave in the same way as an outside attacker. This is particularly true for ransomware-style attacks as the compromised machine attempts to expand/multiply. The problems don&#x27;t just stop here either. DoS attacks, other zero-day type bugs and more are all waiting for any service sitting on the open internet.</p><p>A zitified <code>ssh</code> client is superior since the port used by <code>ssh</code> can be eliminated from the internet-based firewall preventing any connections whatsoever from any network client. In this configuration the <code>ssh</code> process is effectively &quot;
dark&quot;. The only way to <code>ssh</code> to a machine configured in this way is to have an identity authorized for that <a href="/docs/learn/introduction/">Ziti Network</a>.</p><p>It doesn&#x27;t stop there though. A Ziti Network mandates the use of a strong identity. You cannot access any services defined in a <a href="/docs/learn/introduction/">Ziti Network</a> without having gone through the enrollment process to create a strong identity used for bidirectional authentication and authorization. With Ziti, you can&#x27;t even connect to SSH without first being authorized to connect to the remote SSH server.</p><p>Contrast that to SSH. With SSH you need access the sshd port before starting the authentication process. This requires the port to be exposed to the network, exposing it to attack. With SSH you are also usually allowed to authenticate without providing a strong identity using a username and password. Even if you are choosing to use the more secure pub/private key authentication for SSH, the remote machine still needed the public key added to the authorized_keys file before allowing connections to it via SSH. This is all-too-often a step which a human will do, making the process of authorizing a user or revoking access relatively cumbersome. Ziti provides a secure, centralized location to manage authorization of users to services. Ziti makes it trivial to grant or revoke access to a given set of services to users immediately.</p><p>Lastly, Ziti provides support for continual authorization through the use of policy checks. These policy checks run continuously. If a user suddenly fails to meet a particular policy, access to the services provided via the <a href="/docs/learn/introduction/">Ziti Network</a> are revoked immediately.</p><p>Cool right? Let&#x27;s see how we did it and how you can do the same thing using a <a href="/docs/learn/introduction/">Ziti Network</a>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="overview-of-ssh---notice-how-port-22-is-open-to-inbound-connections">Overview of SSH - notice how port 22 is open to inbound connections:<a href="#overview-of-ssh---notice-how-port-22-is-open-to-inbound-connections" class="hash-link" aria-label="Direct link to Overview of SSH - notice how port 22 is open to inbound connections:" title="Direct link to Overview of SSH - notice how port 22 is open to inbound connections:">â</a></h4><p><img loading="lazy" alt="ssh-overview.svg" src="/assets/images/ssh-overview-45937eb23dc9f3295bd27452dda3b660.svg" width="723" height="249" class="img_ev3q"></p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-its-done">How It&#x27;s Done<a href="#how-its-done" class="hash-link" aria-label="Direct link to How It&#x27;s Done" title="Direct link to How It&#x27;s Done">â</a></h2><p>There are a few steps necessary before being able to use <code>zssh</code>:</p><ul><li>Establish a <a href="/docs/learn/quickstarts/network/hosted">Ziti Network</a></li><li>Create and enroll two Ziti Endpoints (one for our <code>ssh</code> server, one for the client)<ul><li>the <code>sshd</code> server will run <code>ziti-tunnel</code> for this demonstration. Conveniently it will run on the same machine I used to setup the <a href="/docs/learn/introduction/">Ziti Network</a>.</li><li>the client will run <code>zssh</code> from my local machine, and I&#x27;ll <code>zssh</code> to the other endpoint</li></ul></li><li>Create the <a href="/docs/learn/core-concepts/services/overview">Ziti Service</a> we&#x27;ll use and authorize the two endpoints to use this service</li><li>Use the <code>zssh</code> binary from the client side and the <code>ziti-tunnel</code> binary from the serving side to connect</li><li>Harden <code>sshd</code> further by removing port 22 from any internet-based firewall configuration (for example, from within the security-groups wizard in AWS) or by forcing <code>sshd</code> to only listen on <code>localhost/127.0.0.1</code></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="overview-of-zssh---notice-port-22-is-no-longer-open-to-inbound-connections">Overview of ZSSH - notice port 22 is no longer open to inbound connections:<a href="#overview-of-zssh---notice-port-22-is-no-longer-open-to-inbound-connections" class="hash-link" aria-label="Direct link to Overview of ZSSH - notice port 22 is no longer open to inbound connections:" title="Direct link to Overview of ZSSH - notice port 22 is no longer open to inbound connections:">â</a></h4><p><img loading="lazy" alt="zssh-overview.svg" src="/assets/images/zssh-overview-e793e9a4cdc8275a8375ff45d73d44c3.svg" width="723" height="249" class="img_ev3q"></p><p>After performing these steps you&#x27;ll have an <code>sshd</code> server that is dark to the internet. Accessing the server via <code>ssh</code>
must now occur using the Ziti Network. Since the service is no longer accessible directly through a network, it is no longer susceptible to the types of attacks mentioned previously!</p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="zssh-in-action">Zssh in Action<a href="#zssh-in-action" class="hash-link" aria-label="Direct link to Zssh in Action" title="Direct link to Zssh in Action">â</a></h2><p>Once the prerequisites are satisfied, we can see <code>zssh</code> in action. Simply download the binary for your platform:</p><ul><li><a href="https://github.com/openziti-test-kitchen/zssh/releases/latest/download/zssh-linux-amd64" target="_blank" rel="noopener noreferrer">linux</a></li><li><a href="https://github.com/openziti-test-kitchen/zssh/releases/latest/download/zssh-windows-amd64.exe" target="_blank" rel="noopener noreferrer">windows</a></li><li><a href="https://github.com/openziti-test-kitchen/zssh/releases/latest/download/zssh-macos-amd64" target="_blank" rel="noopener noreferrer">MacOs</a></li></ul><p>Once you have the executable download, make sure it is named <code>zssh</code> and for simplicity&#x27;s sake we&#x27;ll assume it&#x27;s on the path. A goal for <code>zssh</code> is to make the usage of the command very similar to the usage of <code>ssh</code>. Anyone familiar with <code>ssh</code> should be able to pick up <code>zssh</code> easily. As with most tooling, executing the binary with no arguments will display the expected usage. The general format when using <code>zssh</code> will be similar to that of <code>ssh</code>: <code>zssh &lt;remoteUsername&gt;@&lt;targetIdentity&gt;</code></p><p>Below you can see me <code>zssh</code> from my local machine to the AWS machine secured by <code>ziti-tunnel</code>:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./zssh ubuntu@ziti-tunnel-aws</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO[0000] connection to edge router using token 95c45123-9415-49d6-930a-275ada9ae06f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">connected.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ubuntu@ip-172-31-27-154:~$</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It really was that simple! Now let&#x27;s break down the current flags for <code>zssh</code> and exactly how this worked.</p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="zssh-flags">Zssh Flags<a href="#zssh-flags" class="hash-link" aria-label="Direct link to Zssh Flags" title="Direct link to Zssh Flags">â</a></h2><p>We know that <code>zssh</code> requires access to a <a href="/docs/learn/introduction/">Ziti Network</a> but it is not clear from the example above is where <code>zzsh</code>
found the credentials required to access the network. <code>zssh</code> supports three basic flags:</p><p>-i, --SshKeyPath string Path to ssh key. default: $HOME/.ssh/id_rsa -c, --ZConfig string Path to ziti config file. default: $HOME/.ziti/zssh.json -d, --debug pass to enable additional debug information -h, --help help for this command -s, --service string service name. default: zssh (default &quot;zssh&quot;)</p><p>What you see above is exactly the output <code>zssh</code> provides should you pass the <code>-h/--help</code> flag or execute <code>zssh</code> without any parameters. The <code>-i/--SshKeyPath</code> flag is congruent to the <code>-i</code> flag for <code>ssh</code>. You would use it to supply your key to the <code>ssh</code> client. Under the hood of <code>zssh</code> is a full-fledged <code>ssh</code> client that works similarly to how <code>ssh</code> does. If your <code>~/.ssh/id_rsa</code> file is in the <code>authorized_keys</code> of the remote machine, then you won&#x27;t need to specify the <code>-i/</code>
flag (as I didn&#x27;t in my example). Using <code>zssh</code> requires the use of a public/private key in order for the <code>zssh</code> client to connect to the remote machine.</p><p>The <code>-c/--ZConfig</code> flag controls access to the network. A configuration file must be supplied to use <code>zssh</code> but does not need to be supplied as part of the command. By default, <code>zssh</code> will look at your home directory in a folder named <code>.ziti</code> for a file named <code>zssh.json</code>. In bash this is would be the equivalent of <code>$HOME</code>. In Windows this is the equivalent the environment variable named <code>USERPROFILE</code>. You do not need to supply this flag if a file exists at the default location. You can specify this flag to use <code>zssh</code> with other networks.</p><p>The <code>-s/--service</code> flag is for passing in a different service name other than &quot;zssh&quot;. By default, the service name will be &quot;zssh&quot;, but if you would like to access a different service use the <code>-s</code> flag followed by the service name.</p><p>The <code>-d/--debug</code> flag outputs additional information to assist you with debugging. For example:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./zssh ubuntu@ziti-tunnel-aws -d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO[0000]     sshKeyPath set to: /home/myUser/.ssh/id_rsa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO[0000]        ZConfig set to: /home/myUser/.ziti/zssh.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO[0000]       username set to: ubuntu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO[0000] targetIdentity set to: ziti-tunnel-aws</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO[0000] connection to edge router using token 95c45123-a234-412e-8997-96139fbd1938</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">connected.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ubuntu@ip-172-31-27-154:~$</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Shown above is also one additional piece of information, the remote username. Shown in the example above I have <code>zssh</code>ed to an ubuntu image in AWS. When it was provisioned AWS used the username <code>ubuntu</code>. In order to <code>zssh</code> to this machine I need to tell the remote <code>sshd</code> server that I wish to attach as the <code>ubuntu</code> user. If your username is the same for your local environment as the remote machine you do not need to specify the username. For example, my local username is <code>cd</code> (my initials). When I <code>zssh</code> to my dev machine I can simply use <code>zssh ClintLinux</code>:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./zssh ClintLinux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO[0000] connection to edge router using token 909dfb4f-fa83-4f73-af8e-ed251bcd30be</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">connected.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd@clint-linux-vm ~</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Hopefully this post has been helpful and insightful. Zitifying an application is <em>POWERFUL</em>!!!!</p><p>The next post in this series will cover how we extended the same code we used for <code>zssh</code> and <a href="/blog/zitification/zitifying-scp/">zitified scp</a>.</p><p>Have a look at the code over at <a href="https://github.com/openziti-test-kitchen/zssh/tree/main/zssh/zssh" target="_blank" rel="noopener noreferrer">GitHub</a></p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/zitification/zitifying-ssh/zssh-cheat-sheet">zssh Cheat Sheet</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-01-15T15:50:26.000Z" itemprop="datePublished">January 15, 2024</time> Â· <!-- -->One min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/dovholuknf" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/46322585?v=4" alt="Clint Dovholuk" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/dovholuknf" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Clint Dovholuk</span></a></div><small class="avatar__subtitle" itemprop="description">OpenZiti Maintainer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># establish some variables which are used below</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service_name=zsshSvc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client_identity=&quot;${service_name}&quot;Client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server_identity=&quot;${service_name}&quot;Server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">the_port=22</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># create two identities. one host - one client. Only necessary if you want/need them. Skippable if you</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># already have an identity. provided here to just &#x27;make it easy&#x27; to test/try</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create identity device &quot;${server_identity}&quot; -a &quot;${service_name}&quot;ServerEndpoints -o &quot;${server_identity}&quot;.jwt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create identity device &quot;${client_identity}&quot; -a &quot;${service_name}&quot;ClientEndpoints -o &quot;${client_identity}&quot;.jwt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># if you want to modify anything, often deleting the configs/services is easier than updating them</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># it&#x27;s easier to delete all the items too - so until you understand exactly how ziti works,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># make sure you clean them all up before making a change</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge delete config &quot;${service_name}&quot;-host.v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge delete config &quot;${service_name}&quot;-client-config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge delete service &quot;${service_name}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge delete service-policy &quot;${service_name}&quot;-binding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge delete service-policy &quot;${service_name}&quot;-dialing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config &quot;${service_name}&quot;-host.v1 host.v1 &#x27;{&quot;protocol&quot;:&quot;tcp&quot;, &quot;address&quot;:&quot;localhost&quot;,&quot;port&quot;:&#x27;&quot;${the_port}&quot;&#x27;, &quot;listenOptions&quot;: {&quot;bindUsingEdgeIdentity&quot;:true}}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># intercept is not needed for zscp/zssh but make it for testing if you like</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config &quot;${service_name}&quot;-client-config intercept.v1 &#x27;{&quot;protocols&quot;:[&quot;tcp&quot;],&quot;addresses&quot;:[&quot;&#x27;&quot;${service_name}.ziti&quot;&#x27;&quot;], &quot;portRanges&quot;:[{&quot;low&quot;:&#x27;&quot;${the_port}&quot;&#x27;, &quot;high&quot;:&#x27;&quot;${the_port}&quot;&#x27;}]}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service &quot;${service_name}&quot; --configs &quot;${service_name}&quot;-client-config,&quot;${service_name}&quot;-host.v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy &quot;${service_name}&quot;-binding Bind --service-roles &#x27;@&#x27;&quot;${service_name}&quot; --identity-roles &#x27;#&#x27;&quot;${service_name}&quot;&#x27;ServerEndpoints&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy &quot;${service_name}&quot;-dialing Dial --service-roles &#x27;@&#x27;&quot;${service_name}&quot; --identity-roles &#x27;#&#x27;&quot;${service_name}&quot;&#x27;ClientEndpoints&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><nav class="pagination-nav" aria-label="Blog list page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog"><div class="pagination-nav__label">Newer Entries</div></a></nav></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__links text--center"><div class="footer__links"><a class="footer__link-item" href="/policies/CODE_OF_CONDUCT">Policies</a><span class="footer__link-separator">Â·</span><a href="https://netfoundry.io/pricing/" target="_blank" rel="noopener noreferrer" class="footer__link-item">CloudZiti</a><span class="footer__link-separator">Â·</span><a href="https://blog.openziti.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog</a></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2024 NetFoundry Inc.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.d0af056d.js"></script>
<script src="/assets/js/main.964fe104.js"></script>
</body>
</html>